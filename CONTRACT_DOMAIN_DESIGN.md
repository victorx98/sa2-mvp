# MentorX å¹³å° Contract Domain è¯¦ç»†è®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬ï¼š** v2.16.9
> **åˆ›å»ºæ—¥æœŸï¼š** 2025-11-05
> **æœ€åæ›´æ–°ï¼š** 2025-11-10
> **çŠ¶æ€ï¼š** è®¾è®¡é˜¶æ®µï¼ˆæœåŠ¡é¢„å  TTL æœºåˆ¶å·²ç§»é™¤ï¼‰
> **è´Ÿè´£åŸŸï¼š** Contract Domainï¼ˆåˆåŒåŸŸï¼‰

---

## ğŸ“‹ ç›®å½•

- [å¾…å®Œå–„é—®é¢˜æ¸…å•](#å¾…å®Œå–„é—®é¢˜æ¸…å•)
- [0. æ ¸å¿ƒè®¾è®¡çº¦æŸ](#0-æ ¸å¿ƒè®¾è®¡çº¦æŸ)
- [1. é¢†åŸŸæ¦‚è¿°](#1-é¢†åŸŸæ¦‚è¿°)
- [2. æ ¸å¿ƒæ¦‚å¿µä¸æ¶æ„](#2-æ ¸å¿ƒæ¦‚å¿µä¸æ¶æ„)
- [3. æ•°æ®æ¨¡å‹è®¾è®¡](#3-æ•°æ®æ¨¡å‹è®¾è®¡)
- [4. é¢†åŸŸæœåŠ¡æ¥å£](#4-é¢†åŸŸæœåŠ¡æ¥å£)
- [5. DTO å®šä¹‰](#5-dto-å®šä¹‰)
- [6. ä¸šåŠ¡è§„åˆ™ä¸éªŒè¯](#6-ä¸šåŠ¡è§„åˆ™ä¸éªŒè¯)
- [7. çŠ¶æ€æœºè®¾è®¡](#7-çŠ¶æ€æœºè®¾è®¡)
- [8. å®æ–½æŒ‡å—](#8-å®æ–½æŒ‡å—)

---

## å¾…å®Œå–„é—®é¢˜æ¸…å• - å†³ç­–æ‘˜è¦

> **å®¡æŸ¥æ—¥æœŸï¼š** 2025-11-10
> **å®¡æŸ¥ç‰ˆæœ¬ï¼š** v2.16.9
> **çŠ¶æ€ï¼š** âœ… æ‰€æœ‰é—®é¢˜å·²å†³ç­–ï¼ˆ15 ä¸ª + 5 ä¸ªæ–°å¢å†³ç­– + 1 ä¸ªæ–‡æ¡£æ›´æ–°ï¼‰

| ç¼–å· | é—®é¢˜ | å†³ç­–ç»“æœ |
|------|------|----------|
| **C1** | DTO éªŒè¯è§„åˆ™ | ä½¿ç”¨ `class-validator` è£…é¥°å™¨ï¼Œå‚è€ƒ Catalog Domain |
| **C2** | é”™è¯¯ç å®šä¹‰ | å­—ç¬¦ä¸²å¸¸é‡ + æŒ‰ HTTP çŠ¶æ€åˆ†ç»„çš„å¼‚å¸¸ç±» |
| **C3** | ServiceType æšä¸¾ | ä» `@infrastructure/database/schema` å¯¼å…¥ |
| **C4** | FindOneContractDto éªŒè¯ | Service å±‚éªŒè¯å”¯ä¸€æ€§ï¼Œå¤šç»“æœæŠ›å¼‚å¸¸ |
| **I1** | åˆåŒç¼–å·ç”Ÿæˆ | PostgreSQL Sequence + Advisory Lock + æœˆåº¦é‡ç½® |
| **I2** | è§¦å‘å™¨å®šä¹‰ | `sync_consumed_quantity()` + `sync_held_quantity()` |
| **I3** | ç´¢å¼•åˆ›å»º | çº¦ 30 ä¸ªç´¢å¼•ï¼ˆå« partial indexï¼‰ï¼Œç»Ÿä¸€ SQL è„šæœ¬ |
| **I4** | ç±»å‹å®šä¹‰ | `DrizzleDatabase`, `DrizzleTransaction`, `DrizzleExecutor`ï¼ˆå…¨å±€å…±äº«ï¼‰|
| **I5** | å½’æ¡£æŸ¥è¯¢éªŒè¯ | å¼ºåˆ¶æ—¥æœŸèŒƒå›´ â‰¤ 1 å¹´ï¼Œè‡ªåŠ¨è¡¥å…¨ç¼ºå¤±è¾¹ç•Œ |
| **I6** | CHECK çº¦æŸ | ç»Ÿä¸€çº¦æŸè„šæœ¬ï¼Œå‘½åï¼š`chk_<è¡¨å>_<å­—æ®µ>_<ç±»å‹>` |
| **I7** ğŸ†• | åˆåŒç¼–å·ç”Ÿæˆå‡½æ•° | ç‹¬ç«‹ SQL æ–‡ä»¶ç®¡ç†ï¼ˆ`contract_number_generator.sql`ï¼‰|
| **M1** | Event Publisher | Outbox æ¨¡å¼ï¼ˆ30s è½®è¯¢ + 5 æ¬¡é‡è¯• + æ­»ä¿¡é˜Ÿåˆ—ï¼‰|
| **M2** | æµ‹è¯•æŒ‡å— | 80% è¦†ç›–ç‡ + å…³é”®ç”¨ä¾‹æ¸…å• |
| **M3** | API å“åº” DTO | æ¨è¿Ÿåˆ° API å±‚å®æ–½ |
| **M4** | æƒé™æ§åˆ¶ | æ¨è¿Ÿåˆ°å®æ–½é˜¶æ®µï¼ˆæä¾›æƒé™çŸ©é˜µå‚è€ƒï¼‰|
| **M5** | ç‰ˆæœ¬å· | ç»Ÿä¸€ä¸º v2.16.7 |
| **R1** ğŸ†• | ä¿®è®¢ç‰ˆæœ¬å·ç²’åº¦ | åˆåŒçº§åˆ«ç‰ˆæœ¬å·ï¼ˆrevisionNumberåœ¨åˆåŒå†…å…¨å±€é€’å¢ï¼‰|
| **R2** ğŸ†• | ä¿®è®¢è®°å½•èŒƒå›´ | ä»…è®°å½•"æƒç›Šèµ‹äºˆ"ç±»å˜æ›´ï¼ˆä¸è®°å½•æ¶ˆè´¹/é¢„å ï¼‰|
| **R3** ğŸ†• | ä¿®è®¢è®°å½•å…³è” | å…³è”åˆ°å…·ä½“æƒç›Šè®°å½•ï¼ˆentitlementIdï¼Œç²¾ç¡®è¿½æº¯ï¼‰|
| **R4** ğŸ†• | ä¿®è®¢å®¡æ ¸æµç¨‹ | æ”¯æŒå®¡æ ¸æµç¨‹ï¼ˆstatus, requiresApprovalï¼‰|
| **R5** ğŸ†• | åˆå§‹æƒç›Šè®°å½• | åˆ›å»ºåˆåŒæ—¶è®°å½•åˆå§‹æƒç›Šï¼ˆrevisionType='initial'ï¼‰|
| **R6** ğŸ†• | é¢å¤–æƒç›Šå®¡æ‰¹è§„åˆ™ | æ‰€æœ‰é¢å¤–æƒç›Šï¼ˆaddon/promotion/compensationï¼‰éƒ½éœ€è¦å®¡æ‰¹ï¼ˆè‡ªåŠ¨è®¾ç½® requiresApproval=trueï¼‰|
| **D1** ğŸ†•ğŸ†• | **åˆåŒçŠ¶æ€æœºæ–‡æ¡£åŒæ­¥** | âœ… **å·²å†³ç­–ï¼šæ›´æ–°è®¾è®¡æ–‡æ¡£åæ˜ ä»£ç å®ç°**ï¼ˆå¢åŠ  signed çŠ¶æ€ï¼Œå®Œå–„çŠ¶æ€æµè½¬ï¼‰|

> **è¯¦ç»†å†³ç­–è®°å½•**ï¼šå‚è§æ–‡æ¡£æœ«å°¾ [é™„å½•ï¼šè®¾è®¡å†³ç­–è¯¦ç»†è®°å½•](#é™„å½•è®¾è®¡å†³ç­–è¯¦ç»†è®°å½•)

---


### å…³é”®å®æ–½è¦ç‚¹

#### 1. DTO éªŒè¯æ ‡å‡†ï¼ˆC1ï¼‰
- ä½¿ç”¨ `class` + `class-validator` è£…é¥°å™¨
- å‚è€ƒï¼š`src/domains/catalog/product/dto/create-product.dto.ts`
- å¿…å¡«ï¼š`@IsNotEmpty()` + ç±»å‹éªŒè¯
- å¯é€‰ï¼š`@IsOptional()`
- åµŒå¥—å¯¹è±¡ï¼š`@ValidateNested()` + `@Type(() => NestedDto)`

#### 2. é”™è¯¯å¤„ç†æ ‡å‡†ï¼ˆC2ï¼‰
- å­—ç¬¦ä¸²å¸¸é‡é”™è¯¯ç ï¼ˆä¸ä½¿ç”¨ enumï¼‰
- æŒ‰ HTTP çŠ¶æ€åˆ†ç»„å¼‚å¸¸ç±»ï¼š`ContractException`, `ContractNotFoundException`, `ContractConflictException`, `ContractGoneException`, `ContractUnprocessableException`
- å®ç°ä½ç½®ï¼š`src/domains/contract/common/exceptions/contract.exception.ts`
- å‚è€ƒï¼š`src/domains/catalog/common/exceptions/catalog.exception.ts`

#### 3. ServiceType æšä¸¾ï¼ˆC3ï¼‰
```typescript
import { serviceTypeEnum } from '@infrastructure/database/schema/services.schema';
```
- 11 ç§æœåŠ¡ç±»å‹ï¼šgap_analysis, resume_review, recommendation_letter, recommendation_letter_online, session, mock_interview, class_session, internal_referral, contract_signing_assistance, proxy_application, other_service

#### 4. æ•°æ®åº“ç±»å‹å®šä¹‰ï¼ˆI4ï¼‰
```typescript
// src/shared/types/database.types.ts

import { NodePgDatabase } from 'drizzle-orm/node-postgres';
import { PgTransaction } from 'drizzle-orm/pg-core';
import * as schema from '@infrastructure/database/schema';

export type DrizzleDatabase = NodePgDatabase<typeof schema>;
export type DrizzleTransaction = PgTransaction<typeof schema, any, Record<string, never>>;
export type DrizzleExecutor = DrizzleDatabase | DrizzleTransaction;
```

#### 5. SQL è„šæœ¬æ–‡ä»¶ç»“æ„
- `src/infrastructure/database/migrations/sql/contract_number_generator.sql` - åˆåŒç¼–å·ç”Ÿæˆå‡½æ•°ï¼ˆSequence + Advisory Lockï¼‰
- `src/infrastructure/database/migrations/sql/contract_triggers.sql` - è§¦å‘å™¨ï¼ˆ`sync_consumed_quantity`, `sync_held_quantity`ï¼‰
- `src/infrastructure/database/migrations/sql/contract_indexes.sql` - ç´¢å¼•ï¼ˆçº¦ 30 ä¸ªï¼Œå« partial indexï¼‰
- `src/infrastructure/database/migrations/sql/contract_constraints.sql` - CHECK çº¦æŸï¼ˆçº¦ 20 ä¸ªï¼‰
- `src/infrastructure/database/migrations/sql/contract_entitlement_revisions_indexes.sql` - æƒç›Šä¿®è®¢è¡¨ç´¢å¼•ï¼ˆ9ä¸ªï¼‰ğŸ†•v2.16.8
- `src/infrastructure/database/migrations/sql/contract_entitlement_revisions_constraints.sql` - æƒç›Šä¿®è®¢è¡¨CHECKçº¦æŸï¼ˆ2ä¸ªï¼‰ğŸ†•v2.16.8

#### 6. Event Publisher é…ç½®ï¼ˆM1ï¼‰
- è½®è¯¢é¢‘ç‡ï¼š30 ç§’ï¼ˆ`EVENT_PUBLISHER_POLL_INTERVAL_MS=30000`ï¼‰
- é‡è¯•æ¬¡æ•°ï¼š5 æ¬¡ï¼ˆ`EVENT_PUBLISHER_MAX_RETRIES=5`ï¼‰
- æ‰¹é‡å¤§å°ï¼š100 æ¡ï¼ˆ`EVENT_PUBLISHER_BATCH_SIZE=100`ï¼‰
- ä½¿ç”¨ Advisory Lock é˜²æ­¢å¤šå®ä¾‹å†²çª

#### 7. æµ‹è¯•è¦†ç›–ç›®æ ‡ï¼ˆM2ï¼‰
- Domain Servicesï¼š80%
- ä¸šåŠ¡è§„åˆ™éªŒè¯ï¼š100%ï¼ˆå…³é”®è·¯å¾„ï¼‰
- å…³é”®æµ‹è¯•åœºæ™¯ï¼šæœåŠ¡æ¶ˆè´¹ï¼ˆå«ä¼˜å…ˆçº§ç®—æ³•ï¼‰ã€æœåŠ¡é¢„å ï¼ˆå« TTLï¼‰ã€çŠ¶æ€æµè½¬ã€ä»·æ ¼è¦†ç›–ã€è§¦å‘å™¨ã€å½’æ¡£æŸ¥è¯¢

---

## 0. æ ¸å¿ƒè®¾è®¡çº¦æŸ

> **å®¡æŸ¥å®Œæˆæ—¥æœŸï¼š** 2025-11-06
> **å½“å‰ç‰ˆæœ¬ï¼š** v2.16.7
> **çŠ¶æ€ï¼š** âœ… è®¾è®¡å®Œæˆï¼Œæ‰€æœ‰å¾…å†³ç­–é—®é¢˜å·²è§£å†³ï¼ˆå…± 15 ä¸ªï¼š4 å…³é”® + 6 é‡è¦ + 5 æ¬¡è¦ï¼‰

æœ¬ç« èŠ‚æ€»ç»“å®æ–½æ—¶å¿…é¡»éµå®ˆçš„æ ¸å¿ƒè®¾è®¡çº¦æŸå’Œå…³é”®å†³ç­–ã€‚

---

### 0.1 æ¶æ„çº¦æŸ

#### DDD é˜²è…å±‚åŸåˆ™
- âœ… Contract Domain ä¸ç›´æ¥å¯¼å…¥ Catalog Domain çš„ Schema
- âœ… é€šè¿‡ ProductSnapshot å¿«ç…§æœºåˆ¶å®ç°åŸŸéš”ç¦»
- âœ… `productId` ä»…ä½œä¸º UUID å¼•ç”¨ï¼Œä¸å»ºç«‹å¤–é”®

#### æœåŠ¡æ¥å£å®Œæ•´æ€§
- âœ… ContractService å¿…é¡»åŒ…å«ï¼š`create()`, `activate()`, `suspend()`, `resume()`, `complete()`, `terminate()`
- âœ… `consumeService()` ä½¿ç”¨ `ConsumeServiceDto` å‚æ•°ï¼ˆåŒ…å«å®¡è®¡å­—æ®µï¼‰
- âœ… `getServiceBalance()` æ”¯æŒå¤šç§æŸ¥è¯¢æ¡ä»¶ï¼ˆcontractId / studentId / serviceTypeï¼‰

---

### 0.2 æ•°æ®æ¨¡å‹çº¦æŸ

#### æœåŠ¡å•ä½ç»Ÿä¸€
- âœ… **å•ä½è®¾è®¡**ï¼šæ‰€æœ‰æœåŠ¡ç»Ÿä¸€æŒ‰æ¬¡æ•°è®¡è´¹ï¼ˆv2.16.7ï¼šç§»é™¤ unit å­—æ®µå’Œ ServiceUnit æšä¸¾ï¼‰
- âœ… æ—¶é•¿/å‘¨æœŸä¿¡æ¯åœ¨æœåŠ¡å®šä¹‰ä¸­è¯´æ˜ï¼Œä¸å½±å“è®¡è´¹é€»è¾‘

#### å”¯ä¸€çº¦æŸä¸åˆå¹¶é€»è¾‘
- âœ… **contract_service_entitlements å”¯ä¸€çº¦æŸ**ï¼š`(contract_id, service_type, expires_at, source)`
- âœ… ç›¸åŒæœåŠ¡ç±»å‹æƒç›ŠæŒ‰ä¸Šè¿°é”®åˆå¹¶ï¼Œ`originItems` æ•°ç»„ä¿ç•™æ‰€æœ‰æ¥æºè¿½æº¯

#### åˆåŒç¼–å·ç”Ÿæˆ
- âœ… **æ ¼å¼**ï¼š`CONTRACT-YYYY-MM-NNNNN`ï¼ˆæœˆåº¦åºåˆ—ï¼‰
- âœ… ä½¿ç”¨ PostgreSQL Sequence + Advisory Lock ä¿è¯å¹¶å‘å®‰å…¨
- âœ… æ¯æœˆè‡ªåŠ¨é‡ç½®ï¼Œè¾¾åˆ° 99999 ä¸Šé™æŠ›å¼‚å¸¸

#### Schema ç±»å‹ä¸€è‡´æ€§
- âœ… `originItems.productItemType` ä½¿ç”¨ `ProductItemType` ç±»å‹åˆ«å
- âœ… ä¸ä½¿ç”¨å­—ç¬¦ä¸²å­—é¢é‡ï¼Œä¿æŒç±»å‹ç»Ÿä¸€

---

### 0.3 ä¸šåŠ¡è§„åˆ™çº¦æŸ

#### æƒç›Šè¿‡æœŸå¤„ç†
- âœ… **æƒç›Šè¿‡æœŸæ—¶é—´**ï¼šç»Ÿä¸€ç»§æ‰¿åˆåŒ `expiresAt`ï¼Œä¸æ”¯æŒæœåŠ¡çº§åˆ«ç‹¬ç«‹è¿‡æœŸ
- âœ… **æŸ¥è¯¢æ—¶è¿‡æ»¤**ï¼šæ‰€æœ‰æŸ¥è¯¢æ´»è·ƒåˆåŒ/æƒç›Šæ—¶ï¼ŒåŠ¨æ€è¿‡æ»¤ `expiresAt`ï¼ˆæ— éœ€å®šæ—¶ä»»åŠ¡ï¼‰
- âœ… **æ¶ˆè´¹éªŒè¯**ï¼šæ¶ˆè´¹æœåŠ¡æ—¶éªŒè¯åˆåŒå’Œæƒç›Šæœªè¿‡æœŸ

#### æœåŠ¡æ¶ˆè´¹ä¼˜å…ˆçº§
- âœ… **ä¼˜å…ˆçº§é¡ºåº**ï¼šproduct > addon > promotion > compensation
- âœ… **åŒä¼˜å…ˆçº§æ’åº**ï¼šæŒ‰ `createdAt ASC`ï¼ˆå…ˆåˆ›å»ºçš„å…ˆæ¶ˆè´¹ï¼‰
- âœ… **æ‰£å‡ç­–ç•¥**ï¼šé€æ¡æ‰£å‡ï¼Œç›´åˆ°æ»¡è¶³æ¶ˆè´¹æ•°é‡

#### ä»·æ ¼è¦†ç›–éªŒè¯
- âœ… **å…è´¹åˆåŒï¼ˆ$0ï¼‰**ï¼šå¿…é¡»æä¾› `overrideApprovedBy`ï¼ˆè¶…çº§ç®¡ç†å‘˜ IDï¼‰
- âœ… **ä»·æ ¼è¦†ç›–**ï¼šå¿…é¡»è®°å½• `metadata.pricingNote`ï¼ˆåŸå› è¯´æ˜ï¼‰
- âœ… **ä»·æ ¼èŒƒå›´**ï¼š$0 - äº§å“ä»·æ ¼ Ã— 200%ï¼Œæœ€å¤§æŠ˜æ‰£ 90%

#### å½’æ¡£æŸ¥è¯¢ä¿æŠ¤
- âœ… **å¼ºåˆ¶éªŒè¯**ï¼š`includeArchive=true` å¿…é¡»æä¾› `dateRange` å‚æ•°
- âœ… **å¼‚å¸¸å¤„ç†**ï¼šæœªæä¾›æŠ›å‡º `ARCHIVE_QUERY_REQUIRES_DATE_RANGE` å¼‚å¸¸

---

### 0.4 å¹¶å‘ä¸æ€§èƒ½çº¦æŸ

#### å¹¶å‘æ§åˆ¶
- âœ… **consumeService()**ï¼šä½¿ç”¨ `SELECT ... FOR UPDATE` æ‚²è§‚é” + æ•°æ®åº“äº‹åŠ¡
- âœ… **åˆåŒç¼–å·ç”Ÿæˆ**ï¼šPostgreSQL Advisory Lock é˜²æ­¢é‡å¤
- âœ… **æƒç›Šåˆå¹¶**ï¼š`ON CONFLICT DO UPDATE` å¤„ç†å¹¶å‘æ’å…¥

#### æ•°æ®å®Œæ•´æ€§
- âœ… **availableQuantity åŒæ­¥**ï¼šä½¿ç”¨æ•°æ®åº“è§¦å‘å™¨è‡ªåŠ¨è®¡ç®—
- âœ… **Append-only æµæ°´**ï¼šservice_ledgers åªå¢ä¸æ”¹ï¼Œè°ƒæ•´é€šè¿‡æ–°è®°å½•
- âœ… **äº‹åŠ¡åŸå­æ€§**ï¼šæ‰€æœ‰å†™æ“ä½œä½¿ç”¨æ•°æ®åº“äº‹åŠ¡åŒ…è£¹

#### æ€§èƒ½ä¼˜åŒ–
- âœ… **å¤åˆç´¢å¼•**ï¼š5 ä¸ªå…³é”®ç´¢å¼•è¦†ç›–æ‰€æœ‰æŸ¥è¯¢åœºæ™¯ï¼ˆé¢„æœŸæ€§èƒ½æå‡ 40-95%ï¼‰
- âœ… **é¢„å æ‰¹é‡æ¸…ç†**ï¼šæ‰¹é‡ UPDATE + è§¦å‘å™¨ï¼ˆæ€§èƒ½æå‡ 40 å€ï¼‰
- âœ… **æŸ¥è¯¢ä¼˜åŒ–**ï¼šæä¾› Helper Functions ç®€åŒ–å¸¸è§æŸ¥è¯¢

---

### 0.5 äº‹ä»¶ä¸é›†æˆçº¦æŸ

#### äº‹ä»¶å‘å¸ƒæœºåˆ¶
- âœ… **Outbox æ¨¡å¼**ï¼šåœ¨åŒä¸€äº‹åŠ¡ä¸­å°†äº‹ä»¶å†™å…¥ `domain_events` è¡¨
- âœ… **å¼‚æ­¥å‘å¸ƒå™¨**ï¼šç‹¬ç«‹è¿›ç¨‹å®šæœŸè½®è¯¢å¹¶å‘å¸ƒäº‹ä»¶
- âœ… **é‡è¯•æœºåˆ¶**ï¼šæŒ‡æ•°é€€é¿ + æ­»ä¿¡é˜Ÿåˆ—

#### äº‹ä»¶è½½è·å®šä¹‰
- âœ… æ‰€æœ‰äº‹ä»¶åŒ…å«ï¼š`eventType`, `aggregateId`, `occurredAt`, `payload`
- âœ… å·²å®šä¹‰ 6 ç§äº‹ä»¶è½½è·ï¼šcontract.signed, activated, completed, terminated, suspended, resumed

---

### 0.6 å®æ–½ç®€åŒ–çº¦æŸ

#### MVP èŒƒå›´
- âœ… **å•ä¸€å¸ç§**ï¼šä»…æ”¯æŒ USD
- âœ… **æ— åˆ†åŒºè¡¨**ï¼šMVP ä¾èµ–ç´¢å¼•ä¼˜åŒ–ï¼Œåç»­æ ¹æ®æ•°æ®é‡å†³å®š
- âœ… **æƒé™æ§åˆ¶**ï¼šæ¨è¿Ÿåˆ°å®æ–½é˜¶æ®µï¼ˆåç»­ä½¿ç”¨ `@Roles()` è£…é¥°å™¨ï¼‰
- âœ… **ä½™é¢å¯¹è´¦**ï¼šæ¨è¿Ÿåˆ°å®æ–½é˜¶æ®µï¼ˆMVP ä¾èµ–è§¦å‘å™¨ä¿è¯ä¸€è‡´æ€§ï¼‰

---

### 0.7 å‘½åä¸çº¦å®š

#### å‘½åè§„èŒƒ
- âœ… **æ•°æ®åº“åˆ—å**ï¼šsnake_caseï¼ˆservice_type, created_atï¼‰
- âœ… **TypeScript/DTO**ï¼šcamelCaseï¼ˆserviceType, createdAtï¼‰
- âœ… **æšä¸¾ç±»å‹**ï¼šPascalCaseï¼ˆServiceType, ContractStatusï¼‰
- âœ… Drizzle ORM è‡ªåŠ¨å¤„ç†è½¬æ¢

#### é”™è¯¯ç å®šä¹‰
- âœ… ä½¿ç”¨æšä¸¾ï¼š`ContractErrorCode`
- âœ… å¼‚å¸¸ç±»ï¼š`ContractException`ï¼ˆåŒ…å« errorCode, message, statusCodeï¼‰

---

## ğŸ“ ç‰ˆæœ¬æ›´æ–°æ—¥å¿—

### v2.16.8 (2025-11-10) - å½“å‰ç‰ˆæœ¬

**æ–°å¢åˆåŒæƒç›Šä¿®è®¢è¡¨**

æœ¬æ¬¡ç‰ˆæœ¬æ–°å¢ `contract_entitlement_revisions` è¡¨ï¼Œç”¨äºè®°å½•åˆåŒæƒç›Šçš„å˜æ›´å†å²ï¼Œæ”¯æŒå®¡è®¡è¿½æº¯å’Œç‰ˆæœ¬ç®¡ç†ã€‚

**æ ¸å¿ƒå˜æ›´ï¼š**

1. **æ–°å¢ `contract_entitlement_revisions` è¡¨**
   - è®°å½•æƒç›Šèµ‹äºˆç±»å˜æ›´ï¼ˆinitial, addon, promotion, compensation, etc.ï¼‰
   - æ”¯æŒå®¡æ ¸æµç¨‹ï¼ˆpending â†’ approved/rejected â†’ appliedï¼‰
   - åˆåŒçº§åˆ«ç‰ˆæœ¬å·ï¼ˆrevisionNumber åœ¨åˆåŒå†…å…¨å±€é€’å¢ï¼‰

2. **ContractService å¢å¼º**
   - æ–°å¢ `getEntitlementRevisions()`ï¼šæŸ¥è¯¢ä¿®è®¢å†å²
   - æ–°å¢ `approveRevision()`ï¼šå®¡æ‰¹ä¿®è®¢
   - æ–°å¢ `rejectRevision()`ï¼šæ‹’ç»ä¿®è®¢

3. **ä¸šåŠ¡è§„åˆ™æ›´æ–°**
   - **æ‰€æœ‰é¢å¤–æƒç›Šéƒ½éœ€è¦å®¡æ‰¹**ï¼šaddon/promotion/compensation ç±»å‹æƒç›Šå˜æ›´éœ€ç®¡ç†å‘˜å®¡æ‰¹
   - åˆ›å»ºåˆåŒæ—¶è‡ªåŠ¨è®°å½•åˆå§‹æƒç›Šï¼ˆrevisionType='initial'ï¼‰

**è¿‘æœŸç‰ˆæœ¬æ¼”è¿›ï¼š**
- **v2.16.7**ï¼šæ•°æ®æ¨¡å‹ç®€åŒ–ï¼Œç§»é™¤ unit å­—æ®µï¼›å¢å¼ºæŸ¥è¯¢æ¥å£ï¼ˆfindOneï¼‰
- **v2.16.6**ï¼šServiceUnit ç»Ÿä¸€ä¸º 'times'ï¼ˆæ¬¡æ•°ï¼‰

> **å®Œæ•´å†å²ç‰ˆæœ¬**ï¼šå‚è§æ–‡æ¡£æœ«å°¾ [é™„å½•ï¼šå†å²ç‰ˆæœ¬å˜æ›´](#é™„å½•å†å²ç‰ˆæœ¬å˜æ›´)

---

## 1. é¢†åŸŸæ¦‚è¿°

### 1.1 é¢†åŸŸèŒè´£

Contract Domainï¼ˆåˆåŒåŸŸï¼‰æ˜¯ MentorX å¹³å°çš„**æ ¸å¿ƒä¸šåŠ¡åŸŸ**ï¼Œè´Ÿè´£ç®¡ç†å­¦ç”Ÿçš„åˆåŒç­¾è®¢ã€æœåŠ¡æƒç›Šå’ŒæœåŠ¡æ¶ˆè´¹å…¨ç”Ÿå‘½å‘¨æœŸã€‚

**æ ¸å¿ƒèŒè´£ï¼š**

- âœ… ç®¡ç†åˆåŒçš„å…¨ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»ºã€æ¿€æ´»ã€ç»ˆæ­¢ã€æš‚åœï¼‰
- âœ… ç®¡ç†åˆåŒæœåŠ¡æƒç›Šä½™é¢ï¼ˆService Entitlementsï¼‰
- âœ… è¿½è¸ªæœåŠ¡æ¶ˆè´¹æµæ°´ï¼ˆService Ledger - Append-onlyï¼‰
- âœ… ç®¡ç†æœåŠ¡é¢„å æœºåˆ¶ï¼ˆService Hold - TTLæœºåˆ¶ï¼‰
- âœ… æ”¯æŒé¢å¤–æ·»åŠ æœåŠ¡æƒç›Šï¼ˆä¿ƒæˆç­¾çº¦ã€ä¿ƒé”€ã€è¡¥å¿ï¼‰
- âœ… æä¾›æœåŠ¡ä½™é¢æŸ¥è¯¢å’ŒéªŒè¯
- âœ… æ”¯æŒæµæ°´å½’æ¡£å’Œå†·çƒ­åˆ†ç¦»
- âœ… å‘å¸ƒåˆåŒç›¸å…³ä¸šåŠ¡äº‹ä»¶

**ä¸è´Ÿè´£çš„èŒè´£ï¼š**

- âŒ ä¸å¤„ç†äº§å“å®šä¹‰ï¼ˆCatalog Domain è´Ÿè´£ï¼‰
- âŒ ä¸å¤„ç†æ”¯ä»˜ï¼ˆFinancial Domain è´Ÿè´£ï¼‰
- âŒ ä¸å¤„ç†æœåŠ¡é¢„çº¦ï¼ˆServices Domain è´Ÿè´£ï¼‰
- âŒ ä¸å¤„ç†å¯¼å¸ˆè®¡è´¹ï¼ˆFinancial Domain è´Ÿè´£ï¼‰
- âŒ ä¸å¤„ç†ç»“ç®—ï¼ˆFinancial Domain è´Ÿè´£ï¼‰

### 1.2 é¢†åŸŸç‰¹æ€§

**æ ¸å¿ƒä¸šåŠ¡åŸŸç‰¹æ€§ï¼š**

1. **äº‹ä»¶é©±åŠ¨**ï¼šå‘å¸ƒå’Œç›‘å¬ä¸šåŠ¡äº‹ä»¶ï¼Œé©±åŠ¨è·¨åŸŸåä½œ
2. **çŠ¶æ€ç®¡ç†**ï¼šåˆåŒçŠ¶æ€æœºæµè½¬ï¼ˆdraft â†’ active â†’ completed/terminatedï¼‰
3. **Append-only æµæ°´**ï¼šæœåŠ¡æµæ°´åªèƒ½è¿½åŠ ï¼Œä¸å¯ä¿®æ”¹ï¼Œä¿è¯å®¡è®¡å®Œæ•´æ€§
4. **æœåŠ¡é¢„å æœºåˆ¶**ï¼šé˜²æ­¢è¶…é¢é¢„çº¦ï¼Œéœ€äººå·¥é‡Šæ”¾ï¼ˆv2.16.9ï¼šç§»é™¤è‡ªåŠ¨è¿‡æœŸï¼‰
5. **å†·çƒ­åˆ†ç¦»**ï¼šå†å²æµæ°´å½’æ¡£ï¼Œä¿æŒæŸ¥è¯¢æ€§èƒ½
6. **åˆåŒ-äº§å“ä¸€å¯¹ä¸€ç»‘å®š**ï¼šæ¯ä¸ªåˆåŒä»…å…³è”ä¸€ä¸ªäº§å“ï¼Œäº§å“ä¿¡æ¯é€šè¿‡å¿«ç…§å›ºåŒ–

**æ ¸å¿ƒä¸šåŠ¡çº¦æŸï¼ˆv2.16.6ï¼‰ï¼š**

- ğŸ“Œ **åˆåŒä¸äº§å“çš„ä¸€å¯¹ä¸€å…³ç³»**ï¼š
  - æ¯ä¸ªåˆåŒä»…èƒ½ç»‘å®šä¸€ä¸ªäº§å“ï¼ˆé€šè¿‡ `productId` å­—æ®µï¼‰
  - äº§å“ä¿¡æ¯åœ¨åˆåŒåˆ›å»ºæ—¶é€šè¿‡ `productSnapshot` å›ºåŒ–
  - åˆåŒåˆ›å»ºåä¸å¯æ›´æ¢äº§å“
  - åŸå› ï¼šä¿è¯åˆåŒçš„ç¡®å®šæ€§å’Œå®¡è®¡è¿½æº¯æ€§

- ğŸ“Œ **æœåŠ¡å•ä½ç»Ÿä¸€ä¸ºæ¬¡æ•°**ï¼ˆv2.16.6 æ–°å¢ï¼‰ï¼š
  - æ‰€æœ‰æœåŠ¡æƒç›Šçš„å•ä½ï¼ˆ`unit`ï¼‰ç»Ÿä¸€ä¸º `'times'`ï¼ˆæ¬¡æ•°ï¼‰
  - ä¸æ”¯æŒå…¶ä»–å•ä½ï¼ˆå¦‚ hours, days, sessionsï¼‰
  - æœåŠ¡æ—¶é•¿/å‘¨æœŸä¿¡æ¯åœ¨æœåŠ¡å®šä¹‰ä¸­è¯´æ˜ï¼Œä¸å½±å“è®¡è´¹å•ä½
  - åŸå› ï¼šç®€åŒ–è®¡è´¹æ¨¡å‹ï¼Œé¿å…å•ä½è½¬æ¢å¤æ‚åº¦

**v2.16 æ–°å¢ç‰¹æ€§ï¼š**

- **é¢å¤–æƒç›Šæ·»åŠ **ï¼šæ”¯æŒä¿ƒæˆç­¾çº¦ã€ä¿ƒé”€æ´»åŠ¨ã€è¡¥å¿ç­‰åœºæ™¯çš„æœåŠ¡å¢åŠ 
- **æƒç›Šæ¥æºè¿½æº¯**ï¼šåŒºåˆ†äº§å“æ ‡å‡†æƒç›Š vs é¢å¤–æ·»åŠ æƒç›Š
- **çµæ´»æƒç›Šç®¡ç†**ï¼šåŒä¸€æœåŠ¡ç±»å‹å¯å¤šæ¬¡æ·»åŠ é¢å¤–æƒç›Š

### 1.3 ä¸å…¶ä»–åŸŸçš„åä½œ

**åä½œæ¨¡å¼ï¼šäº‹ä»¶é©±åŠ¨ + æœåŠ¡è°ƒç”¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Contract Domain åä½œå›¾                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Catalog Domain                  Contract Domain
    â”‚                                â”‚
    â”‚ åˆ›å»ºåˆåŒæ—¶æŸ¥è¯¢äº§å“                â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚   è°ƒç”¨: ProductService         â”‚
    â”‚   è¿”å›: ProductDetail          â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                                â”‚
    â”‚                                â”‚ å‘å¸ƒ: contract.signed
    â”‚                                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                â”‚                      â”‚
                                     â”‚                      â–¼
Financial Domain                     â”‚              Notification
    â”‚                                â”‚                      â”‚
    â”‚ payment.succeeded              â”‚                      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                      â”‚
    â”‚                                â”‚                      â”‚
    â”‚                                â”‚ æ¿€æ´»åˆåŒ              â”‚
    â”‚                                â”‚ åˆå§‹åŒ–æœåŠ¡æƒç›Š         â”‚
    â”‚                                â”‚                      â”‚
    â”‚                                â”‚ å‘å¸ƒ: contract.activated
    â”‚                                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                â”‚                      â”‚
    â”‚                                â”‚                      â–¼
Services Domain                      â”‚              Services Domain
    â”‚                                â”‚                      â”‚
    â”‚ services.session.completed     â”‚                      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                      â”‚
    â”‚                                â”‚                      â”‚
    â”‚                                â”‚ åˆ›å»ºæœåŠ¡æµæ°´          â”‚
    â”‚                                â”‚ æ‰£å‡æœåŠ¡æƒç›Š          â”‚
    â”‚                                â”‚                      â”‚
    â”‚                                â”‚ å‘å¸ƒ: service.consumed
    â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
```

**å…³é”®åä½œåœºæ™¯ï¼š**

1. **åˆåŒåˆ›å»º**ï¼š
   - Contract Domain â†’ Catalog Domainï¼šæŸ¥è¯¢äº§å“è¯¦æƒ…
   - Contract Domain â†’ Event Busï¼šå‘å¸ƒ `contract.signed`

2. **åˆåŒæ¿€æ´»**ï¼š
   - Financial Domain â†’ Contract Domainï¼šå‘é€ `payment.succeeded` äº‹ä»¶
   - Contract Domain æ¿€æ´»åˆåŒï¼Œåˆå§‹åŒ–æœåŠ¡æƒç›Š
   - Contract Domain â†’ Event Busï¼šå‘å¸ƒ `contract.activated`

3. **æœåŠ¡æ¶ˆè´¹**ï¼š
   - Services Domain â†’ Contract Domainï¼šå‘é€ `session.completed` äº‹ä»¶
   - Contract Domain åˆ›å»ºæœåŠ¡æµæ°´ï¼Œæ‰£å‡æƒç›Š
   - Contract Domain â†’ Event Busï¼šå‘å¸ƒ `service.consumed`

**è·¨åŸŸåä½œåŸåˆ™ï¼ˆv2.16.4 æ˜ç¡®ï¼‰ï¼š**

- âœ… **Catalog Domain â†’ Contract Domain**ï¼šé€šè¿‡å¿«ç…§æœºåˆ¶ï¼ˆå•å‘ä¾èµ–ï¼‰
- âœ… **Financial Domain â†’ Contract Domain**ï¼šé€šè¿‡äº‹ä»¶é©±åŠ¨ï¼ˆpayment.succeeded æ¿€æ´»åˆåŒï¼‰
- âœ… **Services Domain â†’ Contract Domain**ï¼šé€šè¿‡äº‹ä»¶é©±åŠ¨ï¼ˆsession.completed æ‰£å‡æƒç›Šï¼‰
- âŒ **Financial Domain ä¸æŸ¥è¯¢ Contract Domain**ï¼ˆå†³ç­– #9ï¼‰
  - Financial Domain ä¸ç›´æ¥è°ƒç”¨ Contract Domain çš„æ¥å£æŸ¥è¯¢åˆåŒä¿¡æ¯
  - å¦‚æœ‰éœ€è¦ï¼Œé€šè¿‡äº‹ä»¶ä¼ é€’å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
  - æ¥å£ä¿ç•™ç”¨äºæœªæ¥å¯èƒ½çš„æ‰©å±•éœ€æ±‚
  - ä¿æŒåŸŸçš„ç‹¬ç«‹æ€§å’Œé˜²è…éš”ç¦»

### 1.4 Catalog Domain å¿«ç…§æœºåˆ¶é›†æˆ

#### 1.4.1 å¿«ç…§æ¥å£æ¦‚è¿°

Catalog Domain æä¾›äº†å®Œæ•´çš„ä¸‰å±‚å¿«ç…§ä½“ç³»ï¼Œç”¨äºåœ¨åˆåŒåˆ›å»ºæ—¶æ•è·äº§å“ä¿¡æ¯çš„å†å²çŠ¶æ€ï¼š

```typescript
// Catalog Domain æä¾›çš„å¿«ç…§æ¥å£
ProductService.generateSnapshot(productId: string): Promise<IProductSnapshot>
  â””â”€ è‡ªåŠ¨å±•å¼€æ‰€æœ‰ product itemsï¼ˆåŒ…æ‹¬ services å’Œ service_packagesï¼‰
     â”œâ”€ IProductSnapshotItem (type='service')
     â”‚   â””â”€ serviceSnapshot: IServiceSnapshot
     â””â”€ IProductSnapshotItem (type='service_package')
         â””â”€ servicePackageSnapshot: IServicePackageSnapshot
             â””â”€ items: IServicePackageSnapshotItem[]
                 â””â”€ serviceSnapshot: IServiceSnapshot (é€’å½’å±•å¼€)
```

**å¿«ç…§æ¥å£çš„æ ¸å¿ƒç‰¹æ€§ï¼š**

1. âœ… **å®Œå…¨å±•å¼€**ï¼šservice_package å·²é€’å½’å±•å¼€ä¸ºå…·ä½“çš„ servicesï¼Œæ— éœ€ Contract Domain å†æ¬¡æŸ¥è¯¢
2. âœ… **æ‰¹é‡ä¼˜åŒ–**ï¼šCatalog Domain å†…éƒ¨ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢é¿å… N+1 é—®é¢˜
3. âœ… **å†å²å‡†ç¡®**ï¼šåŒ…å« snapshotAt æ—¶é—´æˆ³ï¼Œè®°å½•å¿«ç…§ç”Ÿæˆæ—¶é—´
4. âœ… **æ•°æ®å®Œæ•´**ï¼šåŒ…å« Contract Domain éœ€è¦çš„æ‰€æœ‰å­—æ®µï¼ˆprice, validityDays, serviceType ç­‰ï¼‰
5. âœ… **é›¶å¤–éƒ¨æŸ¥è¯¢**ï¼šContract Domain æ— éœ€å†æ¬¡è°ƒç”¨ Catalog Domain æŸ¥è¯¢ service æˆ– package è¯¦æƒ…

#### 1.4.2 å¿«ç…§æ•°æ®ç»“æ„

**IProductSnapshot å®Œæ•´ç»“æ„ï¼š**

```typescript
interface IProductSnapshot {
  // Product åŸºæœ¬ä¿¡æ¯
  productId: string;
  productName: string;
  productCode: string;
  price: string;                    // åˆåŒæ€»é¢ï¼ˆå¿«ç…§ï¼‰
  currency: Currency;               // å¸ç§ï¼ˆå¿«ç…§ï¼‰
  validityDays?: number;            // æœ‰æ•ˆæœŸï¼ˆå¿«ç…§ï¼Œnull = æ°¸ä¹…æœ‰æ•ˆï¼‰

  // Product itemsï¼ˆå·²å®Œå…¨å±•å¼€ï¼‰
  items: IProductSnapshotItem[];

  // å¿«ç…§æ—¶é—´
  snapshotAt: Date;
}

interface IProductSnapshotItem {
  type: ProductItemType;            // 'service' | 'service_package'
  quantity: number;                 // æ•°é‡ï¼ˆæ¬¡æ•°ï¼Œæ‰€æœ‰æœåŠ¡ç»Ÿä¸€æŒ‰æ¬¡æ•°è®¡è´¹ï¼‰
  sortOrder: number;                // æ’åº

  // Service snapshotï¼ˆå½“ type='service' æ—¶ï¼‰
  serviceSnapshot?: IServiceSnapshot;

  // Service package snapshotï¼ˆå½“ type='service_package' æ—¶ï¼Œå·²å±•å¼€ä¸º servicesï¼‰
  servicePackageSnapshot?: IServicePackageSnapshot;
}

interface IServiceSnapshot {
  serviceId: string;
  serviceName: string;
  serviceCode: string;
  serviceType: ServiceType;         // ğŸ”‘ ç”¨äºåˆ›å»º contract_service_entitlements
  billingMode: BillingMode;
  requiresEvaluation: boolean;
  requiresMentorAssignment: boolean;
  metadata?: {
    features?: string[];
    deliverables?: string[];        // ç”¨äº serviceSnapshot.description
    duration?: number;
  };
  snapshotAt: Date;
}

interface IServicePackageSnapshot {
  packageId: string;
  packageName: string;
  packageCode: string;
  items: IServicePackageSnapshotItem[];  // ğŸ”‘ å·²å±•å¼€çš„ services
  snapshotAt: Date;
}

interface IServicePackageSnapshotItem {
  serviceSnapshot: IServiceSnapshot;  // ğŸ”‘ å®Œæ•´çš„ service ä¿¡æ¯
  quantity: number;                   // æ•°é‡ï¼ˆæ¬¡æ•°ï¼Œæ‰€æœ‰æœåŠ¡ç»Ÿä¸€æŒ‰æ¬¡æ•°è®¡è´¹ï¼‰
  sortOrder: number;
}
```

#### 1.4.3 Contract Domain ä½¿ç”¨å¿«ç…§çš„æµç¨‹

**åˆåŒåˆ›å»ºæ—¶çš„æ•°æ®æµï¼š**

```
1. API Layer æ¥æ”¶åˆ›å»ºåˆåŒè¯·æ±‚
   â””â”€ { studentId, productId, ... }
         â”‚
         â–¼
2. Application Layer è°ƒç”¨ Catalog Domain è·å–å¿«ç…§
   â””â”€ productSnapshot = await catalogService.getProductSnapshot(productId)
         â”‚
         â–¼
3. Application Layer è°ƒç”¨ Contract Domain åˆ›å»ºåˆåŒ
   â””â”€ contract = await contractService.create({
        studentId,
        productSnapshot,  // ğŸ”‘ ä¼ å…¥å®Œæ•´å¿«ç…§
        ...
      })
         â”‚
         â–¼
4. Contract Domain æ‹†è§£å¿«ç…§æ•°æ®
   â”œâ”€ åˆ›å»º contracts è®°å½•ï¼ˆæå– price, currency, validityDaysï¼‰
   â”œâ”€ å±•å¼€ productSnapshot.items
   â”‚  â”œâ”€ type='service' â†’ æå–æœåŠ¡æƒç›Šæ•°æ®
   â”‚  â””â”€ type='service_package' â†’ éå† itemsï¼Œä¸ºæ¯ä¸ª service æå–æƒç›Šæ•°æ®
   â”œâ”€ æŒ‰ (serviceType + unit + expiresAt + source) åˆ†ç»„åˆå¹¶ï¼ˆv2.16.5 - C-NEW-6ï¼‰
   â”‚  â”œâ”€ totalQuantity: ç´¯åŠ æ‰€æœ‰æ¥æºçš„æ•°é‡
   â”‚  â”œâ”€ originItems: åˆå¹¶ä¸ºæ•°ç»„ï¼ˆä¿ç•™æ‰€æœ‰äº§å“é¡¹è¿½æº¯ä¿¡æ¯ï¼‰
   â”‚  â””â”€ serviceSnapshot: ä½¿ç”¨ç¬¬ä¸€ä¸ªäº§å“é¡¹çš„å¿«ç…§
   â””â”€ ä½¿ç”¨ ON CONFLICT DO UPDATE æ’å…¥ contract_service_entitlements
```

#### 1.4.4 å¿«ç…§æ•°æ®åˆ° Contract è¡¨çš„æ˜ å°„

| Contract Domain è¡¨/å­—æ®µ | æ¥æºå­—æ®µ | è¯´æ˜ |
|------------------------|---------|------|
| **contracts è¡¨** |
| `productId` | `productSnapshot.productId` | äº§å“å¼•ç”¨ï¼ˆä¸ä½¿ç”¨å¤–é”®ï¼‰ |
| `totalAmount` | `productSnapshot.price` | åˆåŒæ€»é¢ï¼ˆå¿«ç…§ï¼‰ |
| `currency` | `productSnapshot.currency` | å¸ç§ï¼ˆå¿«ç…§ï¼‰ |
| `validityDays` | `productSnapshot.validityDays` | æœ‰æ•ˆæœŸï¼ˆå¿«ç…§ï¼Œnull = æ°¸ä¹…æœ‰æ•ˆï¼‰ |
| `expiresAt` | è®¡ç®—ï¼š`signedAt + validityDays` | è¿‡æœŸæ—¶é—´ï¼ˆnull = æ°¸ä¹…æœ‰æ•ˆï¼‰ |
| **contract_service_entitlements è¡¨** |
| `contractId` | æ–°åˆ›å»ºçš„ `contracts.id` | å…³è”åˆåŒ |
| `serviceType` | `serviceSnapshot.serviceType` | æœåŠ¡ç±»å‹ï¼ˆæ¥è‡ª Catalogï¼‰ |
| `source` | å›ºå®šå€¼ `'product'` | æ ‡å‡†æƒç›Šæ¥æº |
| `totalQuantity` | `item.quantity * pkgItem.quantity` | æ•°é‡ï¼ˆå±•å¼€è®¡ç®—ï¼Œæ‰€æœ‰æœåŠ¡ç»Ÿä¸€æŒ‰æ¬¡æ•°è®¡è´¹ï¼‰ |
| `availableQuantity` | ç­‰äº `totalQuantity` | åˆå§‹å¯ç”¨æ•°é‡ |
| `serviceSnapshot` | æ„é€ å¿«ç…§å¯¹è±¡ | æœåŠ¡ä¿¡æ¯å¿«ç…§ï¼ˆv2.16.2 å¿…å¡«ï¼‰ |
| `expiresAt` | ç»§æ‰¿ `contracts.expiresAt` | æƒç›Šè¿‡æœŸæ—¶é—´ |

#### 1.4.5 æƒç›Šæ‹†è§£é€»è¾‘ç¤ºä¾‹

**ç¤ºä¾‹ï¼šäº§å“åŒ…å« 1 ä¸ª service + 1 ä¸ª service_package**

```typescript
// äº§å“å¿«ç…§
{
  productId: 'prod-123',
  price: '5999.00',
  validityDays: 365,
  items: [
    // Item 1: ç›´æ¥æœåŠ¡ï¼ˆç®€å†ä¿®æ”¹ 3 æ¬¡ï¼‰
    {
      type: 'service',
      quantity: 3,              // æ¬¡æ•°ï¼ˆv2.16.7ï¼šæ‰€æœ‰æœåŠ¡ç»Ÿä¸€æŒ‰æ¬¡æ•°è®¡è´¹ï¼‰
      serviceSnapshot: {
        serviceType: 'resume_review',
        serviceName: 'Resume Review',
        ...
      }
    },
    // Item 2: æœåŠ¡åŒ…ï¼ˆåŒ…å« 5 æ¬¡ 1-on-1 session + 2 æ¬¡ mock interviewï¼‰
    {
      type: 'service_package',
      quantity: 1,              // package æ•°é‡å›ºå®šä¸º 1
      servicePackageSnapshot: {
        items: [
          {
            quantity: 5,        // 5æ¬¡1å¯¹1å’¨è¯¢
            serviceSnapshot: {
              serviceType: 'one_on_one_session',
              serviceName: '1-on-1 Session (1 hour)',  // æ—¶é•¿åœ¨åç§°ä¸­è¯´æ˜
              ...
            }
          },
          {
            quantity: 2,        // 2æ¬¡æ¨¡æ‹Ÿé¢è¯•
            serviceSnapshot: {
              serviceType: 'mock_interview',
              serviceName: 'Mock Interview',
              ...
            }
          }
        ]
      }
    }
  ]
}

// æ‹†è§£åç”Ÿæˆçš„æƒç›Šè®°å½•ï¼ˆ3 æ¡ï¼Œv2.16.7ï¼šæ‰€æœ‰æ•°é‡ä»¥æ¬¡æ•°ä¸ºå•ä½ï¼‰
[
  // æ¥è‡ª Item 1ï¼ˆç›´æ¥æœåŠ¡ï¼‰
  {
    serviceType: 'resume_review',
    totalQuantity: 3,           // ç›´æ¥ä½¿ç”¨ item.quantityï¼ˆ3æ¬¡ï¼‰
    source: 'product',
    serviceSnapshot: { ... }
  },
  // æ¥è‡ª Item 2 çš„ç¬¬ 1 ä¸ª serviceï¼ˆæœåŠ¡åŒ…å±•å¼€ï¼‰
  {
    serviceType: 'one_on_one_session',
    totalQuantity: 5,           // 1 * 5 = 5ï¼ˆ5æ¬¡ï¼‰
    source: 'product',
    serviceSnapshot: { ... }
  },
  // æ¥è‡ª Item 2 çš„ç¬¬ 2 ä¸ª serviceï¼ˆæœåŠ¡åŒ…å±•å¼€ï¼‰
  {
    serviceType: 'mock_interview',
    totalQuantity: 2,           // 1 * 2 = 2ï¼ˆ2æ¬¡ï¼‰
    source: 'product',
    serviceSnapshot: { ... }
  }
]
```

#### 1.4.6 ä¸è®¾è®¡æ–‡æ¡£å…¶ä»–éƒ¨åˆ†çš„å…³ç³»

æœ¬ç« èŠ‚æè¿°çš„å¿«ç…§æœºåˆ¶ç›´æ¥å½±å“ä»¥ä¸‹è®¾è®¡ï¼š

- **4.2 ContractService - åˆåŒç®¡ç†æœåŠ¡**
  - `create()` æ–¹æ³•æ¥æ”¶ `CreateContractDto`ï¼Œå…¶ä¸­åŒ…å« `productSnapshot` å­—æ®µ
  - å†…éƒ¨è°ƒç”¨ `deriveEntitlementsFromSnapshot()` æ‹†è§£å¿«ç…§

- **5.1 Contract DTOs - CreateContractDto**
  - æ–°å¢ `productSnapshot: IProductSnapshot` å­—æ®µï¼ˆå¿…å¡«ï¼‰
  - ç§»é™¤åŸ `productId` å­—æ®µï¼ˆæ”¹ä¸ºä»å¿«ç…§ä¸­æå–ï¼‰

- **6.1.1 åˆ›å»ºåˆåŒä¸šåŠ¡è§„åˆ™**
  - æ­¥éª¤ 1ï¼šéªŒè¯äº§å“å¿«ç…§å®Œæ•´æ€§ï¼ˆä¸å†éœ€è¦æŸ¥è¯¢ Catalog Domainï¼‰
  - æ­¥éª¤ 6ï¼šä»å¿«ç…§æ´¾ç”ŸæœåŠ¡æƒç›Šï¼ˆéå† `productSnapshot.items`ï¼‰

---

## 2. æ ¸å¿ƒæ¦‚å¿µä¸æ¶æ„

### 2.1 æ ¸å¿ƒæ¦‚å¿µ

#### 2.1.1 Contractï¼ˆåˆåŒï¼‰

**å®šä¹‰ï¼š** åˆåŒæ˜¯å­¦ç”Ÿä¸å¹³å°ç­¾è®¢çš„æœåŠ¡è´­ä¹°åè®®ï¼ŒåŸºäºäº§å“ï¼ˆProductï¼‰åˆ›å»ºï¼ŒåŒ…å«æœåŠ¡æƒç›Šå’Œè´¢åŠ¡ä¿¡æ¯ã€‚

**ç‰¹ç‚¹ï¼š**

- **åŸºäºäº§å“åˆ›å»º**ï¼šåˆåŒå¼•ç”¨ Catalog Domain çš„äº§å“
- **ç­¾çº¦æ—¶ä¸ç¡®å®šå¯¼å¸ˆ**ï¼šå¯¼å¸ˆåœ¨é¢„çº¦æœåŠ¡æ—¶æ‰ç¡®å®š
- **åŒ…å«è´¢åŠ¡ä¿¡æ¯**ï¼šæ€»é¢ã€å·²ä»˜é‡‘é¢ã€å¸ç§ã€æœ‰æ•ˆæœŸ
- **çŠ¶æ€æµè½¬**ï¼šdraft â†’ active â†’ completed/terminated/suspended

**åˆåŒçŠ¶æ€ï¼ˆContract Statusï¼‰ï¼š**

```typescript
enum ContractStatus {
  DRAFT = 'draft',           // è‰ç¨¿ï¼ˆæœªæ”¯ä»˜ï¼‰
  ACTIVE = 'active',         // ç”Ÿæ•ˆä¸­ï¼ˆå·²æ”¯ä»˜é¦–ä»˜ï¼ŒæœåŠ¡å¯ç”¨ï¼‰
  COMPLETED = 'completed',   // å·²å®Œæˆï¼ˆæœåŠ¡å·²æ¶ˆè´¹å®Œæ¯•æˆ–è¿‡æœŸï¼‰
  TERMINATED = 'terminated', // å·²ç»ˆæ­¢ï¼ˆæå‰ç»ˆæ­¢åˆåŒï¼‰
  SUSPENDED = 'suspended',   // å·²æš‚åœï¼ˆä¸´æ—¶æš‚åœæœåŠ¡ï¼‰
}
```

**å…³é”®å­—æ®µï¼š**

- `productId`: å¼•ç”¨çš„äº§å“IDï¼ˆæ¥è‡ª Catalog Domainï¼‰
- `totalAmount`: åˆåŒæ€»é¢ï¼ˆç¾å…ƒï¼‰
- `paidAmount`: å·²æ”¯ä»˜é‡‘é¢ï¼ˆç¾å…ƒï¼‰
- `validityDays`: æœåŠ¡æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰
- `expiresAt`: è¿‡æœŸæ—¶é—´ï¼ˆè®¡ç®—ï¼šsignedAt + validityDaysï¼‰

#### 2.1.2 Contract Service Entitlementï¼ˆåˆåŒæœåŠ¡æƒç›Šï¼‰

**å®šä¹‰ï¼š** æœåŠ¡æƒç›Šæ˜¯åˆåŒä¸­åŒ…å«çš„å„ç±»æœåŠ¡çš„æ•°é‡å’Œä½¿ç”¨æƒ…å†µè®°å½•ã€‚

**ç‰¹ç‚¹ï¼š**

- **æŒ‰æœåŠ¡ç±»å‹ç®¡ç†**ï¼šæ¯ç§æœåŠ¡ç±»å‹ç‹¬ç«‹ç®¡ç†ä½™é¢
- **ä¸‰ç§ä½™é¢çŠ¶æ€**ï¼šæ€»é‡ï¼ˆtotalï¼‰ã€å·²æ¶ˆè´¹ï¼ˆconsumedï¼‰ã€é¢„å ä¸­ï¼ˆheldï¼‰
- **å¯ç”¨ä½™é¢è®¡ç®—**ï¼šavailable = total - consumed - held
- **v2.16 æ–°å¢**ï¼šåŒºåˆ†æƒç›Šæ¥æºï¼ˆäº§å“æ ‡å‡† vs é¢å¤–æ·»åŠ ï¼‰

**æƒç›Šæ¥æºï¼ˆEntitlement Sourceï¼‰ï¼š**

```typescript
enum EntitlementSource {
  PRODUCT = 'product',           // æ¥è‡ªäº§å“å®šä¹‰ï¼ˆæ ‡å‡†æƒç›Šï¼‰
  ADDON = 'addon',              // é¢å¤–æ·»åŠ ï¼ˆä¿ƒæˆç­¾çº¦ï¼‰
  PROMOTION = 'promotion',      // ä¿ƒé”€æ´»åŠ¨èµ é€
  COMPENSATION = 'compensation', // è¡¥å¿ï¼ˆæœåŠ¡è´¨é‡é—®é¢˜ã€ç³»ç»Ÿæ•…éšœç­‰ï¼‰
}
```

**ä½™é¢ç®¡ç†å…¬å¼ï¼š**

```
availableQuantity = totalQuantity - consumedQuantity - heldQuantity

- totalQuantity: è´­ä¹°æ€»é‡
- consumedQuantity: å·²æ¶ˆè´¹ï¼ˆæœåŠ¡å®Œæˆï¼‰
- heldQuantity: é¢„ç•™ä¸­ï¼ˆå·²é¢„çº¦æœªå®Œæˆï¼‰
- availableQuantity: å¯ç”¨ï¼ˆå¯ä»¥é¢„çº¦ï¼‰
```

**ç¤ºä¾‹ï¼š**

```
å­¦ç”Ÿè´­ä¹°äº§å“ï¼šåŒ…å« 5 æ¬¡ç®€å†ä¿®æ”¹

åˆå§‹çŠ¶æ€ï¼š
- totalQuantity = 5
- consumedQuantity = 0
- heldQuantity = 0
- availableQuantity = 5

é¢„çº¦æœåŠ¡åï¼š
- totalQuantity = 5
- consumedQuantity = 0
- heldQuantity = 1  ï¼ˆé¢„å 1æ¬¡ï¼‰
- availableQuantity = 4

æœåŠ¡å®Œæˆåï¼š
- totalQuantity = 5
- consumedQuantity = 1  ï¼ˆå®Œæˆ1æ¬¡ï¼‰
- heldQuantity = 0  ï¼ˆé‡Šæ”¾é¢„å ï¼‰
- availableQuantity = 4
```

#### 2.1.3 Service Ledgerï¼ˆæœåŠ¡æµæ°´ï¼‰

**å®šä¹‰ï¼š** æœåŠ¡æµæ°´æ˜¯å­¦ç”ŸæœåŠ¡æ¶ˆè´¹å’Œè°ƒæ•´çš„å®Œæ•´è¿½è¸ªè®°å½•ï¼Œé‡‡ç”¨ Append-only æ¨¡å¼ã€‚

**æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼š**

1. **Append-only**ï¼šåªèƒ½ INSERTï¼Œç¦æ­¢ UPDATE/DELETE
2. **æ­£è´Ÿæ•°è®°è´¦**ï¼šquantity å¯æ­£å¯è´Ÿï¼Œä½† balanceAfter å¿…é¡» >= 0
3. **ä½™é¢å¿«ç…§**ï¼šæ¯æ¬¡æ“ä½œè®°å½• balanceAfterï¼Œä¾¿äºå¯¹è´¦å®¡è®¡
4. **å†·çƒ­åˆ†ç¦»**ï¼šå®šæœŸå½’æ¡£å†å²æ•°æ®åˆ° service_ledgers_archive

**æµæ°´ç±»å‹ï¼ˆService Ledger Typeï¼‰ï¼š**

```typescript
enum ServiceLedgerType {
  CONSUMPTION = 'consumption',   // æœåŠ¡æ¶ˆè´¹ï¼ˆquantity < 0ï¼‰
  REFUND = 'refund',            // é€€æ¬¾å¢åŠ ï¼ˆquantity > 0ï¼‰
  ADJUSTMENT = 'adjustment',    // æ‰‹åŠ¨è°ƒæ•´ï¼ˆquantity å¯æ­£å¯è´Ÿï¼‰
  INITIAL = 'initial',          // åˆå§‹åŒ–ï¼ˆquantity > 0ï¼‰
  EXPIRATION = 'expiration',    // è¿‡æœŸæ‰£å‡ï¼ˆquantity < 0ï¼‰
}
```

**æµæ°´æ¥æºï¼ˆService Ledger Sourceï¼‰ï¼š**

```typescript
enum ServiceLedgerSource {
  BOOKING_COMPLETED = 'booking_completed',    // é¢„çº¦å®Œæˆ
  BOOKING_CANCELLED = 'booking_cancelled',    // é¢„çº¦å–æ¶ˆ
  CONTRACT_SIGNED = 'contract_signed',        // åˆåŒç­¾çº¦
  MANUAL_ADJUSTMENT = 'manual_adjustment',    // æ‰‹åŠ¨è°ƒæ•´
  AUTO_EXPIRATION = 'auto_expiration',        // è‡ªåŠ¨è¿‡æœŸ
}
```

**å…³é”®å­—æ®µï¼š**

- `quantity`: æ•°é‡å˜åŒ–ï¼ˆè´Ÿæ•°=æ¶ˆè´¹ï¼Œæ­£æ•°=å¢åŠ ï¼‰
- `balanceAfter`: æ“ä½œåä½™é¢ï¼ˆå¿«ç…§ï¼Œç”¨äºå¯¹è´¦ï¼‰
- `type`: æµæ°´ç±»å‹
- `source`: æµæ°´æ¥æº
- `reason`: è°ƒæ•´åŸå› ï¼ˆmanual_adjustment æ—¶å¿…å¡«ï¼‰

#### 2.1.4 Service Holdï¼ˆæœåŠ¡é¢„å ï¼‰

**å®šä¹‰ï¼š** æœåŠ¡é¢„å æ˜¯é˜²æ­¢è¶…é¢é¢„çº¦çš„ä¸´æ—¶é”ï¼Œéœ€äººå·¥æ“ä½œé‡Šæ”¾ï¼ˆv2.16.9ï¼šç§»é™¤TTLè¿‡æœŸæœºåˆ¶ï¼‰ã€‚

**ç‰¹ç‚¹ï¼š**

- **æ‰‹åŠ¨é‡Šæ”¾**ï¼šå¿…é¡»é€šè¿‡ releaseHold() æˆ– cancelHold() é‡Šæ”¾ï¼ˆv2.16.9ï¼‰
- **æ°¸ä¸è¿‡æœŸ**ï¼šæ— è‡ªåŠ¨è¿‡æœŸæœºåˆ¶ï¼Œå‡å°‘ç³»ç»Ÿå¤æ‚åº¦
- **çŠ¶æ€ç®¡ç†**ï¼šactiveï¼ˆç”Ÿæ•ˆä¸­ï¼‰ã€releasedï¼ˆå·²é‡Šæ”¾ï¼‰ã€cancelledï¼ˆå·²å–æ¶ˆï¼‰
- **ç²’åº¦æ§åˆ¶**ï¼šæŒ‰æœåŠ¡ç±»å‹é¢„å ï¼Œä¸æ¶‰åŠå…·ä½“å¯¼å¸ˆæ—¶é—´æ®µ

**é¢„å çŠ¶æ€ï¼ˆHold Statusï¼‰ï¼š**

```typescript
enum HoldStatus {
  ACTIVE = 'active',       // ç”Ÿæ•ˆä¸­ï¼ˆæœªé‡Šæ”¾ï¼‰
  RELEASED = 'released',   // å·²é‡Šæ”¾ï¼ˆæœåŠ¡å®Œæˆæˆ–ç®¡ç†å‘˜æ‰‹åŠ¨é‡Šæ”¾ï¼‰
  CANCELLED = 'cancelled', // å·²å–æ¶ˆï¼ˆç”¨æˆ·å–æ¶ˆé¢„çº¦ï¼‰
}
```

**é¢„å æµç¨‹ï¼ˆv2.16.9ï¼‰ï¼š**

```
1. å­¦ç”Ÿé€‰æ‹©æœåŠ¡ â†’ æ£€æŸ¥å¯ç”¨ä½™é¢
2. åˆ›å»ºé¢„å è®°å½• â†’ heldQuantity += 1, availableQuantity -= 1ï¼ˆæ°¸ä¸è¿‡æœŸï¼‰
3. æœåŠ¡ç¡®è®¤ â†’ é‡Šæ”¾é¢„å  â†’ ç”Ÿæˆæ¶ˆè´¹æµæ°´
4. æˆ–ç”¨æˆ·å–æ¶ˆ â†’ å–æ¶ˆé¢„å  â†’ é‡Šæ”¾æƒç›Š

æ³¨ï¼šv2.16.9 ç§»é™¤äº† TTL æœºåˆ¶ï¼Œé¢„å ä¸ä¼šè‡ªåŠ¨è¿‡æœŸ
```

### 2.2 æ¶æ„è®¾è®¡

#### 2.2.1 æ ¸å¿ƒæ¨¡å—æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Contract Domain æ¶æ„                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: Contract Managementï¼ˆåˆåŒç®¡ç†å±‚ï¼‰                  â”‚
â”‚  - ContractService: åˆåŒCRUDã€çŠ¶æ€æµè½¬                       â”‚
â”‚  - ContractEntitlementService: æƒç›Šç®¡ç†                      â”‚
â”‚  - å‘å¸ƒäº‹ä»¶ï¼šcontract.signed, contract.activated            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ ç®¡ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: Service Ledgerï¼ˆæœåŠ¡æµæ°´å±‚ï¼‰                       â”‚
â”‚  - ServiceLedgerService: æµæ°´è®°å½•ï¼ˆAppend-onlyï¼‰             â”‚
â”‚  - ServiceLedgerArchiveService: å½’æ¡£ç®¡ç†                     â”‚
â”‚  - æä¾›ä½™é¢å¯¹è´¦å’Œå®¡è®¡åŠŸèƒ½                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ æ”¯æ’‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: Service Holdï¼ˆæœåŠ¡é¢„å å±‚ï¼‰                         â”‚
â”‚  - ServiceHoldService: é¢„å ç®¡ç†ï¼ˆTTLæœºåˆ¶ï¼‰                   â”‚
â”‚  - å®šæ—¶ä»»åŠ¡æ¸…ç†è¿‡æœŸé¢„å                                        â”‚
â”‚  - è®¡ç®—å¯ç”¨ä½™é¢ï¼ˆæ€»ä½™é¢ - æ´»è·ƒé¢„å ï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2.2 æ•°æ®æµå‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¡¾é—®/å­¦ç”Ÿ     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. åˆ›å»ºåˆåŒï¼ˆåŸºäºäº§å“ï¼‰
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Contract         â”‚  â”€â”€â”€â”€â”€â”€â” å‘å¸ƒ contract.signed
â”‚ (draft)          â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
       â”‚ 2. ç›‘å¬ payment.succeeded    â”‚
       â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Contract         â”‚          â”‚ Event Bus   â”‚
â”‚ (active)         â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. åˆå§‹åŒ–æœåŠ¡æƒç›Š
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ContractServiceEntitlement â”‚
â”‚ - resume_review: 3 æ¬¡    â”‚
â”‚ - session: 5 æ¬¡          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. å­¦ç”Ÿé¢„çº¦æœåŠ¡
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ServiceHold            â”‚
â”‚ - quantity: 1          â”‚
â”‚ - expiresAt: +15min    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 5. æœåŠ¡å®Œæˆï¼ˆç›‘å¬ session.completedï¼‰
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ServiceLedger          â”‚
â”‚ - quantity: -1         â”‚
â”‚ - balanceAfter: 2      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2.3 æœåŠ¡æƒç›Šç”Ÿå‘½å‘¨æœŸ

```
ç­¾çº¦é˜¶æ®µï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1. ä» Product æ´¾ç”Ÿæ ‡å‡†æƒç›Š                         â”‚
  â”‚    - æŸ¥è¯¢ product_items                           â”‚
  â”‚    - å±•å¼€ service_packages                        â”‚
  â”‚    - åˆ›å»º contract_service_entitlements          â”‚
  â”‚    - source = 'product'                          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 2. å¯é€‰ï¼šæ·»åŠ é¢å¤–æƒç›Š                              â”‚
  â”‚    - ä¿ƒæˆç­¾çº¦ï¼šé¢å¤–èµ é€æœåŠ¡                        â”‚
  â”‚    - ä¿ƒé”€æ´»åŠ¨ï¼šé™æ—¶èµ é€                            â”‚
  â”‚    - è¡¥å¿ï¼šæœåŠ¡è´¨é‡é—®é¢˜è¡¥å¿                        â”‚
  â”‚    - source = 'addon' | 'promotion' | 'compensation' â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½¿ç”¨é˜¶æ®µï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 3. é¢„çº¦æœåŠ¡ï¼ˆåˆ›å»ºé¢„å ï¼‰                            â”‚
  â”‚    - æ£€æŸ¥ availableQuantity >= 1                  â”‚
  â”‚    - åˆ›å»º ServiceHoldï¼ˆTTL 15åˆ†é’Ÿï¼‰               â”‚
  â”‚    - heldQuantity += 1, availableQuantity -= 1   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 4. æœåŠ¡å®Œæˆï¼ˆé‡Šæ”¾é¢„å ï¼Œç”Ÿæˆæµæ°´ï¼‰                   â”‚
  â”‚    - é‡Šæ”¾ ServiceHold                             â”‚
  â”‚    - heldQuantity -= 1, consumedQuantity += 1    â”‚
  â”‚    - åˆ›å»º ServiceLedger (quantity = -1)          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 5. å®šæœŸå½’æ¡£ï¼ˆå†·çƒ­åˆ†ç¦»ï¼‰                            â”‚
  â”‚    - å½’æ¡£ 90 å¤©å‰æµæ°´åˆ° service_ledgers_archive   â”‚
  â”‚    - ä¸»è¡¨ä¿æŒæ€§èƒ½                                  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 æ ¸å¿ƒè¡¨ç»“æ„

Contract Domain åŒ…å« 8 å¼ æ ¸å¿ƒè¡¨ï¼š

| è¡¨å                                | ç±»å‹   | èŒè´£                   |
| ----------------------------------- | ------ | ---------------------- |
| `contracts`                        | å®ä½“è¡¨ | åˆåŒå®šä¹‰               |
| `contract_service_entitlements`    | å®ä½“è¡¨ | åˆåŒæœåŠ¡æƒç›Šä½™é¢       |
| `contract_entitlement_revisions`   | å†å²è¡¨ | æƒç›Šå˜æ›´ä¿®è®¢å†å² ğŸ†•     |
| `service_ledgers`                  | æµæ°´è¡¨ | æœåŠ¡æ¶ˆè´¹æµæ°´ï¼ˆAppend-onlyï¼‰ |
| `service_holds`                    | å®ä½“è¡¨ | æœåŠ¡é¢„å ï¼ˆTTLæœºåˆ¶ï¼‰     |
| `domain_events`                    | äº‹ä»¶è¡¨ | é¢†åŸŸäº‹ä»¶å‘ä»¶ç®±ï¼ˆOutboxï¼‰ |
| `service_ledgers_archive`          | å½’æ¡£è¡¨ | å†å²æµæ°´å½’æ¡£           |
| `service_ledger_archive_policies`  | é…ç½®è¡¨ | å½’æ¡£ç­–ç•¥é…ç½®           |

#### 3.1.1 è¡¨å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   contracts     â”‚â”€â”€producesâ”€â”€â†’ â”‚  domain_events   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        (äº‹ä»¶å‘ä»¶ç®±)
         â”‚ 1:N
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                  â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚contract_service_entitlementsâ”‚  â”‚  service_ledgers   â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                  â”‚
    â”‚ 1:N ä¿®è®¢å†å²                      â”‚ å½’æ¡£
    â”‚ â†“                                 â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚contract_entitlement_revisionsâ”‚       â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
    â”‚ æ”¯æŒé¢„å                           â”‚
    â”‚                                  â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ service_holds    â”‚           â”‚service_ledgers_archiveâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â”‚ é…ç½®
                                        â”‚
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚service_ledger_archive_policiesâ”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 è¯¦ç»† Schema è®¾è®¡

#### 3.2.1 contractsï¼ˆåˆåŒè¡¨ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `src/database/schema/contracts.schema.ts`

**èŒè´£ï¼š** ç®¡ç†åˆåŒå…¨ç”Ÿå‘½å‘¨æœŸï¼Œè®°å½•åˆåŒåŸºæœ¬ä¿¡æ¯ã€è´¢åŠ¡ä¿¡æ¯å’ŒçŠ¶æ€

```typescript
import { pgTable, uuid, varchar, integer, timestamp, text, json, numeric, pgEnum } from 'drizzle-orm/pg-core';
import { users } from './users.schema';

// åˆåŒçŠ¶æ€æšä¸¾
export const contractStatusEnum = pgEnum('contract_status', [
  'draft',       // è‰ç¨¿ï¼ˆåˆåŒå·²åˆ›å»ºä½†å°šæœªç­¾ç½²ï¼‰
  'signed',      // å·²ç­¾ç½²ï¼ˆåˆåŒå·²ç­¾ç½²ï¼Œç­‰å¾…æ¿€æ´»ï¼‰
  'active',      // ç”Ÿæ•ˆä¸­ï¼ˆåˆåŒå·²æ¿€æ´»ï¼Œå¯æ¶ˆè´¹æœåŠ¡ï¼‰
  'suspended',   // å·²æš‚åœï¼ˆä¸´æ—¶æš‚åœæœåŠ¡ï¼‰
  'completed',   // å·²å®Œæˆï¼ˆæœåŠ¡å·²æ¶ˆè´¹å®Œæ¯•æˆ–è¿‡æœŸï¼‰
  'terminated',  // å·²ç»ˆæ­¢ï¼ˆæå‰ç»ˆæ­¢åˆåŒï¼‰
]);

export const contracts = pgTable('contracts', {
  id: uuid('id').defaultRandom().primaryKey(),

  // å…³è”æ–¹
  studentId: uuid('student_id').notNull().references(() => users.id),
  counselorId: uuid('counselor_id').references(() => users.id), // è´Ÿè´£é¡¾é—®
  // æ³¨æ„ï¼šç­¾çº¦æ—¶ä¸ç¡®å®šå¯¼å¸ˆï¼Œå¯¼å¸ˆåœ¨çº¦è¯¾æ—¶æ‰ç¡®å®šï¼ˆåœ¨sessionsè¡¨ä¸­å…³è”ï¼‰

  // åˆåŒä¿¡æ¯
  contractNumber: varchar('contract_number', { length: 100 }).notNull().unique(),
  title: varchar('title', { length: 500 }),
  description: text('description'),

  // å…³è”äº§å“ï¼ˆå¿…å¡«ï¼‰- å¼•ç”¨ Catalog Domain
  // v2.16.4 å†³ç­– C6: DDD é˜²è…å±‚ï¼ˆAnti-Corruption Layerï¼‰
  // v2.16.4 å†³ç­– I3: åˆåŒä¸äº§å“ä¸€å¯¹ä¸€å…³ç³»
  productId: uuid('product_id').notNull(), // Reference only, no FK constraint
  // åŸŸéš”ç¦»åŸåˆ™ï¼š
  // - Contract Domain does NOT import Catalog Domain schemas
  // - productId is stored as UUID reference for isolation
  // - Product validation happens at Application Layer via CatalogService
  // - NO foreign key constraint to Catalog Domain tables
  // ä¸šåŠ¡çº¦æŸï¼š
  // - æ¯ä¸ªåˆåŒä»…èƒ½ç»‘å®šä¸€ä¸ªäº§å“ï¼ˆä¸€å¯¹ä¸€å…³ç³»ï¼‰
  // - åˆåŒåˆ›å»ºåä¸å¯æ›´æ¢äº§å“
  // - äº§å“ä¿¡æ¯é€šè¿‡ productSnapshot (JSON) å›ºåŒ–

  // è´¢åŠ¡ä¿¡æ¯
  totalAmount: numeric('total_amount', { precision: 12, scale: 2 }).notNull(), // åˆåŒæ€»é¢ï¼ˆç¾å…ƒï¼‰
  paidAmount: numeric('paid_amount', { precision: 12, scale: 2 }).notNull().default('0'), // å·²æ”¯ä»˜é‡‘é¢ï¼ˆç¾å…ƒï¼‰
  currency: varchar('currency', { length: 3 }).notNull().default('USD'), // åˆåŒçº¦å®šä»·ç»Ÿä¸€ä½¿ç”¨ç¾å…ƒ

  // æœ‰æ•ˆæœŸï¼ˆä»äº§å“å¤åˆ¶è€Œæ¥ï¼Œnull = æ°¸ä¹…æœ‰æ•ˆï¼‰
  validityDays: integer('validity_days'), // æœåŠ¡æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰ï¼Œnull = æ°¸ä¹…æœ‰æ•ˆ

  // çŠ¶æ€
  status: contractStatusEnum('status').notNull().default('draft'), // é»˜è®¤ä¸º draftï¼Œè°ƒç”¨ sign() åå˜ä¸º signedï¼Œæ”¯ä»˜æˆåŠŸå activate() å˜ä¸º active

  // æ—¶é—´
  signedAt: timestamp('signed_at', { withTimezone: true }),
  effectiveAt: timestamp('effective_at', { withTimezone: true }),
  expiresAt: timestamp('expires_at', { withTimezone: true }), // è®¡ç®—ï¼šsignedAt + validityDaysï¼Œnull = æ°¸ä¹…æœ‰æ•ˆ

  // å…ƒæ•°æ®
  metadata: json('metadata').$type<{
    pdfUrl?: string;
    attachments?: string[];
    terms?: Record<string, any>;
  }>(),

  // å®¡è®¡å­—æ®µ
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
  createdBy: uuid('created_by').references(() => users.id),
  terminatedAt: timestamp('terminated_at', { withTimezone: true }),
  terminationReason: text('termination_reason'),
});

// ç´¢å¼•
// CREATE INDEX idx_contracts_student ON contracts(student_id);
// CREATE INDEX idx_contracts_counselor ON contracts(counselor_id);
// CREATE INDEX idx_contracts_status ON contracts(status);
// CREATE INDEX idx_contracts_product ON contracts(product_id);

// çº¦æŸ
// ALTER TABLE contracts ADD CONSTRAINT chk_paid_amount_not_exceed_total
// CHECK (paid_amount <= total_amount);
//
// ALTER TABLE contracts ADD CONSTRAINT chk_total_amount_positive
// CHECK (total_amount > 0);
//
// ALTER TABLE contracts ADD CONSTRAINT chk_expires_after_effective
// CHECK (expires_at IS NULL OR expires_at >= effective_at);
```

**ä¸šåŠ¡è§„åˆ™ï¼š**

1. **å”¯ä¸€çº¦æŸ**ï¼š`contractNumber` å…¨å±€å”¯ä¸€
2. **é‡‘é¢çº¦æŸ**ï¼š`paidAmount <= totalAmount`ï¼Œ`totalAmount > 0`
3. **æ—¶é—´çº¦æŸ**ï¼š`expiresAt >= effectiveAt`ï¼ˆå½“ä¸¤è€…éƒ½ä¸ä¸º null æ—¶ï¼‰
4. **äº§å“å¼•ç”¨**ï¼šä¸ä½¿ç”¨å¤–é”®ï¼Œé€šè¿‡æœåŠ¡è°ƒç”¨ Catalog Domain
5. **æ°¸ä¹…æœ‰æ•ˆåˆåŒ**ï¼š
   - `validityDays = null` è¡¨ç¤ºåˆåŒæ°¸ä¹…æœ‰æ•ˆ
   - `expiresAt = null` è¡¨ç¤ºåˆåŒæ°¸ä¹…æœ‰æ•ˆ
   - æ°¸ä¹…æœ‰æ•ˆåˆåŒä¸ä¼šè‡ªåŠ¨å®Œæˆï¼ˆä¸ä¼šå˜ä¸º completed çŠ¶æ€ï¼‰
   - æ°¸ä¹…æœ‰æ•ˆåˆåŒçš„æœåŠ¡æƒç›Šä¹Ÿæ°¸ä¹…æœ‰æ•ˆï¼ˆ`expiresAt = null`ï¼‰

#### 3.2.2 contract_service_entitlementsï¼ˆåˆåŒæœåŠ¡æƒç›Šä½™é¢è¡¨ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `src/database/schema/contract-service-entitlements.schema.ts`

**èŒè´£ï¼š** ç®¡ç†åˆåŒä¸­åŒ…å«çš„æœåŠ¡æƒç›Šä½™é¢ï¼Œæ”¯æŒé¢å¤–æƒç›Šæ·»åŠ ï¼ˆv2.16ï¼‰

```typescript
import { pgTable, uuid, varchar, integer, timestamp, text, pgEnum } from 'drizzle-orm/pg-core';
import { contracts } from './contracts.schema';
import { serviceTypeEnum } from './enums/service-type.enum';

// æƒç›Šæ¥æºæšä¸¾ ğŸ†•v2.16
export const entitlementSourceEnum = pgEnum('entitlement_source', [
  'product',       // æ¥è‡ªäº§å“å®šä¹‰ï¼ˆæ ‡å‡†æƒç›Šï¼‰
  'addon',         // é¢å¤–æ·»åŠ ï¼ˆä¿ƒæˆç­¾çº¦ï¼‰
  'promotion',     // ä¿ƒé”€æ´»åŠ¨èµ é€
  'compensation',  // è¡¥å¿ï¼ˆæœåŠ¡è´¨é‡é—®é¢˜ã€ç³»ç»Ÿæ•…éšœç­‰ï¼‰
]);

// äº§å“é¡¹ç±»å‹ï¼ˆv2.16.4 - ä¸ Catalog Domain ä¿æŒä¸€è‡´ï¼‰
export type ProductItemType = 'service' | 'service_package';

export const contractServiceEntitlements = pgTable('contract_service_entitlements', {
  id: uuid('id').defaultRandom().primaryKey(),

  // å…³è”åˆåŒ
  contractId: uuid('contract_id').notNull().references(() => contracts.id),
  serviceType: serviceTypeEnum('service_type').notNull(),

  // ğŸ†• æƒç›Šæ¥æºè¿½æº¯ï¼ˆv2.16ï¼‰
  source: entitlementSourceEnum('source').notNull().default('product'),

  // ğŸ†• æ¥æºè¿½æº¯ï¼ˆv2.16.4 - JSON æ ¼å¼ï¼Œæ”¯æŒå¤šæ¥æºåˆå¹¶ï¼‰
  originItems: json('origin_items').$type<Array<{
    productItemIndex: number;           // åœ¨ productSnapshot.items ä¸­çš„ç´¢å¼•
    productItemType: ProductItemType;   // v2.16.4: ä½¿ç”¨ç±»å‹åˆ«åï¼ˆå†³ç­– C4ï¼‰
    referenceId: string;                // service_id æˆ– package_idï¼ˆæ¥è‡ªå¿«ç…§ï¼‰
    referenceName: string;              // service_name æˆ– package_name
    quantity: number;                   // æ­¤ item è´¡çŒ®çš„æ•°é‡
    packageItemIndex?: number;          // å¦‚æœæ¥è‡ª packageï¼Œåœ¨ package.items ä¸­çš„ç´¢å¼•
  }>>(),  // source='product' æ—¶å¿…å¡«

  // ğŸ†• é¢å¤–æ·»åŠ åŸå› ï¼ˆsource='addon'/'compensation' æ—¶å¿…å¡«ï¼‰
  addOnReason: text('add_on_reason'),

  // æœåŠ¡æƒç›Šä½™é¢ï¼ˆä»¥æ¬¡æ•°ä¸ºå•ä½ï¼Œv2.16.7ï¼šæ‰€æœ‰æœåŠ¡ç»Ÿä¸€æŒ‰æ¬¡æ•°è®¡è´¹ï¼‰
  totalQuantity: integer('total_quantity').notNull(), // è´­ä¹°æ€»é‡ï¼ˆæ¬¡æ•°ï¼‰
  consumedQuantity: integer('consumed_quantity').notNull().default(0), // å·²æ¶ˆè´¹ï¼ˆæœåŠ¡å®Œæˆï¼‰
  heldQuantity: integer('held_quantity').notNull().default(0), // é¢„ç•™ä¸­ï¼ˆå·²é¢„çº¦æœªå®Œæˆï¼‰
  availableQuantity: integer('available_quantity').notNull(), // å¯ç”¨ = total - consumed - held

  // ğŸ†• æœåŠ¡ä¿¡æ¯å¿«ç…§ï¼ˆv2.16.4 - å¢å¼ºä¸šåŠ¡å­—æ®µï¼Œä»… product æ¥æºå¿…å¡«ï¼‰
  serviceSnapshot: json('service_snapshot').$type<{
    serviceName: string;           // æœåŠ¡åç§°ï¼ˆä¸­æ–‡ï¼‰
    serviceNameEn: string;         // æœåŠ¡åç§°ï¼ˆè‹±æ–‡ï¼‰
    description?: string;          // æœåŠ¡æè¿°
    category?: string;             // æœåŠ¡åˆ†ç±»
    // v2.16.4 æ–°å¢ï¼šä¿ç•™ä¸šåŠ¡å­—æ®µï¼ˆå†³ç­– #3ï¼‰
    billingMode?: string;          // è®¡è´¹æ¨¡å¼ï¼ˆ'fixed' | 'hourly'ï¼‰
    requiresEvaluation?: boolean;  // æ˜¯å¦éœ€è¦è¯„ä¼°
    requiresMentorAssignment?: boolean; // æ˜¯å¦éœ€è¦åˆ†é…å¯¼å¸ˆ
    snapshotAt: string;            // å¿«ç…§æ—¶é—´ï¼ˆISO 8601ï¼‰
  }>(),  // v2.16.4: æ”¹ä¸ºå¯é€‰ï¼Œä»… source='product' æ—¶å¿…å¡«

  // è¿‡æœŸæ—¶é—´ï¼ˆç»Ÿä¸€ç»§æ‰¿åˆåŒè¿‡æœŸæ—¶é—´ - v2.16.4 å†³ç­– #1ï¼‰
  expiresAt: timestamp('expires_at', { withTimezone: true }),

  // å®¡è®¡å­—æ®µ
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
  createdBy: uuid('created_by').references(() => users.id),
  notes: text('notes'),
});

// ç´¢å¼•
// CREATE INDEX idx_contract_service_entitlements_contract ON contract_service_entitlements(contract_id);
// CREATE INDEX idx_contract_service_entitlements_type ON contract_service_entitlements(service_type);
// CREATE INDEX idx_contract_service_entitlements_source ON contract_service_entitlements(source);
// CREATE INDEX idx_contract_service_entitlements_expires_at ON contract_service_entitlements(expires_at);

// v2.16.7: æ·»åŠ å”¯ä¸€çº¦æŸï¼ˆç§»é™¤ unit å­—æ®µï¼‰
// ç¡®ä¿åŒä¸€åˆåŒçš„ç›¸åŒæœåŠ¡ç±»å‹ï¼ˆæŒ‰ serviceType + expiresAt + sourceï¼‰åªæœ‰ä¸€æ¡è®°å½•
// ALTER TABLE contract_service_entitlements ADD CONSTRAINT uq_entitlement_key
// UNIQUE (contract_id, service_type, expires_at, source);
//
// è¯´æ˜ï¼š
// - ç›¸åŒ serviceType çš„å¤šä¸ªäº§å“é¡¹ä¼šåˆå¹¶ä¸ºä¸€æ¡è®°å½•
// - originItems æ•°ç»„ä¿ç•™æ‰€æœ‰æ¥æºè¿½æº¯ä¿¡æ¯
// - ä½¿ç”¨ ON CONFLICT DO UPDATE å¤„ç†å¹¶å‘æ’å…¥

// çº¦æŸï¼šå¯ç”¨æ•°é‡å¿…é¡» >= 0
// ALTER TABLE contract_service_entitlements ADD CONSTRAINT chk_available_quantity
// CHECK (available_quantity >= 0);
//
// ALTER TABLE contract_service_entitlements ADD CONSTRAINT chk_quantity_consistency
// CHECK (available_quantity = total_quantity - consumed_quantity - held_quantity);

// ğŸ†• çº¦æŸï¼šsource='addon' æˆ– 'compensation' æ—¶ï¼ŒaddOnReason å¿…å¡«ï¼ˆv2.16ï¼‰
// ALTER TABLE contract_service_entitlements ADD CONSTRAINT chk_addon_reason CHECK (
//   (source NOT IN ('addon', 'compensation')) OR (add_on_reason IS NOT NULL AND length(add_on_reason) > 0)
// );

// ğŸ†• çº¦æŸï¼šsource='product' æ—¶ï¼ŒoriginItems å¿…å¡«ï¼ˆv2.16.3ï¼‰
// ALTER TABLE contract_service_entitlements ADD CONSTRAINT chk_origin_items CHECK (
//   (source != 'product') OR (origin_items IS NOT NULL AND jsonb_array_length(origin_items) > 0)
// );

// ğŸ†• çº¦æŸï¼šsource='product' æ—¶ï¼ŒserviceSnapshot å¿…å¡«ï¼ˆv2.16.4 - å†³ç­– #6ï¼‰
// ALTER TABLE contract_service_entitlements ADD CONSTRAINT chk_service_snapshot_required_for_product CHECK (
//   (source != 'product') OR (service_snapshot IS NOT NULL)
// );
```

**ä¸šåŠ¡è§„åˆ™ï¼ˆv2.16.7 æ›´æ–°ï¼‰ï¼š**

1. **ä½™é¢ä¸€è‡´æ€§**ï¼š`availableQuantity = totalQuantity - consumedQuantity - heldQuantity`
2. **æ™ºèƒ½åˆå¹¶ç­–ç•¥ï¼ˆv2.16.7 - ç§»é™¤ unit å­—æ®µï¼‰**ï¼š
   - æŒ‰ `(contract_id, service_type, expires_at, source)` å”¯ä¸€çº¦æŸ
   - ç›¸åŒæœåŠ¡ç±»å‹çš„å¤šä¸ªäº§å“é¡¹åˆå¹¶ä¸ºä¸€æ¡è®°å½•
   - `totalQuantity` ç´¯åŠ æ‰€æœ‰æ¥æºçš„æ•°é‡ï¼ˆä»¥æ¬¡æ•°ä¸ºå•ä½ï¼‰
   - `originItems` æ•°ç»„ä¿ç•™æ‰€æœ‰äº§å“é¡¹çš„è¿½æº¯ä¿¡æ¯
   - ä½¿ç”¨ `ON CONFLICT DO UPDATE` å¤„ç†å¹¶å‘æ’å…¥å’Œåç»­æ·»åŠ 
3. **é¢å¤–æƒç›Šç‹¬ç«‹å­˜å‚¨**ï¼šaddon/promotion/compensation ä¸åˆå¹¶ï¼Œæ¯æ¬¡æ·»åŠ åˆ›å»ºæ–°è®°å½•
4. **å¿…å¡«å­—æ®µéªŒè¯ï¼ˆv2.16.4ï¼‰**ï¼š
   - `source='product'` æ—¶ï¼Œ`originItems` å¿…å¡«ï¼ˆå®Œæ•´è¿½æº¯æ¥æºï¼‰
   - `source='product'` æ—¶ï¼Œ`serviceSnapshot` å¿…å¡«ï¼ˆä¿ç•™ä¸šåŠ¡å­—æ®µï¼‰
   - `source='addon'|'compensation'` æ—¶ï¼Œ`addOnReason` å¿…å¡«
   - é¢å¤–æƒç›Š `serviceSnapshot` å¯é€‰ï¼ˆå†³ç­– #6ï¼‰
5. **è¿‡æœŸæ—¶é—´ç»§æ‰¿**ï¼šæ‰€æœ‰æƒç›Šç»Ÿä¸€ç»§æ‰¿ `contract.expiresAt`ï¼ˆå†³ç­– #1ï¼‰
6. **å¹¶å‘æ§åˆ¶**ï¼šä½¿ç”¨æ‚²è§‚é”ï¼ˆSELECT FOR UPDATEï¼‰è€Œéä¹è§‚é”

#### 3.2.3 service_ledgersï¼ˆæœåŠ¡æµæ°´è¡¨ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `src/database/schema/service-ledgers.schema.ts`

**èŒè´£ï¼š** Append-only è¿½è¸ªæ¯æ¬¡æœåŠ¡æ¶ˆè´¹å’Œè°ƒæ•´

```typescript
import { pgTable, uuid, varchar, integer, timestamp, text, json, pgEnum } from 'drizzle-orm/pg-core';
import { contracts } from './contracts.schema';
import { users } from './users.schema';
import { serviceTypeEnum } from './enums/service-type.enum';

// æµæ°´ç±»å‹æšä¸¾
export const serviceLedgerTypeEnum = pgEnum('service_ledger_type', [
  'consumption',      // æœåŠ¡æ¶ˆè´¹ï¼ˆquantity < 0ï¼‰
  'refund',          // é€€æ¬¾å¢åŠ ï¼ˆquantity > 0ï¼‰
  'adjustment',      // æ‰‹åŠ¨è°ƒæ•´ï¼ˆquantity å¯æ­£å¯è´Ÿï¼‰
  'initial',         // åˆå§‹åŒ–ï¼ˆquantity > 0ï¼‰
  'expiration',      // è¿‡æœŸæ‰£å‡ï¼ˆquantity < 0ï¼‰
]);

// æ¥æºæšä¸¾
export const serviceLedgerSourceEnum = pgEnum('service_ledger_source', [
  'booking_completed',    // é¢„çº¦å®Œæˆ
  'booking_cancelled',    // é¢„çº¦å–æ¶ˆ
  'contract_signed',      // åˆåŒç­¾çº¦
  'manual_adjustment',    // æ‰‹åŠ¨è°ƒæ•´
  'auto_expiration',      // è‡ªåŠ¨è¿‡æœŸ
]);

export const serviceLedgers = pgTable('service_ledgers', {
  id: uuid('id').defaultRandom().primaryKey(),

  // å…³è”åˆåŒå’Œå­¦ç”Ÿ
  contractId: uuid('contract_id').notNull().references(() => contracts.id),
  studentId: uuid('student_id').notNull().references(() => users.id),

  // æœåŠ¡ç±»å‹
  serviceType: serviceTypeEnum('service_type').notNull(),

  // æ•°é‡å˜åŒ–ï¼ˆè´Ÿæ•°=æ¶ˆè´¹ï¼Œæ­£æ•°=å¢åŠ ï¼‰
  quantity: integer('quantity').notNull(),

  // æµæ°´ç±»å‹å’Œæ¥æº
  type: serviceLedgerTypeEnum('type').notNull(),
  source: serviceLedgerSourceEnum('source').notNull(),

  // æ“ä½œåä½™é¢ï¼ˆå¿…é¡» >= 0ï¼‰
  balanceAfter: integer('balance_after').notNull(), // å¿«ç…§ï¼Œç”¨äºå¯¹è´¦

  // å…³è”ä¸šåŠ¡è®°å½•
  relatedHoldId: uuid('related_hold_id'), // å…³è”çš„é¢„å è®°å½•
  relatedBookingId: uuid('related_booking_id'), // å…³è”çš„é¢„çº¦IDï¼ˆsessions/classesç­‰ï¼‰

  // å®¡è®¡å­—æ®µ
  reason: text('reason'), // è°ƒæ•´åŸå› ï¼ˆmanual_adjustmentæ—¶å¿…å¡«ï¼‰
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  createdBy: uuid('created_by').notNull().references(() => users.id),

  // å…ƒæ•°æ®
  metadata: json('metadata'), // é¢å¤–ä¿¡æ¯ï¼ˆå¦‚åŸå§‹balanceã€æ“ä½œIPç­‰ï¼‰
});

// ç´¢å¼•
// CREATE INDEX idx_service_ledgers_contract ON service_ledgers(contract_id);
// CREATE INDEX idx_service_ledgers_student ON service_ledgers(student_id);
// CREATE INDEX idx_service_ledgers_service_type ON service_ledgers(service_type);
// CREATE INDEX idx_service_ledgers_created_at ON service_ledgers(created_at);
// CREATE INDEX idx_service_ledgers_source ON service_ledgers(source);

// çº¦æŸï¼šbalanceAfter å¿…é¡» >= 0
// ALTER TABLE service_ledgers ADD CONSTRAINT chk_balance_after_non_negative
// CHECK (balance_after >= 0);

// çº¦æŸï¼šæ‰‹åŠ¨è°ƒæ•´æ—¶ reason å¿…å¡«
// ALTER TABLE service_ledgers ADD CONSTRAINT chk_adjustment_reason CHECK (
//   (type != 'adjustment') OR (reason IS NOT NULL AND length(reason) > 0)
// );

// çº¦æŸï¼šä¸åŒç±»å‹çš„ quantity æ­£è´Ÿæ ¡éªŒ
// ALTER TABLE service_ledgers ADD CONSTRAINT chk_consumption_quantity_negative
// CHECK (type != 'consumption' OR quantity < 0);
//
// ALTER TABLE service_ledgers ADD CONSTRAINT chk_refund_quantity_positive
// CHECK (type != 'refund' OR quantity > 0);
//
// ALTER TABLE service_ledgers ADD CONSTRAINT chk_initial_quantity_positive
// CHECK (type != 'initial' OR quantity > 0);
//
// ALTER TABLE service_ledgers ADD CONSTRAINT chk_expiration_quantity_negative
// CHECK (type != 'expiration' OR quantity < 0);
```

**ä¸šåŠ¡è§„åˆ™ï¼š**

1. **Append-only**ï¼šåº”ç”¨å±‚ç¦æ­¢ UPDATE/DELETE æ“ä½œ
2. **ä½™é¢éè´Ÿ**ï¼š`balanceAfter >= 0`
3. **æ­£è´Ÿçº¦æŸ**ï¼š
   - `type='consumption'` â†’ `quantity < 0`
   - `type='refund'` â†’ `quantity > 0`
   - `type='initial'` â†’ `quantity > 0`
   - `type='expiration'` â†’ `quantity < 0`
4. **å¿…å¡«å­—æ®µ**ï¼š`type='adjustment'` æ—¶ï¼Œ`reason` å¿…å¡«

#### 3.2.4 service_holdsï¼ˆæœåŠ¡é¢„å è¡¨ï¼‰ã€å·²ç®€åŒ– - v2.16.9 ç§»é™¤è¿‡æœŸé€»è¾‘ã€‘

**æ–‡ä»¶è·¯å¾„ï¼š** `src/database/schema/service-holds.schema.ts`

**èŒè´£ï¼š** é˜²æ­¢è¶…é¢é¢„çº¦

**v2.16.9 é‡å¤§å˜æ›´ï¼š**
- âŒ **ç§»é™¤ TTL è¿‡æœŸæ—¶é—´**ï¼šä¸å†éœ€è¦ expiresAt å­—æ®µ
- âœ… **é¢„å æ°¸ä¸è¿‡æœŸ**ï¼šå¿…é¡»ç”±äººå·¥æ“ä½œé‡Šæ”¾
- âœ… **ç®€åŒ–çŠ¶æ€ç®¡ç†**ï¼šåªæœ‰ active â†’ released/cancelled

**è®¾è®¡å˜æ›´åŸå› ï¼š**
1. **ä¸šåŠ¡å®Œæ•´æ€§**ï¼šé¢„å ä»£è¡¨ç”¨æˆ·çš„é¢„çº¦æ„å›¾ï¼Œä¸åº”è‡ªåŠ¨å¤±æ•ˆ
2. **å‡å°‘å¤æ‚åº¦**ï¼šç§»é™¤ä¸å¿…è¦çš„è¿‡æœŸé€»è¾‘å’Œå®šæ—¶ä»»åŠ¡
3. **äººå·¥å®¡æ ¸é‡è¦æ“ä½œ**ï¼šé¢„çº¦åˆ›å»ºå’Œå–æ¶ˆéƒ½éœ€è¦äººå·¥ç¡®è®¤
4. **æ•°æ®å®¡è®¡**ï¼šä¿ç•™å®Œæ•´çš„é¢„å å†å²è®°å½•

```typescript
import { pgTable, uuid, varchar, integer, timestamp, pgEnum } from 'drizzle-orm/pg-core';
import { contracts } from './contracts.schema';
import { users } from './users.schema';
import { serviceTypeEnum } from './enums/service-type.enum';

// é¢„å çŠ¶æ€æšä¸¾ï¼ˆv2.16.9: ç§»é™¤ 'expired' çŠ¶æ€ï¼‰
export const holdStatusEnum = pgEnum('hold_status', [
  'active',       // ç”Ÿæ•ˆä¸­ï¼ˆæœªé‡Šæ”¾ï¼‰
  'released',     // å·²é‡Šæ”¾ï¼ˆæœåŠ¡å®Œæˆï¼‰
  'cancelled',    // å·²å–æ¶ˆï¼ˆç”¨æˆ·å–æ¶ˆé¢„çº¦ï¼‰
]);

export const serviceHolds = pgTable('service_holds', {
  id: uuid('id').defaultRandom().primaryKey(),

  // å…³è”åˆåŒå’Œå­¦ç”Ÿ
  contractId: uuid('contract_id').notNull().references(() => contracts.id),
  studentId: uuid('student_id').notNull().references(() => users.id),

  // æœåŠ¡ç±»å‹å’Œé¢„å æ•°é‡
  serviceType: serviceTypeEnum('service_type').notNull(),
  quantity: integer('quantity').notNull().default(1), // é»˜è®¤é¢„å 1ä¸ªå•ä½

  // çŠ¶æ€ç®¡ç†
  status: holdStatusEnum('status').notNull().default('active'),

  // å…³è”ä¸šåŠ¡è®°å½•
  relatedBookingId: uuid('related_booking_id'), // å…³è”çš„é¢„çº¦IDï¼ˆsessions/classesç­‰ï¼‰

  // é‡Šæ”¾ä¿¡æ¯ï¼ˆäººå·¥æ“ä½œè®°å½•ï¼‰
  releasedAt: timestamp('released_at', { withTimezone: true }),
  releaseReason: varchar('release_reason', { length: 100 }), // 'completed' | 'cancelled' | 'admin_manual'

  // å®¡è®¡å­—æ®µ
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  createdBy: uuid('created_by').notNull().references(() => users.id),

  // æ—¶é—´æˆ³å­—æ®µ
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
});

// ç´¢å¼•
// CREATE INDEX idx_service_holds_contract ON service_holds(contract_id);
// CREATE INDEX idx_service_holds_student ON service_holds(student_id);
// CREATE INDEX idx_service_holds_service_type ON service_holds(service_type);
// CREATE INDEX idx_service_holds_status ON service_holds(status);
// âŒ ç§»é™¤: idx_service_holds_expires_at (no longer needed)
```

**ä¸šåŠ¡è§„åˆ™ï¼ˆv2.16.9ï¼‰ï¼š**

1. **é¢„å æ°¸ä¸è¿‡æœŸ**ï¼šstatus åªèƒ½é€šè¿‡ `releaseHold()` æˆ– `cancelHold()` å˜æ›´
2. **ä»…æ´»è·ƒé¢„å è®¡é¢„ç®—**ï¼šheld_quantity ä»…ç»Ÿè®¡ status = 'active' çš„è®°å½•
3. **è§¦å‘å™¨è‡ªåŠ¨ç»´æŠ¤**ï¼šheld_quantity åœ¨ hold çŠ¶æ€å˜æ›´æ—¶è‡ªåŠ¨æ›´æ–°
4. **äººå·¥æ“ä½œå¿…é¡»æ˜ç¡®åŸå› **ï¼šreleaseReason å¿…å¡«ï¼ˆcompleted / cancelled / admin_manualï¼‰

**ä½¿ç”¨åœºæ™¯ï¼š**

```typescript
// åˆ›å»ºé¢„å 
const hold = await createHold({ contractId, serviceType });
// â†’ è§¦å‘å™¨ï¼šheld_quantity += 1, available_quantity -= 1

// æœåŠ¡å®Œæˆåé‡Šæ”¾
await releaseHold(holdId, 'completed');
// â†’ è§¦å‘å™¨ï¼šheld_quantity -= 1

// ç”¨æˆ·å–æ¶ˆé¢„çº¦
await cancelHold(holdId, 'cancelled');
// â†’ è§¦å‘å™¨ï¼šheldå™¨ï¼šheld_quantity -= 1

// ç®¡ç†å‘˜æ‰‹åŠ¨é‡Šæ”¾ï¼ˆé’ˆå¯¹å¼‚å¸¸æˆ–æŠ•è¯‰ï¼‰
await releaseHold(holdId, 'admin_manual');
// â†’ è§¦å‘å™¨ï¼šheld_quantity -= 1
```

**ç›‘æ§å»ºè®®ï¼š**

ç”±äºç§»é™¤äº†è‡ªåŠ¨è¿‡æœŸï¼Œå»ºè®®å®šæœŸæ£€æŸ¥é•¿æ—¶é—´æœªé‡Šæ”¾çš„é¢„å ï¼ˆå¦‚è¶…è¿‡24å°æ—¶ï¼‰ï¼š

```typescript
// æŸ¥è¯¢åˆ›å»ºè¶…è¿‡24å°æ—¶ä¸”ä»æœªé‡Šæ”¾çš„é¢„å 
const oldHolds = await db.query.serviceHolds.findMany({
  where: and(
    eq(serviceHolds.status, 'active'),
    lt(serviceHolds.createdAt, new Date(Date.now() - 24 * 60 * 60 * 1000))
  )
});
// äººå·¥å®¡æ ¸åé‡Šæ”¾
```

**æ•°æ®å®Œæ•´æ€§ä¿è¯ï¼š**

1. **æ•°æ®åº“è§¦å‘å™¨**ï¼ˆ`sync_held_quantity`ï¼‰ç¡®ä¿ held_quantity å®æ—¶åŒæ­¥
2. **çŠ¶æ€çº¦æŸ**ï¼šstatus åªèƒ½ä» 'active' â†’ 'released'/'cancelled'ï¼ˆæ³¨å†Œåº”ç”¨å±‚æ£€æŸ¥ï¼‰
3. **å®Œæ•´æ€§æ£€æŸ¥**ï¼šå®šæœŸå¯¹è´¦ held_quantity ä¸ service_holds è¡¨ï¼ˆæ¨èæ¯å‘¨ä¸€æ¬¡ï¼‰

**ä¸šåŠ¡è§„åˆ™ï¼ˆv2.16.9ï¼‰ï¼š**

1. **é¢„å æ°¸ä¸è¿‡æœŸ**ï¼šstatus åªèƒ½é€šè¿‡ `releaseHold()` æˆ– `cancelHold()` å˜æ›´
2. **ä»…æ´»è·ƒé¢„å è®¡é¢„ç®—**ï¼šheld_quantity ä»…ç»Ÿè®¡ status = 'active' çš„è®°å½•
3. **è§¦å‘å™¨è‡ªåŠ¨ç»´æŠ¤**ï¼šheld_quantity åœ¨ hold çŠ¶æ€å˜æ›´æ—¶è‡ªåŠ¨æ›´æ–°
4. **äººå·¥æ“ä½œå¿…é¡»æ˜ç¡®åŸå› **ï¼šreleaseReason å¿…å¡«ï¼ˆcompleted / cancelled / admin_manualï¼‰

**ğŸ†• æ•°æ®ä¸€è‡´æ€§ä¿è¯ï¼ˆv2.16.5 å†³ç­– C-NEW-2ï¼‰ï¼š**

ä½¿ç”¨æ•°æ®åº“è§¦å‘å™¨è‡ªåŠ¨åŒæ­¥ `contract_service_entitlements.held_quantity`ï¼Œé¿å…åº”ç”¨å±‚æ‰‹åŠ¨åŒæ­¥å¯¼è‡´çš„ä¸ä¸€è‡´é—®é¢˜ã€‚

```sql
-- è§¦å‘å™¨å‡½æ•°ï¼šè‡ªåŠ¨åŒæ­¥ held_quantity
CREATE OR REPLACE FUNCTION sync_held_quantity()
RETURNS TRIGGER AS $$
BEGIN
  -- åœºæ™¯ 1: åˆ›å»ºæ–°é¢„å ï¼ˆINSERT ä¸” status = 'active'ï¼‰
  IF TG_OP = 'INSERT' AND NEW.status = 'active' THEN
    UPDATE contract_service_entitlements
    SET
      held_quantity = held_quantity + NEW.quantity,
      available_quantity = available_quantity - NEW.quantity,
      updated_at = NOW()
    WHERE contract_id = NEW.contract_id
      AND service_type = NEW.service_type;

    -- éªŒè¯ï¼šç¡®ä¿ available_quantity >= 0ï¼ˆè§¦å‘ CHECK çº¦æŸï¼‰
    IF NOT FOUND THEN
      RAISE EXCEPTION 'Entitlement not found for contract_id=%, service_type=%',
        NEW.contract_id, NEW.service_type;
    END IF;

    RETURN NEW;
  END IF;

  -- åœºæ™¯ 2: é‡Šæ”¾é¢„å ï¼ˆUPDATE ä¸” status ä» 'active' å˜ä¸ºå…¶ä»–çŠ¶æ€ï¼‰
  IF TG_OP = 'UPDATE'
     AND OLD.status = 'active'
     AND NEW.status != 'active' THEN
    UPDATE contract_service_entitlements
    SET
      held_quantity = held_quantity - OLD.quantity,
      available_quantity = available_quantity + OLD.quantity,
      updated_at = NOW()
    WHERE contract_id = OLD.contract_id
      AND service_type = OLD.service_type;

    RETURN NEW;
  END IF;

  -- å…¶ä»–æƒ…å†µï¼šä¸å¤„ç†
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ç»‘å®šè§¦å‘å™¨åˆ° service_holds è¡¨
CREATE TRIGGER service_holds_sync_trigger
  AFTER INSERT OR UPDATE ON service_holds
  FOR EACH ROW
  EXECUTE FUNCTION sync_held_quantity();

-- ä½¿ç”¨è¯´æ˜ï¼š
-- 1. åº”ç”¨å±‚åªéœ€æ“ä½œ service_holds è¡¨ï¼Œheld_quantity ä¼šè‡ªåŠ¨åŒæ­¥
-- 2. è§¦å‘å™¨åœ¨äº‹åŠ¡å†…æ‰§è¡Œï¼Œä¿è¯åŸå­æ€§
-- 3. å¦‚æœ available_quantity å˜ä¸ºè´Ÿæ•°ï¼ŒCHECK çº¦æŸä¼šé˜»æ­¢äº‹åŠ¡æäº¤
```

**åº”ç”¨å±‚ä»£ç ç®€åŒ–ï¼ˆæ— éœ€æ‰‹åŠ¨åŒæ­¥ï¼‰ï¼š**

```typescript
// åˆ›å»ºé¢„å ï¼ˆè§¦å‘å™¨è‡ªåŠ¨åŒæ­¥ held_quantityï¼‰
// v2.16.7: æ”¯æŒå¯é€‰çš„äº‹åŠ¡å‚æ•°
async createHold(dto: CreateHoldDto, tx?: DrizzleTransaction): Promise<ServiceHold> {
  // ä½¿ç”¨æä¾›çš„äº‹åŠ¡æˆ–é»˜è®¤æ•°æ®åº“è¿æ¥
  const executor = tx ?? db;

  return await executor.insert(serviceHolds).values({
    contractId: dto.contractId,
    studentId: dto.studentId,
    serviceType: dto.serviceType,
    quantity: dto.quantity ?? 1,
    status: 'active',
    createdBy: dto.studentId,
    relatedBookingId: dto.relatedBookingId,
  }).returning();

  // âœ… è§¦å‘å™¨è‡ªåŠ¨æ‰§è¡Œï¼š
  // UPDATE contract_service_entitlements
  // SET held_quantity = held_quantity + 1,
  //     available_quantity = available_quantity - 1
  //
  // æ³¨æ„ï¼šå¦‚æœåœ¨äº‹åŠ¡ä¸­è°ƒç”¨ï¼Œè§¦å‘å™¨ä¼šåœ¨åŒä¸€äº‹åŠ¡ä¸­æ‰§è¡Œ
  // v2.16.9: ç§»é™¤ expiresAt å­—æ®µï¼Œé¢„å æ°¸ä¸è¿‡æœŸ
}

// é‡Šæ”¾é¢„å ï¼ˆè§¦å‘å™¨è‡ªåŠ¨åŒæ­¥ held_quantityï¼‰
async releaseHold(holdId: string, reason: string): Promise<void> {
  await db.update(serviceHolds)
    .set({
      status: 'released',
      releasedAt: new Date(),
      releaseReason: reason,
      updatedAt: new Date(),
    })
    .where(eq(serviceHolds.id, holdId));

  // âœ… è§¦å‘å™¨è‡ªåŠ¨æ‰§è¡Œï¼š
  // UPDATE contract_service_entitlements
  // SET held_quantity = held_quantity - 1,
  //     available_quantity = available_quantity + 1
}

// æ‰¹é‡æ¸…ç†è¿‡æœŸé¢„å ï¼ˆè§¦å‘å™¨è‡ªåŠ¨åŒæ­¥ï¼‰
async cleanupExpiredHolds(): Promise<number> {
  const result = await db.update(serviceHolds)
    .set({
      status: 'expired',
      updatedAt: new Date(),
    })
    .where(and(
      eq(serviceHolds.status, 'active'),
      lt(serviceHolds.expiresAt, new Date())
    ));

  // âœ… è§¦å‘å™¨ä¼šä¸ºæ¯ä¸€è¡Œè‡ªåŠ¨åŒæ­¥ held_quantity
  return result.rowCount;
}
```

**ä¸€è‡´æ€§ä¿è¯ï¼š**
- âœ… æ•°æ®åº“çº§åˆ«ä¿è¯ `held_quantity` ä¸ `service_holds` è¡¨å®æ—¶åŒæ­¥
- âœ… è§¦å‘å™¨åœ¨äº‹åŠ¡å†…æ‰§è¡Œï¼Œä¸é¢„å æ“ä½œåŸå­æ€§æäº¤
- âœ… æ— éœ€åº”ç”¨å±‚æ‰‹åŠ¨åŒæ­¥ï¼Œå‡å°‘ä»£ç å¤æ‚åº¦å’Œå‡ºé”™æ¦‚ç‡
- âœ… CHECK çº¦æŸé˜²æ­¢ `available_quantity < 0`

**äº‹åŠ¡ä½¿ç”¨ç¤ºä¾‹ï¼ˆv2.16.7ï¼‰ï¼š**

```typescript
// åœºæ™¯ï¼šé¢„çº¦æœåŠ¡æ—¶ï¼Œåœ¨åŒä¸€äº‹åŠ¡ä¸­åˆ›å»ºé¢„çº¦è®°å½•å’Œé¢„å è®°å½•

async createBooking(bookingDto: CreateBookingDto): Promise<Booking> {
  return await db.transaction(async (tx) => {
    // 1. åˆ›å»ºé¢„çº¦è®°å½•
    const booking = await tx.insert(bookings).values({
      studentId: bookingDto.studentId,
      serviceType: bookingDto.serviceType,
      scheduledAt: bookingDto.scheduledAt,
      status: 'pending',
    }).returning();

    // 2. åœ¨åŒä¸€äº‹åŠ¡ä¸­åˆ›å»ºé¢„å ï¼ˆå…³é”®ï¼ï¼‰
    const hold = await holdService.createHold({
      contractId: bookingDto.contractId,
      studentId: bookingDto.studentId,
      serviceType: bookingDto.serviceType,
      quantity: 1,
      relatedBookingId: booking.id,
      createdBy: bookingDto.studentId,
    }, tx); // â† ä¼ å…¥äº‹åŠ¡å¯¹è±¡

    // 3. æ›´æ–°é¢„çº¦è®°å½•ï¼Œå…³è”é¢„å ID
    await tx.update(bookings)
      .set({ holdId: hold.id })
      .where(eq(bookings.id, booking.id));

    // äº‹åŠ¡æäº¤ï¼šé¢„çº¦è®°å½• + é¢„å è®°å½• + æƒç›Šä½™é¢æ›´æ–° åŸå­æ€§å®Œæˆ
    return booking;
  });
}

// ä¼˜åŠ¿ï¼š
// âœ… åŸå­æ€§ï¼šé¢„çº¦å’Œé¢„å è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
// âœ… ä¸€è‡´æ€§ï¼šè§¦å‘å™¨åœ¨åŒä¸€äº‹åŠ¡ä¸­æ›´æ–°æƒç›Šä½™é¢ï¼ˆv2.16.9: æ— è¿‡æœŸæ—¶é—´ï¼‰
// âœ… æ— ç«æ€æ¡ä»¶ï¼šé¿å…é¢„çº¦åˆ›å»ºåã€é¢„å åˆ›å»ºå‰è¢«å…¶ä»–è¯·æ±‚æ¶ˆè´¹ä½™é¢
// âœ… äººå·¥é‡Šæ”¾ï¼šé¢„å æ°¸ä¸è¿‡æœŸï¼Œå¿…é¡»æ‰‹åŠ¨è°ƒç”¨ releaseHold()
```

#### 3.2.5 domain_eventsï¼ˆé¢†åŸŸäº‹ä»¶å‘ä»¶ç®±è¡¨ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `src/database/schema/domain-events.schema.ts`

**èŒè´£ï¼š** Transactional Outbox æ¨¡å¼ï¼Œä¿è¯äº‹ä»¶å¯é å‘å¸ƒ

```typescript
import { pgTable, uuid, varchar, text, json, timestamp, integer, pgEnum } from 'drizzle-orm/pg-core';

// äº‹ä»¶çŠ¶æ€æšä¸¾
export const eventStatusEnum = pgEnum('event_status', [
  'pending',    // å¾…å‘å¸ƒ
  'published',  // å·²å‘å¸ƒ
  'failed',     // å‘å¸ƒå¤±è´¥
]);

export const domainEvents = pgTable('domain_events', {
  id: uuid('id').defaultRandom().primaryKey(),

  // äº‹ä»¶ç±»å‹ï¼ˆå¦‚ï¼šcontract.signed, contract.activatedï¼‰
  eventType: varchar('event_type', { length: 100 }).notNull(),

  // èšåˆæ ¹IDï¼ˆå¦‚ï¼šcontractIdï¼‰
  aggregateId: uuid('aggregate_id').notNull(),

  // èšåˆæ ¹ç±»å‹ï¼ˆå¦‚ï¼šContractï¼‰
  aggregateType: varchar('aggregate_type', { length: 50 }).notNull().default('Contract'),

  // äº‹ä»¶è½½è·ï¼ˆJSONBæ ¼å¼ï¼‰
  payload: json('payload').$type<Record<string, any>>().notNull(),

  // å‘å¸ƒçŠ¶æ€
  status: eventStatusEnum('status').notNull().default('pending'),

  // æ—¶é—´æˆ³
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  publishedAt: timestamp('published_at', { withTimezone: true }),

  // é‡è¯•ä¿¡æ¯
  retryCount: integer('retry_count').notNull().default(0),
  maxRetries: integer('max_retries').notNull().default(3),
  errorMessage: text('error_message'),

  // å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰
  metadata: json('metadata').$type<{
    correlationId?: string;   // å…³è”IDï¼ˆç”¨äºè¿½è¸ªï¼‰
    causationId?: string;     // å› æœIDï¼ˆè§¦å‘æ­¤äº‹ä»¶çš„åŸå› ï¼‰
    publishedBy?: string;     // å‘å¸ƒè€…ä¿¡æ¯
  }>(),
});

// ç´¢å¼•
// CREATE INDEX idx_domain_events_status ON domain_events(status);
// CREATE INDEX idx_domain_events_created_at ON domain_events(created_at);
// CREATE INDEX idx_domain_events_aggregate ON domain_events(aggregate_type, aggregate_id);
// CREATE INDEX idx_domain_events_event_type ON domain_events(event_type);
```

**ä¸šåŠ¡è§„åˆ™ï¼š**

1. **äº‹åŠ¡ä¸€è‡´æ€§**ï¼šäº‹ä»¶åœ¨ä¸šåŠ¡äº‹åŠ¡ä¸­åˆ›å»ºï¼Œç¡®ä¿ä¸šåŠ¡æ•°æ®å’Œäº‹ä»¶åŸå­æ€§
2. **åå°å‘å¸ƒ**ï¼šå®šæ—¶ä»»åŠ¡ï¼ˆ30ç§’å‘¨æœŸï¼‰æ‰«æ `status='pending'` çš„äº‹ä»¶å¹¶å‘å¸ƒ
3. **é‡è¯•æœºåˆ¶**ï¼šå¤±è´¥åé‡è¯•æœ€å¤š 3 æ¬¡ï¼Œè¶…è¿‡åæ ‡è®°ä¸º `failed`
4. **å¹‚ç­‰æ€§**ï¼šæ¶ˆè´¹è€…éœ€è¦å®ç°å¹‚ç­‰å¤„ç†ï¼ˆé€šè¿‡ event.id å»é‡ï¼‰
5. **æ¸…ç†ç­–ç•¥**ï¼šå·²å‘å¸ƒäº‹ä»¶ä¿ç•™ 30 å¤©åå½’æ¡£æˆ–åˆ é™¤

**æ”¯æŒçš„äº‹ä»¶ç±»å‹ï¼š**

| Event Type              | è§¦å‘æ—¶æœº           | æ¶ˆè´¹è€…                    |
| ----------------------- | ------------------ | ------------------------- |
| `contract.signed`       | åˆåŒç­¾ç½²å®Œæˆ       | Profile, Notification     |
| `contract.activated`    | åˆåŒæ¿€æ´»           | Profile, Analytics        |
| `contract.suspended`    | åˆåŒæš‚åœ           | Services (å–æ¶ˆé¢„çº¦)       |
| `contract.resumed`      | åˆåŒæ¢å¤           | Services                  |
| `contract.completed`    | åˆåŒå®Œæˆ           | Analytics                 |
| `contract.terminated`   | åˆåŒç»ˆæ­¢           | Services, Profile         |
| `entitlement.added`     | æ·»åŠ é¢å¤–æƒç›Š       | Notification              |
| `service.consumed`      | æœåŠ¡æ¶ˆè´¹å®Œæˆ       | Analytics                 |

#### 3.2.6 service_ledgers_archiveï¼ˆæœåŠ¡æµæ°´å½’æ¡£è¡¨ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `src/database/schema/service-ledgers-archive.schema.ts`

**èŒè´£ï¼š** å†·çƒ­åˆ†ç¦»å½’æ¡£å†å²æµæ°´æ•°æ®

```typescript
import { pgTable, uuid, varchar, integer, timestamp, text, json } from 'drizzle-orm/pg-core';
import { serviceLedgerTypeEnum, serviceLedgerSourceEnum } from './service-ledgers.schema';
import { serviceTypeEnum } from './enums/service-type.enum';

// å½’æ¡£è¡¨ç»“æ„ä¸ä¸»è¡¨å®Œå…¨ä¸€è‡´
export const serviceLedgersArchive = pgTable('service_ledgers_archive', {
  id: uuid('id').primaryKey(), // ä¿æŒåŸID
  contractId: uuid('contract_id').notNull(),
  studentId: uuid('student_id').notNull(),
  serviceType: serviceTypeEnum('service_type').notNull(),
  quantity: integer('quantity').notNull(),
  type: serviceLedgerTypeEnum('type').notNull(),
  source: serviceLedgerSourceEnum('source').notNull(),
  balanceAfter: integer('balance_after').notNull(),
  relatedHoldId: uuid('related_hold_id'),
  relatedBookingId: uuid('related_booking_id'),
  reason: text('reason'),
  createdAt: timestamp('created_at', { withTimezone: true }).notNull(),
  createdBy: uuid('created_by').notNull(),
  metadata: json('metadata'),

  // å½’æ¡£ä¿¡æ¯
  archivedAt: timestamp('archived_at', { withTimezone: true }).defaultNow().notNull(),
});

// ç´¢å¼•ï¼ˆé’ˆå¯¹å½’æ¡£æŸ¥è¯¢ä¼˜åŒ– - v2.16.4 å†³ç­– I5ï¼‰
// CREATE INDEX idx_service_ledgers_archive_contract ON service_ledgers_archive(contract_id);
// CREATE INDEX idx_service_ledgers_archive_student ON service_ledgers_archive(student_id);
// CREATE INDEX idx_service_ledgers_archive_created_at ON service_ledgers_archive(created_at);
```

**å½’æ¡£æŸ¥è¯¢ç­–ç•¥ä¸æ€§èƒ½ä¼˜åŒ–ï¼ˆv2.16.4 å†³ç­– I5ï¼‰ï¼š**

1. **é»˜è®¤æŸ¥è¯¢ç­–ç•¥ï¼ˆå¿«é€Ÿï¼‰**ï¼š
   - ä»…æŸ¥è¯¢ä¸»è¡¨ `service_ledgers`
   - é€‚ç”¨äºæ—¥å¸¸ä¸šåŠ¡æŸ¥è¯¢ï¼ˆè¿‘æœŸæµæ°´ï¼‰
   - æ€§èƒ½æœ€ä¼˜ï¼ˆæ—  UNION ALL å¼€é”€ï¼‰

2. **å®Œæ•´å†å²æŸ¥è¯¢ï¼ˆ`includeArchive=true`ï¼‰**ï¼š
   - ä½¿ç”¨ UNION ALL åˆå¹¶ä¸»è¡¨å’Œå½’æ¡£è¡¨
   - **å¿…é¡»æä¾›æ—¥æœŸèŒƒå›´è¿‡æ»¤**ï¼ˆé¿å…å…¨è¡¨æ‰«æï¼‰
   - é€‚ç”¨äºå®¡è®¡ã€å†å²åˆ†æç­‰åœºæ™¯

3. **å¿…éœ€ç´¢å¼•ï¼ˆæ€§èƒ½å…³é”®ï¼‰**ï¼š
   ```sql
   -- å½’æ¡£è¡¨å¤åˆç´¢å¼•ï¼ˆä¼˜åŒ–æŒ‰åˆåŒæŸ¥è¯¢ï¼‰
   CREATE INDEX idx_archive_contract_created
     ON service_ledgers_archive(contract_id, created_at DESC);

   -- å½’æ¡£è¡¨å¤åˆç´¢å¼•ï¼ˆä¼˜åŒ–æŒ‰å­¦ç”ŸæŸ¥è¯¢ï¼‰
   CREATE INDEX idx_archive_student_created
     ON service_ledgers_archive(student_id, created_at DESC);

   -- å½’æ¡£è¡¨å¤åˆç´¢å¼•ï¼ˆä¼˜åŒ–æŒ‰æœåŠ¡ç±»å‹æŸ¥è¯¢ï¼‰
   CREATE INDEX idx_archive_service_created
     ON service_ledgers_archive(service_type, created_at DESC);
   ```

4. **æŸ¥è¯¢ç¤ºä¾‹ï¼ˆä¼˜åŒ–ç‰ˆï¼‰**ï¼š
   ```sql
   -- ç¤ºä¾‹ 1: é»˜è®¤æŸ¥è¯¢ï¼ˆä»…ä¸»è¡¨ï¼Œæœ€å¿«ï¼‰
   SELECT * FROM service_ledgers
   WHERE contract_id = $1
   ORDER BY created_at DESC
   LIMIT 50;

   -- ç¤ºä¾‹ 2: å®Œæ•´å†å²æŸ¥è¯¢ï¼ˆå¸¦æ—¥æœŸèŒƒå›´ï¼Œæ¨èï¼‰
   SELECT * FROM service_ledgers
   WHERE contract_id = $1 AND created_at >= $2
   UNION ALL
   SELECT * FROM service_ledgers_archive
   WHERE contract_id = $1 AND created_at >= $2
   ORDER BY created_at DESC;

   -- ç¤ºä¾‹ 3: æŒ‰å­¦ç”ŸæŸ¥è¯¢ï¼ˆå¸¦åˆ†é¡µï¼‰
   SELECT * FROM (
     SELECT * FROM service_ledgers
     WHERE student_id = $1 AND created_at >= $2
     UNION ALL
     SELECT * FROM service_ledgers_archive
     WHERE student_id = $1 AND created_at >= $2
   ) AS combined
   ORDER BY created_at DESC
   LIMIT 20 OFFSET 0;
   ```

5. **æ€§èƒ½æœ€ä½³å®è·µ**ï¼š
   - âœ“ æ€»æ˜¯ä½¿ç”¨æ—¥æœŸèŒƒå›´è¿‡æ»¤ï¼ˆcreated_at >= ?ï¼‰
   - âœ“ ä½¿ç”¨å¤åˆç´¢å¼•è¦†ç›– WHERE + ORDER BY
   - âœ“ é™åˆ¶è¿”å›è¡Œæ•°ï¼ˆLIMITï¼‰
   - âœ— é¿å…æ— è¿‡æ»¤æ¡ä»¶çš„ UNION ALLï¼ˆæ€§èƒ½æ€æ‰‹ï¼‰
   - âœ— é¿å… SELECT * ï¼ˆä»…æŸ¥è¯¢éœ€è¦çš„åˆ—ï¼‰

#### 3.2.6 service_ledger_archive_policiesï¼ˆå½’æ¡£ç­–ç•¥é…ç½®è¡¨ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `src/database/schema/service-ledger-archive-policies.schema.ts`

**èŒè´£ï¼š** é…ç½®å†·çƒ­åˆ†ç¦»çš„å½’æ¡£ç­–ç•¥

```typescript
import { pgTable, uuid, integer, boolean, timestamp, text, pgEnum } from 'drizzle-orm/pg-core';
import { contracts } from './contracts.schema';
import { serviceTypeEnum } from './enums/service-type.enum';

// ç­–ç•¥èŒƒå›´æšä¸¾
export const archivePolicyScopeEnum = pgEnum('archive_policy_scope', [
  'global',          // å…¨å±€é»˜è®¤ç­–ç•¥
  'contract',        // åˆåŒçº§åˆ«ç­–ç•¥
  'service_type',    // æœåŠ¡ç±»å‹çº§åˆ«ç­–ç•¥
]);

export const serviceLedgerArchivePolicies = pgTable('service_ledger_archive_policies', {
  id: uuid('id').defaultRandom().primaryKey(),

  // ç­–ç•¥èŒƒå›´
  scope: archivePolicyScopeEnum('scope').notNull(),

  // å…³è”å®ä½“ï¼ˆæ ¹æ®scopeä¸åŒï¼Œå¯èƒ½ä¸ºç©ºï¼‰
  contractId: uuid('contract_id').references(() => contracts.id), // scope='contract'æ—¶å¿…å¡«
  serviceType: serviceTypeEnum('service_type'), // scope='service_type'æ—¶å¿…å¡«

  // å½’æ¡£è§„åˆ™
  archiveAfterDays: integer('archive_after_days').notNull().default(90), // è¶…è¿‡Nå¤©å½’æ¡£
  deleteAfterArchive: boolean('delete_after_archive').notNull().default(false), // å½’æ¡£åæ˜¯å¦åˆ é™¤ä¸»è¡¨æ•°æ®

  // å¯ç”¨çŠ¶æ€
  enabled: boolean('enabled').notNull().default(true),

  // å®¡è®¡å­—æ®µ
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
  createdBy: uuid('created_by'),
  notes: text('notes'),
});

// ç´¢å¼•
// CREATE INDEX idx_service_ledger_archive_policies_scope ON service_ledger_archive_policies(scope);
// CREATE INDEX idx_service_ledger_archive_policies_contract ON service_ledger_archive_policies(contract_id);
// CREATE INDEX idx_service_ledger_archive_policies_service_type ON service_ledger_archive_policies(service_type);

// çº¦æŸï¼šæ¯ä¸ªscopeåªèƒ½æœ‰ä¸€æ¡è®°å½•
// CREATE UNIQUE INDEX idx_service_ledger_archive_policies_unique_global
// ON service_ledger_archive_policies(scope) WHERE scope = 'global';
//
// CREATE UNIQUE INDEX idx_service_ledger_archive_policies_unique_contract
// ON service_ledger_archive_policies(contract_id) WHERE scope = 'contract';
//
// CREATE UNIQUE INDEX idx_service_ledger_archive_policies_unique_service_type
// ON service_ledger_archive_policies(service_type) WHERE scope = 'service_type';
```

**ç­–ç•¥ä¼˜å…ˆçº§ï¼š** contract > service_type > global

**é»˜è®¤é…ç½®ï¼š**
- `archiveAfterDays`: 90
- `deleteAfterArchive`: false

---

#### 3.2.7 contract_entitlement_revisionsï¼ˆåˆåŒæƒç›Šä¿®è®¢è¡¨ï¼‰ğŸ†•

> **ç‰ˆæœ¬ï¼š** v2.16.7 æ–°å¢
> **æ–‡ä»¶è·¯å¾„ï¼š** `src/infrastructure/database/schema/contract-entitlement-revisions.schema.ts`

**èŒè´£ï¼š** è®°å½•åˆåŒæœåŠ¡æƒç›Šçš„å˜æ›´å†å²ï¼Œæ”¯æŒå®¡è®¡è¿½æº¯å’Œç‰ˆæœ¬ç®¡ç†

**è®¾è®¡å†³ç­–ï¼š**
- âœ… åˆåŒçº§åˆ«ç‰ˆæœ¬å·ï¼šrevision_number åœ¨åˆåŒå†…å…¨å±€é€’å¢ï¼ˆ1, 2, 3...ï¼‰
- âœ… ä»…è®°å½•"æƒç›Šèµ‹äºˆ"ç±»å˜æ›´ï¼ˆä¸è®°å½•æ¶ˆè´¹/é¢„å ç­‰ä¸´æ—¶çŠ¶æ€ï¼‰
- âœ… å…³è”åˆ°å…·ä½“æƒç›Šè®°å½•ï¼ˆentitlement_idï¼‰ï¼Œç²¾ç¡®è¿½æº¯
- âœ… æ”¯æŒå®¡æ ¸æµç¨‹ï¼ˆstatus, requires_approvalï¼‰
- âœ… åˆ›å»ºåˆåŒæ—¶è®°å½•åˆå§‹æƒç›Šï¼ˆrevision_type='initial'ï¼‰

**æ ¸å¿ƒç”¨é€”ï¼š**
1. **å®¡è®¡è¿½æº¯**ï¼šè®°å½•æƒç›Šä½•æ—¶è¢«æ·»åŠ ã€ç”±è°æ·»åŠ ã€åŸå› æ˜¯ä»€ä¹ˆ
2. **ç‰ˆæœ¬ç®¡ç†**ï¼šæ”¯æŒæƒç›Šä¿®è®¢å†å²æŸ¥è¯¢å’Œç‰ˆæœ¬å¯¹æ¯”
3. **å®¡æ ¸æµç¨‹**ï¼šæ”¯æŒéœ€è¦å®¡æ‰¹çš„æƒç›Šå˜æ›´ï¼ˆå¦‚å¤§é¢è¡¥å¿ï¼‰
4. **æ•°æ®ä¿®å¤**ï¼šå½“æƒç›Šè®¡ç®—é”™è¯¯æ—¶ï¼Œå¯é€šè¿‡ä¿®è®¢å†å²å®šä½å’Œä¿®å¤

**ä¿®è®¢ç±»å‹æšä¸¾ï¼ˆentitlement_revision_typeï¼‰ï¼š**

```typescript
export const entitlementRevisionTypeEnum = pgEnum('entitlement_revision_type', [
  'initial',      // åˆå§‹æƒç›Šï¼ˆåˆ›å»ºåˆåŒæ—¶ï¼‰
  'addon',        // æ·»åŠ é¢å¤–æƒç›Šï¼ˆä¿ƒæˆç­¾çº¦ï¼‰
  'promotion',    // ä¿ƒé”€æ´»åŠ¨èµ é€
  'compensation', // è¡¥å¿
  'increase',     // å¢åŠ æ•°é‡ï¼ˆæ‰‹åŠ¨è°ƒæ•´ï¼‰
  'decrease',     // å‡å°‘æ•°é‡ï¼ˆæ‰‹åŠ¨è°ƒæ•´ï¼‰
  'expiration',   // è¿‡æœŸè°ƒæ•´
  'termination',  // åˆåŒç»ˆæ­¢æ—¶çš„æƒç›Šå¤„ç†
]);
```

**ä¿®è®¢çŠ¶æ€æšä¸¾ï¼ˆrevision_statusï¼‰ï¼š**

```typescript
export const revisionStatusEnum = pgEnum('revision_status', [
  'pending',   // å¾…å®¡æ ¸
  'approved',  // å·²æ‰¹å‡†
  'rejected',  // å·²æ‹’ç»
  'applied',   // å·²åº”ç”¨ï¼ˆç”Ÿæ•ˆï¼‰
]);
```

**Schema å®šä¹‰ï¼š**

```typescript
export const contractEntitlementRevisions = pgTable(
  'contract_entitlement_revisions',
  {
    id: uuid('id').defaultRandom().primaryKey(),

    // å…³è”åˆåŒï¼ˆå¿…å¡«ï¼‰
    contractId: uuid('contract_id')
      .notNull()
      .references(() => contracts.id, { onDelete: 'cascade' }),

    // å…³è”æƒç›Šè®°å½•ï¼ˆå¯ç©ºï¼ŒæŸäº›å†å²è®°å½•å¯èƒ½ä¸å…³è”å…·ä½“æƒç›Šï¼‰
    entitlementId: uuid('entitlement_id').references(
      () => contractServiceEntitlements.id,
      { onDelete: 'set null' }
    ),

    // æœåŠ¡æ ‡è¯†
    serviceType: varchar('service_type', { length: 100 }).notNull(),
    serviceName: varchar('service_name', { length: 500 }).notNull(),

    // ä¿®è®¢ç‰ˆæœ¬å·ï¼ˆåˆåŒå†…å…¨å±€é€’å¢ï¼‰
    revisionNumber: integer('revision_number').notNull(),

    // ä¿®è®¢å…ƒæ•°æ®
    revisionType: entitlementRevisionTypeEnum('revision_type').notNull(),
    source: varchar('source', { length: 50 }).notNull(), // 'product', 'addon', 'promotion', 'compensation'

    // æ•°é‡å˜æ›´
    quantityChanged: integer('quantity_changed').notNull(),  // æ­£æ•°=å¢åŠ ï¼Œè´Ÿæ•°=å‡å°‘
    totalQuantity: integer('total_quantity').notNull(),      // å˜æ›´åçš„æ€»é‡
    availableQuantity: integer('available_quantity').notNull(), // å˜æ›´åçš„å¯ç”¨é‡

    // å®¡æ ¸å·¥ä½œæµ
    status: revisionStatusEnum('status').notNull().default('pending'),
    requiresApproval: boolean('requires_approval').notNull().default(false),
    approvedBy: uuid('approved_by').references(() => users.id),
    approvedAt: timestamp('approved_at', { withTimezone: true }),
    approvalNotes: text('approval_notes'),

    // å˜æ›´åŸå› å’Œè¯´æ˜
    addOnReason: text('add_on_reason'),  // addon/promotion/compensation æ—¶å¿…å¡«
    description: text('description'),
    attachments: json('attachments').$type<string[]>(),  // é™„ä»¶URLæ•°ç»„

    // æ“ä½œäºº
    createdBy: uuid('created_by').references(() => users.id),

    // å…³è”ä¸šåŠ¡è®°å½•
    relatedBookingId: uuid('related_booking_id'),
    relatedHoldId: uuid('related_hold_id'),
    relatedProductId: uuid('related_product_id'),

    // å¿«ç…§ä¿¡æ¯ï¼ˆç”¨äºå®¡è®¡è¿½æº¯ï¼‰
    snapshot: json('snapshot').$type<{
      serviceSnapshot?: any;
      productSnapshot?: any;
      originItems?: any[];
    }>(),

    // å®¡è®¡å­—æ®µ
    createdAt: timestamp('created_at', { withTimezone: true })
      .defaultNow()
      .notNull(),
  }
);
```

**ç´¢å¼•å®šä¹‰ï¼ˆ9ä¸ªï¼‰ï¼š**

```typescript
// 1. æŒ‰åˆåŒæŸ¥è¯¢ä¿®è®¢å†å²
CREATE INDEX idx_entitlement_revisions_contract
ON contract_entitlement_revisions(contract_id);

// 2. æŒ‰æƒç›Šè®°å½•æŸ¥è¯¢ä¿®è®¢å†å²
CREATE INDEX idx_entitlement_revisions_entitlement
ON contract_entitlement_revisions(entitlement_id);

// 3. æŒ‰æœåŠ¡ç±»å‹æŸ¥è¯¢
CREATE INDEX idx_entitlement_revisions_service_type
ON contract_entitlement_revisions(service_type);

// 4. æŒ‰ä¿®è®¢ç±»å‹æŸ¥è¯¢
CREATE INDEX idx_entitlement_revisions_revision_type
ON contract_entitlement_revisions(revision_type);

// 5. æŒ‰çŠ¶æ€æŸ¥è¯¢ï¼ˆå®¡æ‰¹æµç¨‹ï¼‰
CREATE INDEX idx_entitlement_revisions_status
ON contract_entitlement_revisions(status);

// 6. æŒ‰åˆ›å»ºæ—¶é—´æŸ¥è¯¢
CREATE INDEX idx_entitlement_revisions_created_at
ON contract_entitlement_revisions(created_at DESC);

// 7. å”¯ä¸€çº¦æŸï¼šåˆåŒå†…ç‰ˆæœ¬å·å¿…é¡»å”¯ä¸€
CREATE UNIQUE INDEX idx_entitlement_revisions_version_unique
ON contract_entitlement_revisions(contract_id, revision_number);

// 8. å¤åˆç´¢å¼•ï¼šæŒ‰åˆåŒ+æœåŠ¡ç±»å‹æŸ¥è¯¢
CREATE INDEX idx_entitlement_revisions_contract_service
ON contract_entitlement_revisions(contract_id, service_type, revision_number DESC);

// 9. Partial Indexï¼šå¾…å®¡æ‰¹æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_entitlement_revisions_pending_approval
ON contract_entitlement_revisions(status, requires_approval)
WHERE status = 'pending' AND requires_approval = true;
```

**CHECK çº¦æŸï¼š**

```typescript
// çº¦æŸ1ï¼šquantityChanged ä¸èƒ½ä¸º 0
ALTER TABLE contract_entitlement_revisions
ADD CONSTRAINT chk_quantity_changed_not_zero CHECK (quantity_changed != 0);

// çº¦æŸ2ï¼špending çŠ¶æ€å¿…é¡»æœ‰ requires_approval=true
ALTER TABLE contract_entitlement_revisions
ADD CONSTRAINT chk_approval_consistency CHECK (
  (status != 'pending') OR
  (status = 'pending' AND requires_approval = true)
);
```

**TypeScript ç±»å‹ï¼š**

```typescript
export type ContractEntitlementRevision =
  typeof contractEntitlementRevisions.$inferSelect;

export type NewContractEntitlementRevision =
  typeof contractEntitlementRevisions.$inferInsert;
```

**æ•°æ®ç¤ºä¾‹ï¼š**

```typescript
// ç¤ºä¾‹1ï¼šåˆ›å»ºåˆåŒæ—¶çš„åˆå§‹æƒç›Š
{
  id: 'revision-001',
  contractId: 'contract-123',
  entitlementId: 'entitlement-001',
  serviceType: 'session',
  serviceName: '1-on-1 Session',
  revisionNumber: 1,
  revisionType: 'initial',
  source: 'product',
  quantityChanged: 5,        // +5 æ¬¡
  totalQuantity: 5,
  availableQuantity: 5,
  status: 'applied',         // åˆå§‹æƒç›Šç›´æ¥ç”Ÿæ•ˆ
  requiresApproval: false,
  createdBy: 'counselor-001',
  createdAt: '2025-01-01T10:00:00Z',
  snapshot: {
    serviceSnapshot: { /* ... */ },
    productSnapshot: { /* ... */ }
  }
}

// ç¤ºä¾‹2ï¼šæ·»åŠ é¢å¤–æƒç›Šï¼ˆéœ€è¦å®¡æ‰¹ï¼‰
{
  id: 'revision-002',
  contractId: 'contract-123',
  entitlementId: 'entitlement-002',
  serviceType: 'mock_interview',
  serviceName: 'Mock Interview',
  revisionNumber: 2,
  revisionType: 'addon',
  source: 'addon',
  quantityChanged: 2,        // +2 æ¬¡
  totalQuantity: 2,
  availableQuantity: 2,
  status: 'pending',         // å¾…å®¡æ‰¹
  requiresApproval: true,
  addOnReason: 'ä¿ƒæˆç­¾çº¦ï¼Œé¢å¤–èµ é€2æ¬¡æ¨¡æ‹Ÿé¢è¯•',
  createdBy: 'counselor-001',
  createdAt: '2025-01-05T14:00:00Z'
}

// ç¤ºä¾‹3ï¼šå®¡æ‰¹åç”Ÿæ•ˆ
{
  id: 'revision-002',
  status: 'applied',
  requiresApproval: true,
  approvedBy: 'admin-001',
  approvedAt: '2025-01-05T15:00:00Z',
  approvalNotes: 'åŒæ„è¡¥å¿ï¼Œæ‰¹å‡†2æ¬¡æ¨¡æ‹Ÿé¢è¯•'
}
```

**ä¸šåŠ¡è§„åˆ™ï¼š**

1. **ç‰ˆæœ¬å·å”¯ä¸€æ€§**ï¼šæ¯ä¸ªåˆåŒçš„ä¿®è®¢ç‰ˆæœ¬å·ä»1å¼€å§‹é€’å¢ï¼Œå¿…é¡»å”¯ä¸€
2. **å˜æ›´æ•°é‡éé›¶**ï¼š`quantityChanged` ä¸èƒ½ä¸º0ï¼ˆæ­£æ•°=å¢åŠ ï¼Œè´Ÿæ•°=å‡å°‘ï¼‰
3. **å®¡æ‰¹ä¸€è‡´æ€§**ï¼š`status='pending'` æ—¶ï¼Œå¿…é¡»æœ‰ `requires_approval=true`
4. **åŸå› å¿…å¡«**ï¼šå½“ `source` ä¸º `addon`/`promotion`/`compensation` æ—¶ï¼Œ`addOnReason` å¿…å¡«
5. **å¿«ç…§å®Œæ•´æ€§**ï¼š`revisionType='initial'` æ—¶ï¼Œå»ºè®®åŒ…å« `productSnapshot` å’Œ `serviceSnapshot`
6. **æƒç›Šå…³è”**ï¼š`entitlementId` åº”å…³è”åˆ°è¢«ä¿®æ”¹çš„å…·ä½“æƒç›Šè®°å½•ï¼ˆç”¨äºç²¾ç¡®è¿½æº¯ï¼‰

**ä½¿ç”¨åœºæ™¯ï¼š**

```typescript
// åœºæ™¯1ï¼šæŸ¥è¯¢åˆåŒçš„æ‰€æœ‰æƒç›Šä¿®è®¢å†å²
const revisions = await db.query.contractEntitlementRevisions.findMany({
  where: eq(contractEntitlementRevisions.contractId, 'contract-123'),
  orderBy: [desc(contractEntitlementRevisions.revisionNumber)],
});

// åœºæ™¯2ï¼šæŸ¥è¯¢ç‰¹å®šæƒç›Šçš„ä¿®è®¢å†å²
const entitlementRevisions = await db.query.contractEntitlementRevisions.findMany({
  where: eq(contractEntitlementRevisions.entitlementId, 'entitlement-001'),
  orderBy: [asc(contractEntitlementRevisions.revisionNumber)],
});

// åœºæ™¯3ï¼šæŸ¥è¯¢å¾…å®¡æ‰¹çš„ä¿®è®¢
const pendingRevisions = await db.query.contractEntitlementRevisions.findMany({
  where: and(
    eq(contractEntitlementRevisions.status, 'pending'),
    eq(contractEntitlementRevisions.requiresApproval, true)
  ),
});

// åœºæ™¯4ï¼šç»Ÿè®¡æŸä¸ªåˆåŒçš„ä¿®è®¢æ¬¡æ•°
const [stats] = await db
  .select({
    totalRevisions: count(),
    initialRevisions: count().filter(
      eq(contractEntitlementRevisions.revisionType, 'initial')
    ),
    addonRevisions: count().filter(
      eq(contractEntitlementRevisions.revisionType, 'addon')
    ),
  })
  .from(contractEntitlementRevisions)
  .where(eq(contractEntitlementRevisions.contractId, 'contract-123'));
```

**æ€§èƒ½ä¼˜åŒ–ï¼š**

1. **9ä¸ªç´¢å¼•**è¦†ç›–æ‰€æœ‰å¸¸è§æŸ¥è¯¢åœºæ™¯
2. **å¤åˆç´¢å¼•**ä¼˜åŒ–æŒ‰åˆåŒ+æœåŠ¡ç±»å‹æŸ¥è¯¢
3. **Partial Index**ä¼˜åŒ–å¾…å®¡æ‰¹æŸ¥è¯¢ï¼ˆ`WHERE status='pending' AND requires_approval=true`ï¼‰
4. **æ•´æ•°ç±»å‹**çš„ revisionNumber æ’åºé«˜æ•ˆ
5. **UUIDç±»å‹**çš„å…³è”å­—æ®µæ”¯æŒå¿«é€ŸJOIN

**æ–‡ä»¶ä½ç½®ï¼š**
- Schema: `src/infrastructure/database/schema/contract-entitlement-revisions.schema.ts`
- SQLè¿ç§»: `src/infrastructure/database/migrations/0002_add_contract_entitlement_revisions.sql`

---

## 4. é¢†åŸŸæœåŠ¡æ¥å£

### 4.1 æ ¸å¿ƒæœåŠ¡åˆ—è¡¨

Contract Domain æä¾› 4 ä¸ªæ ¸å¿ƒæœåŠ¡ï¼š

| æœåŠ¡åç§°                        | æ–¹æ³•æ•° | èŒè´£                           |
| ------------------------------- | ------ | ------------------------------ |
| `ContractService`              | 12     | åˆåŒç®¡ç†å’ŒæœåŠ¡æƒç›Šç®¡ç†         |
| `ServiceLedgerService`         | 5      | æœåŠ¡æµæ°´è®°å½•å’Œä½™é¢å¯¹è´¦         |
| `ServiceHoldService`           | 5      | æœåŠ¡é¢„å ç®¡ç†ï¼ˆTTLæœºåˆ¶ï¼‰         |
| `ServiceLedgerArchiveService`  | 4      | æµæ°´å½’æ¡£ç®¡ç†ï¼ˆå†·çƒ­åˆ†ç¦»ï¼‰        |

> **v2.16.7 æ›´æ–°**ï¼š`ContractService` å¢åŠ  3 ä¸ªæ–¹æ³•ï¼Œç”¨äºæƒç›Šä¿®è®¢å†å²ç®¡ç†

### 4.2 ContractService - åˆåŒç®¡ç†æœåŠ¡

**èŒè´£ï¼š** åˆåŒå…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…å«æœåŠ¡æƒç›Šç®¡ç†

```typescript
interface ContractService {
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // åˆåŒç®¡ç†ï¼ˆ9ä¸ªæ–¹æ³•ï¼‰
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /**
   * åˆ›å»ºåˆåŒ
   * - åŸºäºäº§å“åˆ›å»ºåˆåŒ
   * - ä»äº§å“æ´¾ç”ŸæœåŠ¡æƒç›Š
   * - å‘å¸ƒ contract.signed äº‹ä»¶
   */
  create(dto: CreateContractDto): Promise<Contract>;

  /**
   * æŸ¥è¯¢åˆåŒåˆ—è¡¨ï¼ˆåˆ†é¡µã€ç­›é€‰ã€æ’åºï¼‰
   */
  search(
    filter: ContractFilterDto,
    pagination?: PaginationDto,
    sort?: SortDto
  ): Promise<PaginatedResult<Contract>>;

  /**
   * æŸ¥è¯¢å•ä¸ªåˆåŒï¼ˆæ”¯æŒå¤šç§æŸ¥è¯¢æ¡ä»¶ï¼‰
   * - æ”¯æŒæŒ‰ contractId æŸ¥è¯¢
   * - æ”¯æŒæŒ‰ contractNumber æŸ¥è¯¢
   * - æ”¯æŒæŒ‰ studentId + status ç»„åˆæŸ¥è¯¢
   * - è¿”å›å”¯ä¸€åŒ¹é…çš„åˆåŒï¼Œä¸å­˜åœ¨åˆ™è¿”å› null
   */
  findOne(filter: FindOneContractDto): Promise<Contract | null>;

  /**
   * æ›´æ–°åˆåŒä¿¡æ¯ï¼ˆä»…draftçŠ¶æ€å¯æ›´æ–°ï¼‰
   */
  update(id: string, dto: UpdateContractDto): Promise<Contract>;

  /**
   * æ¿€æ´»åˆåŒ
   * - ç›‘å¬ payment.succeeded äº‹ä»¶è§¦å‘
   * - æ›´æ–°çŠ¶æ€ä¸º active
   * - åˆå§‹åŒ–æœåŠ¡æƒç›Šä½™é¢
   * - å‘å¸ƒ contract.activated äº‹ä»¶
   */
  activate(id: string): Promise<Contract>;

  /**
   * ç»ˆæ­¢åˆåŒ
   * - æ›´æ–°çŠ¶æ€ä¸º terminated
   * - è®°å½•ç»ˆæ­¢åŸå› 
   * - å‘å¸ƒ contract.terminated äº‹ä»¶
   */
  terminate(id: string, reason: string): Promise<Contract>;

  /**
   * å®ŒæˆåˆåŒï¼ˆè‡ªåŠ¨è§¦å‘æˆ–æ‰‹åŠ¨è§¦å‘ï¼‰
   * - è§¦å‘æ¡ä»¶ï¼šæ‰€æœ‰æœåŠ¡å·²æ¶ˆè´¹å®Œ OR åˆåŒå·²è¿‡æœŸ
   * - æ›´æ–°çŠ¶æ€ä¸º completed
   * - å‘å¸ƒ contract.completed äº‹ä»¶
   * - å¯ç”±å®šæ—¶ä»»åŠ¡è‡ªåŠ¨è§¦å‘ï¼Œä¹Ÿå¯æ‰‹åŠ¨è§¦å‘
   */
  complete(id: string): Promise<Contract>;

  /**
   * æš‚åœåˆåŒï¼ˆä»…ç®¡ç†å‘˜ï¼‰
   * - æ›´æ–°çŠ¶æ€ä¸º suspended
   * - è®°å½•æš‚åœåŸå› 
   * - å‘å¸ƒ contract.suspended äº‹ä»¶
   * - æƒé™ï¼šä»…å…·æœ‰ admin è§’è‰²çš„ç”¨æˆ·å¯æš‚åœ
   */
  suspend(id: string, reason: string): Promise<Contract>;

  /**
   * æ¢å¤å·²æš‚åœçš„åˆåŒ
   * - æ›´æ–°çŠ¶æ€å›åˆ° active
   * - å‘å¸ƒ contract.resumed äº‹ä»¶
   * - æƒé™ï¼šä»…å…·æœ‰ admin è§’è‰²çš„ç”¨æˆ·å¯æ¢å¤
   */
  resume(id: string): Promise<Contract>;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // æœåŠ¡æƒç›Šç®¡ç†ï¼ˆ3ä¸ªæ–¹æ³•ï¼‰ğŸ†•v2.16
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /**
   * æŸ¥è¯¢æœåŠ¡æƒç›Šä½™é¢ï¼ˆæ”¯æŒçµæ´»æŸ¥è¯¢æ¡ä»¶ï¼‰
   * - æ”¯æŒæŒ‰ contractId æŸ¥è¯¢ç‰¹å®šåˆåŒçš„æƒç›Š
   * - æ”¯æŒæŒ‰ studentId æŸ¥è¯¢å­¦ç”Ÿæ‰€æœ‰åˆåŒçš„æƒç›Š
   * - æ”¯æŒæŒ‰ serviceType è¿‡æ»¤ç‰¹å®šæœåŠ¡ç±»å‹
   * - æŒ‰æœåŠ¡ç±»å‹æ±‡æ€»ï¼Œä¸åŒºåˆ†æ¥æºï¼ˆå†³ç­– #7ï¼‰
   * - è¿”å›æ€»é‡ã€å·²æ¶ˆè´¹ã€é¢„å ã€å¯ç”¨
   */
  getServiceBalance(query: ServiceBalanceQuery): Promise<ServiceBalance>;

  /**
   * æ‰£å‡æœåŠ¡æƒç›Šï¼ˆå†…éƒ¨æ–¹æ³•ï¼Œç”±äº‹ä»¶ç›‘å¬å™¨è°ƒç”¨ï¼‰
   * - ç›‘å¬ session.completed äº‹ä»¶
   * - æŒ‰ä¼˜å…ˆçº§æ‰£å‡ï¼šproduct > addon > promotion > compensationï¼ˆå†³ç­– #6ï¼‰
   * - æ‰£å‡æœåŠ¡æƒç›Šä½™é¢
   * - åˆ›å»ºæœåŠ¡æµæ°´
   * - é‡Šæ”¾å…³è”çš„é¢„å ï¼ˆå¦‚æœæœ‰ï¼‰
   */
  consumeService(dto: ConsumeServiceDto): Promise<void>;

  /**
   * æ·»åŠ é¢å¤–æƒç›Š ğŸ†•v2.16
   * - ä¿ƒæˆç­¾çº¦ï¼šé¢å¤–èµ é€æœåŠ¡
   * - ä¿ƒé”€æ´»åŠ¨ï¼šé™æ—¶èµ é€
   * - è¡¥å¿ï¼šæœåŠ¡è´¨é‡é—®é¢˜è¡¥å¿
   * - è‡ªåŠ¨è®°å½•æƒç›Šä¿®è®¢å†å²ï¼ˆrevisionNumberé€’å¢ï¼‰ğŸ†•v2.16.8
   * - æ”¯æŒéœ€è¦å®¡æ‰¹çš„æƒç›Šå˜æ›´ï¼ˆrequiresApproval=true æ—¶ status='pending'ï¼‰ğŸ†•v2.16.8
   * - è®°å½• addOnReason ç”¨äºå®¡è®¡è¿½æº¯ğŸ†•v2.16.8
   *
   * @param dto - æ·»åŠ æƒç›Šçš„å‚æ•°ï¼ˆåŒ…å« source, addOnReason, requiresApproval ç­‰ï¼‰
   * @returns è¿”å›æ›´æ–°/åˆ›å»ºçš„æƒç›Šè®°å½•
   * @throws ContractException å¦‚æœä½™é¢ä¸è¶³æˆ–å‚æ•°éªŒè¯å¤±è´¥
   *
   * @example
   * // åœºæ™¯1ï¼šæ·»åŠ ä¿ƒæˆç­¾çº¦çš„æƒç›Šï¼ˆç›´æ¥ç”Ÿæ•ˆï¼‰
   * await contractService.addEntitlement({
   *   contractId: 'contract-123',
   *   serviceType: 'mock_interview',
   *   totalQuantity: 2,
   *   source: 'addon',
   *   addOnReason: 'ä¿ƒæˆç­¾çº¦ï¼Œé¢å¤–èµ é€2æ¬¡æ¨¡æ‹Ÿé¢è¯•',
   *   requiresApproval: false,
   *   createdBy: 'counselor-001'
   * });
   *
   * @example
   * // åœºæ™¯2ï¼šæ·»åŠ éœ€è¦å®¡æ‰¹çš„è¡¥å¿æƒç›Š
   * await contractService.addEntitlement({
   *   contractId: 'contract-123',
   *   serviceType: 'session',
   *   totalQuantity: 5,
   *   source: 'compensation',
   *   addOnReason: 'å¯¼å¸ˆç¼ºå¸­è¡¥å¿5æ¬¡session',
   *   requiresApproval: true, // éœ€è¦ç®¡ç†å‘˜å®¡æ‰¹
   *   createdBy: 'counselor-001'
   * });
   * // è¿”å›çš„æƒç›ŠçŠ¶æ€ä¸º 'pending'ï¼Œéœ€è¦è°ƒç”¨ approveRevision() æ‰èƒ½ç”Ÿæ•ˆ
   */
  addEntitlement(dto: AddEntitlementDto): Promise<ContractServiceEntitlement>;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // æƒç›Šä¿®è®¢å†å²ç®¡ç†ï¼ˆ3ä¸ªæ–¹æ³•ï¼‰ğŸ†•v2.16.7
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  /**
   * æŸ¥è¯¢åˆåŒæƒç›Šä¿®è®¢å†å²
   * - æ”¯æŒæŒ‰ contractId æŸ¥è¯¢åˆåŒçš„æ‰€æœ‰ä¿®è®¢
   * - å¯é€‰ï¼šæŒ‰ serviceType è¿‡æ»¤ç‰¹å®šæœåŠ¡ç±»å‹
   * - å¯é€‰ï¼šæŒ‰ revisionType è¿‡æ»¤ä¿®è®¢ç±»å‹
   * - å¯é€‰ï¼šæŒ‰ status è¿‡æ»¤å®¡æ‰¹çŠ¶æ€
   * - æŒ‰ revisionNumber é™åºæ’åˆ—ï¼ˆæœ€æ–°åœ¨å‰ï¼‰
   */
  getEntitlementRevisions(
    contractId: string,
    options?: {
      serviceType?: string;
      revisionType?: string;
      status?: 'pending' | 'approved' | 'rejected' | 'applied';
    }
  ): Promise<ContractEntitlementRevision[]>;

  /**
   * å®¡æ‰¹æƒç›Šä¿®è®¢
   * - å°† status ä» 'pending' æ›´æ–°ä¸º 'approved'
   * - æ›´æ–° approvedBy å’Œ approvedAt
   * - è®°å½• approvalNotes
   * - æ›´æ–° contract_service_entitlements è¡¨ï¼ˆåº”ç”¨å˜æ›´ï¼‰
   * - æœ€åå°† status æ›´æ–°ä¸º 'applied'
   * - æƒé™ï¼šä»…å…·æœ‰ admin æˆ–å®¡æ‰¹æƒé™çš„ç”¨æˆ·å¯è°ƒç”¨
   *
   * @param revisionId - ä¿®è®¢è®°å½•ID
   * @param approverId - å®¡æ‰¹äººID
   * @param notes - å®¡æ‰¹å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰
   */
  approveRevision(
    revisionId: string,
    approverId: string,
    notes?: string
  ): Promise<void>;

  /**
   * æ‹’ç»æƒç›Šä¿®è®¢
   * - å°† status ä» 'pending' æ›´æ–°ä¸º 'rejected'
   * - æ›´æ–° approvedBy å’Œ approvedAt
   * - è®°å½• approvalNotesï¼ˆæ‹’ç»åŸå› ï¼‰
   * - ä¸ä¿®æ”¹ contract_service_entitlements è¡¨ï¼ˆä¸åº”ç”¨å˜æ›´ï¼‰
   * - æƒé™ï¼šä»…å…·æœ‰ admin æˆ–å®¡æ‰¹æƒé™çš„ç”¨æˆ·å¯è°ƒç”¨
   *
   * @param revisionId - ä¿®è®¢è®°å½•ID
   * @param approverId - å®¡æ‰¹äººID
   * @param reason - æ‹’ç»åŸå› 
   */
  rejectRevision(
    revisionId: string,
    approverId: string,
    reason: string
  ): Promise<void>;
}
```

### 4.3 ServiceLedgerService - æœåŠ¡æµæ°´ç®¡ç†æœåŠ¡

**èŒè´£ï¼š** æœåŠ¡æµæ°´è¿½è¸ªå’Œä½™é¢ç®¡ç†ï¼ˆAppend-onlyï¼‰

```typescript
interface ServiceLedgerService {
  /**
   * è®°å½•æœåŠ¡æ¶ˆè´¹
   * - quantity < 0
   * - åˆ›å»º consumption ç±»å‹æµæ°´
   * - æ›´æ–° balanceAfter å¿«ç…§
   */
  recordConsumption(dto: RecordConsumptionDto): Promise<ServiceLedger>;

  /**
   * è®°å½•æ‰‹åŠ¨è°ƒæ•´
   * - quantity å¯æ­£å¯è´Ÿ
   * - å¿…é¡»å¡«å†™ reason
   * - åˆ›å»º adjustment ç±»å‹æµæ°´
   */
  recordAdjustment(dto: RecordAdjustmentDto): Promise<ServiceLedger>;

  /**
   * è®¡ç®—å¯ç”¨ä½™é¢
   * - æ€»ä½™é¢ - æ´»è·ƒé¢„å æ•°é‡
   */
  calculateAvailableBalance(
    contractId: string,
    serviceType: string
  ): Promise<BalanceInfo>;

  /**
   * æŸ¥è¯¢æµæ°´è®°å½•
   * - æ”¯æŒè·¨ä¸»è¡¨+å½’æ¡£è¡¨æŸ¥è¯¢ï¼ˆUNION ALLï¼‰
   * - æ”¯æŒåˆ†é¡µã€ç­›é€‰ã€æ’åº
   */
  queryLedgers(query: LedgerQueryDto): Promise<PaginatedResult<ServiceLedger>>;

  /**
   * éªŒè¯ä½™é¢å¯¹è´¦
   * - é€šè¿‡ balanceAfter å¿«ç…§éªŒè¯ä½™é¢æ­£ç¡®æ€§
   * - ç”¨äºå®¡è®¡å’Œæ•°æ®ä¿®å¤
   */
  verifyBalance(
    contractId: string,
    serviceType: string
  ): Promise<BalanceVerificationResult>;
}
```

### 4.4 ServiceHoldService - æœåŠ¡é¢„å ç®¡ç†æœåŠ¡

**èŒè´£ï¼š** TTL æœºåˆ¶é˜²æ­¢è¶…é¢é¢„çº¦

```typescript
// Drizzle äº‹åŠ¡ç±»å‹ï¼ˆv2.16.7ï¼‰
// ä» drizzle-orm å¯¼å…¥ï¼šimport { type PgTransaction } from 'drizzle-orm/pg-core';
type DrizzleTransaction = any; // å®é™…ç±»å‹ä¸º PgTransaction<...>

interface ServiceHoldService {
  /**
   * åˆ›å»ºé¢„å 
   * - æ£€æŸ¥å¯ç”¨ä½™é¢
   * - åˆ›å»ºé¢„å è®°å½•
   * - è®¾ç½® TTLï¼ˆç¯å¢ƒå˜é‡å¯é…ç½®ï¼Œé»˜è®¤ 15 åˆ†é’Ÿ - å†³ç­– #11ï¼‰
   * - æ›´æ–°æƒç›Šè¡¨ï¼šheldQuantity += 1, availableQuantity -= 1
   *
   * @param dto - åˆ›å»ºé¢„å çš„æ•°æ®
   * @param tx - å¯é€‰çš„ Drizzle äº‹åŠ¡å¯¹è±¡ï¼Œæ”¯æŒåœ¨å¤–éƒ¨äº‹åŠ¡ä¸­åˆ›å»ºé¢„å ï¼ˆv2.16.7ï¼‰
   * @returns åˆ›å»ºçš„é¢„å è®°å½•
   */
  createHold(dto: CreateHoldDto, tx?: DrizzleTransaction): Promise<ServiceHold>;

  /**
   * é‡Šæ”¾é¢„å 
   * - æ›´æ–°çŠ¶æ€ä¸º released
   * - ç”Ÿæˆæ¶ˆè´¹æµæ°´ï¼ˆå¦‚æœæœåŠ¡å®Œæˆï¼‰
   * - æ›´æ–°æƒç›Šè¡¨ï¼šheldQuantity -= 1
   */
  releaseHold(holdId: string, reason: string): Promise<ServiceHold>;

  /**
   * æ¸…ç†è¿‡æœŸé¢„å ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
   * - æŸ¥è¯¢ expiresAt < now ä¸” status = 'active'
   * - æ‰¹é‡æ›´æ–°ä¸º expired
   * - é‡Šæ”¾æƒç›Šä½™é¢
   */
  cleanupExpiredHolds(): Promise<number>;

  /**
   * æŸ¥è¯¢æ´»è·ƒé¢„å 
   * - å­¦ç”Ÿçš„æ‰€æœ‰æ´»è·ƒé¢„å 
   * - å¯é€‰æŒ‰æœåŠ¡ç±»å‹ç­›é€‰
   */
  findActiveHolds(
    contractId: string,
    serviceType?: string
  ): Promise<ServiceHold[]>;

  /**
   * å»¶é•¿é¢„å æ—¶é—´
   * - å»¶é•¿ TTLï¼ˆå¦‚å­¦ç”Ÿéœ€è¦æ›´å¤šæ—¶é—´å®Œæˆé¢„çº¦ï¼‰
   */
  extendHold(holdId: string, additionalMinutes: number): Promise<ServiceHold>;
}
```

### 4.5 ServiceLedgerArchiveService - æµæ°´å½’æ¡£ç®¡ç†æœåŠ¡

**èŒè´£ï¼š** å†·çƒ­åˆ†ç¦»å½’æ¡£ç®¡ç†

```typescript
interface ServiceLedgerArchiveService {
  /**
   * æ‰§è¡Œå½’æ¡£ä»»åŠ¡ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
   * - æŸ¥è¯¢è¶…è¿‡ä¿ç•™æœŸçš„æµæ°´ï¼ˆé»˜è®¤ 90 å¤©ï¼‰
   * - æ‰¹é‡å¤åˆ¶åˆ°å½’æ¡£è¡¨
   * - å¯é€‰åˆ é™¤ä¸»è¡¨æ•°æ®
   */
  archiveOldLedgers(daysOld?: number): Promise<ArchiveResult>;

  /**
   * æŸ¥è¯¢å½’æ¡£ç­–ç•¥
   * - ä¼˜å…ˆçº§ï¼šcontract > service_type > global
   */
  getArchivePolicy(
    contractId?: string,
    serviceType?: string
  ): Promise<ArchivePolicy>;

  /**
   * è®¾ç½®å½’æ¡£ç­–ç•¥
   * - æ”¯æŒå…¨å±€ã€åˆåŒçº§ã€æœåŠ¡ç±»å‹çº§ç­–ç•¥
   */
  setArchivePolicy(dto: SetArchivePolicyDto): Promise<ArchivePolicy>;

  /**
   * è·¨è¡¨æŸ¥è¯¢æµæ°´
   * - ä¸»è¡¨ + å½’æ¡£è¡¨ UNION ALL
   * - æ”¯æŒåˆ†é¡µã€ç­›é€‰ã€æ’åº
   */
  queryLedgersWithArchive(
    query: LedgerQueryDto
  ): Promise<PaginatedResult<ServiceLedger>>;
}
```

---

## 5. DTO å®šä¹‰

### 5.1 Contract DTOs

#### CreateContractDto (v2.16.4 æ›´æ–°)

```typescript
interface CreateContractDto {
  // å…³è”æ–¹
  studentId: string;
  counselorId?: string;

  // åˆåŒä¿¡æ¯
  title?: string;
  description?: string;

  // ğŸ”‘ äº§å“å¿«ç…§ï¼ˆv2.16.3 - ä» Catalog Domain è·å–ï¼‰
  productSnapshot: IProductSnapshot; // å¿…å¡«ï¼åŒ…å«å®Œæ•´çš„äº§å“å’ŒæœåŠ¡ä¿¡æ¯

  // ğŸ†• v2.16.4: å…è®¸è¦†ç›–å®šä»·ï¼ˆå†³ç­– #12ï¼‰
  totalAmount?: string;   // å¯é€‰ï¼šè¦†ç›– productSnapshot.priceï¼ˆæ”¯æŒä¿ƒé”€æŠ˜æ‰£ã€å®šåˆ¶åŒ–å®šä»·ï¼‰
  currency?: string;      // å¯é€‰ï¼šè¦†ç›– productSnapshot.currencyï¼ˆé»˜è®¤ USDï¼‰

  // å…ƒæ•°æ®
  metadata?: {
    pdfUrl?: string;
    attachments?: string[];
    terms?: Record<string, any>;
  };
}

// å­—æ®µä¼˜å…ˆçº§ï¼š
// - productId â†’ productSnapshot.productIdï¼ˆå¿…å¡«ï¼‰
// - totalAmount â†’ dto.totalAmount ?? productSnapshot.priceï¼ˆå¯è¦†ç›–ï¼‰
// - currency â†’ dto.currency ?? productSnapshot.currencyï¼ˆå¯è¦†ç›–ï¼‰
// - validityDays â†’ productSnapshot.validityDaysï¼ˆä¸å¯è¦†ç›–ï¼‰
```

#### UpdateContractDto

```typescript
interface UpdateContractDto {
  title?: string;
  description?: string;
  metadata?: {
    pdfUrl?: string;
    attachments?: string[];
    terms?: Record<string, any>;
  };
}
```

#### FindOneContractDto (v2.16.7 æ–°å¢)

```typescript
interface FindOneContractDto {
  // æ–¹å¼1ï¼šæŒ‰åˆåŒIDæŸ¥è¯¢
  contractId?: string;

  // æ–¹å¼2ï¼šæŒ‰åˆåŒç¼–å·æŸ¥è¯¢
  contractNumber?: string;

  // æ–¹å¼3ï¼šæŒ‰ç»„åˆæ¡ä»¶æŸ¥è¯¢
  studentId?: string;           // å­¦ç”ŸID
  status?: ContractStatus;      // åˆåŒçŠ¶æ€
  productId?: string;           // äº§å“ID
}

// éªŒè¯è§„åˆ™ï¼š
// - contractIdã€contractNumberã€(studentId + status)ã€(studentId + productId) è‡³å°‘æä¾›ä¸€ç§æŸ¥è¯¢æ–¹å¼
// - å¦‚æœæä¾› contractIdï¼Œåˆ™å¿½ç•¥å…¶ä»–æ¡ä»¶ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
// - å¦‚æœæä¾› contractNumberï¼Œåˆ™å¿½ç•¥ç»„åˆæ¡ä»¶ï¼ˆæ¬¡ä¼˜å…ˆçº§ï¼‰
// - ç»„åˆæ¡ä»¶æŸ¥è¯¢æ—¶ï¼Œå¿…é¡»ç¡®ä¿è¿”å›å”¯ä¸€ç»“æœï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸

// ä½¿ç”¨ç¤ºä¾‹ï¼š
// 1. findOne({ contractId: 'uuid' })                           // æŒ‰IDæŸ¥è¯¢
// 2. findOne({ contractNumber: 'CONTRACT-2025-11-00001' })    // æŒ‰ç¼–å·æŸ¥è¯¢
// 3. findOne({ studentId: 'uuid', status: 'active' })         // æŸ¥è¯¢å­¦ç”Ÿçš„æ´»è·ƒåˆåŒ
// 4. findOne({ studentId: 'uuid', productId: 'uuid' })        // æŸ¥è¯¢å­¦ç”Ÿçš„ç‰¹å®šäº§å“åˆåŒ
```

#### ContractFilterDto

```typescript
interface ContractFilterDto {
  studentId?: string;
  counselorId?: string;
  productId?: string;
  status?: ContractStatus | ContractStatus[];
  signedAfter?: Date;
  signedBefore?: Date;
  expiresAfter?: Date;
  expiresBefore?: Date;
}
```

#### ServiceBalanceQuery (v2.16.4 æŸ¥è¯¢æ¡ä»¶)

```typescript
interface ServiceBalanceQuery {
  // æŸ¥è¯¢æ¡ä»¶ï¼ˆcontractId æˆ– studentId è‡³å°‘æä¾›ä¸€ä¸ªï¼‰
  contractId?: string;          // æŸ¥è¯¢ç‰¹å®šåˆåŒçš„æƒç›Š
  studentId?: string;           // æŸ¥è¯¢å­¦ç”Ÿæ‰€æœ‰åˆåŒçš„æƒç›Š

  // è¿‡æ»¤æ¡ä»¶ï¼ˆå¯é€‰ï¼‰
  serviceType?: string;         // è¿‡æ»¤ç‰¹å®šæœåŠ¡ç±»å‹
  includeExpired?: boolean;     // æ˜¯å¦åŒ…å«å·²è¿‡æœŸçš„æƒç›Šï¼ˆé»˜è®¤ï¼šfalseï¼‰
}

// éªŒè¯è§„åˆ™ï¼š
// - contractId å’Œ studentId è‡³å°‘æä¾›ä¸€ä¸ª
// - å¦‚æœåŒæ—¶æä¾›ï¼Œåˆ™ä»¥ contractId ä¸ºå‡†
// - includeExpired=false æ—¶ï¼Œè‡ªåŠ¨è¿‡æ»¤ expiresAt < now() çš„æƒç›Š
```

#### ServiceBalance (v2.16.4 æŸ¥è¯¢ç»“æœ)

```typescript
interface ServiceBalance {
  // æŸ¥è¯¢å…ƒä¿¡æ¯
  query: {
    contractId?: string;
    studentId?: string;
    serviceType?: string;
  };

  // å­¦ç”Ÿä¿¡æ¯ï¼ˆæŒ‰ studentId æŸ¥è¯¢æ—¶è¿”å›ï¼‰
  student?: {
    id: string;
    name?: string;
    email?: string;
  };

  // åˆåŒçº§åˆ«çš„æƒç›Šä½™é¢åˆ—è¡¨
  contracts: Array<{
    // åˆåŒåŸºæœ¬ä¿¡æ¯
    contractId: string;
    contractCode: string;
    contractTitle?: string;
    contractStatus: string;
    studentId: string;
    signedAt?: Date;
    expiresAt?: Date;
    isExpired: boolean;           // åˆåŒæ˜¯å¦å·²è¿‡æœŸ

    // è¯¥åˆåŒä¸‹çš„æœåŠ¡æƒç›Šä½™é¢
    entitlements: Array<{
      serviceType: string;
      serviceName: string;        // æ¥è‡ª serviceSnapshot
      serviceNameEn: string;      // æ¥è‡ª serviceSnapshot
      // v2.16.4: ç§»é™¤ source å­—æ®µï¼Œä»…è¿”å›æ±‡æ€»æ•°æ®ï¼ˆå†³ç­– #7ï¼‰
      // v2.16.7: ç§»é™¤ unit å­—æ®µï¼ˆæ‰€æœ‰æœåŠ¡ç»Ÿä¸€æŒ‰æ¬¡æ•°è®¡è´¹ï¼‰
      totalQuantity: number;      // æ±‡æ€»æ‰€æœ‰æ¥æºçš„æ€»é‡ï¼ˆæ¬¡æ•°ï¼‰
      consumedQuantity: number;   // æ±‡æ€»æ‰€æœ‰æ¥æºçš„å·²æ¶ˆè´¹ï¼ˆæ¬¡æ•°ï¼‰
      heldQuantity: number;       // æ±‡æ€»æ‰€æœ‰æ¥æºçš„é¢„å ä¸­ï¼ˆæ¬¡æ•°ï¼‰
      availableQuantity: number;  // æ±‡æ€»æ‰€æœ‰æ¥æºçš„å¯ç”¨ï¼ˆæ¬¡æ•°ï¼‰
      expiresAt?: Date;           // æƒç›Šè¿‡æœŸæ—¶é—´ï¼ˆç»§æ‰¿è‡ªåˆåŒï¼‰
      isExpired: boolean;         // æƒç›Šæ˜¯å¦å·²è¿‡æœŸ
    }>;
  }>;
}

// ä½¿ç”¨åœºæ™¯ï¼š
// 1. æŸ¥è¯¢ç‰¹å®šåˆåŒçš„æ‰€æœ‰æœåŠ¡æƒç›Š
//    getServiceBalance({ contractId: 'xxx' })
//
// 2. æŸ¥è¯¢å­¦ç”Ÿæ‰€æœ‰åˆåŒçš„æœåŠ¡æƒç›Š
//    getServiceBalance({ studentId: 'xxx', includeExpired: false })
//
// 3. æŸ¥è¯¢ç‰¹å®šåˆåŒçš„ç‰¹å®šæœåŠ¡æƒç›Š
//    getServiceBalance({ contractId: 'xxx', serviceType: 'gap_analysis' })
//
// 4. æŸ¥è¯¢å­¦ç”Ÿæ‰€æœ‰ä¸€å¯¹ä¸€å’¨è¯¢æœåŠ¡çš„ä½™é¢
//    getServiceBalance({ studentId: 'xxx', serviceType: 'session' })
//
// æ³¨æ„ï¼š
// - å‰ç«¯åªå…³å¿ƒæ€»å¯ç”¨é‡ï¼Œä¸å…³å¿ƒæ¥æºæ˜ç»†
// - åå°æ¶ˆè´¹æ—¶æŒ‰ä¼˜å…ˆçº§ï¼ˆproduct > addon > promotion > compensationï¼‰æ‰£å‡
// - é™ä½å‰ç«¯å¤æ‚åº¦ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
```

### 5.2 Service Entitlement DTOs

#### AddEntitlementDto (v2.16.4 æ›´æ–°)

```typescript
interface AddEntitlementDto {
  contractId: string;
  serviceType: string;
  totalQuantity: number;
  source: 'addon' | 'promotion' | 'compensation'; // æ¥æº
  addOnReason: string; // å¿…å¡«ï¼šæ·»åŠ åŸå› 
  // v2.16.6: ç§»é™¤ unit å­—æ®µï¼ˆç»Ÿä¸€ä¸º 'times'ï¼Œç”±ç³»ç»Ÿè‡ªåŠ¨è®¾ç½®ï¼‰
  // v2.16.4: ç§»é™¤ expiresAt å­—æ®µï¼ˆå†³ç­– #5ï¼‰
  // é¢å¤–æƒç›Šç»Ÿä¸€ç»§æ‰¿åˆåŒçš„ expiresAtï¼Œä¸æ”¯æŒç‹¬ç«‹çš„è¿‡æœŸæ—¶é—´
  notes?: string;
  serviceSnapshot?: {    // v2.16.4: å¯é€‰ï¼ˆå†³ç­– #6ï¼‰
    serviceName: string;
    serviceNameEn: string;
    description?: string;
  };
}
```

#### ConsumeServiceDto (v2.16.4 æ–°å¢)

```typescript
interface ConsumeServiceDto {
  contractId: string;           // åˆåŒID
  studentId: string;            // å­¦ç”ŸIDï¼ˆæµæ°´è®°å½•å¿…éœ€ï¼‰
  serviceType: string;          // æœåŠ¡ç±»å‹
  quantity: number;             // æ¶ˆè´¹æ•°é‡ï¼ˆå¿…é¡» > 0ï¼‰
  relatedBookingId?: string;    // å…³è”é¢„çº¦IDï¼ˆå®¡è®¡è¿½æº¯ï¼‰
  relatedHoldId?: string;       // å…³è”é¢„å IDï¼ˆå¦‚æœæœ‰ï¼Œå°†è‡ªåŠ¨é‡Šæ”¾ï¼‰
  source: 'booking_completed';  // æ¶ˆè´¹æ¥æºï¼ˆå½“å‰ä»…æ”¯æŒé¢„çº¦å®Œæˆï¼‰
  metadata?: Record<string, any>; // é¢å¤–å…ƒæ•°æ®
}

// ä½¿ç”¨åœºæ™¯ï¼š
// - ç”± session.completed äº‹ä»¶ç›‘å¬å™¨è°ƒç”¨
// - è‡ªåŠ¨æŒ‰ä¼˜å…ˆçº§æ‰£å‡æƒç›Šï¼ˆproduct > addon > promotion > compensationï¼‰
// - åˆ›å»ºæœåŠ¡æ¶ˆè´¹æµæ°´
// - å¦‚æœæä¾› relatedHoldIdï¼Œè‡ªåŠ¨é‡Šæ”¾å¯¹åº”é¢„å 
```

### 5.3 Service Ledger DTOs

#### RecordConsumptionDto

```typescript
interface RecordConsumptionDto {
  contractId: string;
  studentId: string;
  serviceType: string;
  quantity: number; // å¿…é¡» < 0
  relatedHoldId?: string;
  relatedBookingId?: string;
  metadata?: Record<string, any>;
}
```

#### RecordAdjustmentDto

```typescript
interface RecordAdjustmentDto {
  contractId: string;
  studentId: string;
  serviceType: string;
  quantity: number; // å¯æ­£å¯è´Ÿ
  reason: string; // å¿…å¡«
  metadata?: Record<string, any>;
}
```

#### LedgerQueryDto

```typescript
interface LedgerQueryDto {
  contractId?: string;
  studentId?: string;
  serviceType?: string;
  type?: ServiceLedgerType | ServiceLedgerType[];
  source?: ServiceLedgerSource | ServiceLedgerSource[];
  createdAfter?: Date;
  createdBefore?: Date;
  includeArchive?: boolean; // æ˜¯å¦åŒ…å«å½’æ¡£æ•°æ®
  pagination?: PaginationDto;
  sort?: SortDto;
}
```

#### BalanceInfo

```typescript
interface BalanceInfo {
  contractId: string;
  serviceType: string;
  totalBalance: number; // æ€»ä½™é¢ï¼ˆæ¬¡æ•°ï¼Œä» contract_service_entitlements è®¡ç®—ï¼‰
  activeHolds: number; // æ´»è·ƒé¢„å æ•°é‡ï¼ˆæ¬¡æ•°ï¼‰
  availableBalance: number; // å¯ç”¨ä½™é¢ = totalBalance - activeHoldsï¼ˆæ¬¡æ•°ï¼‰
}
```

#### BalanceVerificationResult

```typescript
interface BalanceVerificationResult {
  contractId: string;
  serviceType: string;
  isValid: boolean;
  expectedBalance: number;
  actualBalance: number;
  discrepancy: number;
  errors: Array<{
    ledgerId: string;
    expectedBalanceAfter: number;
    actualBalanceAfter: number;
  }>;
}
```

### 5.4 Service Hold DTOs

#### CreateHoldDto

```typescript
interface CreateHoldDto {
  contractId: string;
  studentId: string;
  serviceType: string;
  quantity?: number; // é»˜è®¤ 1
  relatedBookingId?: string;
  createdBy: string;
}

// æ³¨æ„ï¼ˆv2.16.9ï¼‰ï¼š
// v2.16.9 ç§»é™¤ TTL æœºåˆ¶ï¼Œé¢„å æ°¸ä¸è¿‡æœŸï¼Œéœ€æ‰‹åŠ¨é‡Šæ”¾
// - createHold() æ–¹æ³•æ¥å—å¯é€‰çš„ DrizzleTransaction å‚æ•°ï¼ˆtxï¼‰
// - å¦‚æœæä¾› txï¼Œåˆ™åœ¨è¯¥äº‹åŠ¡ä¸­åˆ›å»ºé¢„å è®°å½•
// - å¦‚æœä¸æä¾› txï¼Œåˆ™ä½¿ç”¨ç‹¬ç«‹äº‹åŠ¡
//
// ä½¿ç”¨åœºæ™¯ï¼š
// 1. ç‹¬ç«‹åˆ›å»ºé¢„å ï¼šawait holdService.createHold(dto)
// 2. åœ¨å¤–éƒ¨äº‹åŠ¡ä¸­åˆ›å»ºï¼šawait holdService.createHold(dto, tx)
```

### 5.5 Archive Policy DTOs

#### SetArchivePolicyDto

```typescript
interface SetArchivePolicyDto {
  scope: 'global' | 'contract' | 'service_type';
  contractId?: string; // scope='contract' æ—¶å¿…å¡«
  serviceType?: string; // scope='service_type' æ—¶å¿…å¡«
  archiveAfterDays: number; // è¶…è¿‡Nå¤©å½’æ¡£
  deleteAfterArchive: boolean; // å½’æ¡£åæ˜¯å¦åˆ é™¤ä¸»è¡¨æ•°æ®
  enabled: boolean;
  notes?: string;
}
```

#### ArchiveResult

```typescript
interface ArchiveResult {
  totalArchived: number; // å½’æ¡£è®°å½•æ•°
  totalDeleted: number; // åˆ é™¤è®°å½•æ•°ï¼ˆå¦‚æœ deleteAfterArchive=trueï¼‰
  archivedAt: Date;
  timeTaken: number; // è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
}
```

### 5.6 Common DTOs

#### PaginationDto

```typescript
interface PaginationDto {
  page: number; // é¡µç ï¼ˆä» 1 å¼€å§‹ï¼‰
  pageSize: number; // æ¯é¡µè®°å½•æ•°
}
```

#### SortDto

```typescript
interface SortDto {
  field: string; // æ’åºå­—æ®µ
  order: 'asc' | 'desc'; // æ’åºæ–¹å‘
}
```

#### PaginatedResult<T>

```typescript
interface PaginatedResult<T> {
  data: T[];
  total: number;
  page: number;
  pageSize: number;
  totalPages: number;
}
```

### 5.7 Event Payload DTOs (v2.16.4 æ–°å¢)

**ç›®çš„ï¼š** å®šä¹‰ Contract Domain å‘å¸ƒçš„æ‰€æœ‰äº‹ä»¶è½½è·ç»“æ„

#### ContractSignedEvent

```typescript
interface ContractSignedEvent {
  eventType: 'contract.signed';
  aggregateId: string; // contractId
  occurredAt: Date;
  payload: {
    contractId: string;
    contractCode: string;
    studentId: string;
    studentName?: string;
    counselorId?: string;
    counselorName?: string;
    productId: string;
    productName: string;
    totalAmount: string;
    currency: string;
    validityDays?: number;
    signedAt: Date;
    expiresAt?: Date;
  };
}

// ä½¿ç”¨åœºæ™¯ï¼š
// - é€šçŸ¥ CRM ç³»ç»ŸåˆåŒå·²ç­¾è®¢
// - è§¦å‘æ¬¢è¿é‚®ä»¶å‘é€
// - åˆ›å»ºå¾…ä»˜æ¬¾æé†’ä»»åŠ¡
```

#### ContractActivatedEvent

```typescript
interface ContractActivatedEvent {
  eventType: 'contract.activated';
  aggregateId: string; // contractId
  occurredAt: Date;
  payload: {
    contractId: string;
    contractCode: string;
    studentId: string;
    effectiveAt: Date;
    expiresAt?: Date;
    paidAmount: string;
    // æ¿€æ´»çš„æœåŠ¡æƒç›Šåˆ—è¡¨
    entitlements: Array<{
      serviceType: string;
      serviceName: string;
      totalQuantity: number;      // æ•°é‡ï¼ˆæ¬¡æ•°ï¼Œv2.16.7ï¼šæ‰€æœ‰æœåŠ¡ç»Ÿä¸€æŒ‰æ¬¡æ•°è®¡è´¹ï¼‰
      expiresAt?: Date;
    }>;
  };
}

// ä½¿ç”¨åœºæ™¯ï¼š
// - é€šçŸ¥å­¦ç”ŸæœåŠ¡å·²æ¿€æ´»
// - å…è®¸å­¦ç”Ÿå¼€å§‹é¢„çº¦æœåŠ¡
// - è§¦å‘æœåŠ¡ä½¿ç”¨æŒ‡å—å‘é€
```

#### ContractCompletedEvent

```typescript
interface ContractCompletedEvent {
  eventType: 'contract.completed';
  aggregateId: string; // contractId
  occurredAt: Date;
  payload: {
    contractId: string;
    contractCode: string;
    studentId: string;
    completedAt: Date;
    completionReason: 'services_consumed' | 'expired'; // å®ŒæˆåŸå› 
    totalServicesConsumed: number; // æ€»æ¶ˆè´¹æœåŠ¡æ¬¡æ•°
  };
}

// ä½¿ç”¨åœºæ™¯ï¼š
// - è§¦å‘æ»¡æ„åº¦è°ƒæŸ¥
// - æ¨èç»­çº¦æˆ–æ–°äº§å“
// - å½’æ¡£åˆåŒæ•°æ®
```

#### ContractTerminatedEvent

```typescript
interface ContractTerminatedEvent {
  eventType: 'contract.terminated';
  aggregateId: string; // contractId
  occurredAt: Date;
  payload: {
    contractId: string;
    contractCode: string;
    studentId: string;
    terminatedAt: Date;
    terminationReason: string; // ç»ˆæ­¢åŸå› ï¼ˆå¿…å¡«ï¼‰
    remainingServices: Array<{
      serviceType: string;
      remainingQuantity: number;  // å‰©ä½™æ•°é‡ï¼ˆæ¬¡æ•°ï¼Œv2.16.7ï¼šæ‰€æœ‰æœåŠ¡ç»Ÿä¸€æŒ‰æ¬¡æ•°è®¡è´¹ï¼‰
    }>;
  };
}

// ä½¿ç”¨åœºæ™¯ï¼š
// - é€šçŸ¥ç›¸å…³æ–¹åˆåŒå·²ç»ˆæ­¢
// - å†»ç»“å‰©ä½™æœåŠ¡æƒç›Š
// - è§¦å‘é€€æ¬¾æµç¨‹ï¼ˆå¦‚é€‚ç”¨ï¼‰
```

#### ContractSuspendedEvent (v2.16.4 æ–°å¢)

```typescript
interface ContractSuspendedEvent {
  eventType: 'contract.suspended';
  aggregateId: string; // contractId
  occurredAt: Date;
  payload: {
    contractId: string;
    contractCode: string;
    studentId: string;
    suspendedAt: Date;
    suspensionReason: string; // æš‚åœåŸå› ï¼ˆå¿…å¡«ï¼‰
    suspendedBy: string; // æ“ä½œäººIDï¼ˆä»…ç®¡ç†å‘˜ï¼‰
  };
}

// ä½¿ç”¨åœºæ™¯ï¼š
// - é€šçŸ¥å­¦ç”ŸæœåŠ¡å·²æš‚åœ
// - é˜»æ­¢æ–°çš„æœåŠ¡é¢„çº¦
// - è®°å½•æš‚åœæ—¥å¿—
```

#### ContractResumedEvent (v2.16.4 æ–°å¢)

```typescript
interface ContractResumedEvent {
  eventType: 'contract.resumed';
  aggregateId: string; // contractId
  occurredAt: Date;
  payload: {
    contractId: string;
    contractCode: string;
    studentId: string;
    resumedAt: Date;
    resumedBy: string; // æ“ä½œäººIDï¼ˆä»…ç®¡ç†å‘˜ï¼‰
  };
}

// ä½¿ç”¨åœºæ™¯ï¼š
// - é€šçŸ¥å­¦ç”ŸæœåŠ¡å·²æ¢å¤
// - å…è®¸é‡æ–°é¢„çº¦æœåŠ¡
// - è®°å½•æ¢å¤æ—¥å¿—
```

#### äº‹ä»¶ç»“æ„è¯´æ˜

**ç»Ÿä¸€å­—æ®µï¼š**
- `eventType`: äº‹ä»¶ç±»å‹æ ‡è¯†
- `aggregateId`: èšåˆæ ¹IDï¼ˆåˆåŒIDï¼‰
- `occurredAt`: äº‹ä»¶å‘ç”Ÿæ—¶é—´ï¼ˆUTCï¼‰
- `payload`: äº‹ä»¶è½½è·ï¼ˆå…·ä½“æ•°æ®ï¼‰

**æœ€ä½³å®è·µï¼š**
- äº‹ä»¶è½½è·åº”åŒ…å«äº‹ä»¶æ¶ˆè´¹è€…éœ€è¦çš„æ‰€æœ‰å¿…è¦ä¿¡æ¯
- é¿å…åœ¨è½½è·ä¸­åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ï¼‰
- äº‹ä»¶å‘å¸ƒåä¸å¯ä¿®æ”¹ï¼ˆEvent Sourcing åŸåˆ™ï¼‰
- äº‹ä»¶åç§°ä½¿ç”¨è¿‡å»æ—¶ï¼ˆsigned, activated, completedï¼‰

### 5.8 Contract Entitlement Revision DTOs (v2.16.7 æ–°å¢)

#### CreateEntitlementRevisionDto

```typescript
/**
 * åˆ›å»ºæƒç›Šä¿®è®¢ DTO
 * ç”¨äºåœ¨ addEntitlement() å’Œ create() æ–¹æ³•å†…éƒ¨åˆ›å»ºä¿®è®¢è®°å½•
 */
interface CreateEntitlementRevisionDto {
  contractId: string;          // åˆåŒIDï¼ˆå¿…å¡«ï¼‰
  entitlementId?: string;      // æƒç›Šè®°å½•IDï¼ˆå¯é€‰ï¼‰
  serviceType: string;         // æœåŠ¡ç±»å‹ï¼ˆå¿…å¡«ï¼‰
  serviceName: string;         // æœåŠ¡åç§°å¿«ç…§ï¼ˆå¿…å¡«ï¼‰
  revisionNumber: number;      // ä¿®è®¢ç‰ˆæœ¬å·ï¼ˆå¿…å¡«ï¼‰
  revisionType: string;        // ä¿®è®¢ç±»å‹ï¼ˆå¿…å¡«ï¼‰
  source: 'product' | 'addon' | 'promotion' | 'compensation'; // æƒç›Šæ¥æº
  quantityChanged: number;     // å˜æ›´æ•°é‡ï¼ˆå¿…å¡«ï¼Œæ­£æ•°=å¢åŠ ï¼Œè´Ÿæ•°=å‡å°‘ï¼‰
  totalQuantity: number;       // å˜æ›´åæ€»é‡ï¼ˆå¿…å¡«ï¼‰
  availableQuantity: number;   // å˜æ›´åå¯ç”¨é‡ï¼ˆå¿…å¡«ï¼‰
  status?: 'pending' | 'approved' | 'rejected' | 'applied'; // çŠ¶æ€ï¼ˆé»˜è®¤ 'applied'ï¼‰
  requiresApproval?: boolean;  // æ˜¯å¦éœ€è¦å®¡æ‰¹ï¼ˆé»˜è®¤ falseï¼‰
  approvedBy?: string;         // å®¡æ‰¹äººIDï¼ˆå¯é€‰ï¼‰
  approvedAt?: Date;           // å®¡æ‰¹æ—¶é—´ï¼ˆå¯é€‰ï¼‰
  approvalNotes?: string;      // å®¡æ‰¹å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰
  addOnReason?: string;        // æ·»åŠ åŸå› ï¼ˆaddon/promotion/compensation æ—¶å¿…å¡«ï¼‰
  description?: string;        // è¯¦ç»†è¯´æ˜ï¼ˆå¯é€‰ï¼‰
  attachments?: string[];      // é™„ä»¶URLæ•°ç»„ï¼ˆå¯é€‰ï¼‰
  createdBy: string;           // æ“ä½œäººIDï¼ˆå¿…å¡«ï¼‰
  relatedBookingId?: string;   // å…³è”é¢„çº¦IDï¼ˆå¯é€‰ï¼‰
  relatedHoldId?: string;      // å…³è”é¢„å IDï¼ˆå¯é€‰ï¼‰
  relatedProductId?: string;   // å…³è”äº§å“IDï¼ˆå¯é€‰ï¼‰
  snapshot?: {                 // å¿«ç…§ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
    serviceSnapshot?: any;
    productSnapshot?: any;
    originItems?: any[];
  };
}
```

#### ApproveRevisionDto

```typescript
/**
 * å®¡æ‰¹æƒç›Šä¿®è®¢ DTO
 */
interface ApproveRevisionDto {
  revisionId: string;     // ä¿®è®¢è®°å½•IDï¼ˆå¿…å¡«ï¼‰
  approverId: string;     // å®¡æ‰¹äººIDï¼ˆå¿…å¡«ï¼‰
  notes?: string;         // å®¡æ‰¹å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰
}
```

#### RejectRevisionDto

```typescript
/**
 * æ‹’ç»æƒç›Šä¿®è®¢ DTO
 */
interface RejectRevisionDto {
  revisionId: string;     // ä¿®è®¢è®°å½•IDï¼ˆå¿…å¡«ï¼‰
  approverId: string;     // å®¡æ‰¹äººIDï¼ˆå¿…å¡«ï¼‰
  reason: string;         // æ‹’ç»åŸå› ï¼ˆå¿…å¡«ï¼‰
}
```

#### GetEntitlementRevisionsQuery

```typescript
/**
 * æŸ¥è¯¢æƒç›Šä¿®è®¢å†å²å‚æ•°
 */
interface GetEntitlementRevisionsQuery {
  contractId: string;                               // åˆåŒIDï¼ˆå¿…å¡«ï¼‰
  serviceType?: string;                             // æœåŠ¡ç±»å‹ï¼ˆå¯é€‰ï¼Œè¿‡æ»¤ï¼‰
  revisionType?: 'initial' | 'addon' | 'promotion' | 'compensation' | 'increase' | 'decrease'; // ä¿®è®¢ç±»å‹ï¼ˆå¯é€‰ï¼‰
  status?: 'pending' | 'approved' | 'rejected' | 'applied'; // çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
  page?: number;                                    // é¡µç ï¼ˆå¯é€‰ï¼Œé»˜è®¤1ï¼‰
  pageSize?: number;                                // æ¯é¡µè®°å½•æ•°ï¼ˆå¯é€‰ï¼Œé»˜è®¤20ï¼‰
  sortBy?: 'revisionNumber' | 'createdAt';          // æ’åºå­—æ®µï¼ˆå¯é€‰ï¼Œé»˜è®¤ revisionNumber DESCï¼‰
  sortOrder?: 'asc' | 'desc';                       // æ’åºæ–¹å‘ï¼ˆå¯é€‰ï¼‰
}
```

**ä½¿ç”¨åœºæ™¯ï¼š**

```typescript
// åœºæ™¯1ï¼šæŸ¥è¯¢æŸä¸ªåˆåŒçš„æ‰€æœ‰æƒç›Šä¿®è®¢å†å²
const params: GetEntitlementRevisionsQuery = {
  contractId: 'contract-123',
  sortBy: 'revisionNumber',
  sortOrder: 'desc'
};

// åœºæ™¯2ï¼šæŸ¥è¯¢ç‰¹å®šæœåŠ¡ç±»å‹çš„ä¿®è®¢å†å²
const params: GetEntitlementRevisionsQuery = {
  contractId: 'contract-123',
  serviceType: 'session',
  sortBy: 'revisionNumber',
  sortOrder: 'desc'
};

// åœºæ™¯3ï¼šæŸ¥è¯¢å¾…å®¡æ‰¹çš„ä¿®è®¢ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰
const params: GetEntitlementRevisionsQuery = {
  contractId: 'contract-123',
  status: 'pending',
  page: 1,
  pageSize: 50
};
```

---

## 6. ä¸šåŠ¡è§„åˆ™ä¸éªŒè¯

### 6.1 åˆåŒä¸šåŠ¡è§„åˆ™

#### 6.1.1 åˆ›å»ºåˆåŒ

**å‰ç½®æ¡ä»¶ï¼š**
1. âœ… å­¦ç”Ÿï¼ˆstudentIdï¼‰å¿…é¡»å­˜åœ¨
2. âœ… äº§å“å¿«ç…§ï¼ˆproductSnapshotï¼‰å·²ç”± Application Layer ä» Catalog Domain è·å–
3. âœ… äº§å“å¿«ç…§æ•°æ®å®Œæ•´ï¼ˆåŒ…å« priceã€items ç­‰å¿…è¦å­—æ®µï¼‰
4. âœ… é¡¾é—®ï¼ˆcounselorIdï¼‰å¿…é¡»å­˜åœ¨ï¼ˆå¯é€‰ï¼‰

**æ ¸å¿ƒä¸šåŠ¡çº¦æŸï¼ˆv2.16.4 å†³ç­– I3ï¼‰ï¼š**
- ğŸ“Œ **åˆåŒä¸äº§å“ä¸€å¯¹ä¸€å…³ç³»**ï¼š
  - æ¯ä¸ªåˆåŒä»…èƒ½ç»‘å®šä¸€ä¸ªäº§å“
  - åˆåŒåˆ›å»ºæ—¶å¿…é¡»æä¾›å®Œæ•´çš„ `productSnapshot`
  - åˆåŒåˆ›å»ºåä¸å¯æ›´æ¢äº§å“ï¼ˆproductId ä¸å¯å˜ï¼‰
  - äº§å“ä¿¡æ¯å›ºåŒ–åœ¨ `productSnapshot` JSON å­—æ®µä¸­

**æ‰§è¡Œé€»è¾‘ï¼š**
1. éªŒè¯äº§å“å¿«ç…§å®Œæ•´æ€§ï¼š
   - éªŒè¯ `productSnapshot.productId` å­˜åœ¨
   - éªŒè¯ `productSnapshot.price > 0`
   - éªŒè¯ `productSnapshot.items.length > 0`
   - éªŒè¯æ¯ä¸ª item çš„ `quantity > 0`
   - éªŒè¯ service å’Œ service_package å¿«ç…§å­˜åœ¨
2. **æ€»é‡‘é¢è¦†ç›–éªŒè¯ï¼ˆv2.16.4 å†³ç­– I4 - Decision #5ï¼‰ï¼š**
   - é»˜è®¤å€¼ï¼šä½¿ç”¨ `productSnapshot.price`
   - å¦‚æœæä¾›äº† `totalAmount`ï¼ˆè¦†ç›–äº§å“ä»·æ ¼ï¼‰ï¼š
     - âœ“ **é‡‘é¢èŒƒå›´éªŒè¯**ï¼š
       - å¿…é¡» >= 0ï¼ˆå…è®¸å…è´¹åˆåŒï¼‰
       - å¿…é¡» <= `productSnapshot.price * 2`ï¼ˆé˜²æ­¢è¾“å…¥é”™è¯¯ï¼‰
       - å¦‚æœä½äºåŸä»·ï¼Œæœ€å¤šæŠ˜æ‰£ 90%ï¼ˆå³æœ€ä½ 10% åŸä»·ï¼‰
     - âœ“ **æƒé™éªŒè¯**ï¼š
       - è¦†ç›–ä»·æ ¼éœ€è¦ `pricing_override` æƒé™
       - å…è´¹åˆåŒï¼ˆ$0ï¼‰éœ€è¦è¶…çº§ç®¡ç†å‘˜æƒé™
     - âœ“ **å®¡è®¡è¿½æº¯**ï¼š
       - å¿…é¡»åœ¨ `metadata.pricingNote` ä¸­è®°å½•è¦†ç›–åŸå› 
       - è®°å½•æ“ä½œäººï¼ˆcreatedByï¼‰å’Œæ—¶é—´æˆ³
   - **ç¤ºä¾‹**ï¼š
     - äº§å“ä»·æ ¼ï¼š$1000
     - å…è®¸èŒƒå›´ï¼š$100 - $2000
     - $0ï¼šä»…è¶…çº§ç®¡ç†å‘˜å¯è®¾ç½®ï¼ˆç‰¹æ®Šå…è´¹åˆåŒï¼‰
     - $500ï¼šéœ€ pricing_override æƒé™ + åŸå› è¯´æ˜ï¼ˆ"æ—©é¸Ÿä¼˜æƒ  50% æŠ˜æ‰£"ï¼‰
     - $2500ï¼šâŒ æŠ›å‡ºå¼‚å¸¸ï¼ˆè¶…è¿‡æœ€å¤§å…è®¸é‡‘é¢ï¼‰
     - $50ï¼šâŒ æŠ›å‡ºå¼‚å¸¸ï¼ˆä½äºæœ€ä½ 10% åŸä»·ï¼‰
3. ç”Ÿæˆå”¯ä¸€åˆåŒç¼–å·ï¼ˆv2.16.4 å†³ç­– C5ï¼‰ï¼š
   - æ ¼å¼ï¼š`CONTRACT-YYYY-MM-NNNNN`
   - è°ƒç”¨ PostgreSQL å‡½æ•°ï¼š`generate_contract_code()`
   - ç¤ºä¾‹ï¼šCONTRACT-2025-01-00001
   - æœˆå†…é¡ºåºé€’å¢ï¼Œæœˆåˆè‡ªåŠ¨é‡ç½®
   - å¹¶å‘å®‰å…¨ï¼ˆåŸºäº PostgreSQL SEQUENCEï¼‰
3. åˆ›å»ºåˆåŒè®°å½•ï¼ˆstatus = draftï¼‰ï¼š
   - `productId` â† `productSnapshot.productId`ï¼ˆä¸€å¯¹ä¸€ç»‘å®šï¼Œä¸å¯å˜ï¼‰
   - `totalAmount` â† `productSnapshot.price`
   - `currency` â† `productSnapshot.currency`
   - `validityDays` â† `productSnapshot.validityDays`ï¼ˆnull = æ°¸ä¹…æœ‰æ•ˆï¼‰
   - è®¡ç®— `expiresAt = signedAt + validityDays`ï¼ˆnull = æ°¸ä¹…æœ‰æ•ˆï¼‰
   - `productSnapshot` â† å®Œæ•´çš„äº§å“å¿«ç…§ï¼ˆå›ºåŒ–äº§å“ä¿¡æ¯ï¼‰
4. ä»äº§å“å¿«ç…§æ´¾ç”ŸæœåŠ¡æƒç›Šï¼ˆè¯¦è§ 1.4.5 æƒç›Šæ‹†è§£é€»è¾‘ï¼‰ï¼š
   - éå† `productSnapshot.items`
   - **type='service'**ï¼šç›´æ¥åˆ›å»ºæƒç›Šè®°å½•
   - **type='service_package'**ï¼šéå† `servicePackageSnapshot.items`ï¼Œä¸ºæ¯ä¸ª service åˆ›å»ºæƒç›Šè®°å½•
   - æ•°é‡è®¡ç®—ï¼š`totalQuantity = item.quantity * pkgItem.quantity`
   - åˆå¹¶ç›¸åŒ serviceType çš„æƒç›Šï¼ˆç´¯åŠ æ•°é‡ï¼‰
   - æ‰¹é‡æ’å…¥ `contract_service_entitlements`ï¼ˆsource = 'product'ï¼‰
   - å¦‚æœåˆåŒæ°¸ä¹…æœ‰æ•ˆï¼Œæƒç›Šä¹Ÿæ°¸ä¹…æœ‰æ•ˆï¼ˆexpiresAt = nullï¼‰
5. å‘å¸ƒäº‹ä»¶ï¼š`contract.signed`

**åç½®æ¡ä»¶ï¼š**
1. âœ… åˆåŒçŠ¶æ€ä¸º draft
2. âœ… æœåŠ¡æƒç›Šå·²åˆå§‹åŒ–ï¼ˆå·²å±•å¼€ service_packagesï¼‰
3. âœ… æƒç›ŠåŒ…å«æœåŠ¡å¿«ç…§ï¼ˆserviceSnapshot å­—æ®µï¼‰
4. âœ… äº‹ä»¶å·²å‘å¸ƒ

**å…³é”®å˜æ›´ï¼ˆv2.16.3ï¼‰ï¼š**
- âœ… Contract Domain ä¸å†è°ƒç”¨ Catalog Domain æŸ¥è¯¢äº§å“è¯¦æƒ…
- âœ… å¿«ç…§ç”± Application Layer åœ¨è°ƒç”¨å‰è·å–å¹¶ä¼ å…¥
- âœ… æƒç›Šæ´¾ç”Ÿé€»è¾‘å®Œå…¨åŸºäºå¿«ç…§æ•°æ®ï¼ˆé›¶å¤–éƒ¨æŸ¥è¯¢ï¼‰

#### 6.1.2 æ¿€æ´»åˆåŒ

**å‰ç½®æ¡ä»¶ï¼š**
1. âœ… åˆåŒçŠ¶æ€ä¸º draft
2. âœ… å·²æ”¶åˆ° `payment.succeeded` äº‹ä»¶
3. âœ… æ”¯ä»˜é‡‘é¢ >= é¦–ä»˜è¦æ±‚

**æ‰§è¡Œé€»è¾‘ï¼š**
1. æ›´æ–°åˆåŒçŠ¶æ€ä¸º active
2. è®¾ç½® effectiveAt = now
3. è®¡ç®— expiresAtï¼š
   - å¦‚æœ validityDays != nullï¼šexpiresAt = signedAt + validityDays
   - å¦‚æœ validityDays = nullï¼šexpiresAt = nullï¼ˆæ°¸ä¹…æœ‰æ•ˆï¼‰
4. æ›´æ–° paidAmount
5. å‘å¸ƒäº‹ä»¶ï¼š`contract.activated`

**åç½®æ¡ä»¶ï¼š**
1. âœ… åˆåŒçŠ¶æ€ä¸º active
2. âœ… æœåŠ¡æƒç›Šå¯ç”¨
3. âœ… äº‹ä»¶å·²å‘å¸ƒ
4. âœ… æ°¸ä¹…æœ‰æ•ˆåˆåŒçš„ expiresAt = null

#### 6.1.3 ç»ˆæ­¢åˆåŒ

**å‰ç½®æ¡ä»¶ï¼š**
1. âœ… åˆåŒçŠ¶æ€ä¸º active æˆ– suspended
2. âœ… æä¾›ç»ˆæ­¢åŸå› 

**æ‰§è¡Œé€»è¾‘ï¼š**
1. æ›´æ–°åˆåŒçŠ¶æ€ä¸º terminated
2. è®¾ç½® terminatedAt = now
3. è®°å½• terminationReason
4. å†»ç»“æ‰€æœ‰æœåŠ¡æƒç›Šï¼ˆavailableQuantity = 0ï¼‰
5. å‘å¸ƒäº‹ä»¶ï¼š`contract.terminated`

**åç½®æ¡ä»¶ï¼š**
1. âœ… åˆåŒçŠ¶æ€ä¸º terminated
2. âœ… æœåŠ¡æƒç›Šä¸å¯ç”¨
3. âœ… äº‹ä»¶å·²å‘å¸ƒ

### 6.2 æœåŠ¡æƒç›Šä¸šåŠ¡è§„åˆ™

#### 6.2.1 æ·»åŠ é¢å¤–æƒç›Š ğŸ†•v2.16

**å‰ç½®æ¡ä»¶ï¼š**
1. âœ… åˆåŒå­˜åœ¨ä¸”çŠ¶æ€ä¸º active
2. âœ… æœåŠ¡ç±»å‹æœ‰æ•ˆ
3. âœ… æƒç›Šæ¥æºä¸º addon/promotion/compensation
4. âœ… æä¾›æ·»åŠ åŸå› ï¼ˆaddOnReasonï¼‰

**æ ¸å¿ƒä¸šåŠ¡è§„åˆ™ï¼ˆv2.16.8 å†³ç­– R6ï¼‰ï¼š**
- ğŸ“Œ **æ‰€æœ‰é¢å¤–æƒç›Šéƒ½éœ€è¦å®¡æ‰¹**ï¼šæ— è®ºæ·»åŠ æ•°é‡å¤šå°‘ï¼Œæ‰€æœ‰ `source='addon'|'promotion'|'compensation'` çš„æƒç›Šå˜æ›´éƒ½éœ€è¦å®¡æ‰¹
- ğŸ“Œ **è‡ªåŠ¨åˆ›å»ºå¾…å®¡æ‰¹ä¿®è®¢**ï¼šç³»ç»Ÿè‡ªåŠ¨åˆ›å»º `status='pending'` çš„æƒç›Šä¿®è®¢è®°å½•
- ğŸ“Œ **å®¡æ‰¹å‰æƒç›Šä¸å¯ç”¨**ï¼šåœ¨å®¡æ‰¹é€šè¿‡å‰ï¼Œæ·»åŠ çš„æƒç›Šä¸è®¡å…¥å¯ç”¨ä½™é¢ï¼ˆ`availableQuantity = 0`ï¼‰
- ğŸ“Œ **å®¡æ‰¹åç«‹å³ç”Ÿæ•ˆ**ï¼šå®¡æ‰¹é€šè¿‡åï¼Œç³»ç»Ÿè‡ªåŠ¨æ›´æ–° `status='applied'` å¹¶å°† `availableQuantity` è®¾ç½®ä¸º `totalQuantity`

**æ‰§è¡Œé€»è¾‘ï¼š**
1. éªŒè¯åˆåŒçŠ¶æ€
2. éªŒè¯æœåŠ¡ç±»å‹å­˜åœ¨äº Catalog Domain
3. **åˆ›å»º contract_service_entitlements è®°å½•ï¼š**
   - source = addon/promotion/compensation
   - addOnReason = æä¾›çš„åŸå› 
   - totalQuantity = æ·»åŠ æ•°é‡
   - availableQuantity = 0ï¼ˆâš ï¸ å®¡æ‰¹å‰ä¸å¯ç”¨ï¼‰
   - status = 'pending'
4. **åˆ›å»ºæƒç›Šä¿®è®¢è®°å½•ï¼ˆrevisionType='addon'|'promotion'|'compensation'ï¼‰ï¼š**
   - revisionNumber = åˆåŒå†…ä¸‹ä¸€ä¸ªç‰ˆæœ¬å·
   - status = 'pending'
   - requiresApproval = trueï¼ˆè‡ªåŠ¨è®¾ç½®ï¼‰
   - è®°å½•å®Œæ•´å¿«ç…§ç”¨äºå®¡è®¡è¿½æº¯
5. åˆ›å»ºåˆå§‹åŒ–æµæ°´ï¼ˆtype = 'initial', source = 'manual_adjustment'ï¼‰
   - âš ï¸ æ³¨æ„ï¼šæ­¤æ—¶ balanceAfter = 0ï¼ˆå› ä¸ºæƒç›Šå°šæœªç”Ÿæ•ˆï¼‰

**å®¡æ‰¹æµç¨‹ï¼š**
```
æ·»åŠ æƒç›Šè¯·æ±‚
    â†“
ç³»ç»Ÿåˆ›å»ºæƒç›Šè®°å½•ï¼ˆavailable=0, status=pendingï¼‰
    â†“
åˆ›å»ºä¿®è®¢è®°å½•ï¼ˆstatus=pending, requiresApproval=trueï¼‰
    â†“
ç®¡ç†å‘˜è°ƒç”¨ approveRevision() / rejectRevision()
    â†“
å¦‚æœæ‰¹å‡†ï¼š
  - æ›´æ–° revision.status='applied'
  - æ›´æ–° entitlement.availableQuantity = totalQuantity
  - åˆ›å»º adjustment æµæ°´ï¼ˆ+quantityï¼‰

å¦‚æœæ‹’ç»ï¼š
  - æ›´æ–° revision.status='rejected'
  - æƒç›Šä¿æŒä¸å¯ç”¨
  - å¯é€‰æ‹©åˆ é™¤æƒç›Šè®°å½•æˆ–ä¿ç•™è®°å½•ï¼ˆaudit trailï¼‰
```

**åç½®æ¡ä»¶ï¼š**
1. âœ… æœåŠ¡æƒç›Šè®°å½•å·²åˆ›å»ºï¼ˆä½†ä¸å¯ç”¨ï¼Œavailable=0ï¼‰
2. âœ… å¾…å®¡æ‰¹çš„ä¿®è®¢è®°å½•å·²åˆ›å»º
3. âœ… æµæ°´å·²è®°å½•ï¼ˆè®°å½•åˆå§‹çŠ¶æ€ï¼‰
4. âœ… ç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹

**ä¸šåŠ¡åœºæ™¯ç¤ºä¾‹ï¼š**

```typescript
// åœºæ™¯1ï¼šä¿ƒæˆç­¾çº¦ - é¢å¤–èµ é€2æ¬¡æ¨¡æ‹Ÿé¢è¯•ï¼ˆéœ€è¦å®¡æ‰¹ï¼‰
// æ­¥éª¤1ï¼šæ·»åŠ æƒç›Šè¯·æ±‚ï¼ˆåˆ›å»ºå¾…å®¡æ‰¹è®°å½•ï¼‰
await contractService.addEntitlement({
  contractId: 'xxx',
  serviceType: 'mock_interview',
  totalQuantity: 2,
  source: 'addon',
  addOnReason: 'ä¿ƒæˆç­¾çº¦ï¼Œé¢å¤–èµ é€2æ¬¡æ¨¡æ‹Ÿé¢è¯•',
  createdBy: counselorId,
});
// ç»“æœï¼š
// - æƒç›Šè®°å½•åˆ›å»ºï¼ˆavailable=0, status=pendingï¼‰
// - ä¿®è®¢è®°å½•åˆ›å»ºï¼ˆrevisionNumber=2, status=pending, requiresApproval=trueï¼‰
// - å­¦ç”Ÿæš‚æ—¶æ— æ³•ä½¿ç”¨è¿™2æ¬¡æƒç›Šï¼ˆå†³ç­– R6ï¼šæ‰€æœ‰é¢å¤–æƒç›Šéƒ½éœ€è¦å®¡æ‰¹ï¼‰

// æ­¥éª¤2ï¼šç®¡ç†å‘˜å®¡æ‰¹é€šè¿‡
await contractService.approveRevision({
  revisionId: 'revision-002',
  approverId: 'admin-001',
  notes: 'åŒæ„ä¿ƒæˆç­¾çº¦èµ é€',
});
// ç»“æœï¼š
// - ä¿®è®¢çŠ¶æ€æ›´æ–°ä¸º applied
// - æƒç›Š availableQuantity æ›´æ–°ä¸º 2
// - å­¦ç”Ÿå¯ç«‹å³ä½¿ç”¨è¿™2æ¬¡æƒç›Š

// åœºæ™¯2ï¼šè¡¥å¿ - æœåŠ¡è´¨é‡é—®é¢˜è¡¥å¿1æ¬¡ç®€å†ä¿®æ”¹
await contractService.addEntitlement({
  contractId: 'xxx',
  serviceType: 'resume_review',
  totalQuantity: 1,
  source: 'compensation',
  addOnReason: 'è¡¥å¿ï¼šå¯¼å¸ˆæœªæŒ‰æ—¶æäº¤ç®€å†ä¿®æ”¹',
  createdBy: counselorId,
});
// âš ï¸ åŒæ ·éœ€è¦å®¡æ‰¹ï¼Œæ— è®ºæ•°é‡å¤šå°‘ï¼ˆå†³ç­– R6ï¼‰

// åœºæ™¯3ï¼šç®¡ç†å‘˜æ‹’ç»å®¡æ‰¹
await contractService.rejectRevision({
  revisionId: 'revision-003',
  approverId: 'admin-001',
  reason: 'è¡¥å¿åŸå› ä¸å……åˆ†ï¼Œå»ºè®®ä¸å­¦ç”Ÿè¿›ä¸€æ­¥æ²Ÿé€š',
});
// ç»“æœï¼š
// - ä¿®è®¢çŠ¶æ€æ›´æ–°ä¸º rejected
// - æƒç›Šä¿æŒä¸å¯ç”¨ï¼ˆavailable=0ï¼‰
// - å¯é€‰æ‹©åˆ é™¤æƒç›Šè®°å½•æˆ–ä¿ç•™å®¡è®¡ç—•è¿¹
```

#### 6.2.2 æ‰£å‡æœåŠ¡æƒç›Šï¼ˆv2.16.4 ä¼˜å…ˆçº§ç®—æ³•ï¼‰

**å‰ç½®æ¡ä»¶ï¼š**
1. âœ… åˆåŒçŠ¶æ€ä¸º active
2. âœ… æœåŠ¡æƒç›Šå­˜åœ¨
3. âœ… æ€»å¯ç”¨ä½™é¢ >= æ‰£å‡æ•°é‡

**æ‰§è¡Œé€»è¾‘ï¼ˆå†³ç­– I3 - ä¼˜å…ˆçº§ç®—æ³• + å†³ç­– C-NEW-1 - å¹¶å‘æ§åˆ¶ï¼‰ï¼š**

```typescript
async consumeService(dto: ConsumeServiceDto): Promise<void> {
  const { contractId, serviceType, quantity } = dto;

  // ğŸ”’ ä½¿ç”¨äº‹åŠ¡ + æ‚²è§‚é”ä¿è¯å¹¶å‘å®‰å…¨ï¼ˆå†³ç­– C-NEW-1ï¼‰
  await db.transaction(async (trx) => {
    // Step 1: åŠ é”æŸ¥è¯¢è¯¥åˆåŒä¸‹è¯¥æœåŠ¡ç±»å‹çš„æ‰€æœ‰å¯ç”¨æƒç›Šï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº
    // ä½¿ç”¨ FOR UPDATE æ‚²è§‚é”ï¼Œé˜»å¡å…¶ä»–å¹¶å‘äº‹åŠ¡ï¼Œé¿å…è¶…é¢æ‰£å‡
    const entitlements = await trx.execute(sql`
      SELECT *
      FROM contract_service_entitlements
      WHERE contract_id = ${dto.contractId}
        AND service_type = ${dto.serviceType}
        AND available_quantity > 0
      ORDER BY
        CASE source
          WHEN 'product' THEN 1
          WHEN 'addon' THEN 2
          WHEN 'promotion' THEN 3
          WHEN 'compensation' THEN 4
        END,
        created_at ASC
      FOR UPDATE  -- ğŸ”’ æ‚²è§‚é”ï¼šé”å®šæŸ¥è¯¢ç»“æœï¼Œé˜²æ­¢å¹¶å‘ä¿®æ”¹
    `);

    // Step 2: éªŒè¯æ€»å¯ç”¨ä½™é¢
    const totalAvailable = entitlements.reduce(
      (sum, e) => sum + e.available_quantity,
      0
    );
    if (totalAvailable < quantity) {
      throw new ContractException('INSUFFICIENT_BALANCE', {
        required: quantity,
        available: totalAvailable,
        contractId,
        serviceType,
      });
    }

    // Step 3: é€æ¡æ‰£å‡ï¼Œç›´åˆ°æ»¡è¶³æ¶ˆè´¹æ•°é‡
    let remaining = quantity;

    for (const entitlement of entitlements) {
      if (remaining <= 0) break;

      const toConsume = Math.min(entitlement.available_quantity, remaining);

      // æ›´æ–°æƒç›Šè®°å½•ï¼ˆäº‹åŠ¡å†…ï¼Œå·²åŠ é”ï¼Œå¹¶å‘å®‰å…¨ï¼‰
      await trx.update(contractServiceEntitlements)
        .set({
          consumedQuantity: entitlement.consumed_quantity + toConsume,
          availableQuantity: entitlement.available_quantity - toConsume,
          updatedAt: new Date(),
        })
        .where(eq(contractServiceEntitlements.id, entitlement.id));

      // åˆ›å»ºæµæ°´è®°å½•ï¼ˆäº‹åŠ¡å†…ï¼ŒåŸå­æ€§ä¿è¯ï¼‰
      await trx.insert(serviceLedgers).values({
        contractId: dto.contractId,
        studentId: dto.studentId,
        entitlementId: entitlement.id,
        serviceType: dto.serviceType,
        type: 'consumption',
        source: entitlement.source, // è®°å½•æ¥è‡ªå“ªä¸ªæ¥æº
        quantity: -toConsume, // è´Ÿæ•°è¡¨ç¤ºæ¶ˆè´¹
        balanceAfter: entitlement.available_quantity - toConsume,
        relatedBookingId: dto.relatedBookingId,
        relatedHoldId: dto.relatedHoldId,
        createdBy: dto.studentId,
      });

      remaining -= toConsume;
    }

    // Step 4: å¦‚æœæœ‰å…³è”é¢„å ï¼Œè‡ªåŠ¨é‡Šæ”¾ï¼ˆäº‹åŠ¡å†…ï¼‰
    if (dto.relatedHoldId) {
      // æ›´æ–°é¢„å çŠ¶æ€ï¼ˆè§¦å‘å™¨ä¼šè‡ªåŠ¨åŒæ­¥ held_quantityï¼Œè§å†³ç­– C-NEW-2ï¼‰
      await trx.update(serviceHolds)
        .set({
          status: 'released',
          releasedAt: new Date(),
          releaseReason: 'consumed',
          updatedAt: new Date(),
        })
        .where(eq(serviceHolds.id, dto.relatedHoldId));

      // âœ… æ•°æ®åº“è§¦å‘å™¨è‡ªåŠ¨æ‰§è¡Œï¼ˆæ— éœ€æ‰‹åŠ¨åŒæ­¥ï¼‰ï¼š
      // UPDATE contract_service_entitlements
      // SET held_quantity = held_quantity - 1,
      //     available_quantity = available_quantity + 1
    }

    // äº‹åŠ¡æäº¤ï¼šæ‰€æœ‰æ“ä½œæˆåŠŸæ‰æäº¤ï¼Œä»»ä½•å¤±è´¥éƒ½å›æ»š
  });
}
```

**å¹¶å‘æ§åˆ¶è¯´æ˜ï¼ˆv2.16.5 å†³ç­– C-NEW-1ï¼‰ï¼š**

- âœ… **æ‚²è§‚é”ï¼ˆFOR UPDATEï¼‰**ï¼šæŸ¥è¯¢æ—¶é”å®šæƒç›Šè®°å½•ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡åŒæ—¶æ‰£å‡
- âœ… **æ•°æ®åº“äº‹åŠ¡**ï¼šæƒç›Šæ›´æ–°ã€æµæ°´è®°å½•ã€é¢„å é‡Šæ”¾åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼Œä¿è¯åŸå­æ€§
- âœ… **é˜»å¡ç­‰å¾…**ï¼šå¹¶å‘è¯·æ±‚ä¼šæ’é˜Ÿæ‰§è¡Œï¼Œé¿å…è¶…é¢æ‰£å‡
- âœ… **æ­»é”é¢„é˜²**ï¼šå§‹ç»ˆæŒ‰ç›¸åŒé¡ºåºï¼ˆcontractId â†’ serviceTypeï¼‰é”å®šèµ„æº

**ä¼˜å…ˆçº§æ’åºç¤ºä¾‹ï¼š**

```sql
-- æŸ¥è¯¢ç»“æœé¡ºåºï¼ˆæŒ‰ä¼˜å…ˆçº§ + åˆ›å»ºæ—¶é—´ï¼‰
1. product   | 2025-01-01 | available: 3
2. product   | 2025-01-03 | available: 2
3. addon     | 2025-01-05 | available: 2
4. promotion | 2025-01-10 | available: 1

-- æ¶ˆè´¹ 7 æ¬¡çš„æ‰£å‡é¡ºåºï¼š
-- è®°å½• 1: æ‰£å‡ 3 æ¬¡ (product)
-- è®°å½• 2: æ‰£å‡ 2 æ¬¡ (product)
-- è®°å½• 3: æ‰£å‡ 2 æ¬¡ (addon)
-- è®°å½• 4: å‰©ä½™ 1 æ¬¡ (promotion)
```

**åç½®æ¡ä»¶ï¼š**
1. âœ… æƒç›Šä½™é¢å·²æŒ‰ä¼˜å…ˆçº§æ›´æ–°
2. âœ… æ¯æ¡æƒç›Šçš„æµæ°´å·²è®°å½•ï¼ˆsource å­—æ®µè®°å½•æ¥æºï¼‰
3. âœ… balanceAfter æ­£ç¡®
4. âœ… å…³è”é¢„å å·²é‡Šæ”¾ï¼ˆå¦‚æœæœ‰ï¼‰

### 6.3 æœåŠ¡æµæ°´ä¸šåŠ¡è§„åˆ™

#### 6.3.1 Append-only ä¿æŠ¤

**åº”ç”¨å±‚ä¿æŠ¤ï¼š**

```typescript
class ServiceLedgerService {
  async recordLedger(...) {
    // âœ… åªæä¾› INSERT æ–¹æ³•
    return await this.db.insert(serviceLedgers).values(...);
  }

  // âŒ ä¸æä¾› update() æ–¹æ³•
  // âŒ ä¸æä¾› delete() æ–¹æ³•
}
```

**æ•°æ®åº“æƒé™ä¿æŠ¤ï¼š**

```sql
-- åªæˆäºˆ INSERT å’Œ SELECT æƒé™ï¼Œç¦æ­¢ UPDATE/DELETE
REVOKE UPDATE, DELETE ON service_ledgers FROM mentorx_app_user;
GRANT INSERT, SELECT ON service_ledgers TO mentorx_app_user;
```

#### 6.3.2 ä½™é¢å¯¹è´¦éªŒè¯

**éªŒè¯é€»è¾‘ï¼š**

```typescript
async verifyBalance(
  contractId: string,
  serviceType: string
): Promise<BalanceVerificationResult> {
  // 1. æŸ¥è¯¢æ‰€æœ‰æµæ°´ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
  const ledgers = await this.queryLedgers({
    contractId,
    serviceType,
    sort: { field: 'createdAt', order: 'asc' },
  });

  // 2. é€æ¡éªŒè¯ balanceAfter
  let expectedBalance = 0;
  const errors: Array<any> = [];

  for (const ledger of ledgers.data) {
    expectedBalance += ledger.quantity;

    if (ledger.balanceAfter !== expectedBalance) {
      errors.push({
        ledgerId: ledger.id,
        expectedBalanceAfter: expectedBalance,
        actualBalanceAfter: ledger.balanceAfter,
      });
    }
  }

  // 3. è¿”å›éªŒè¯ç»“æœ
  return {
    contractId,
    serviceType,
    isValid: errors.length === 0,
    expectedBalance,
    actualBalance: ledgers.data[ledgers.data.length - 1]?.balanceAfter ?? 0,
    discrepancy: expectedBalance - (ledgers.data[ledgers.data.length - 1]?.balanceAfter ?? 0),
    errors,
  };
}
```

### 6.4 æœåŠ¡é¢„å ä¸šåŠ¡è§„åˆ™

#### 6.4.1 åˆ›å»ºé¢„å ã€å·²ç®€åŒ– - v2.16.9 ç§»é™¤è¿‡æœŸé€»è¾‘ã€‘

**å‰ç½®æ¡ä»¶ï¼š**
1. âœ… åˆåŒçŠ¶æ€ä¸º active
2. âœ… æœåŠ¡æƒç›Šå­˜åœ¨
3. âœ… availableQuantity >= é¢„å æ•°é‡

**æ‰§è¡Œé€»è¾‘ï¼ˆv2.16.9 æ›´æ–°ï¼‰ï¼š**
1. éªŒè¯å¯ç”¨ä½™é¢
2. åˆ›å»ºé¢„å è®°å½•ï¼š
   - status = 'active'ï¼ˆæ— è¿‡æœŸæ—¶é—´ï¼Œæ°¸ä¸è¿‡æœŸï¼‰
3. **è§¦å‘å™¨è‡ªåŠ¨åŒæ­¥æƒç›Šè¡¨**ï¼š
   - heldQuantity += é¢„å æ•°é‡
   - availableQuantity -= é¢„å æ•°é‡

**åç½®æ¡ä»¶ï¼š**
1. âœ… é¢„å è®°å½•å·²åˆ›å»º
2. âœ… æƒç›Šä½™é¢å·²æ›´æ–°ï¼ˆè§¦å‘å™¨ï¼‰

#### 6.4.2 é‡Šæ”¾é¢„å ã€v2.16.9 ç§»é™¤è¿‡æœŸé€»è¾‘ã€‘

**å‰ç½®æ¡ä»¶ï¼š**
1. âœ… é¢„å è®°å½•å­˜åœ¨
2. âœ… é¢„å çŠ¶æ€ä¸º active

**æ‰§è¡Œé€»è¾‘ï¼ˆv2.16.9 æ›´æ–°ï¼‰ï¼š**
1. æ›´æ–°é¢„å è®°å½•ï¼š
   - status = 'released' æˆ– 'cancelled'
   - releasedAt = now
   - releaseReason = 'completed' | 'cancelled' | 'admin_manual'
2. **è§¦å‘å™¨è‡ªåŠ¨åŒæ­¥æƒç›Šè¡¨**ï¼š
   - heldQuantity -= é¢„å æ•°é‡
3. ï¼ˆå¯é€‰ï¼‰å¦‚æœæœåŠ¡å®Œæˆï¼Œåˆ›å»ºæ¶ˆè´¹æµæ°´

**åç½®æ¡ä»¶ï¼š**
1. âœ… é¢„å å·²é‡Šæ”¾
2. âœ… æƒç›Šä½™é¢å·²æ›´æ–°ï¼ˆè§¦å‘å™¨ï¼‰
3. âœ… æµæ°´å·²è®°å½•ï¼ˆå¦‚æœæœåŠ¡å®Œæˆï¼‰

#### 6.4.3 é¢„å æ°¸ä¸è¿‡æœŸã€v2.16.9 é‡å¤§å˜æ›´ã€‘

**è®¾è®¡å˜æ›´ï¼š**
- âŒ ç§»é™¤ `expiresAt` å­—æ®µï¼ˆä¸å†éœ€è¦è¿‡æœŸæ—¶é—´ï¼‰
- âŒ ç§»é™¤è‡ªåŠ¨æ¸…ç†é€»è¾‘ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
- âœ… **é¢„å æ°¸ä¸è¿‡æœŸ**ï¼šå¿…é¡»é€šè¿‡ releaseHold() æˆ– cancelHold() é‡Šæ”¾
- âœ… ç®€åŒ–çŠ¶æ€ç®¡ç†ï¼šactive â†’ released/cancelled

**å†³ç­–ç†ç”±ï¼ˆv2.16.9ï¼‰ï¼š**
1. **ä¸šåŠ¡å®Œæ•´æ€§**ï¼šé¢„å ä»£è¡¨ç”¨æˆ·çš„é¢„çº¦æ„å›¾ï¼Œä¸åº”è‡ªåŠ¨å¤±æ•ˆ
2. **å‡å°‘å¤æ‚åº¦**ï¼šç§»é™¤è¿‡æœŸé€»è¾‘ã€TTLã€å®šæ—¶ä»»åŠ¡
3. **äººå·¥å®¡æ ¸é‡è¦**ï¼šæ‰€æœ‰é‡Šæ”¾æ“ä½œå¿…é¡»æ˜ç¡®ç¡®è®¤
4. **æ•°æ®å®Œæ•´æ€§**ï¼šä¿ç•™å®Œæ•´çš„é¢„å å†å²è®°å½•

**æ–°çš„å¤„ç†æµç¨‹ï¼š**

```typescript
// åœºæ™¯1ï¼šæ­£å¸¸å®ŒæˆæœåŠ¡
await holdService.releaseHold(holdId, 'completed');

// åœºæ™¯2ï¼šç”¨æˆ·å–æ¶ˆé¢„çº¦
await holdService.cancelHold(holdId, 'cancelled');

// åœºæ™¯3ï¼šç®¡ç†å‘˜æ‰‹åŠ¨é‡Šæ”¾ï¼ˆå¤„ç†å¼‚å¸¸ï¼‰
await holdService.releaseHold(holdId, 'admin_manual');
```

**ç›‘æ§å»ºè®®ï¼š**

å»ºè®®å®šæœŸæ£€æŸ¥é•¿æ—¶é—´æœªé‡Šæ”¾çš„é¢„å ï¼ˆå¦‚è¶…è¿‡24å°æ—¶ï¼‰ï¼š

```typescript
// æŸ¥è¯¢åˆ›å»ºè¶…è¿‡24å°æ—¶ä¸”ä»ä¸º active çš„é¢„å 
const oldHolds = await db.query.serviceHolds.findMany({
  where: and(
    eq(serviceHolds.status, 'active'),
    lt(
      serviceHolds.createdAt,
      new Date(Date.now() - 24 * 60 * 60 * 1000) // 24å°æ—¶å‰
    )
  )
});
// äººå·¥å®¡æ ¸åé‡Šæ”¾
```

**æ€§èƒ½æå‡ï¼š**
- ç§»é™¤å®šæ—¶ä»»åŠ¡ â†’ å‡å°‘ç³»ç»Ÿè´Ÿè½½
- å‡å°‘æ•°æ®åº“å­—æ®µ â†’ èŠ‚çœå­˜å‚¨ç©ºé—´
- ç®€åŒ–åº”ç”¨å±‚é€»è¾‘ â†’ æå‡å¯ç»´æŠ¤æ€§

### 6.5 æµæ°´å½’æ¡£ä¸šåŠ¡è§„åˆ™

#### 6.5.1 å½’æ¡£ç­–ç•¥ä¼˜å…ˆçº§

**ä¼˜å…ˆçº§ï¼š** contract > service_type > global

**æŸ¥è¯¢é€»è¾‘ï¼š**

```typescript
async getArchivePolicy(
  contractId?: string,
  serviceType?: string
): Promise<ArchivePolicy> {
  // 1. æŸ¥è¯¢åˆåŒçº§ç­–ç•¥
  if (contractId) {
    const contractPolicy = await this.findPolicy({ scope: 'contract', contractId });
    if (contractPolicy && contractPolicy.enabled) {
      return contractPolicy;
    }
  }

  // 2. æŸ¥è¯¢æœåŠ¡ç±»å‹çº§ç­–ç•¥
  if (serviceType) {
    const serviceTypePolicy = await this.findPolicy({ scope: 'service_type', serviceType });
    if (serviceTypePolicy && serviceTypePolicy.enabled) {
      return serviceTypePolicy;
    }
  }

  // 3. æŸ¥è¯¢å…¨å±€ç­–ç•¥
  const globalPolicy = await this.findPolicy({ scope: 'global' });
  if (globalPolicy && globalPolicy.enabled) {
    return globalPolicy;
  }

  // 4. è¿”å›é»˜è®¤ç­–ç•¥
  return {
    archiveAfterDays: 90,
    deleteAfterArchive: false,
  };
}
```

#### 6.5.2 æ‰§è¡Œå½’æ¡£ä»»åŠ¡

**æ‰§è¡Œé¢‘ç‡ï¼š** æ¯å¤©å‡Œæ™¨ 2:00

**æ‰§è¡Œé€»è¾‘ï¼š**

```typescript
async archiveOldLedgers(daysOld?: number): Promise<ArchiveResult> {
  const startTime = Date.now();
  const policy = await this.getArchivePolicy();
  const archiveDays = daysOld ?? policy.archiveAfterDays;

  // 1. æŸ¥è¯¢éœ€è¦å½’æ¡£çš„æµæ°´
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - archiveDays);

  const oldLedgers = await this.db.query.serviceLedgers.findMany({
    where: lt(serviceLedgers.createdAt, cutoffDate),
  });

  // 2. æ‰¹é‡å¤åˆ¶åˆ°å½’æ¡£è¡¨
  await this.db.insert(serviceLedgersArchive).values(
    oldLedgers.map(ledger => ({
      ...ledger,
      archivedAt: new Date(),
    }))
  );

  // 3. å¯é€‰ï¼šåˆ é™¤ä¸»è¡¨æ•°æ®
  let deletedCount = 0;
  if (policy.deleteAfterArchive) {
    await this.db.delete(serviceLedgers).where(
      lt(serviceLedgers.createdAt, cutoffDate)
    );
    deletedCount = oldLedgers.length;
  }

  return {
    totalArchived: oldLedgers.length,
    totalDeleted: deletedCount,
    archivedAt: new Date(),
    timeTaken: Date.now() - startTime,
  };
}
```

### 6.6 æƒç›Šä¿®è®¢ä¸šåŠ¡è§„åˆ™ ğŸ†•v2.16.7

#### 6.6.1 åˆ›å»ºæƒç›Šä¿®è®¢è®°å½•

**è§¦å‘æ—¶æœºï¼š**
1. **åˆ›å»ºåˆåŒæ—¶**ï¼šä¸ºæ¯ä¸ªåˆå§‹æƒç›Šåˆ›å»º revisionType='initial' çš„ä¿®è®¢è®°å½•
2. **æ·»åŠ é¢å¤–æƒç›Šæ—¶**ï¼šä¸ºæ¯æ¬¡æ·»åŠ åˆ›å»º revisionType='addon'|'promotion'|'compensation' çš„ä¿®è®¢è®°å½•

**æ‰§è¡Œé€»è¾‘ï¼š**

```typescript
async createEntitlementRevision(dto: CreateEntitlementRevisionDto): Promise<void> {
  // 1. éªŒè¯å‚æ•°å®Œæ•´æ€§
  if (!dto.contractId || !dto.serviceType || !dto.revisionType) {
    throw new ContractException('INVALID_REVISION_DATA', 'Missing required fields');
  }

  // 2. éªŒè¯ quantityChanged ä¸ä¸º 0
  if (dto.quantityChanged === 0) {
    throw new ContractException('INVALID_QUANTITY_CHANGED', 'Quantity change cannot be zero');
  }

  // 3. éªŒè¯ source å’Œ addOnReason ä¸€è‡´æ€§
  if (['addon', 'promotion', 'compensation'].includes(dto.source) && !dto.addOnReason) {
    throw new ContractException('MISSING_ADD_ON_REASON', 'addOnReason is required for addon/promotion/compensation');
  }

  // 4. éªŒè¯å®¡æ‰¹çŠ¶æ€ä¸€è‡´æ€§
  if (dto.status === 'pending' && !dto.requiresApproval) {
    throw new ContractException('INVALID_APPROVAL_STATUS', 'pending status must have requiresApproval=true');
  }

  // 5. è·å–ä¸‹ä¸€ä¸ª revisionNumberï¼ˆå¦‚æœæ˜¯æ–°å¢è®°å½•ï¼‰
  if (dto.revisionNumber === undefined) {
    const lastRevision = await this.findLastRevisionNumber(dto.contractId);
    dto.revisionNumber = (lastRevision || 0) + 1;
  }

  // 6. æ’å…¥ä¿®è®¢è®°å½•
  await this.db.insert(contractEntitlementRevisions).values({
    ...dto,
    createdAt: new Date(),
  });
}
```

**ä¸šåŠ¡è§„åˆ™ï¼š**

1. **å‚æ•°å®Œæ•´æ€§**ï¼šcontractId, serviceType, revisionType, quantityChanged ç­‰å¿…å¡«å­—æ®µä¸èƒ½ä¸ºç©º
2. **å˜æ›´æ•°é‡éé›¶**ï¼šquantityChanged ä¸èƒ½ä¸º 0ï¼ˆå¿…é¡»æ­£æ•°æˆ–è´Ÿæ•°ï¼‰
3. **åŸå› å¿…å¡«**ï¼šå½“ source ä¸º 'addon'|'promotion'|'compensation' æ—¶ï¼ŒaddOnReason å¿…å¡«
4. **å®¡æ‰¹ä¸€è‡´æ€§**ï¼šå¦‚æœ status='pending'ï¼Œåˆ™ requiresApproval å¿…é¡»ä¸º true
5. **ç‰ˆæœ¬å·å”¯ä¸€**ï¼šæ¯ä¸ªåˆåŒçš„ revision_number å¿…é¡»å”¯ä¸€ï¼Œä»1å¼€å§‹é€’å¢

**åç½®æ¡ä»¶ï¼š**
- âœ… revisionNumber åœ¨åˆåŒå†…å…¨å±€å”¯ä¸€ä¸”é€’å¢
- âœ… ä¿®è®¢è®°å½•æˆåŠŸå†™å…¥æ•°æ®åº“
- âœ… entitlementId æ­£ç¡®å…³è”åˆ°è¢«ä¿®æ”¹çš„æƒç›Šè®°å½•

---

#### 6.6.2 å®¡æ‰¹æƒç›Šä¿®è®¢

**å‰ç½®æ¡ä»¶ï¼š**
1. ä¿®è®¢è®°å½•å­˜åœ¨ä¸” status='pending'
2. è°ƒç”¨è€…å…·æœ‰ admin æˆ–å®¡æ‰¹æƒé™

**æ‰§è¡Œé€»è¾‘ï¼š**

```typescript
async approveRevision(revisionId: string, approverId: string, notes?: string): Promise<void> {
  return await this.db.transaction(async (tx) => {
    // 1. æŸ¥è¯¢ä¿®è®¢è®°å½•å¹¶åŠ é”
    const revision = await tx.query.contractEntitlementRevisions.findFirst({
      where: eq(contractEntitlementRevisions.id, revisionId),
      // ä½¿ç”¨ FOR UPDATE é”å®šè®°å½•ï¼Œé˜²æ­¢å¹¶å‘ä¿®æ”¹
    });

    if (!revision) {
      throw new ContractNotFoundException('REVISION_NOT_FOUND', 'Revision not found');
    }

    // 2. éªŒè¯çŠ¶æ€
    if (revision.status !== 'pending') {
      throw new ContractException(
        'INVALID_REVISION_STATUS',
        `Expected status=pending, got ${revision.status}`
      );
    }

    // 3. æ›´æ–°ä¿®è®¢çŠ¶æ€ä¸º approved
    await tx.update(contractEntitlementRevisions)
      .set({
        status: 'approved',
        approvedBy: approverId,
        approvedAt: new Date(),
        approvalNotes: notes,
      })
      .where(eq(contractEntitlementRevisions.id, revisionId));

    // 4. åº”ç”¨æƒç›Šå˜æ›´ï¼ˆæ›´æ–° contract_service_entitlementsï¼‰
    await tx.update(contractServiceEntitlements)
      .set({
        totalQuantity: revision.totalQuantity,
        availableQuantity: revision.availableQuantity,
        updatedAt: new Date(),
      })
      .where(eq(contractServiceEntitlements.id, revision.entitlementId!));

    // 5. æ ‡è®°ä¸ºå·²åº”ç”¨
    await tx.update(contractEntitlementRevisions)
      .set({ status: 'applied' })
      .where(eq(contractEntitlementRevisions.id, revisionId));

    // 6. å‘å¸ƒ entitlement.revised äº‹ä»¶ï¼ˆå¯é€‰ï¼‰
    // await this.eventBus.publish(createEntitlementRevisedEvent(revision));
  });
}
```

**ä¸šåŠ¡è§„åˆ™ï¼š**

1. **çŠ¶æ€éªŒè¯**ï¼šåªæœ‰ status='pending' çš„ä¿®è®¢å¯ä»¥è¢«å®¡æ‰¹
2. **ç‰ˆæœ¬åŒ¹é…**ï¼šç¡®ä¿ revisionNumber æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼ˆä¹è§‚é”ï¼‰
3. **åŸå­æ€§ä¿è¯**ï¼šå®¡æ‰¹ã€åº”ç”¨å˜æ›´ã€æ ‡è®°å®Œæˆåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­
4. **å¹‚ç­‰æ€§**ï¼šå¦‚æœå·²ç» appliedï¼Œé‡å¤è°ƒç”¨åº”è¯¥æŠ›å‡ºå¼‚å¸¸

**åç½®æ¡ä»¶ï¼š**
- âœ… ä¿®è®¢çŠ¶æ€æ›´æ–°ä¸º 'applied'
- âœ… contract_service_entitlements è¡¨å·²æ›´æ–°
- âœ… å®¡æ‰¹ä¿¡æ¯å·²è®°å½•ï¼ˆapprovedBy, approvedAt, approvalNotesï¼‰

---

#### 6.6.3 æ‹’ç»æƒç›Šä¿®è®¢

**å‰ç½®æ¡ä»¶ï¼š**
1. ä¿®è®¢è®°å½•å­˜åœ¨ä¸” status='pending'
2. è°ƒç”¨è€…å…·æœ‰ admin æˆ–å®¡æ‰¹æƒé™

**æ‰§è¡Œé€»è¾‘ï¼š**

```typescript
async rejectRevision(revisionId: string, approverId: string, reason: string): Promise<void> {
  await this.db.update(contractEntitlementRevisions)
    .set({
      status: 'rejected',
      approvedBy: approverId,
      approvedAt: new Date(),
      approvalNotes: reason, // è®°å½•æ‹’ç»åŸå› 
    })
    .where(and(
      eq(contractEntitlementRevisions.id, revisionId),
      eq(contractEntitlementRevisions.status, 'pending') // ç¡®ä¿çŠ¶æ€æ˜¯ pending
    ));

  // ç¡®ä¿æ²¡æœ‰ä¿®æ”¹ contract_service_entitlementsï¼ˆæ‹’ç»ä¸åº”ç”¨å˜æ›´ï¼‰
}
```

**ä¸šåŠ¡è§„åˆ™ï¼š**

1. **çŠ¶æ€éªŒè¯**ï¼šåªæœ‰ status='pending' çš„ä¿®è®¢å¯ä»¥è¢«æ‹’ç»
2. **ä¸åº”ç”¨å˜æ›´**ï¼šcontract_service_entitlements è¡¨ä¿æŒä¸å˜
3. **åŸå› å¿…å¡«**ï¼šæ‹’ç»æ—¶å¿…é¡»æä¾› reasonï¼ˆè®°å½•åœ¨ approvalNotes ä¸­ï¼‰

**åç½®æ¡ä»¶ï¼š**
- âœ… ä¿®è®¢çŠ¶æ€æ›´æ–°ä¸º 'rejected'
- âœ… æ‹’ç»åŸå› å·²è®°å½•
- âœ… contract_service_entitlements æœªè¢«ä¿®æ”¹

---

#### 6.6.4 æŸ¥è¯¢æƒç›Šä¿®è®¢å†å²

**å‰ç½®æ¡ä»¶ï¼š**
1. contractId å¿…é¡»æä¾›
2. å¯é€‰çš„è¿‡æ»¤æ¡ä»¶ï¼ˆserviceType, revisionType, statusï¼‰

**æŸ¥è¯¢é€»è¾‘ï¼š**

```typescript
async getEntitlementRevisions(
  contractId: string,
  options?: {
    serviceType?: string;
    revisionType?: string;
    status?: 'pending' | 'approved' | 'rejected' | 'applied';
    page?: number;
    pageSize?: number;
  }
): Promise<PaginatedResult<ContractEntitlementRevision>> {
  const whereConditions = [
    eq(contractEntitlementRevisions.contractId, contractId)
  ];

  if (options?.serviceType) {
    whereConditions.push(
      eq(contractEntitlementRevisions.serviceType, options.serviceType)
    );
  }

  if (options?.revisionType) {
    whereConditions.push(
      eq(contractEntitlementRevisions.revisionType, options.revisionType)
    );
  }

  if (options?.status) {
    whereConditions.push(
      eq(contractEntitlementRevisions.status, options.status)
    );
  }

  // ç»Ÿè®¡æ€»æ•°
  const [countResult] = await this.db
    .select({ count: count() })
    .from(contractEntitlementRevisions)
    .where(and(...whereConditions));

  // æŸ¥è¯¢æ•°æ®
  const data = await this.db.query.contractEntitlementRevisions.findMany({
    where: and(...whereConditions),
    orderBy: [desc(contractEntitlementRevisions.revisionNumber)],
    offset: ((options?.page || 1) - 1) * (options?.pageSize || 20),
    limit: options?.pageSize || 20,
  });

  return {
    data,
    total: countResult.count,
    page: options?.page || 1,
    pageSize: options?.pageSize || 20,
    totalPages: Math.ceil(countResult.count / (options?.pageSize || 20)),
  };
}
```

**ä¸šåŠ¡è§„åˆ™ï¼š**

1. **æ’åºè§„åˆ™**ï¼šæŒ‰ revisionNumber é™åºæ’åˆ—ï¼ˆæœ€æ–°ä¿®è®¢åœ¨å‰ï¼‰
2. **åˆ†é¡µæ”¯æŒ**ï¼šæ”¯æŒ page å’Œ pageSize å‚æ•°
3. **å¤åˆè¿‡æ»¤**ï¼šå¯ä»¥åŒæ—¶ä½¿ç”¨å¤šä¸ªè¿‡æ»¤æ¡ä»¶
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨ count() è·å–æ€»æ•°ï¼Œæ”¯æŒåˆ†é¡µæŸ¥è¯¢

**è¿”å›æ ¼å¼ï¼š**

```typescript
{
  data: ContractEntitlementRevision[],  // å½“å‰é¡µæ•°æ®
  total: number,                        // æ€»è®°å½•æ•°
  page: number,                         // å½“å‰é¡µç 
  pageSize: number,                     // æ¯é¡µå¤§å°
  totalPages: number,                   // æ€»é¡µæ•°
}
```

---

#### 6.6.5 åˆå§‹æƒç›Šä¿®è®¢è®°å½•ï¼ˆåˆ›å»ºåˆåŒæ—¶ï¼‰

**è§¦å‘æ—¶æœºï¼š** åœ¨ create() æ–¹æ³•ä¸­ï¼Œæ´¾ç”Ÿåˆå§‹æƒç›Šå

**ä¸šåŠ¡è§„åˆ™ï¼š**

```typescript
// å¯¹äºæ¯ä¸ªä» productSnapshot æ´¾ç”Ÿçš„æƒç›Šï¼š
await createEntitlementRevision({
  contractId: contract.id,
  entitlementId: createdEntitlement.id,
  serviceType: item.serviceSnapshot.serviceType,
  serviceName: item.serviceSnapshot.serviceName,
  revisionNumber: ++globalRevisionNumber,  // åˆåŒå†…å…¨å±€é€’å¢
  revisionType: 'initial',
  source: 'product',
  quantityChanged: totalQuantity,  // æ­£æ•°
  totalQuantity: totalQuantity,
  availableQuantity: totalQuantity,
  status: 'applied',  // åˆå§‹æƒç›Šç›´æ¥ç”Ÿæ•ˆ
  requiresApproval: false,
  createdBy: dto.counselorId,
  snapshot: {
    serviceSnapshot: item.serviceSnapshot,
    productSnapshot: dto.productSnapshot,
    originItems: [item],  // æ¥æºè¿½æº¯
  }
});
```

**å…³é”®ç‰¹æ€§ï¼š**
1. æ¯ä¸ªåˆå§‹æƒç›Šåˆ›å»ºä¸€æ¡ revisionType='initial' çš„è®°å½•
2. revisionNumber åœ¨åˆåŒå†…å…¨å±€é€’å¢ï¼ˆè·¨æ‰€æœ‰æœåŠ¡ç±»å‹ï¼‰
3. çŠ¶æ€ç›´æ¥ä¸º 'applied'ï¼ˆæ— éœ€å®¡æ‰¹ï¼‰
4. åŒ…å«å®Œæ•´çš„ productSnapshot å’Œ serviceSnapshot ç”¨äºå®¡è®¡è¿½æº¯

---

#### 6.6.6 é¢å¤–æƒç›Šä¿®è®¢è®°å½•ï¼ˆæ·»åŠ æƒç›Šæ—¶ï¼‰

**è§¦å‘æ—¶æœºï¼š** åœ¨ addEntitlement() æ–¹æ³•ä¸­

**æ‰§è¡Œä¸šåŠ¡è§„åˆ™ï¼ˆv2.16.8 å†³ç­– R6ï¼‰ï¼š**
- ğŸ“Œ **æ‰€æœ‰é¢å¤–æƒç›Šéƒ½éœ€è¦å®¡æ‰¹**ï¼šç³»ç»Ÿè‡ªåŠ¨è®¾ç½® `requiresApproval = true`
- ğŸ“Œ **æƒç›Šåˆå§‹çŠ¶æ€ä¸º pending**ï¼šåˆ›å»ºçš„æƒç›Šè®°å½• `status='pending'`ï¼Œ`availableQuantity = 0`
- ğŸ“Œ **ä¿®è®¢è®°å½•çŠ¶æ€åŒæ­¥**ï¼šä¿®è®¢è®°å½• `status='pending'`ï¼Œç­‰å¾…å®¡æ‰¹

**æ‰§è¡Œé€»è¾‘ï¼š**

```typescript
// 1. è·å–ä¸‹ä¸€ä¸ª revisionNumber
const lastRevision = await findLastRevisionNumber(contractId);
const nextRevisionNumber = (lastRevision || 0) + 1;

// 2. åˆ›å»ºæƒç›Šè®°å½•ï¼ˆæ³¨æ„ï¼šavailableQuantity = 0ï¼Œstatus = 'pending'ï¼‰
const entitlement = await createEntitlement({
  contractId: contractId,
  serviceType: dto.serviceType,
  source: dto.source,  // 'addon' | 'promotion' | 'compensation'
  totalQuantity: dto.totalQuantity,
  availableQuantity: 0,  // âš ï¸ å®¡æ‰¹å‰ä¸å¯ç”¨
  addOnReason: dto.addOnReason,
  createdBy: dto.createdBy,
  status: 'pending',  // ç­‰å¾…å®¡æ‰¹
});

// 3. åˆ›å»ºä¿®è®¢è®°å½•ï¼ˆè‡ªåŠ¨è®¾ç½® requiresApproval = trueï¼‰
await createEntitlementRevision({
  contractId: contractId,
  entitlementId: entitlement.id,
  serviceType: dto.serviceType,
  serviceName: dto.serviceSnapshot.serviceName,
  revisionNumber: nextRevisionNumber,
  revisionType: dto.source,  // 'addon' | 'promotion' | 'compensation'
  source: dto.source,
  quantityChanged: dto.totalQuantity,
  totalQuantity: dto.totalQuantity,
  availableQuantity: 0,  // âš ï¸ å®¡æ‰¹å‰
  status: 'pending',
  requiresApproval: true,  // å†³ç­– R6ï¼šæ‰€æœ‰é¢å¤–æƒç›Šéƒ½éœ€è¦å®¡æ‰¹
  addOnReason: dto.addOnReason,
  createdBy: dto.createdBy,
  snapshot: {
    serviceSnapshot: dto.serviceSnapshot,
  }
});
```

**å…³é”®ç‰¹æ€§ï¼ˆv2.16.8 å†³ç­– R6ï¼‰ï¼š**
1. æ¯æ¬¡æ·»åŠ é¢å¤–æƒç›Šåˆ›å»ºä¸€æ¡æ–°çš„ä¿®è®¢è®°å½•
2. revisionNumber ç»§ç»­å…¨å±€é€’å¢ï¼ˆä¸é‡ç½®ï¼‰
3. **æ‰€æœ‰é¢å¤–æƒç›Šéƒ½éœ€è¦å®¡æ‰¹**ï¼šè‡ªåŠ¨è®¾ç½® `requiresApproval=true`ï¼ŒçŠ¶æ€ä¸º 'pending'
4. å®¡æ‰¹å‰æƒç›Šä¸å¯ç”¨ï¼ˆ`availableQuantity = 0`ï¼‰
5. addOnReason è®°å½•æ·»åŠ åŸå› ï¼ˆç”¨äºå®¡è®¡ï¼‰
6. å®¡æ‰¹é€šè¿‡åæ›´æ–°çŠ¶æ€ä¸º 'applied' å¹¶æ¿€æ´»æƒç›Š

---

#### 6.6.7 ä¿®è®¢è®°å½•çš„ä¸å¯å˜æ€§

**æ ¸å¿ƒåŸåˆ™ï¼š** ä¿®è®¢è®°å½•ä¸€æ—¦åˆ›å»ºï¼Œæ ¸å¿ƒå­—æ®µä¸å¯ä¿®æ”¹

**ä¸å…è®¸ä¿®æ”¹çš„å­—æ®µï¼š**
- âŒ contractIdï¼ˆåˆåŒIDï¼‰
- âŒ entitlementIdï¼ˆæƒç›ŠIDï¼‰
- âŒ serviceTypeï¼ˆæœåŠ¡ç±»å‹ï¼‰
- âŒ revisionNumberï¼ˆç‰ˆæœ¬å·ï¼‰
- âŒ revisionTypeï¼ˆä¿®è®¢ç±»å‹ï¼‰
- âŒ sourceï¼ˆæ¥æºï¼‰
- âŒ quantityChangedï¼ˆå˜æ›´æ•°é‡ï¼‰
- âŒ createdByï¼ˆåˆ›å»ºäººï¼‰
- âŒ createdAtï¼ˆåˆ›å»ºæ—¶é—´ï¼‰

**å…è®¸ä¿®æ”¹çš„å­—æ®µï¼š**
- âœ… statusï¼ˆçŠ¶æ€ï¼špending â†’ approved/rejected/appliedï¼‰
- âœ… approvedByï¼ˆå®¡æ‰¹äººï¼‰
- âœ… approvedAtï¼ˆå®¡æ‰¹æ—¶é—´ï¼‰
- âœ… approvalNotesï¼ˆå®¡æ‰¹å¤‡æ³¨ï¼‰
- âœ… attachmentsï¼ˆé™„ä»¶ï¼‰

**å®ç°æ–¹å¼ï¼š**
1. **åº”ç”¨å±‚ä¿æŠ¤**ï¼šService å±‚ä¸æä¾›ä¿®æ”¹æ ¸å¿ƒå­—æ®µçš„æ–¹æ³•
2. **æ•°æ®åº“çº¦æŸ**ï¼šä¸ä½¿ç”¨è§¦å‘å™¨å¼ºåˆ¶ï¼Œä¾èµ–åº”ç”¨å±‚é€»è¾‘
3. **å®¡è®¡æ—¥å¿—**ï¼šå¦‚æœå¿…é¡»ä¿®æ”¹æ ¸å¿ƒå­—æ®µï¼Œåº”åˆ›å»ºæ–°çš„ä¿®è®¢è®°å½•ï¼Œè€Œä¸æ˜¯ä¿®æ”¹æ—§è®°å½•

**ä¾‹å¤–æƒ…å†µï¼š**
- æ•°æ®ä¿®å¤åœºæ™¯ï¼šç”± DBA ç›´æ¥ä¿®æ”¹æ•°æ®åº“ï¼ˆéœ€è®°å½•æ“ä½œæ—¥å¿—ï¼‰
- ç‰ˆæœ¬å›æ»šåœºæ™¯ï¼šåˆ›å»ºåå‘ä¿®è®¢è®°å½•ï¼ˆå¦‚ï¼šincrease ååˆ›å»º decreaseï¼‰

---

## 7. çŠ¶æ€æœºè®¾è®¡

### 7.1 åˆåŒçŠ¶æ€æœº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  draft  â”‚ è‰ç¨¿ï¼ˆåˆå§‹çŠ¶æ€ - åˆåŒå·²åˆ›å»ºä½†å°šæœªç­¾ç½²ï¼‰
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”‚ sign() â† åˆåŒç­¾ç½²å®Œæˆï¼ˆåˆ›å»ºåˆåŒæ—¶è‡ªåŠ¨æ‰§è¡Œï¼‰
     â”‚ å½“ createdAt è¢«è®¾ç½®ä¸”åˆåŒåŸºæœ¬ä¿¡æ¯å·²ç¡®è®¤
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ signed  â”‚ å·²ç­¾ç½²ï¼ˆåˆåŒå·²ç­¾ç½²ï¼Œç­‰å¾…æ”¯ä»˜æ¿€æ´»ï¼‰
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”‚ activate() â† ç›‘å¬ payment.succeeded äº‹ä»¶
     â”‚ é¦–ä»˜æ¬¾æ”¯ä»˜æˆåŠŸåè§¦å‘
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ active  â”‚ ç”Ÿæ•ˆä¸­ï¼ˆåˆåŒå·²æ¿€æ´»ï¼Œå¯æ¶ˆè´¹æœåŠ¡ï¼‰
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                            â”‚
     â”‚ terminate(reason)          â”‚ suspend(reason)
     â”‚ ç®¡ç†å‘˜æ“ä½œ                   â”‚ ç®¡ç†å‘˜æ“ä½œ
     â”‚                            â”‚
     â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ terminated â”‚              â”‚ suspended  â”‚
â”‚ å·²ç»ˆæ­¢      â”‚              â”‚ å·²æš‚åœ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    ï¼ˆä¸å¯æ¢å¤ï¼‰                    â”‚
                                   â”‚ resume()
                                   â”‚ ç®¡ç†å‘˜æ“ä½œ
                                   â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ active  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â”‚ complete() â† è‡ªåŠ¨è§¦å‘ï¼ˆæœåŠ¡æ¶ˆè´¹å®Œæ¯•æˆ–è¿‡æœŸï¼‰
                                   â”‚ å®šæ—¶ä»»åŠ¡æ£€æµ‹è‡ªåŠ¨å®Œæˆ
                                   â”‚
                                   â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ completed â”‚
                              â”‚ å·²å®Œæˆ     â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€è½¬æ¢è§„åˆ™ï¼ˆv2.16.4 æ˜ç¡®ï¼‰ï¼š**

| å½“å‰çŠ¶æ€ | äº‹ä»¶/æ“ä½œ | ç›®æ ‡çŠ¶æ€ | æ¡ä»¶ | è§¦å‘æ–¹å¼ | è¯´æ˜ |
|----------|-----------|----------|------|----------|------|
| draft | sign() | signed | åˆåŒåˆ›å»ºå®Œæˆ | è‡ªåŠ¨è§¦å‘ | åˆåŒåŸºæœ¬ä¿¡æ¯å·²ç¡®å®š |
| signed | activate() | active | payment.succeeded | äº‹ä»¶ç›‘å¬ | é¦–ä»˜æ¬¾æ”¯ä»˜æˆåŠŸå |
| active | terminate(reason) | terminated | æä¾›ç»ˆæ­¢åŸå›  | ç®¡ç†å‘˜æ“ä½œ | ä» active æˆ– suspended å‡å¯ç»ˆæ­¢ |
| active | suspend(reason) | suspended | æä¾›æš‚åœåŸå›  | **ä»…ç®¡ç†å‘˜** | ä¸´æ—¶æš‚åœæœåŠ¡ |
| active | complete() | completed | **æœåŠ¡æ¶ˆè´¹å®Œæ¯• OR å·²è¿‡æœŸ** | è‡ªåŠ¨è§¦å‘ | å®šæ—¶ä»»åŠ¡æ£€æµ‹è‡ªåŠ¨å®Œæˆ |
| suspended | resume() | active | æ¢å¤æœåŠ¡ | ç®¡ç†å‘˜æ“ä½œ | ä»æš‚åœçŠ¶æ€æ¢å¤ |
| suspended | terminate(reason) | terminated | æä¾›ç»ˆæ­¢åŸå›  | ç®¡ç†å‘˜æ“ä½œ | æš‚åœæœŸé—´ä¹Ÿå¯ç»ˆæ­¢ |

**çŠ¶æ€è½¬æ¢è¯¦ç»†è¯´æ˜ï¼š**

1. **åˆ›å»ºåˆåŒï¼ˆdraft â†’ signedï¼‰**
   - è§¦å‘æ—¶æœºï¼šè°ƒç”¨ `create()` æ–¹æ³•åˆ›å»ºåˆåŒæ—¶è‡ªåŠ¨å®Œæˆ
   - æ‰§è¡Œæ“ä½œï¼šè®¾ç½® `signedAt` æ—¶é—´æˆ³ï¼Œå‘å¸ƒ `contract.signed` äº‹ä»¶
   - çŠ¶æ€å«ä¹‰ï¼šåˆåŒå·²ç­¾ç½²ï¼Œç­‰å¾…å­¦ç”Ÿæ”¯ä»˜é¦–ä»˜æ¬¾

2. **æ¿€æ´»åˆåŒï¼ˆsigned â†’ activeï¼‰**
   - è§¦å‘æ—¶æœºï¼šç›‘å¬ `payment.succeeded` äº‹ä»¶ï¼ˆå†³ç­– #13ï¼‰
   - å‰ç½®æ¡ä»¶ï¼šé¦–ä»˜æ¬¾å·²æˆåŠŸæ”¯ä»˜
   - æ‰§è¡Œæ“ä½œï¼šè®¾ç½® `activatedAt`ï¼Œä»äº§å“å¿«ç…§åˆ›å»ºæœåŠ¡æƒç›Šï¼Œå‘å¸ƒ `contract.activated` äº‹ä»¶
   - çŠ¶æ€å«ä¹‰ï¼šåˆåŒå·²æ¿€æ´»ï¼Œå­¦ç”Ÿå¯å¼€å§‹é¢„çº¦å’Œæ¶ˆè´¹æœåŠ¡

3. **æš‚åœåˆåŒï¼ˆactive â†’ suspendedï¼‰**
   - è§¦å‘ï¼šç®¡ç†å‘˜æ‰‹åŠ¨æ“ä½œï¼ˆå†³ç­– #13ï¼‰
   - å‰ç½®æ¡ä»¶ï¼šæä¾›æš‚åœåŸå› 
   - æ‰§è¡Œæ“ä½œï¼šè®¾ç½® `suspendedAt`ï¼Œå¢åŠ  `suspensionCount`ï¼Œå‘å¸ƒ `contract.suspended` äº‹ä»¶
   - çŠ¶æ€å«ä¹‰ï¼šä¸´æ—¶æš‚åœæœåŠ¡ï¼Œå­¦ç”Ÿä¸å¯é¢„çº¦æ–°æœåŠ¡

4. **æ¢å¤åˆåŒï¼ˆsuspended â†’ activeï¼‰**
   - è§¦å‘ï¼šç®¡ç†å‘˜æ‰‹åŠ¨æ“ä½œ
   - æ‰§è¡Œæ“ä½œï¼šæ¸…ç©º `suspendedAt`ï¼Œå‘å¸ƒ `contract.resumed` äº‹ä»¶
   - çŠ¶æ€å«ä¹‰ï¼šæ¢å¤æœåŠ¡ï¼Œå­¦ç”Ÿå¯ç»§ç»­é¢„çº¦

5. **å®ŒæˆåˆåŒï¼ˆactive â†’ completedï¼‰**
   - è§¦å‘ï¼šè‡ªåŠ¨å®šæ—¶ä»»åŠ¡æ£€æµ‹ï¼ˆå†³ç­– #13ï¼‰
   - æ¡ä»¶ï¼šæ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶
     - âœ… æ‰€æœ‰æœåŠ¡æƒç›Šå·²æ¶ˆè´¹å®Œæ¯•ï¼ˆ`availableQuantity = 0`ï¼‰
     - âœ… åˆåŒå·²è¿‡æœŸï¼ˆ`expiresAt < now()`ï¼‰
   - æ‰§è¡Œæ“ä½œï¼šè®¾ç½® `completedAt`ï¼Œå‘å¸ƒ `contract.completed` äº‹ä»¶
   - çŠ¶æ€å«ä¹‰ï¼šåˆåŒæ­£å¸¸ç»“æŸï¼ŒæœåŠ¡äº¤ä»˜å®Œæˆ

6. **ç»ˆæ­¢åˆåŒï¼ˆactive/suspended â†’ terminatedï¼‰**
   - è§¦å‘ï¼šç®¡ç†å‘˜æ‰‹åŠ¨æ“ä½œ
   - å‰ç½®æ¡ä»¶ï¼šæä¾›ç»ˆæ­¢åŸå› 
   - æ‰§è¡Œæ“ä½œï¼šè®¾ç½® `terminatedAt`ï¼Œå†»ç»“æ‰€æœ‰æƒç›Šï¼ˆ`availableQuantity = 0`ï¼‰ï¼Œå‘å¸ƒ `contract.terminated` äº‹ä»¶
   - çŠ¶æ€å«ä¹‰ï¼šåˆåŒæå‰ç»ˆæ­¢ï¼Œä¸å†æä¾›æœåŠ¡
| suspended  | terminate(reason)   | terminated | æä¾›ç»ˆæ­¢åŸå›                  | ç®¡ç†å‘˜æ“ä½œ |

**å…³é”®çŠ¶æ€è½¬æ¢è¯´æ˜ï¼ˆv2.16.4ï¼‰ï¼š**

1. **æ¿€æ´»æ¡ä»¶ï¼ˆdraft â†’ activeï¼‰**
   - è§¦å‘ï¼šç›‘å¬ `payment.succeeded` äº‹ä»¶ï¼ˆå†³ç­– #13ï¼‰
   - æ¡ä»¶ï¼šé¦–ä»˜æ¬¾å·²æˆåŠŸæ”¯ä»˜
   - æ“ä½œï¼šè®¾ç½® `effectiveAt`ã€è®¡ç®— `expiresAt`ã€åˆå§‹åŒ–æœåŠ¡æƒç›Š

2. **å®Œæˆæ¡ä»¶ï¼ˆactive â†’ completedï¼‰**
   - è§¦å‘ï¼šè‡ªåŠ¨å®šæ—¶ä»»åŠ¡æ£€æµ‹ï¼ˆå†³ç­– #13ï¼‰
   - æ¡ä»¶ï¼šæ»¡è¶³ä»¥ä¸‹**ä»»ä¸€æ¡ä»¶**å³è‡ªåŠ¨å®Œæˆ
     - âœ… æ‰€æœ‰æœåŠ¡æƒç›Šå·²æ¶ˆè´¹å®Œæ¯•ï¼ˆ`availableQuantity = 0`ï¼‰
     - âœ… åˆåŒå·²è¿‡æœŸï¼ˆ`expiresAt < now`ï¼‰
   - æ“ä½œï¼šæ›´æ–°çŠ¶æ€ä¸º `completed`

3. **æš‚åœæƒé™ï¼ˆactive â†’ suspendedï¼‰**
   - è§¦å‘ï¼šç®¡ç†å‘˜æ‰‹åŠ¨æ“ä½œï¼ˆå†³ç­– #13ï¼‰
   - æ¡ä»¶ï¼š**ä»…ç®¡ç†å‘˜**æœ‰æƒé™æš‚åœåˆåŒ
   - ç›®çš„ï¼šä¸´æ—¶æš‚åœæœåŠ¡ï¼ˆå¦‚å­¦ç”Ÿè¯·å‡ã€çº çº·å¤„ç†ç­‰ï¼‰
   - å½±å“ï¼šæš‚åœæœŸé—´ä¸å¯é¢„çº¦æœåŠ¡ï¼Œä½†æ—¶é—´ä»åœ¨æµé€

**ä¸å…è®¸çš„è½¬æ¢ï¼š**

- âŒ terminated â†’ activeï¼ˆç»ˆæ­¢åä¸å¯æ¢å¤ï¼‰
- âŒ completed â†’ activeï¼ˆå®Œæˆåä¸å¯æ¢å¤ï¼‰
- âŒ draft â†’ completedï¼ˆè‰ç¨¿ä¸èƒ½ç›´æ¥å®Œæˆï¼‰

### 7.2 é¢„å çŠ¶æ€æœºã€v2.16.9 é‡å¤§ç®€åŒ– - ç§»é™¤è¿‡æœŸé€»è¾‘ã€‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ active  â”‚ ç”Ÿæ•ˆä¸­ï¼ˆåˆå§‹çŠ¶æ€ï¼‰
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                            â”‚
     â”‚ release('completed')       â”‚ cancel('cancelled')
     â”‚                            â”‚
     â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    released     â”‚    â”‚    cancelled    â”‚
â”‚ (æœåŠ¡å·²å®Œæˆ)    â”‚    â”‚ (ç”¨æˆ·å·²å–æ¶ˆ)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€è½¬æ¢è§„åˆ™ï¼ˆv2.16.9 æ›´æ–°ï¼‰ï¼š**

| å½“å‰çŠ¶æ€ | äº‹ä»¶/æ“ä½œ                  | ç›®æ ‡çŠ¶æ€ | æ¡ä»¶/è¯´æ˜                  |
| -------- | -------------------------- | -------- | -------------------------- |
| active   | release('completed')      | released | æœåŠ¡å®Œæˆ                   |
| active   | cancel('cancelled')       | cancelled | ç”¨æˆ·å–æ¶ˆé¢„çº¦               |
| active   | release('admin_manual')   | released | ç®¡ç†å‘˜æ‰‹åŠ¨é‡Šæ”¾ï¼ˆå¼‚å¸¸å¤„ç†ï¼‰ |

**v2.16.9 é‡å¤§å˜æ›´ï¼š**
- âŒ **ç§»é™¤ `expired` çŠ¶æ€**ï¼ˆä¸å†è‡ªåŠ¨è¿‡æœŸï¼‰
- âŒ **ç§»é™¤ TTL æœºåˆ¶**ï¼ˆä¸å†éœ€è¦ expiresAt å­—æ®µï¼‰
- âœ… **é¢„å æ°¸ä¸è¿‡æœŸ**ï¼šå¿…é¡»é€šè¿‡ releaseHold() æˆ– cancelHold() é‡Šæ”¾
- âœ… **æ‰€æœ‰çŠ¶æ€è½¬æ¢å‡ä¸ºäººå·¥è§¦å‘**
- âœ… `cancelled` çŠ¶æ€ç”¨äºåŒºåˆ†å–æ¶ˆæ“ä½œ

**ä¸å…è®¸çš„è½¬æ¢ï¼š**
- âŒ released â†’ activeï¼ˆé‡Šæ”¾åä¸å¯æ¢å¤ï¼‰
- âŒ cancelled â†’ activeï¼ˆå–æ¶ˆåä¸å¯æ¢å¤ï¼‰
- âŒ active â†’ activeï¼ˆé‡å¤é‡Šæ”¾æŠ›å¼‚å¸¸ï¼‰

**å¯¹æ¯”ï¼šbefore â†’ after**

```
Before (v2.16.8):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ active  â”‚ â† expiresAt = createdAt + 15min
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”œâ”€â†’ released  (äººå·¥)
     â”œâ”€â†’ cancelled (äººå·¥)
     â””â”€â†’ expired   (å®šæ—¶ä»»åŠ¡)

After (v2.16.9):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ active  â”‚ â† æ°¸ä¸è¿‡æœŸ
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”œâ”€â†’ released  (äººå·¥)
     â””â”€â†’ cancelled (äººå·¥)

     // æ²¡æœ‰ expired çŠ¶æ€ï¼Œæ²¡æœ‰å®šæ—¶ä»»åŠ¡
```

---

## 8. å®æ–½æŒ‡å—

### 8.1 å‘½åçº¦å®šï¼ˆNaming Conventionsï¼‰

**ç›®çš„ï¼š** æé«˜ç¼–ç å‡†ç¡®æ€§å’Œå›¢é˜Ÿç†è§£ä¸€è‡´æ€§

#### 8.1.1 æ•°æ®åº“å‘½åè§„èŒƒ

**è¡¨åå’Œåˆ—åï¼š** snake_caseï¼ˆå°å†™ä¸‹åˆ’çº¿ï¼‰

```sql
-- è¡¨å
contracts
contract_service_entitlements
service_ledgers

-- åˆ—å
contract_id
service_type
created_at
updated_at
expires_at
```

**æšä¸¾ç±»å‹ï¼š** snake_case

```sql
-- æšä¸¾ç±»å‹åç§°
contract_status
entitlement_source
service_unit

-- æšä¸¾å€¼
'draft', 'active', 'completed', 'terminated', 'suspended'
'product', 'addon', 'promotion', 'compensation'
'times', 'hours', 'sessions', 'days', 'minutes'
```

#### 8.1.2 TypeScript å‘½åè§„èŒƒ

**æ¥å£å’Œç±»å‹ï¼š** PascalCase

```typescript
interface Contract { ... }
interface ContractServiceEntitlement { ... }
type ProductItemType = 'service' | 'service_package';
enum ContractStatus { ... }
```

**å˜é‡å’Œå±æ€§ï¼š** camelCase

```typescript
const contractId = '...';
const serviceType = 'gap_analysis';
const createdAt = new Date();

// DTO å±æ€§
interface CreateContractDto {
  studentId: string;
  productSnapshot: IProductSnapshot;
  totalAmount?: string;
}
```

**å¸¸é‡å’Œæšä¸¾å€¼ï¼š** UPPER_SNAKE_CASE æˆ– PascalCaseï¼ˆæšä¸¾ï¼‰

```typescript
const MAX_CONTRACT_AMOUNT = 100000;
// const DEFAULT_TTL_MINUTES = 15;  // v2.16.9: å·²åºŸå¼ƒï¼Œç§»é™¤TTLæœºåˆ¶

enum ContractStatus {
  Draft = 'draft',
  Active = 'active',
  Completed = 'completed',
}
```

#### 8.1.3 Drizzle ORM è‡ªåŠ¨è½¬æ¢

Drizzle ORM ä¼šè‡ªåŠ¨å¤„ç†æ•°æ®åº“å’Œ TypeScript ä¹‹é—´çš„å‘½åè½¬æ¢ï¼š

```typescript
// Schema å®šä¹‰ï¼ˆæ•°æ®åº“ï¼šsnake_caseï¼‰
export const contracts = pgTable('contracts', {
  serviceType: varchar('service_type', { length: 100 }),  // æ•°æ®åº“åˆ—å
  createdAt: timestamp('created_at'),                      // æ•°æ®åº“åˆ—å
});

// TypeScript ä½¿ç”¨ï¼ˆä»£ç ï¼šcamelCaseï¼‰
const contract = await db.query.contracts.findFirst({
  where: (c) => eq(c.serviceType, 'gap_analysis'),  // TypeScript å±æ€§å
});

console.log(contract.serviceType);  // camelCase
console.log(contract.createdAt);    // camelCase
```

#### 8.1.4 æ–‡ä»¶å‘½åè§„èŒƒ

**Schema æ–‡ä»¶ï¼š** kebab-case + `.schema.ts`

```
contracts.schema.ts
contract-service-entitlements.schema.ts
service-ledgers.schema.ts
service-type.enum.ts
```

**Service æ–‡ä»¶ï¼š** kebab-case + `.service.ts`

```
contract.service.ts
service-ledger.service.ts
service-hold.service.ts
```

**DTO æ–‡ä»¶ï¼š** kebab-case + `.dto.ts`

```
create-contract.dto.ts
service-balance-query.dto.ts
consume-service.dto.ts
```

#### 8.1.5 é‡è¦æé†’

âš ï¸ **æ•°æ®åº“ vs TypeScript çš„å¯¹åº”å…³ç³»ï¼š**

| æ•°æ®åº“ï¼ˆSQLï¼‰      | TypeScriptï¼ˆä»£ç ï¼‰ | è¯´æ˜                     |
|-------------------|-------------------|-------------------------|
| `service_type`    | `serviceType`     | Drizzle è‡ªåŠ¨è½¬æ¢        |
| `created_at`      | `createdAt`       | Drizzle è‡ªåŠ¨è½¬æ¢        |
| `expires_at`      | `expiresAt`       | Drizzle è‡ªåŠ¨è½¬æ¢        |
| `contract_status` | `ContractStatus`  | æšä¸¾ç±»å‹ï¼ˆPascalCaseï¼‰  |

âœ… **æœ€ä½³å®è·µï¼š**
- Schema å®šä¹‰æ—¶ï¼šä½¿ç”¨æ•°æ®åº“å‘½åï¼ˆsnake_caseï¼‰
- TypeScript ä»£ç ä¸­ï¼šä½¿ç”¨ camelCase è®¿é—®å±æ€§
- ç±»å‹å’Œæ¥å£ï¼šä½¿ç”¨ PascalCase
- æ–‡ä»¶å‘½åï¼šä½¿ç”¨ kebab-case

---

### 8.1.5 SQL è„šæœ¬æ–‡ä»¶ç»“æ„ï¼ˆv2.16.8 å†³ç­– I7ï¼‰

**ç›®çš„ï¼š** å®šä¹‰æ•°æ®åº“å‡½æ•°ã€è§¦å‘å™¨ã€ç´¢å¼•ã€çº¦æŸçš„ SQL è„šæœ¬ç®¡ç†æ–¹æ¡ˆ

**æ ¸å¿ƒåŸåˆ™ï¼š** ç‹¬ç«‹ SQL æ–‡ä»¶ç®¡ç†ï¼ˆé€‰é¡¹ Aï¼‰ï¼Œä¸ Drizzle è¡¨ç»“æ„è¿ç§»åˆ†ç¦»

**æ–‡ä»¶ç»“æ„ï¼š**
```
src/infrastructure/database/
â”œâ”€â”€ migrations/
â”‚   â”œâ”€â”€ sql/                          # ç‹¬ç«‹ SQL è„šæœ¬ï¼ˆâ­ï¸ é€‰é¡¹ A - æ¨èï¼‰
â”‚   â”‚   â”œâ”€â”€ contract_number_generator.sql          # åˆåŒç¼–å·ç”Ÿæˆå‡½æ•°ï¼ˆSequence + Advisory Lockï¼‰
â”‚   â”‚   â”‚   - å‡½æ•°åç§°ï¼šgenerate_contract_code()
â”‚   â”‚   â”‚   - æ ¼å¼ï¼šCONTRACT-YYYY-MM-NNNNN
â”‚   â”‚   â”‚   - ä½¿ç”¨ï¼šSELECT generate_contract_code()
â”‚   â”‚   â”‚   - ç‰¹æ€§ï¼šMonthly reset, Advisory Lock ä¿è¯å¹¶å‘å®‰å…¨
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ contract_triggers.sql                     # æ•°æ®åº“è§¦å‘å™¨
â”‚   â”‚   â”‚   - sync_held_quantity()                    # åŒæ­¥é¢„å æ•°é‡ï¼ˆv2.16.5 å†³ç­– C-NEW-2ï¼‰
â”‚   â”‚   â”‚   - sync_consumed_quantity()                # åŒæ­¥æ¶ˆè´¹æ•°é‡ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰
â”‚   â”‚   â”‚   - è§¦å‘å™¨ç»‘å®šï¼šservice_holds è¡¨ (INSERT/UPDATE)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ contract_indexes.sql                      # ç´¢å¼•ï¼ˆçº¦ 30 ä¸ªï¼‰
â”‚   â”‚   â”‚   - è¦†ç›–æ‰€æœ‰é«˜é¢‘æŸ¥è¯¢åœºæ™¯
â”‚   â”‚   â”‚   - åŒ…å«å¤åˆç´¢å¼•ã€partial index
â”‚   â”‚   â”‚   - å‘½åè§„èŒƒï¼šidx_<è¡¨å>_<å­—æ®µ1>_<å­—æ®µ2>
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ contract_constraints.sql                  # CHECK çº¦æŸï¼ˆçº¦ 20 ä¸ªï¼‰
â”‚   â”‚   â”‚   - å‘½åè§„èŒƒï¼šchk_<è¡¨å>_<å­—æ®µ>_<ç±»å‹>
â”‚   â”‚   â”‚   - ç¤ºä¾‹ï¼šchk_contracts_paid_amount_not_exceed_total
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ contract_entitlement_revisions_indexes.sql      # ä¿®è®¢è¡¨ç´¢å¼•ï¼ˆ9ä¸ªï¼‰ğŸ†•v2.16.8
â”‚   â”‚   â””â”€â”€ contract_entitlement_revisions_constraints.sql  # ä¿®è®¢è¡¨CHECKçº¦æŸï¼ˆ2ä¸ªï¼‰ğŸ†•v2.16.8
â”‚   â”‚
â”‚   â”œâ”€â”€ 0000_initial.sql                      # Drizzle è‡ªåŠ¨ç”Ÿæˆçš„è¡¨ç»“æ„è¿ç§»
â”‚   â”œâ”€â”€ 0001_contract_tables.sql              # contract ç›¸å…³è¡¨
â”‚   â””â”€â”€ 0002_add_contract_entitlement_revisions.sql  # ä¿®è®¢è¡¨è¿ç§»
â”‚
â””â”€â”€ schema/                                   # TypeScript Schema å®šä¹‰
    â”œâ”€â”€ contracts.schema.ts
    â”œâ”€â”€ contract-service-entitlements.schema.ts
    â”œâ”€â”€ contract-entitlement-revisions.schema.ts  # ğŸ†•v2.16.8
    â””â”€â”€ ...
```

**å®æ–½æ–¹å¼ï¼ˆå†³ç­– I7 - é€‰é¡¹ Aï¼‰ï¼š**

| å®æ–½æ­¥éª¤ | å·¥å…·/å‘½ä»¤ | è¯´æ˜ |
|---------|----------|------|
| 1. ç”Ÿæˆè¡¨ç»“æ„è¿ç§» | `npm run db:generate` | Drizzle Kit è‡ªåŠ¨ç”Ÿæˆ |
| 2. åˆ›å»º SQL è„šæœ¬ | æ‰‹åŠ¨åˆ›å»º | æŒ‰ç…§ä¸Šè¿°æ–‡ä»¶ç»“æ„ |
| 3. æ‰§è¡Œ SQL è„šæœ¬ | `psql -d db -f script.sql` | æ‰‹åŠ¨é€ä¸€æ‰§è¡Œ |
| 4. è¿è¡Œè¿ç§» | `npm run db:migrate` | æ‰§è¡Œ Drizzle è¿ç§» |

**ä¸ºä»€ä¹ˆé€‰æ‹©ç‹¬ç«‹ SQL æ–‡ä»¶ï¼ˆé€‰é¡¹ Aï¼‰ï¼š**

âœ… **ä¼˜åŠ¿ï¼š**
1. **èŒè´£æ¸…æ™°**ï¼šå‡½æ•°ã€è§¦å‘å™¨ã€ç´¢å¼•ã€çº¦æŸä¸è¡¨ç»“æ„åˆ†ç¦»
2. **ç‰ˆæœ¬æ§åˆ¶**ï¼šSQL æ–‡ä»¶ç‹¬ç«‹ç‰ˆæœ¬æ§åˆ¶ï¼ŒDBA å¯ä»¥ç›´æ¥å®¡æ ¸
3. **æ˜“äºç»´æŠ¤**ï¼šDBA å¯ä»¥å•ç‹¬ä¿®æ”¹ SQL è„šæœ¬ï¼Œæ— éœ€ç†è§£ TypeScript ä»£ç 
4. **å®¡æ ¸å‹å¥½**ï¼šå®‰å…¨å®¡è®¡æ—¶ï¼ŒDBA åªéœ€å®¡æ ¸ SQL æ–‡ä»¶
5. **éƒ¨ç½²çµæ´»**ï¼šå¯ä»¥å•ç‹¬éƒ¨ç½²å‡½æ•°å’Œçº¦æŸï¼Œä¸å½±å“è¡¨ç»“æ„è¿ç§»
6. **è¯­æ³•é«˜äº®**ï¼šSQL æ–‡ä»¶åœ¨ç¼–è¾‘å™¨ä¸­æœ‰å®Œæ•´è¯­æ³•é«˜äº®å’ŒéªŒè¯

âš ï¸ **æ³¨æ„äº‹é¡¹ï¼š**
1. **éƒ¨ç½²é¡ºåº**ï¼šå¿…é¡»å…ˆæ‰§è¡Œè¡¨ç»“æ„è¿ç§»ï¼Œå†æ‰§è¡Œ SQL è„šæœ¬ï¼ˆå‡½æ•°ã€ç´¢å¼•ã€çº¦æŸï¼‰
2. **äººä¸ºé”™è¯¯**ï¼šéœ€è¦æ‰‹åŠ¨æ‰§è¡Œ SQL è„šæœ¬ï¼Œå¯èƒ½é—æ¼
3. **è‡ªåŠ¨åŒ–**ï¼šå»ºè®®ç¼–å†™éƒ¨ç½²è„šæœ¬ï¼Œè‡ªåŠ¨åŒ–æ‰§è¡Œæ‰€æœ‰ SQL æ–‡ä»¶

**è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ç¤ºä¾‹ï¼š**
```bash
#!/bin/bash
# deploy-contract-db.sh

echo "ğŸš€ éƒ¨ç½² Contract Domain æ•°æ®åº“..."

# 1. è¿è¡Œ Drizzle è¿ç§»ï¼ˆè¡¨ç»“æ„ï¼‰
echo "ğŸ“¦ æ‰§è¡Œè¡¨ç»“æ„è¿ç§»..."
npm run db:migrate

# 2. æ‰§è¡Œ SQL è„šæœ¬ï¼ˆå‡½æ•°ã€è§¦å‘å™¨ã€ç´¢å¼•ã€çº¦æŸï¼‰
echo "ğŸ”§ æ‰§è¡Œ SQL è„šæœ¬..."

SQL_DIR="src/infrastructure/database/migrations/sql"

# åˆåŒç¼–å·ç”Ÿæˆå‡½æ•°
echo "  - åˆåŒç¼–å·ç”Ÿæˆå‡½æ•°..."
psql -d mentorx -f "$SQL_DIR/contract_number_generator.sql"

# è§¦å‘å™¨
echo "  - è§¦å‘å™¨..."
psql -d mentorx -f "$SQL_DIR/contract_triggers.sql"

# ç´¢å¼•
echo "  - ç´¢å¼•..."
psql -d mentorx -f "$SQL_DIR/contract_indexes.sql"

# CHECK çº¦æŸ
echo "  - CHECK çº¦æŸ..."
psql -d mentorx -f "$SQL_DIR/contract_constraints.sql"

# ä¿®è®¢è¡¨ç´¢å¼•ï¼ˆv2.16.8ï¼‰
echo "  - ä¿®è®¢è¡¨ç´¢å¼•..."
psql -d mentorx -f "$SQL_DIR/contract_entitlement_revisions_indexes.sql"

# ä¿®è®¢è¡¨çº¦æŸï¼ˆv2.16.8ï¼‰
echo "  - ä¿®è®¢è¡¨çº¦æŸ..."
psql -d mentorx -f "$SQL_DIR/contract_entitlement_revisions_constraints.sql"

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
```

**ä½¿ç”¨æ–¹å¼ï¼š**
```bash
# ä¸€é”®éƒ¨ç½²
./scripts/deploy-contract-db.sh
```

---

### 8.2 ç¯å¢ƒå˜é‡é…ç½®ï¼ˆv2.16.4 å†³ç­– M3ï¼‰

**ç›®çš„ï¼š** å®šä¹‰ Contract Domain æ‰€éœ€çš„ç¯å¢ƒå˜é‡

#### 8.2.1 æœåŠ¡é¢„å ï¼ˆService Holdsï¼‰

```bash
# é¢„å è¿‡æœŸæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
CONTRACT_HOLD_TTL_MINUTES=15

# é¢„å æ¸…ç†ä»»åŠ¡ï¼ˆCron è¡¨è¾¾å¼ï¼‰
# æ¯ 5 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡æ¸…ç†ä»»åŠ¡ï¼Œé‡Šæ”¾è¿‡æœŸé¢„å 
CONTRACT_HOLD_CLEANUP_CRON='*/5 * * * *'
```

**è¯´æ˜ï¼ˆv2.16.9ï¼‰ï¼š**
- âŒ `CONTRACT_HOLD_TTL_MINUTES`: **å·²åºŸå¼ƒ** - æœåŠ¡é¢„å ä¸å†è‡ªåŠ¨è¿‡æœŸ
- âŒ `CONTRACT_HOLD_CLEANUP_CRON`: **å·²åºŸå¼ƒ** - ç§»é™¤è‡ªåŠ¨æ¸…ç†ä»»åŠ¡
- âœ… **æ‰‹åŠ¨é‡Šæ”¾**ï¼šæ‰€æœ‰é¢„å å¿…é¡»é€šè¿‡ `releaseHold()` æˆ– `cancelHold()` æ˜¾å¼é‡Šæ”¾
- âœ… **ç›‘æ§å»ºè®®**ï¼šå»ºè®®å®ç°ç›‘æ§ä»»åŠ¡ï¼Œå®šæœŸæ£€æŸ¥é•¿æ—¶é—´æœªé‡Šæ”¾çš„é¢„å ï¼ˆå¦‚è¶…è¿‡24å°æ—¶ï¼‰

#### 8.2.2 æµæ°´å½’æ¡£ï¼ˆLedger Archiveï¼‰

```bash
# æµæ°´å½’æ¡£ä»»åŠ¡ï¼ˆCron è¡¨è¾¾å¼ï¼‰
# æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œå½’æ¡£ä»»åŠ¡
CONTRACT_ARCHIVE_CRON='0 2 * * *'

# å½’æ¡£é˜ˆå€¼ï¼ˆå¤©æ•°ï¼‰
# è¶…è¿‡ 90 å¤©çš„æµæ°´è‡ªåŠ¨å½’æ¡£
CONTRACT_ARCHIVE_THRESHOLD_DAYS=90
```

**è¯´æ˜ï¼š**
- `CONTRACT_ARCHIVE_CRON`: æµæ°´å½’æ¡£çš„å®šæ—¶ä»»åŠ¡
  - å»ºè®®åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œï¼ˆå‡Œæ™¨ 2-4 ç‚¹ï¼‰
  - å°†è¶…è¿‡é˜ˆå€¼çš„æµæ°´ç§»åŠ¨åˆ° `service_ledgers_archive` è¡¨

- `CONTRACT_ARCHIVE_THRESHOLD_DAYS`: å½’æ¡£é˜ˆå€¼å¤©æ•°
  - é»˜è®¤ 90 å¤©ï¼ˆ3 ä¸ªæœˆï¼‰
  - å¯æ ¹æ®æ•°æ®é‡å’Œæ€§èƒ½éœ€æ±‚è°ƒæ•´

#### 8.2.3 åˆåŒç¼–å·ç”Ÿæˆ

```bash
# åˆåŒç¼–å·å‰ç¼€
CONTRACT_NUMBER_PREFIX='CONTRACT'

# åˆåŒç¼–å·æ ¼å¼
# æ”¯æŒçš„æ ¼å¼å˜é‡ï¼š{PREFIX}-{YYYY}-{MM}-{NNNNN}
CONTRACT_NUMBER_FORMAT='{PREFIX}-{YYYY}-{MM}-{NNNNN}'
```

**è¯´æ˜ï¼š**
- `CONTRACT_NUMBER_PREFIX`: åˆåŒç¼–å·å‰ç¼€ï¼ˆé»˜è®¤ 'CONTRACT'ï¼‰
- `CONTRACT_NUMBER_FORMAT`: åˆåŒç¼–å·æ ¼å¼ï¼ˆé»˜è®¤æœˆåº¦åºåˆ—ï¼‰
  - v2.16.4 å†³ç­– C5ï¼šé‡‡ç”¨ `CONTRACT-YYYY-MM-NNNNN` æ ¼å¼
  - æœˆåˆè‡ªåŠ¨é‡ç½®åºåˆ—å·

#### 8.2.4 ä¸šåŠ¡è§„åˆ™é…ç½®

```bash
# æ€»é‡‘é¢è¦†ç›–çš„æœ€å¤§æŠ˜æ‰£æ¯”ä¾‹ï¼ˆç™¾åˆ†æ¯”ï¼‰
CONTRACT_MAX_DISCOUNT_PERCENTAGE=90

# æ€»é‡‘é¢è¦†ç›–çš„æœ€å¤§å€æ•°
CONTRACT_MAX_PRICE_MULTIPLIER=2.0

# æ˜¯å¦å…è®¸å…è´¹åˆåŒï¼ˆ$0ï¼‰
CONTRACT_ALLOW_FREE_CONTRACTS=false
```

**è¯´æ˜ï¼š**
- `CONTRACT_MAX_DISCOUNT_PERCENTAGE`: æœ€å¤§æŠ˜æ‰£æ¯”ä¾‹ï¼ˆé»˜è®¤ 90%ï¼Œå³æœ€ä½ 10% åŸä»·ï¼‰
- `CONTRACT_MAX_PRICE_MULTIPLIER`: æœ€å¤§ä»·æ ¼å€æ•°ï¼ˆé»˜è®¤ 2.0ï¼Œå³æœ€é«˜ 200% åŸä»·ï¼‰
- `CONTRACT_ALLOW_FREE_CONTRACTS`: æ˜¯å¦å…è®¸å…è´¹åˆåŒï¼ˆé»˜è®¤ falseï¼Œéœ€è¦ç‰¹æ®Šæƒé™ï¼‰

#### 8.2.5 å®Œæ•´é…ç½®ç¤ºä¾‹

```bash
# Contract Domain Environment Variables

# === Service Holds ===
CONTRACT_HOLD_TTL_MINUTES=15
CONTRACT_HOLD_CLEANUP_CRON='*/5 * * * *'

# === Ledger Archive ===
CONTRACT_ARCHIVE_CRON='0 2 * * *'
CONTRACT_ARCHIVE_THRESHOLD_DAYS=90

# === Contract Number Generation ===
CONTRACT_NUMBER_PREFIX='CONTRACT'
CONTRACT_NUMBER_FORMAT='{PREFIX}-{YYYY}-{MM}-{NNNNN}'

# === Business Rules ===
CONTRACT_MAX_DISCOUNT_PERCENTAGE=90
CONTRACT_MAX_PRICE_MULTIPLIER=2.0
CONTRACT_ALLOW_FREE_CONTRACTS=false
```

---

### 8.3 å¼€å‘ä»»åŠ¡æ¸…å•

#### Phase 1: æ ¸å¿ƒæ¨¡å—å¼€å‘

- [ ] **åˆ›å»º Contract Domain ç›®å½•ç»“æ„**
  ```
  src/domains/sales/contract/
  â”œâ”€â”€ contract/                  # åˆåŒç®¡ç†
  â”‚   â”œâ”€â”€ contract.service.ts
  â”‚   â”œâ”€â”€ contract.repository.ts
  â”‚   â”œâ”€â”€ contract.controller.ts
  â”‚   â””â”€â”€ dto/
  â”œâ”€â”€ service-entitlement/       # æœåŠ¡æƒç›Šç®¡ç†
  â”‚   â”œâ”€â”€ service-entitlement.service.ts
  â”‚   â””â”€â”€ dto/
  â”œâ”€â”€ service-ledger/            # æœåŠ¡æµæ°´ç®¡ç†
  â”‚   â”œâ”€â”€ service-ledger.service.ts
  â”‚   â”œâ”€â”€ service-ledger.repository.ts
  â”‚   â””â”€â”€ dto/
  â”œâ”€â”€ service-hold/              # æœåŠ¡é¢„å ç®¡ç†
  â”‚   â”œâ”€â”€ service-hold.service.ts
  â”‚   â”œâ”€â”€ service-hold.repository.ts
  â”‚   â””â”€â”€ dto/
  â”œâ”€â”€ archive/                   # å½’æ¡£ç®¡ç†
  â”‚   â”œâ”€â”€ service-ledger-archive.service.ts
  â”‚   â””â”€â”€ dto/
  â”œâ”€â”€ entitlement-revision/      # æƒç›Šä¿®è®¢å†å²ç®¡ç† ğŸ†•v2.16.8
  â”‚   â”œâ”€â”€ entitlement-revision.service.ts
  â”‚   â””â”€â”€ dto/
  â”œâ”€â”€ events/                    # äº‹ä»¶ç›‘å¬å™¨
  â”‚   â”œâ”€â”€ listeners/
  â”‚   â””â”€â”€ handlers/
  â””â”€â”€ contract.module.ts
  ```} .guist/system_sandbox/tool_use/Edit:0{

- [ ] **åˆ›å»ºæ•°æ®åº“ Schema**
  - [ ] `src/database/schema/contracts.schema.ts`
  - [ ] `src/database/schema/contract-service-entitlements.schema.ts`
  - [ ] `src/database/schema/service-ledgers.schema.ts`
  - [ ] `src/database/schema/service-holds.schema.ts`
  - [ ] `src/database/schema/service-ledgers-archive.schema.ts`
  - [ ] `src/database/schema/service-ledger-archive-policies.schema.ts`
  - [ ] `src/database/schema/enums/service-type.enum.ts`ï¼ˆç»Ÿä¸€æšä¸¾ï¼‰

- [ ] **ç”Ÿæˆæ•°æ®åº“è¿ç§»**
  ```bash
  npm run db:generate
  npm run db:migrate
  ```

- [ ] **å®ç° ContractService**
  - [ ] `create()` - åˆ›å»ºåˆåŒ
  - [ ] `search()` - æŸ¥è¯¢åˆåŒåˆ—è¡¨
  - [ ] `findOne()` - æŸ¥è¯¢å•ä¸ªåˆåŒï¼ˆæ”¯æŒå¤šç§æŸ¥è¯¢æ¡ä»¶ï¼‰ğŸ†•v2.16.7
  - [ ] `update()` - æ›´æ–°åˆåŒä¿¡æ¯
  - [ ] `activate()` - æ¿€æ´»åˆåŒ
  - [ ] `terminate()` - ç»ˆæ­¢åˆåŒ
  - [ ] `suspend()` - æš‚åœåˆåŒ ğŸ†•v2.16.4
  - [ ] `resume()` - æ¢å¤åˆåŒ ğŸ†•v2.16.4
  - [ ] `complete()` - å®ŒæˆåˆåŒ ğŸ†•v2.16.4
  - [ ] `getServiceBalance()` - æŸ¥è¯¢æœåŠ¡æƒç›Šä½™é¢
  - [ ] `consumeService()` - æ‰£å‡æœåŠ¡æƒç›Š
  - [ ] `addEntitlement()` - æ·»åŠ é¢å¤–æƒç›Š ğŸ†•v2.16 (è‡ªåŠ¨è®°å½•ä¿®è®¢å†å²)
  - [ ] `getEntitlementRevisions()` - æŸ¥è¯¢æƒç›Šä¿®è®¢å†å² ğŸ†•v2.16.8
  - [ ] `approveRevision()` - å®¡æ‰¹æƒç›Šä¿®è®¢ ğŸ†•v2.16.8
  - [ ] `rejectRevision()` - æ‹’ç»æƒç›Šä¿®è®¢ ğŸ†•v2.16.8

- [ ] **å®ç° ServiceLedgerService**
  - [ ] `recordConsumption()` - è®°å½•æœåŠ¡æ¶ˆè´¹
  - [ ] `recordAdjustment()` - è®°å½•æ‰‹åŠ¨è°ƒæ•´
  - [ ] `calculateAvailableBalance()` - è®¡ç®—å¯ç”¨ä½™é¢
  - [ ] `queryLedgers()` - æŸ¥è¯¢æµæ°´è®°å½•
  - [ ] `verifyBalance()` - éªŒè¯ä½™é¢å¯¹è´¦

- [ ] **å®ç° ServiceHoldService**
  - [ ] `createHold()` - åˆ›å»ºé¢„å 
  - [ ] `releaseHold()` - é‡Šæ”¾é¢„å 
  - [ ] `cleanupExpiredHolds()` - æ¸…ç†è¿‡æœŸé¢„å ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
  - [ ] `findActiveHolds()` - æŸ¥è¯¢æ´»è·ƒé¢„å 
  - [ ] `extendHold()` - å»¶é•¿é¢„å æ—¶é—´

- [ ] **å®ç° ServiceLedgerArchiveService**
  - [ ] `archiveOldLedgers()` - æ‰§è¡Œå½’æ¡£ä»»åŠ¡
  - [ ] `getArchivePolicy()` - æŸ¥è¯¢å½’æ¡£ç­–ç•¥
  - [ ] `setArchivePolicy()` - è®¾ç½®å½’æ¡£ç­–ç•¥
  - [ ] `queryLedgersWithArchive()` - è·¨è¡¨æŸ¥è¯¢æµæ°´

#### Phase 2: äº‹ä»¶é›†æˆ

- [ ] **å®ç°äº‹ä»¶ç›‘å¬å™¨**
  - [ ] `PaymentSucceededListener` - ç›‘å¬ payment.succeededï¼Œæ¿€æ´»åˆåŒ
  - [ ] `SessionCompletedListener` - ç›‘å¬ session.completedï¼Œæ‰£å‡æƒç›Š
  - [ ] `SessionCancelledListener` - ç›‘å¬ session.cancelledï¼Œé‡Šæ”¾é¢„å 

- [ ] **å®ç°äº‹ä»¶å‘å¸ƒ**
  - [ ] `contract.signed` - åˆåŒç­¾è®¢
  - [ ] `contract.activated` - åˆåŒæ¿€æ´»
  - [ ] `contract.terminated` - åˆåŒç»ˆæ­¢
  - [ ] `service.consumed` - æœåŠ¡æ¶ˆè´¹

#### Phase 3: å®šæ—¶ä»»åŠ¡

- [ ] **å®ç°å®šæ—¶ä»»åŠ¡**
  - [ ] æ¸…ç†è¿‡æœŸé¢„å ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰
  - [ ] å½’æ¡£å†å²æµæ°´ï¼ˆæ¯å¤©å‡Œæ™¨ 2:00ï¼‰
  - [ ] è‡ªåŠ¨å®Œæˆè¿‡æœŸåˆåŒï¼ˆæ¯å¤©å‡Œæ™¨ 3:00ï¼‰

#### Phase 4: æµ‹è¯•

- [ ] **å•å…ƒæµ‹è¯•**
  - [ ] ContractService æµ‹è¯•
  - [ ] ServiceLedgerService æµ‹è¯•
  - [ ] ServiceHoldService æµ‹è¯•
  - [ ] ServiceLedgerArchiveService æµ‹è¯•
  - [ ] Entitlement Revision Service æµ‹è¯• ğŸ†•v2.16.8

- [ ] **é›†æˆæµ‹è¯•**
  - [ ] åˆåŒåˆ›å»º â†’ æ¿€æ´» â†’ æœåŠ¡æ¶ˆè´¹ â†’ å®Œæˆï¼ˆå®Œæ•´æµç¨‹ï¼‰
  - [ ] é¢å¤–æƒç›Šæ·»åŠ æµ‹è¯• ğŸ†•v2.16
  - [ ] é¢„å è¶…æ—¶è‡ªåŠ¨é‡Šæ”¾æµ‹è¯•
  - [ ] æµæ°´å½’æ¡£æµ‹è¯•
  - [ ] ä½™é¢å¯¹è´¦æµ‹è¯•
  - [ ] åˆå§‹æƒç›Šä¿®è®¢è®°å½•æµ‹è¯• ğŸ†•v2.16.8
  - [ ] é¢å¤–æƒç›Šä¿®è®¢è®°å½•æµ‹è¯• ğŸ†•v2.16.8
  - [ ] æƒç›Šä¿®è®¢å®¡æ‰¹æµç¨‹æµ‹è¯• ğŸ†•v2.16.8
  - [ ] æƒç›Šä¿®è®¢æ‹’ç»æµç¨‹æµ‹è¯• ğŸ†•v2.16.8
  - [ ] æƒç›Šä¿®è®¢å†å²æŸ¥è¯¢æµ‹è¯• ğŸ†•v2.16.8

- [ ] **E2E æµ‹è¯•**
  - [ ] é¡¾é—®åˆ›å»ºåˆåŒ
  - [ ] å­¦ç”Ÿæ”¯ä»˜é¦–ä»˜
  - [ ] å­¦ç”Ÿé¢„çº¦æœåŠ¡
  - [ ] å¯¼å¸ˆå®ŒæˆæœåŠ¡
  - [ ] å­¦ç”ŸæŸ¥è¯¢ä½™é¢

---

## 9. è®¾è®¡æ–‡æ¡£ä¸ä»£ç å®ç°å·®å¼‚åˆ†æ

> **ç‰ˆæœ¬ï¼š** v2.16.9
> **å®¡æŸ¥æ—¥æœŸï¼š** 2025-11-10
> **çŠ¶æ€ï¼š** âš ï¸ å·²å‘ç°å·®å¼‚ï¼ˆ7 é¡¹ï¼‰

æœ¬ç« èŠ‚è®°å½•åœ¨ä»£ç å®ç°è¿‡ç¨‹ä¸­ä¸è®¾è®¡æ–‡æ¡£çš„å·®å¼‚ã€‚è¿™äº›å·®å¼‚éœ€è¦åœ¨åç»­å¼€å‘ä¸­é€æ­¥å¯¹é½ã€‚

---

### 9.1 æ ¸å¿ƒå·®å¼‚æ±‡æ€»

| ç¼–å· | å·®å¼‚ç±»å‹ | è®¾è®¡æ–‡æ¡£ | ä»£ç å®ç° | ä¼˜å…ˆçº§ | å½±å“èŒƒå›´ |
|------|----------|----------|----------|--------|----------|
| **D1** | åˆåŒçŠ¶æ€å·®å¼‚ | `draft` â†’ `active` | `signed` â†’ `active` | ğŸ”´ é«˜ | çŠ¶æ€æœºã€ä¸šåŠ¡è§„åˆ™ |
| **D2** | æ–¹æ³•ç¼ºå¤± | `suspend()`, `resume()`, `complete()` | âŒ æœªå®ç° | ğŸ”´ é«˜ | ContractService æ¥å£ |
| **D3** | ä¿®è®¢è®°å½•æœªå®ç° | `getEntitlementRevisions()`, `approveRevision()`, `rejectRevision()` | âŒ æœªå®ç° | ğŸŸ¡ ä¸­ | v2.16.8 æ–°å¢åŠŸèƒ½ |
| **D4** | DTO å­—æ®µå·®å¼‚ | `addOnReason` (v2.16.4) | `reason` | ğŸŸ¡ ä¸­ | é¢å¤–æƒç›Šæ·»åŠ  |
| **D5** | äº‹ä»¶ç›‘å¬å™¨ç¼ºå¤± | `payment.succeeded`, `session.completed` ç›‘å¬å™¨ | âŒ æœªå®ç° | ğŸŸ¡ ä¸­ | äº‹ä»¶é©±åŠ¨æµç¨‹ |
| **D6** | äº‹åŠ¡æ”¯æŒå·®å¼‚ | `createHold(dto, tx?)` æ”¯æŒå¤–éƒ¨äº‹åŠ¡ | éƒ¨åˆ†æ”¯æŒ | ğŸŸ¢ ä½ | é¢„å æœåŠ¡ |
| **D7** | çŠ¶æ€æ£€æŸ¥å·®å¼‚ | æ–‡æ¡£ä¸­å¤šå¤„çŠ¶æ€æ£€æŸ¥æ›´ä¸¥æ ¼ | ä»£ç å®ç°è¾ƒå®½æ¾ | ğŸŸ¢ ä½ | æ•°æ®å®Œæ•´æ€§ |

---

### 9.2 è¯¦ç»†å·®å¼‚è¯´æ˜

#### D1: åˆåŒçŠ¶æ€å·®å¼‚ âš ï¸ é«˜ä¼˜å…ˆçº§

**è®¾è®¡æ–‡æ¡£ï¼ˆSection 3.2.1, 7.1ï¼‰:**
- åˆåŒçŠ¶æ€ï¼š`draft` â†’ `active` â†’ `completed/terminated/suspended`ï¼ˆç¬¬ 1116-1118 è¡Œï¼‰
- `create()` æ–¹æ³•åˆ›å»ºçŠ¶æ€ä¸º `draft` çš„åˆåŒ

**ä»£ç å®ç°ï¼ˆcontracts.schema.ts:15-21, contract.service.ts:94ï¼‰:**
```typescript
// Schema å®šä¹‰
export const contractStatusEnum = pgEnum("contract_status", [
  "signed",  // â† å®é™…ä¸º signed
  "active",
  "suspended",
  "completed",
  "terminated",
]);

// create() æ–¹æ³•
status: "signed",  // â† ç›´æ¥åˆ›å»ºä¸º signed
```

**å·®å¼‚å½±å“ï¼š**
- ä¸è®¾è®¡æ–‡æ¡£çš„çŠ¶æ€æœºå®Œå…¨ä¸å…¼å®¹
- `draft` çŠ¶æ€ç›¸å…³çš„ä¸šåŠ¡è§„åˆ™æ— æ³•åº”ç”¨
- æ”¯ä»˜æ¿€æ´»æµç¨‹éœ€è¦è°ƒæ•´

**å»ºè®®æ–¹æ¡ˆï¼š**
1. **é€‰é¡¹ A**ï¼ˆæ¨èï¼‰ï¼šä¿®æ”¹ä»£ç ï¼Œå¢åŠ  `draft` çŠ¶æ€
   - Schema æ›´æ–°ï¼š`ALTER TYPE contract_status ADD VALUE 'draft' BEFORE 'signed';`
   - ContractService ä¿®æ”¹ï¼š`create()` æ–¹æ³•åˆ›å»º `draft` çŠ¶æ€åˆåŒ
   - æ·»åŠ  `sign()` æ–¹æ³•å°† `draft` â†’ `signed`

2. **é€‰é¡¹ B**ï¼šæ›´æ–°è®¾è®¡æ–‡æ¡£ï¼Œç§»é™¤ `draft` çŠ¶æ€
   - ä¿®æ”¹ Section 0.1ã€3.2.1ã€7.1
   - æ›´æ–°æ‰€æœ‰ç›¸å…³ä¸šåŠ¡æµç¨‹

---

#### D2: åˆåŒçŠ¶æ€ç®¡ç†æ–¹æ³•ç¼ºå¤± âš ï¸ é«˜ä¼˜å…ˆçº§

**è®¾è®¡æ–‡æ¡£ï¼ˆSection 4.2ï¼‰:**
- `suspend(id, reason)` - æš‚åœåˆåŒ
- `resume(id)` - æ¢å¤åˆåŒ
- `complete(id)` - å®ŒæˆåˆåŒ

**ä»£ç å®ç°:**
- âŒ ä»¥ä¸Šæ–¹æ³•å‡æœªå®ç°
- ä»…å®ç°äº†åŸºæœ¬çš„ `create()`, `findOne()`, `activate()`

**å·®å¼‚å½±å“ï¼š**
- åˆåŒç”Ÿå‘½å‘¨æœŸä¸å®Œæ•´
- æ— æ³•å¤„ç†æš‚åœã€æ¢å¤ã€è‡ªåŠ¨å®Œæˆç­‰ä¸šåŠ¡åœºæ™¯
- ç¼ºå°‘ç›¸å…³äº‹ä»¶å‘å¸ƒï¼ˆ`contract.suspended`, `contract.resumed`, `contract.completed`ï¼‰

**å®ç°çŠ¶æ€æ£€æŸ¥ï¼š**
```typescript
// contract.service.ts ä¸­ç¼ºå°‘ä»¥ä¸‹æ–¹æ³•ï¼š
- async suspend(id: string, reason: string): Promise<Contract>  // âŒ ç¼ºå¤±
- async resume(id: string): Promise<Contract>                    // âŒ ç¼ºå¤±
- async complete(id: string): Promise<Contract>                  // âŒ ç¼ºå¤±
- async update(id: string, dto: IUpdateContractDto)             // âŒ ç¼ºå¤±
- async terminate(id: string, reason: string)                   // âŒ ç¼ºå¤±
```

---

#### D3: æƒç›Šä¿®è®¢åŠŸèƒ½æœªå®ç° ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

**è®¾è®¡æ–‡æ¡£ï¼ˆSection 4.2, 6.6, v2.16.8 æ–°å¢ï¼‰:**
- `getEntitlementRevisions()` - æŸ¥è¯¢ä¿®è®¢å†å²
- `approveRevision()` - å®¡æ‰¹ä¿®è®¢
- `rejectRevision()` - æ‹’ç»ä¿®è®¢
- å®Œæ•´ä¸šåŠ¡è§„åˆ™ï¼ˆ6.6.1-6.6.7ï¼‰

**ä»£ç å®ç°:**
- âœ… Schema å·²åˆ›å»ºï¼š`contract-entitlement-revisions.schema.ts`
- âŒ Service æ–¹æ³•æœªå®ç°
- âŒ DTO æœªå®šä¹‰ï¼ˆ`ApproveRevisionDto`, `RejectRevisionDto` ç­‰ï¼‰

**å·®å¼‚å½±å“ï¼š**
- v2.16.8 çš„æ ¸å¿ƒåŠŸèƒ½ç¼ºå¤±
- é¢å¤–æƒç›Šå®¡æ‰¹æµç¨‹æ— æ³•å·¥ä½œï¼ˆå†³ç­– R6ï¼‰
- å®¡è®¡è¿½æº¯ä¸å®Œæ•´

**æ–‡ä»¶æ£€æŸ¥ï¼š**
```
src/domains/contract/
  â”œâ”€â”€ services/
  â”‚   â”œâ”€â”€ contract.service.ts              âœ… å­˜åœ¨
  â”‚   â””â”€â”€ entitlement-revision.service.ts  âŒ ç¼ºå¤± â† éœ€è¦åˆ›å»º
  â””â”€â”€ dto/
      â”œâ”€â”€ approve-revision.dto.ts          âŒ ç¼ºå¤±
      â””â”€â”€ reject-revision.dto.ts           âŒ ç¼ºå¤±
```

---

#### D4: DTO å­—æ®µå‘½åå·®å¼‚ ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

**è®¾è®¡æ–‡æ¡£ï¼ˆSection 5.2, v2.16.4ï¼‰:**
```typescript
interface AddEntitlementDto {
  addOnReason: string;  // â† æ–‡æ¡£ä½¿ç”¨ addOnReason
  ...
}
```

**ä»£ç å®ç°ï¼ˆadd-entitlement.dto.tsï¼‰:**
```typescript
export interface IAddEntitlementDto {
  reason: string;  // â† ä»£ç ä½¿ç”¨ reason
  ...
}
```

**å½±å“èŒƒå›´ï¼š**
- å­—æ®µå‘½åä¸ä¸€è‡´
- å½±å“ä»£ç å¯è¯»æ€§å’Œç»´æŠ¤æ€§
- ä¸æ–‡æ¡£ä¸­çš„çº¦æŸè§„åˆ™ä¸åŒ¹é…ï¼ˆ6.2.1 è¦æ±‚ addOnReason å¿…å¡«ï¼‰

**å…¶ä»– DTO å·®å¼‚ï¼š**
- `ConsumeServiceDto` - `sessionId` vs `relatedBookingId`
- `UpdateContractDto` - ç¼ºå°‘æ–‡æ¡£ä¸­çš„å¤šä¸ªå­—æ®µ

---

#### D5: äº‹ä»¶ç›‘å¬å™¨ç¼ºå¤± ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

**è®¾è®¡æ–‡æ¡£ï¼ˆSection 1.3, 2.2.2ï¼‰:**
```
Financial Domain â†’ Contract Domain: payment.succeeded äº‹ä»¶
  â””â”€ è§¦å‘ activate() æ–¹æ³•

Services Domain â†’ Contract Domain: session.completed äº‹ä»¶
  â””â”€ è§¦å‘ consumeService() æ–¹æ³•
```

**ä»£ç å®ç°:**
- âœ… Domain events è¡¨å·²åˆ›å»ºï¼ˆdomain_eventsï¼‰
- âœ… Event publisher å®šæ—¶ä»»åŠ¡å­˜åœ¨ï¼ˆtasks/event-publisher.task.tsï¼‰
- âŒ **äº‹ä»¶ç›‘å¬å™¨æœªå®ç°ï¼š**
  - `PaymentSucceededListener` - ç›‘å¬æ”¯ä»˜æˆåŠŸ
  - `SessionCompletedListener` - ç›‘å¬æœåŠ¡å®Œæˆ
  - `SessionCancelledListener` - ç›‘å¬æœåŠ¡å–æ¶ˆ

**å·®å¼‚å½±å“ï¼š**
- äº‹ä»¶é©±åŠ¨æ¶æ„ä¸å®Œæ•´
- åˆåŒæ¿€æ´»éœ€è¦æ‰‹åŠ¨è°ƒç”¨ APIï¼ˆè€Œä¸æ˜¯è‡ªåŠ¨ï¼‰
- æœåŠ¡æ¶ˆè´¹éœ€è¦æ‰‹åŠ¨è°ƒç”¨ï¼ˆè€Œä¸æ˜¯ç›‘å¬äº‹ä»¶ï¼‰

**éœ€è¦åˆ›å»ºçš„æ–‡ä»¶ï¼š**
```
src/domains/contract/events/
  â”œâ”€â”€ listeners/
  â”‚   â”œâ”€â”€ payment-succeeded.listener.ts      âŒ ç¼ºå¤±
  â”‚   â”œâ”€â”€ session-completed.listener.ts      âŒ ç¼ºå¤±
  â”‚   â””â”€â”€ session-cancelled.listener.ts      âŒ ç¼ºå¤±
  â””â”€â”€ handlers/
      â”œâ”€â”€ contract-activation.handler.ts     âŒ ç¼ºå¤±
      â””â”€â”€ service-consumption.handler.ts    âŒ ç¼ºå¤±
```

---

#### D6: äº‹åŠ¡æ”¯æŒä¸å®Œæ•´ ğŸŸ¢ ä½ä¼˜å…ˆçº§

**è®¾è®¡æ–‡æ¡£ï¼ˆv2.16.7 å†³ç­–ï¼‰:**
```typescript
// ServiceHoldService.createHold() æ”¯æŒå¤–éƒ¨äº‹åŠ¡
async createHold(dto: CreateHoldDto, tx?: DrizzleTransaction): Promise<ServiceHold>
```

**ä»£ç å®ç°:**
- âœ… ContractService ä¸­ä½¿ç”¨äº† `db.transaction()`
- âš ï¸ ServiceHoldService ä¸­æ–¹æ³•ç­¾åä¸ä¸€è‡´
- âš ï¸ ServiceLedgerService æ”¯æŒ `tx` å‚æ•°ï¼Œä½†æœªå®Œå…¨åˆ©ç”¨

**å·®å¼‚ç»†èŠ‚ï¼š**
```typescript
// è®¾è®¡æ–‡æ¡£ï¼ˆSection 3.2.4, 1653 è¡Œï¼‰
async createHold(dto: CreateHoldDto, tx?: DrizzleTransaction)

// å®é™…ä»£ç ï¼ˆservice-hold.service.tsï¼‰
async createHold(dto: ICreateHoldDto): Promise<ServiceHold>  // â† ç¼ºå°‘ tx å‚æ•°
```

---

#### D7: çŠ¶æ€éªŒè¯å®½æ¾ ğŸŸ¢ ä½ä¼˜å…ˆçº§

**å¤šå¤„å·®å¼‚ï¼š**

| åœºæ™¯ | è®¾è®¡æ–‡æ¡£è¦æ±‚ | ä»£ç å®ç° | é£é™©ç­‰çº§ |
|------|--------------|----------|----------|
| activate() | æ£€æŸ¥ `status = 'draft'` | æ£€æŸ¥ `status = 'signed'` | ä½ |
| consumeService() | ä¸¥æ ¼æ£€æŸ¥ contract.status = 'active' | æœªæ£€æŸ¥æˆ–æ£€æŸ¥è¾ƒå®½æ¾ | ä¸­ |
| addEntitlement() | æ£€æŸ¥ contract.status = 'active' | æœªæ£€æŸ¥ | ä¸­ |
| è¿‡æœŸæ—¶é—´éªŒè¯ | ä¸¥æ ¼éªŒè¯ `expiresAt >= effectiveAt` | æ— æ£€æŸ¥ | ä½ |

**ç¤ºä¾‹å·®å¼‚ï¼š**
```typescript
// è®¾è®¡æ–‡æ¡£ï¼ˆ6.1.2ï¼‰è¦æ±‚ï¼š
// âœ… åˆåŒçŠ¶æ€ä¸º draft
// âœ… å·²æ”¶åˆ° payment.succeeded äº‹ä»¶
// âœ… æ”¯ä»˜é‡‘é¢ >= é¦–ä»˜è¦æ±‚

// ä»£ç å®ç°ï¼ˆcontract.service.ts:204-207ï¼‰ï¼š
if (contract.status !== "signed") {
  throw new ContractException("CONTRACT_NOT_DRAFT");
}
// ç¼ºå°‘ï¼špayment éªŒè¯ã€é‡‘é¢éªŒè¯
```

---

### 9.3 å·®å¼‚ä¿®å¤å†³ç­–æ‘˜è¦

> **å®¡æŸ¥å®Œæˆæ—¥æœŸï¼š** 2025-11-10
> **çŠ¶æ€ï¼š** âœ… æ‰€æœ‰å·®å¼‚å·²è®¨è®ºå¹¶å†³ç­–

æœ¬æ¬¡å®¡æŸ¥å…±å‘ç° 7 é¡¹å·®å¼‚ï¼Œå·²å…¨éƒ¨è®¨è®ºå¹¶ç¡®å®šä¿®å¤æ–¹æ¡ˆã€‚å›¢é˜Ÿé€‰æ‹©åœ¨åç»­å¼€å‘ä¸­é‡‡ç”¨æ–¹æ¡ˆ Aï¼ˆå®Œæ•´å®ç°ï¼‰æ¥å¯¹é½è®¾è®¡æ–‡æ¡£ä¸ä»£ç å®ç°ã€‚

#### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ä¿®å¤ï¼‰
1. **D1 - åˆåŒçŠ¶æ€å·®å¼‚**
   - âœ… **å·²å†³ç­–ï¼šæ–¹æ¡ˆ A**ï¼ˆä¿®æ”¹ä»£ç ï¼Œå¢åŠ  `draft` çŠ¶æ€ï¼‰
   - å®ç°å†…å®¹ï¼šå¢åŠ  `draft` â†’ `signed` â†’ `active` çŠ¶æ€æµè½¬
   - é¢„è®¡å·¥ä½œé‡ï¼š2-3 å¤©
   - å½±å“èŒƒå›´ï¼šçŠ¶æ€æœºã€æ‰€æœ‰ä¸šåŠ¡æµç¨‹

2. **D2 - çŠ¶æ€ç®¡ç†æ–¹æ³•ç¼ºå¤±**
   - âœ… **å·²å†³ç­–ï¼šæ–¹æ¡ˆ A**ï¼ˆå®Œæ•´å®ç°ä¸‰ä¸ªæ–¹æ³•ï¼‰
   - å®ç°å†…å®¹ï¼š`suspend()`, `resume()`, `complete()`
   - é¢„è®¡å·¥ä½œé‡ï¼š2-3 å¤©
   - å½±å“èŒƒå›´ï¼šåˆåŒç”Ÿå‘½å‘¨æœŸç®¡ç†

#### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆåº”å°½å¿«ä¿®å¤ï¼‰
3. **D3 - æƒç›Šä¿®è®¢åŠŸèƒ½**
   - âœ… **å·²å†³ç­–ï¼šæ–¹æ¡ˆ A**ï¼ˆå®Œæ•´å®ç° v2.16.8 æ‰€æœ‰åŠŸèƒ½ï¼‰
   - å®ç°å†…å®¹ï¼š`getEntitlementRevisions()`, `approveRevision()`, `rejectRevision()`
   - é¢„è®¡å·¥ä½œé‡ï¼š3-4 å¤©
   - å½±å“èŒƒå›´ï¼šv2.16.8 æ ¸å¿ƒåŠŸèƒ½ã€å®¡è®¡è¿½æº¯

4. **D5 - äº‹ä»¶ç›‘å¬å™¨**
   - âœ… **å·²å†³ç­–ï¼šæ–¹æ¡ˆ A**ï¼ˆå®Œæ•´å®ç°æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼‰
   - å®ç°å†…å®¹ï¼š`payment.succeeded`, `session.completed` ç›‘å¬å™¨å’Œå¤„ç†å™¨
   - é¢„è®¡å·¥ä½œé‡ï¼š2-3 å¤©
   - å½±å“èŒƒå›´ï¼šäº‹ä»¶é©±åŠ¨æ¶æ„å®Œæ•´æ€§

#### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆåº”å°½å¿«ä¿®å¤ï¼‰
5. **D4 - DTO å­—æ®µå‘½åå·®å¼‚**
   - âœ… **å·²å†³ç­–ï¼šæ–¹æ¡ˆ A**ï¼ˆä¿®æ”¹ä»£ç ï¼Œç»Ÿä¸€ä½¿ç”¨è®¾è®¡æ–‡æ¡£å‘½åï¼‰
   - å®ç°å†…å®¹ï¼š`reason` â†’ `addOnReason`, `sessionId` â†’ `relatedBookingId`
   - é¢„è®¡å·¥ä½œé‡ï¼š1 å¤©
   - å½±å“èŒƒå›´ï¼šDTO å®šä¹‰ã€Service æ¥å£

#### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯å»¶åä¿®å¤ï¼‰
6. **D6 - äº‹åŠ¡æ”¯æŒå·®å¼‚**
   - âœ… **å·²å†³ç­–ï¼šæ–¹æ¡ˆ A**ï¼ˆå®Œå–„æ‰€æœ‰ Service çš„äº‹åŠ¡æ”¯æŒï¼‰
   - å®ç°å†…å®¹ï¼šæ‰€æœ‰ Service æ–¹æ³•æ·»åŠ å¯é€‰ `tx` å‚æ•°
   - é¢„è®¡å·¥ä½œé‡ï¼š1 å¤©
   - å½±å“èŒƒå›´ï¼šæ•°æ®ä¸€è‡´æ€§ã€åŸå­æ€§æ“ä½œ

7. **D7 - çŠ¶æ€éªŒè¯å®½æ¾**
   - âœ… **å·²å†³ç­–ï¼šæ–¹æ¡ˆ A**ï¼ˆæ·»åŠ å…¨é¢çš„çŠ¶æ€éªŒè¯ï¼‰
   - å®ç°å†…å®¹ï¼šæ‰€æœ‰çŠ¶æ€è½¬æ¢æ–¹æ³•æ·»åŠ éªŒè¯é€»è¾‘
   - é¢„è®¡å·¥ä½œé‡ï¼š0.5 å¤©
   - å½±å“èŒƒå›´ï¼šæ•°æ®å®Œæ•´æ€§ã€éæ³•æ“ä½œé˜²æŠ¤

#### æ€»ä½“å·¥ä½œé‡è¯„ä¼°

| ä¼˜å…ˆçº§ | é¡¹æ•° | é¢„è®¡å·¥ä½œé‡ | å¤‡æ³¨ |
|--------|------|------------|------|
| ğŸ”´ é«˜ | 2 é¡¹ | 4-6 å¤© | æ ¸å¿ƒä¸šåŠ¡æµç¨‹ |
| ğŸŸ¡ ä¸­ | 3 é¡¹ | 6-8 å¤© | åŠŸèƒ½å®Œæ•´æ€§ |
| ğŸŸ¢ ä½ | 2 é¡¹ | 1.5 å¤© | æ•°æ®å®Œæ•´æ€§ä¼˜åŒ– |
| **æ€»è®¡** | **7 é¡¹** | **11.5-15.5 å¤©** | **çº¦ 2-3 å‘¨å¼€å‘é‡** |

#### å®æ–½å»ºè®®

**é˜¶æ®µä¸€ï¼ˆç¬¬ 1 å‘¨ï¼‰ï¼šé«˜ä¼˜å…ˆçº§**
1. å®ç° D1ï¼ˆåˆåŒçŠ¶æ€å·®å¼‚ï¼‰
2. å®ç° D2ï¼ˆçŠ¶æ€ç®¡ç†æ–¹æ³•ç¼ºå¤±ï¼‰

**é˜¶æ®µäºŒï¼ˆç¬¬ 2-3 å‘¨ï¼‰ï¼šä¸­ä¼˜å…ˆçº§**
3. å®ç° D3ï¼ˆæƒç›Šä¿®è®¢åŠŸèƒ½ï¼‰
4. å®ç° D5ï¼ˆäº‹ä»¶ç›‘å¬å™¨ï¼‰
5. å®ç° D4ï¼ˆDTO å­—æ®µå‘½åç»Ÿä¸€ï¼‰

**é˜¶æ®µä¸‰ï¼ˆç¬¬ 4 å‘¨ï¼‰ï¼šä½ä¼˜å…ˆçº§ + ä¼˜åŒ–**
6. å®ç° D6ï¼ˆäº‹åŠ¡æ”¯æŒå®Œå–„ï¼‰
7. å®ç° D7ï¼ˆçŠ¶æ€éªŒè¯ï¼‰
8. è¡¥å……å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

#### é£é™©è¯„ä¼°

**ä½é£é™©é¡¹**ï¼šD4, D6, D7
- æ”¹åŠ¨èŒƒå›´å°ï¼Œå½±å“å¯æ§
- å®¹æ˜“æµ‹è¯•éªŒè¯
- å›æ»šæˆæœ¬ä½

**ä¸­é£é™©é¡¹**ï¼šD2, D5
- å½±å“æ ¸å¿ƒæµç¨‹ï¼ˆçŠ¶æ€æœºã€äº‹ä»¶é©±åŠ¨ï¼‰
- éœ€è¦é›†æˆæµ‹è¯•
- éœ€è¦ç¡®ä¿äº‹ä»¶å¹‚ç­‰æ€§

**é«˜é£é™©é¡¹**ï¼šD1, D3
- D1 å½±å“æ•´ä¸ªä¸šåŠ¡æµç¨‹ï¼ˆçŠ¶æ€æµè½¬ï¼‰
- D3 æ˜¯æ–°åŠŸèƒ½ï¼ˆå®¡æ‰¹æµç¨‹ï¼‰ï¼Œéœ€è¦å®Œæ•´æµ‹è¯•
- å»ºè®®ï¼šåˆ†æ‰¹éƒ¨ç½²ï¼Œå……åˆ†æµ‹è¯•

#### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

å›¢é˜Ÿå·²å®Œæˆæ‰€æœ‰å·®å¼‚çš„è®¨è®ºå’Œå†³ç­–ï¼Œå»ºè®®åœ¨ä¸‹ä¸€ä¸ª Sprint ä¸­å¼€å§‹å®æ–½ï¼š

1. **åˆ›å»ºå®æ–½ä»»åŠ¡**ï¼šä¸ºæ¯ä¸ª D# åˆ›å»ºç‹¬ç«‹çš„å¼€å‘ä»»åŠ¡
2. **åˆ†é…è´£ä»»äºº**ï¼šæ ¹æ®å›¢é˜Ÿèµ„æºåˆ†é…
3. **è¡¥å……æµ‹è¯•**ï¼šæ¯ä¸ªä¿®å¤éƒ½éœ€è¦å•å…ƒæµ‹è¯•è¦†ç›–
4. **Code Review**ï¼šæ¶æ„å¸ˆæˆ– Senior å®¡æ ¸å…³é”®æ”¹åŠ¨
5. **æ–‡æ¡£æ›´æ–°**ï¼šä¿®å¤ååŒæ­¥æ›´æ–°è®¾è®¡æ–‡æ¡£

---

### 9.4 å·®å¼‚æ£€æµ‹æ–¹æ³•

---

### 9.4 å·®å¼‚æ£€æµ‹æ–¹æ³•

**è‡ªåŠ¨åŒ–æ£€æµ‹ï¼ˆå»ºè®®ï¼‰ï¼š**
```typescript
// å¯åˆ›å»ºè„šæœ¬è‡ªåŠ¨å¯¹æ¯”
function detectDifferences() {
  // 1. è¯»å–æ¥å£å®šä¹‰
  const interfaceMethods = parseInterface('IContractService');

  // 2. è¯»å–å®é™…å®ç°
  const implementedMethods = parseService('ContractService');

  // 3. å¯¹æ¯”å·®å¼‚
  const missing = interfaceMethods.filter(m => !implementedMethods.includes(m));

  return {
    missingMethods,
    inconsistentDTOs,
    missingEventListeners
  };
}
```

**æ‰‹åŠ¨æ£€æŸ¥æ¸…å•ï¼š**
- [ ] æ¥å£å®šä¹‰ vs å®é™…å®ç°ï¼ˆ4.2 èŠ‚ï¼‰
- [ ] Schema å­—æ®µ vs DTO å­—æ®µï¼ˆ3.2 èŠ‚ vs 5.x èŠ‚ï¼‰
- [ ] äº‹ä»¶å®šä¹‰ vs äº‹ä»¶ç›‘å¬å™¨ï¼ˆ5.7 èŠ‚ vs events/ ç›®å½•ï¼‰
- [ ] ä¸šåŠ¡è§„åˆ™ vs éªŒè¯é€»è¾‘ï¼ˆ6.x èŠ‚ vs ä»£ç å®ç°ï¼‰

---

## é™„å½•ï¼šå†å²ç‰ˆæœ¬å˜æ›´

### v2.16.9 (2025-11-10)

**æœåŠ¡é¢„å æœºåˆ¶é‡å¤§ç®€åŒ– - ç§»é™¤ TTL è‡ªåŠ¨è¿‡æœŸ**

**æ ¸å¿ƒå˜æ›´ï¼š**
- âŒ **ç§»é™¤ `expiresAt` å­—æ®µ**ï¼š`service_holds` è¡¨ä¸­ä¸å†å­˜å‚¨è¿‡æœŸæ—¶é—´
- âŒ **ç§»é™¤è‡ªåŠ¨è¿‡æœŸæœºåˆ¶**ï¼šå–æ¶ˆå®šæ—¶ä»»åŠ¡æ¸…ç†è¿‡æœŸé¢„å 
- âœ… **é¢„å æ°¸ä¸è¿‡æœŸ**ï¼šæ‰€æœ‰é¢„å å¿…é¡»é€šè¿‡äººå·¥æ“ä½œé‡Šæ”¾
- âœ… **ç®€åŒ–çŠ¶æ€æœº**ï¼šä»…ä¿ç•™ `active` â†’ `released`/`cancelled` çŠ¶æ€è½¬æ¢

**è®¾è®¡ç†ç”±ï¼š**
1. **ä¸šåŠ¡å®Œæ•´æ€§**ï¼šé¢„å ä»£è¡¨ç”¨æˆ·çš„é¢„çº¦æ„å›¾ï¼Œä¸åº”è‡ªåŠ¨å¤±æ•ˆ
2. **å‡å°‘ç³»ç»Ÿå¤æ‚åº¦**ï¼šç§»é™¤ä¸å¿…è¦çš„å®šæ—¶ä»»åŠ¡å’Œè¿‡æœŸé€»è¾‘
3. **äººå·¥å®¡æ ¸é‡è¦æ“ä½œ**ï¼šæ‰€æœ‰é‡Šæ”¾æ“ä½œéœ€è¦æ˜ç¡®ç¡®è®¤
4. **æ•°æ®å®¡è®¡è¿½æº¯**ï¼šä¿ç•™å®Œæ•´çš„é¢„å å†å²è®°å½•

**å½±å“èŒƒå›´ï¼š**
- `service_holds` è¡¨ï¼šåˆ é™¤ `expires_at` åˆ—
- `hold_status` æšä¸¾ï¼šç§»é™¤ `expired` çŠ¶æ€å€¼
- `ServiceHoldService`ï¼š`expireHolds()` æ–¹æ³•æ”¹ä¸º `getLongUnreleasedHolds()`ï¼ˆä»…ç›‘æ§ï¼Œä¸è‡ªåŠ¨é‡Šæ”¾ï¼‰
- `hold-cleanup.task.ts`ï¼šå®šæ—¶ä»»åŠ¡æ ‡è®°ä¸º `@deprecated`ï¼Œè‡ªåŠ¨é€»è¾‘ç§»é™¤
- ç¯å¢ƒå˜é‡ï¼š`CONTRACT_HOLD_TTL_MINUTES` å’Œ `HOLD_CLEANUP_CRON` æ ‡è®°ä¸ºåºŸå¼ƒ

**çŠ¶æ€æœºå˜æ›´ï¼š**

**Before:**
```
active â”€â”€â†’ released (äººå·¥)
   â”œâ”€â”€â†’ cancelled (äººå·¥)
   â””â”€â”€â†’ expired (å®šæ—¶ä»»åŠ¡ï¼Œè‡ªåŠ¨)
```

**After:**
```
active â”€â”€â†’ released (äººå·¥)
   â””â”€â”€â†’ cancelled (äººå·¥)

// æ²¡æœ‰ expired çŠ¶æ€ï¼Œæ²¡æœ‰è‡ªåŠ¨è¿‡æœŸ
```

**ç›‘æ§å»ºè®®ï¼š**
- å®ç°ç›‘æ§å‘Šè­¦ï¼šæ£€æŸ¥ `active` çŠ¶æ€è¶…è¿‡ 24 å°æ—¶çš„é¢„å 
- ç®¡ç†å‘˜äººå·¥å®¡æ ¸åï¼Œæ‰‹åŠ¨è°ƒç”¨ `releaseHold()` æˆ– `cancelHold()` é‡Šæ”¾

**å‚è€ƒæ–‡æ¡£ï¼š**
- Section 3.2.4: `service_holds` schema å·²æ›´æ–°
- Section 6.4: ä¸šåŠ¡è§„åˆ™å·²æ›´æ–°
- Section 7.2: çŠ¶æ€æœºå·²ç®€åŒ–

---

### v2.16.6 (2025-11-06)

**ä¸šåŠ¡çº¦æŸç®€åŒ– - ServiceUnit å•ä¸€åŒ–**

- ServiceUnit æšä¸¾ç®€åŒ–ä¸ºå•ä¸€å€¼ `'times'`
- é¿å…å•ä½è½¬æ¢å’ŒéªŒè¯å¤æ‚åº¦
- ç»Ÿä¸€è®¡è´¹æ¨¡å‹ï¼Œé™ä½ç³»ç»Ÿå¤æ‚åº¦
- æ—¶é•¿ä¿¡æ¯åœ¨æœåŠ¡å®šä¹‰ï¼ˆCatalog Domainï¼‰ä¸­è¯´æ˜

---

### v2.16.5 (2025-11-06)

**ç¬¬äºŒè½®å®¡æŸ¥å†³ç­–å®Œæˆ**

å®Œæˆäº†ç¬¬äºŒè½®æ·±åº¦å®¡æŸ¥ä¸­å‘ç°çš„æ‰€æœ‰å¾…å†³ç­–é—®é¢˜ï¼ˆ3 ä¸ªé‡è¦é—®é¢˜ + 7 ä¸ªæ¬¡è¦é—®é¢˜ï¼‰ï¼š

**é‡è¦é—®é¢˜å†³ç­–ï¼š**
- **I-NEW-3**ï¼šäº‹ä»¶å‘å¸ƒå¤±è´¥é‡è¯•æœºåˆ¶ â†’ Outbox æ¨¡å¼
- **I-NEW-4**ï¼šå½’æ¡£æŸ¥è¯¢æ—¥æœŸèŒƒå›´å¼ºåˆ¶éªŒè¯ â†’ å¼ºåˆ¶éªŒè¯ + é»˜è®¤æ—¥æœŸèŒƒå›´
- **I-NEW-6**ï¼štotalAmount è¦†ç›–éªŒè¯è§„åˆ™å¢å¼º â†’ å¢å¼ºéªŒè¯ + å®¡è®¡å­—æ®µ

**æ¬¡è¦é—®é¢˜å†³ç­–ï¼š**
- **M-NEW-1**ï¼šæƒé™æ§åˆ¶ â†’ æ¨è¿Ÿåˆ°å®æ–½é˜¶æ®µ
- **M-NEW-2**ï¼šä½™é¢å¯¹è´¦å®šæœŸä»»åŠ¡ â†’ æ¨è¿Ÿåˆ°å®æ–½é˜¶æ®µ
- **M-NEW-3**ï¼šServiceUnit æšä¸¾ç²¾ç®€ â†’ å•ä¸€å•ä½ `'times'`
- **M-NEW-4**ï¼šå½’æ¡£è¡¨åˆ†åŒºç­–ç•¥ â†’ MVP ä¸ä½¿ç”¨åˆ†åŒº
- **M-NEW-5**ï¼šåˆåŒé‡‘é¢å¸ç§ â†’ å•ä¸€å¸ç§ USD
- **M-NEW-6**ï¼šé”™è¯¯ç å®šä¹‰ â†’ å®šä¹‰é”™è¯¯ç æšä¸¾ + å¼‚å¸¸ç±»
- **M-NEW-7**ï¼šåˆåŒç¼–å·é‡ç½®å¤±è´¥å¤„ç† â†’ è‡ªåŠ¨é‡ç½® + å¼‚å¸¸å¤„ç†

**æ–°å¢çº¦æŸï¼š**
- ServiceUnit ä»…æ”¯æŒ 'times'ï¼ˆæ‰€æœ‰æœåŠ¡æŒ‰æ¬¡æ•°è®¡è´¹ï¼‰
- åˆåŒé‡‘é¢ä»…æ”¯æŒ USD
- å½’æ¡£æŸ¥è¯¢å¼ºåˆ¶æ—¥æœŸèŒƒå›´éªŒè¯
- äº‹ä»¶å‘å¸ƒé‡‡ç”¨ Outbox æ¨¡å¼ä¿è¯å¯é æ€§

---

### v2.16.4 (2025-11-06)

**ç¬¬ä¸€è½®è®¾è®¡å®¡æŸ¥å®Œæˆ**

å®Œæˆäº†æ‰€æœ‰åŸºç¡€è®¾è®¡é—®é¢˜å†³ç­–ï¼ˆå…± 19 ä¸ªé—®é¢˜ï¼š6 ä¸ªå…³é”®é—®é¢˜ + 5 ä¸ªé‡è¦é—®é¢˜ + 8 ä¸ªæ¬¡è¦é—®é¢˜ï¼‰ï¼š

**å…³é”®é—®é¢˜å†³ç­–ï¼š**
- **C1-C2**ï¼šæ·»åŠ  `suspend()`, `resume()`, `complete()` æ–¹æ³•
- **C3**ï¼š`consumeService()` æ”¹ç”¨ `ConsumeServiceDto` å‚æ•°
- **C4**ï¼š`productItemType` å­—æ®µä½¿ç”¨ `ProductItemType` ç±»å‹åˆ«å
- **C5**ï¼šåˆåŒç¼–å·æ ¼å¼ç¡®å®šä¸º `CONTRACT-YYYY-MM-NNNNN`
- **C6**ï¼šåˆ é™¤ Catalog Domain schema å¯¼å…¥ï¼Œä¿æŒ DDD åŸŸéš”ç¦»

**æ–°å¢å†…å®¹ï¼š**
- Section 5.7: Event Payload DTOsï¼ˆ6 ç§äº‹ä»¶ç±»å‹ï¼‰
- Section 6.1.1: totalAmount è¦†ç›–éªŒè¯è§„åˆ™
- Section 6.2.2: æœåŠ¡æ¶ˆè´¹ä¼˜å…ˆçº§ç®—æ³•
- Section 8.1: å‘½åçº¦å®šæ–‡æ¡£
- Section 8.2: ç¯å¢ƒå˜é‡é…ç½®æ–‡æ¡£
- Section 3.2.2: ServiceUnit æšä¸¾å®šä¹‰
- Section 3.2.6: å½’æ¡£æŸ¥è¯¢ç­–ç•¥ä¸æ€§èƒ½ä¼˜åŒ–

**ä¸šåŠ¡çº¦æŸæ˜ç¡®ï¼š**
- åˆåŒä¸äº§å“ä¸€å¯¹ä¸€å…³ç³»ï¼ˆä¸å¯æ›´æ¢äº§å“ï¼‰
- æœåŠ¡å•ä½ç»Ÿä¸€ä¸ºæ¬¡æ•° 'times'
- æ€»é‡‘é¢è¦†ç›–é™åˆ¶ï¼ˆæœ€å¤š 90% æŠ˜æ‰£ï¼Œæœ€é«˜ 200% åŸä»·ï¼‰
- å½’æ¡£æŸ¥è¯¢å¿…é¡»æä¾›æ—¥æœŸèŒƒå›´è¿‡æ»¤
- é¢„å é»˜è®¤ 15 åˆ†é’Ÿè¿‡æœŸï¼Œæ¯ 5 åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡

---

## é™„å½•ï¼šå†å²ç‰ˆæœ¬å˜æ›´

### v2.16.9 (2025-11-10)

**æœåŠ¡é¢„å æœºåˆ¶é‡å¤§ç®€åŒ– - ç§»é™¤ TTL è‡ªåŠ¨è¿‡æœŸ**

**æ ¸å¿ƒå˜æ›´ï¼š**
- âŒ **ç§»é™¤ `expiresAt` å­—æ®µ**ï¼š`service_holds` è¡¨ä¸­ä¸å†å­˜å‚¨è¿‡æœŸæ—¶é—´
- âŒ **ç§»é™¤è‡ªåŠ¨è¿‡æœŸæœºåˆ¶**ï¼šå–æ¶ˆå®šæ—¶ä»»åŠ¡æ¸…ç†è¿‡æœŸé¢„å 
- âœ… **é¢„å æ°¸ä¸è¿‡æœŸ**ï¼šæ‰€æœ‰é¢„å å¿…é¡»é€šè¿‡äººå·¥æ“ä½œé‡Šæ”¾
- âœ… **ç®€åŒ–çŠ¶æ€æœº**ï¼šä»…ä¿ç•™ `active` â†’ `released`/`cancelled` çŠ¶æ€è½¬æ¢

**è®¾è®¡ç†ç”±ï¼š**
1. **ä¸šåŠ¡å®Œæ•´æ€§**ï¼šé¢„å ä»£è¡¨ç”¨æˆ·çš„é¢„çº¦æ„å›¾ï¼Œä¸åº”è‡ªåŠ¨å¤±æ•ˆ
2. **å‡å°‘ç³»ç»Ÿå¤æ‚åº¦**ï¼šç§»é™¤ä¸å¿…è¦çš„å®šæ—¶ä»»åŠ¡å’Œè¿‡æœŸé€»è¾‘
3. **äººå·¥å®¡æ ¸é‡è¦æ“ä½œ**ï¼šæ‰€æœ‰é‡Šæ”¾æ“ä½œéœ€è¦æ˜ç¡®ç¡®è®¤
4. **æ•°æ®å®¡è®¡è¿½æº¯**ï¼šä¿ç•™å®Œæ•´çš„é¢„å å†å²è®°å½•

**å½±å“èŒƒå›´ï¼š**
- `service_holds` è¡¨ï¼šåˆ é™¤ `expires_at` åˆ—
- `hold_status` æšä¸¾ï¼šç§»é™¤ `expired` çŠ¶æ€å€¼
- `ServiceHoldService`ï¼š`expireHolds()` æ–¹æ³•æ”¹ä¸º `getLongUnreleasedHolds()`ï¼ˆä»…ç›‘æ§ï¼Œä¸è‡ªåŠ¨é‡Šæ”¾ï¼‰
- `hold-cleanup.task.ts`ï¼šå®šæ—¶ä»»åŠ¡æ ‡è®°ä¸º `@deprecated`ï¼Œè‡ªåŠ¨é€»è¾‘ç§»é™¤
- ç¯å¢ƒå˜é‡ï¼š`CONTRACT_HOLD_TTL_MINUTES` å’Œ `HOLD_CLEANUP_CRON` æ ‡è®°ä¸ºåºŸå¼ƒ

**çŠ¶æ€æœºå˜æ›´ï¼š**

**Before:**
```
active â”€â”€â†’ released (äººå·¥)
   â”œâ”€â”€â†’ cancelled (äººå·¥)
   â””â”€â”€â†’ expired (å®šæ—¶ä»»åŠ¡ï¼Œè‡ªåŠ¨)
```

**After:**
```
active â”€â”€â†’ released (äººå·¥)
   â””â”€â”€â†’ cancelled (äººå·¥)

// æ²¡æœ‰ expired çŠ¶æ€ï¼Œæ²¡æœ‰è‡ªåŠ¨è¿‡æœŸ
```

**ç›‘æ§å»ºè®®ï¼š**
- å®ç°ç›‘æ§å‘Šè­¦ï¼šæ£€æŸ¥ `active` çŠ¶æ€è¶…è¿‡ 24 å°æ—¶çš„é¢„å 
- ç®¡ç†å‘˜äººå·¥å®¡æ ¸åï¼Œæ‰‹åŠ¨è°ƒç”¨ `releaseHold()` æˆ– `cancelHold()` é‡Šæ”¾

**å‚è€ƒæ–‡æ¡£ï¼š**
- Section 3.2.4: `service_holds` schema å·²æ›´æ–°
- Section 6.4: ä¸šåŠ¡è§„åˆ™å·²æ›´æ–°
- Section 7.2: çŠ¶æ€æœºå·²ç®€åŒ–

---

### v2.16.6 (2025-11-06)

**ä¸šåŠ¡çº¦æŸç®€åŒ– - ServiceUnit å•ä¸€åŒ–**

- ServiceUnit æšä¸¾ç®€åŒ–ä¸ºå•ä¸€å€¼ `'times'`
- é¿å…å•ä½è½¬æ¢å’ŒéªŒè¯å¤æ‚åº¦
- ç»Ÿä¸€è®¡è´¹æ¨¡å‹ï¼Œé™ä½ç³»ç»Ÿå¤æ‚åº¦
- æ—¶é•¿ä¿¡æ¯åœ¨æœåŠ¡å®šä¹‰ï¼ˆCatalog Domainï¼‰ä¸­è¯´æ˜

---

### v2.16.5 (2025-11-06)

**ç¬¬äºŒè½®å®¡æŸ¥å†³ç­–å®Œæˆ**

å®Œæˆäº†ç¬¬äºŒè½®æ·±åº¦å®¡æŸ¥ä¸­å‘ç°çš„æ‰€æœ‰å¾…å†³ç­–é—®é¢˜ï¼ˆ3 ä¸ªé‡è¦é—®é¢˜ + 7 ä¸ªæ¬¡è¦é—®é¢˜ï¼‰ï¼š

**é‡è¦é—®é¢˜å†³ç­–ï¼š**
- **I-NEW-3**ï¼šäº‹ä»¶å‘å¸ƒå¤±è´¥é‡è¯•æœºåˆ¶ â†’ Outbox æ¨¡å¼
- **I-NEW-4**ï¼šå½’æ¡£æŸ¥è¯¢æ—¥æœŸèŒƒå›´å¼ºåˆ¶éªŒè¯ â†’ å¼ºåˆ¶éªŒè¯ + é»˜è®¤æ—¥æœŸèŒƒå›´
- **I-NEW-6**ï¼štotalAmount è¦†ç›–éªŒè¯è§„åˆ™å¢å¼º â†’ å¢å¼ºéªŒè¯ + å®¡è®¡å­—æ®µ

**æ¬¡è¦é—®é¢˜å†³ç­–ï¼š**
- **M-NEW-1**ï¼šæƒé™æ§åˆ¶ â†’ æ¨è¿Ÿåˆ°å®æ–½é˜¶æ®µ
- **M-NEW-2**ï¼šä½™é¢å¯¹è´¦å®šæœŸä»»åŠ¡ â†’ æ¨è¿Ÿåˆ°å®æ–½é˜¶æ®µ
- **M-NEW-3**ï¼šServiceUnit æšä¸¾ç²¾ç®€ â†’ å•ä¸€å•ä½ `'times'`
- **M-NEW-4**ï¼šå½’æ¡£è¡¨åˆ†åŒºç­–ç•¥ â†’ MVP ä¸ä½¿ç”¨åˆ†åŒº
- **M-NEW-5**ï¼šåˆåŒé‡‘é¢å¸ç§ â†’ å•ä¸€å¸ç§ USD
- **M-NEW-6**ï¼šé”™è¯¯ç å®šä¹‰ â†’ å®šä¹‰é”™è¯¯ç æšä¸¾ + å¼‚å¸¸ç±»
- **M-NEW-7**ï¼šåˆåŒç¼–å·é‡ç½®å¤±è´¥å¤„ç† â†’ è‡ªåŠ¨é‡ç½® + å¼‚å¸¸å¤„ç†

**æ–°å¢çº¦æŸï¼š**
- ServiceUnit ä»…æ”¯æŒ 'times'ï¼ˆæ‰€æœ‰æœåŠ¡æŒ‰æ¬¡æ•°è®¡è´¹ï¼‰
- åˆåŒé‡‘é¢ä»…æ”¯æŒ USD
- å½’æ¡£æŸ¥è¯¢å¼ºåˆ¶æ—¥æœŸèŒƒå›´éªŒè¯
- äº‹ä»¶å‘å¸ƒé‡‡ç”¨ Outbox æ¨¡å¼ä¿è¯å¯é æ€§

---

### v2.16.4 (2025-11-06)

**ç¬¬ä¸€è½®è®¾è®¡å®¡æŸ¥å®Œæˆ**

å®Œæˆäº†æ‰€æœ‰åŸºç¡€è®¾è®¡é—®é¢˜å†³ç­–ï¼ˆå…± 19 ä¸ªé—®é¢˜ï¼š6 ä¸ªå…³é”®é—®é¢˜ + 5 ä¸ªé‡è¦é—®é¢˜ + 8 ä¸ªæ¬¡è¦é—®é¢˜ï¼‰ï¼š

**å…³é”®é—®é¢˜å†³ç­–ï¼š**
- **C1-C2**ï¼šæ·»åŠ  `suspend()`, `resume()`, `complete()` æ–¹æ³•
- **C3**ï¼š`consumeService()` æ”¹ç”¨ `ConsumeServiceDto` å‚æ•°
- **C4**ï¼š`productItemType` å­—æ®µä½¿ç”¨ `ProductItemType` ç±»å‹åˆ«å
- **C5**ï¼šåˆåŒç¼–å·æ ¼å¼ç¡®å®šä¸º `CONTRACT-YYYY-MM-NNNNN`
- **C6**ï¼šåˆ é™¤ Catalog Domain schema å¯¼å…¥ï¼Œä¿æŒ DDD åŸŸéš”ç¦»

**æ–°å¢å†…å®¹ï¼š**
- Section 5.7: Event Payload DTOsï¼ˆ6 ç§äº‹ä»¶ç±»å‹ï¼‰
- Section 6.1.1: totalAmount è¦†ç›–éªŒè¯è§„åˆ™
- Section 6.2.2: æœåŠ¡æ¶ˆè´¹ä¼˜å…ˆçº§ç®—æ³•
- Section 8.1: å‘½åçº¦å®šæ–‡æ¡£
- Section 8.2: ç¯å¢ƒå˜é‡é…ç½®æ–‡æ¡£
- Section 3.2.2: ServiceUnit æšä¸¾å®šä¹‰
- Section 3.2.6: å½’æ¡£æŸ¥è¯¢ç­–ç•¥ä¸æ€§èƒ½ä¼˜åŒ–

**ä¸šåŠ¡çº¦æŸæ˜ç¡®ï¼š**
- åˆåŒä¸äº§å“ä¸€å¯¹ä¸€å…³ç³»ï¼ˆä¸å¯æ›´æ¢äº§å“ï¼‰
- æœåŠ¡å•ä½ç»Ÿä¸€ä¸ºæ¬¡æ•° 'times'
- æ€»é‡‘é¢è¦†ç›–é™åˆ¶ï¼ˆæœ€å¤š 90% æŠ˜æ‰£ï¼Œæœ€é«˜ 200% åŸä»·ï¼‰
- å½’æ¡£æŸ¥è¯¢å¿…é¡»æä¾›æ—¥æœŸèŒƒå›´è¿‡æ»¤
- é¢„å é»˜è®¤ 15 åˆ†é’Ÿè¿‡æœŸï¼Œæ¯ 5 åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡

---

