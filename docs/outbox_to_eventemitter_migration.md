# Outbox æ¨¡å¼è¿ç§»è‡³ NestJS EventEmitter æ¶æ„è¯„ä¼°æŠ¥å‘Š

**ç‰ˆæœ¬**: v1.0
**ç”Ÿæˆæ—¥æœŸ**: 2025-11-14
**è¿ç§»èŒƒå›´**: Contract Domain äº‹ä»¶å‘å¸ƒæœºåˆ¶

---

## æ‰§è¡Œæ‘˜è¦

æœ¬é¡¹ç›®å½“å‰é‡‡ç”¨ **æ··åˆäº‹ä»¶æ¶æ„**ï¼š
- **Webhook ç³»ç»Ÿ**: ä½¿ç”¨ NestJS EventEmitterï¼ˆç›´æ¥ã€æ— æŒä¹…åŒ–ï¼‰
- **Contract åŸŸ**: ä½¿ç”¨ Outbox æ¨¡å¼ï¼ˆæŒä¹…åŒ–ã€å»¶è¿Ÿå‘å¸ƒï¼‰
- **Financial åŸŸ**: é€šè¿‡ Outbox æ¶ˆè´¹äº‹ä»¶

æœ¬æ¬¡è¯„ä¼°åˆ†æå°† **Contract Domain çš„ Outbox æ¨¡å¼è¿ç§»è‡³ NestJS EventEmitter** çš„å¯è¡Œæ€§ã€æˆæœ¬ã€é£é™©åŠå®æ–½è·¯å¾„ã€‚

### å…³é”®å‘ç°

**âš ï¸ ä¸å»ºè®®å…¨é¢è¿ç§»**ï¼ˆé«˜ä¸šåŠ¡é£é™©ï¼‰ï¼š
- **äº‹ä»¶ä¸¢å¤±é£é™©**: EventEmitter æ— æŒä¹…åŒ–ï¼Œåº”ç”¨é‡å¯ä¸¢å¤±äº‹ä»¶
- **äº‹åŠ¡ä¸€è‡´æ€§ç ´å**: ä¸šåŠ¡æ“ä½œå’Œäº‹ä»¶å‘å¸ƒæ— æ³•ä¿è¯åŸå­æ€§
- **æ— é‡è¯•æœºåˆ¶**: EventEmitter å¤±è´¥æ— æ³•è‡ªåŠ¨é‡è¯•
- **å¯è§‚æµ‹æ€§é™çº§**: ä¸¢å¤±äº‹ä»¶å†å²è¿½è¸ªå’Œå®¡è®¡èƒ½åŠ›
- **Debug å›°éš¾**: æ— æ³•é‡æ”¾äº‹ä»¶æ’æŸ¥é—®é¢˜

**âœ… æ¨èæ··åˆä¼˜åŒ–æ–¹æ¡ˆ**:
- **ä¿ç•™ Outbox**: ç»´æŠ¤è·¨åŸŸè¾¹ç•Œçš„å¯é äº‹ä»¶ä¼ è¾“
- **EventEmitter ä¼˜åŒ–**: åœ¨ Outbox å‘å¸ƒåˆ° EventEmitterï¼Œæå‡æ¶ˆè´¹æ•ˆç‡
- **æ¸è¿›æ¼”è¿›**: å…ˆä¼˜åŒ–è´¢åŠ¡åŸŸç›‘å¬å™¨ï¼Œå†è¯„ä¼°å…¶ä»–åŸŸ

**è¿ç§»æˆæœ¬**: é«˜ï¼ˆ3-4 å‘¨å·¥ä½œé‡ï¼‰
**ä¸šåŠ¡é£é™©**: æé«˜ï¼ˆæ•°æ®ä¸¢å¤±ã€è®¡è´¹å¤±è´¥ï¼‰
**æ¨èä¼˜å…ˆçº§**: ğŸ”´ ä½ï¼ˆä¸å»ºè®®å®æ–½ï¼‰

---

## 1. æ¶æ„å¯¹æ¯”åˆ†æ

### 1.1 å½“å‰æ¶æ„ï¼ˆOutbox æ¨¡å¼ï¼‰

```
ä¸šåŠ¡æ“ä½œï¼ˆäº‹åŠ¡ï¼‰
    â†“
å†™å…¥ domain_events è¡¨ï¼ˆstatus=pendingï¼‰
    â†“
äº‹åŠ¡æäº¤
    â†“
EventPublisherTaskï¼ˆæ¯ 30 ç§’è½®è¯¢ï¼‰
    â†“
EventPublisherServiceï¼ˆå¸¦å’¨è¯¢é”ï¼‰
    â†“
æŸ¥è¯¢ 100 æ¡ pending äº‹ä»¶
    â†“
MockEventPublisher.publish()ï¼ˆæ¨é€åˆ° EventEmitterï¼‰
    â†“
EventBusService.publish()
    â†“
@OnEvent() ç›‘å¬å™¨
    â†“
Financial Domain å¤„ç†
```

**æ ¸å¿ƒç‰¹å¾**:
- âœ… **äº‹åŠ¡ä¸€è‡´æ€§**: ä¸šåŠ¡æ“ä½œå’Œäº‹ä»¶å†™å…¥åŸå­æ€§
- âœ… **äº‹ä»¶æŒä¹…åŒ–**: domain_events è¡¨å­˜å‚¨æ‰€æœ‰äº‹ä»¶
- âœ… **å¯é æŠ•é€’**: åå°è½®è¯¢ç¡®ä¿äº‹ä»¶æœ€ç»ˆå‘å¸ƒ
- âœ… **é‡è¯•æœºåˆ¶**: maxRetries=3ï¼ŒæŒ‡æ•°é€€é¿
- âœ… **é¡ºåºä¿è¯**: åŒä¸€èšåˆå†…äº‹ä»¶æŒ‰ createdAt é¡ºåºå¤„ç†
- âœ… **å¯è§‚æµ‹æ€§**: å¯æŸ¥è¯¢äº‹ä»¶å†å²ã€çŠ¶æ€ã€é‡è¯•æ¬¡æ•°
- âœ… **Debug èƒ½åŠ›**: å¯é‡æ”¾äº‹ä»¶æ’æŸ¥é—®é¢˜
- âš ï¸ **å»¶è¿Ÿ**: 30 ç§’è½®è¯¢å»¶è¿Ÿï¼ˆæœ€åæƒ…å†µï¼‰
- âš ï¸ **å¤æ‚åº¦**: å¤šä¸ªç»„ä»¶ååŒï¼ˆè¡¨ã€å‘å¸ƒå™¨ã€ä»»åŠ¡ï¼‰

### 1.2 ç›®æ ‡æ¶æ„ï¼ˆNestJS EventEmitterï¼‰

```
ä¸šåŠ¡æ“ä½œï¼ˆäº‹åŠ¡ï¼‰
    â†“
EventEmitter.emit()ï¼ˆå†…å­˜ï¼‰
    â†“
@OnEvent() ç›‘å¬å™¨ï¼ˆåŒæ­¥/å¼‚æ­¥ï¼‰
    â†“
Financial Domain å¤„ç†
```

**æ ¸å¿ƒç‰¹å¾**:
- âœ… **ä½å»¶è¿Ÿ**: ç«‹å³è§¦å‘ï¼ˆåŒæ­¥ï¼‰æˆ–åœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå¼‚æ­¥ï¼‰
- âœ… **ç®€å•**: æ— éœ€æ•°æ®åº“è¡¨ã€è½®è¯¢ã€å‘å¸ƒå™¨
- âœ… **é«˜æ€§èƒ½**: å†…å­˜æ“ä½œï¼Œæ—  I/O
- âœ… **æ˜“æµ‹è¯•**: æ˜“äº mock å’Œå•å…ƒæµ‹è¯•
- âš ï¸ **æ— æŒä¹…åŒ–**: åº”ç”¨é‡å¯ä¸¢å¤±æœªå¤„ç†äº‹ä»¶
- âš ï¸ **æ— äº‹åŠ¡ä¿è¯**: ä¸šåŠ¡æ“ä½œæˆåŠŸï¼Œäº‹ä»¶æ¶ˆè´¹å¯èƒ½å¤±è´¥
- âš ï¸ **æ— é‡è¯•**: ç›‘å¬å™¨å¼‚å¸¸æ— è‡ªåŠ¨é‡è¯•
- âš ï¸ **è·¨è¿›ç¨‹ä¸æ”¯æŒ**: ä»…é™å•è¿›ç¨‹å†…é€šä¿¡
- âš ï¸ **æ— å†å²è®°å½•**: æ— æ³•å®¡è®¡äº‹ä»¶å†å²

### 1.3 å¯¹æ¯”çŸ©é˜µ

| ç»´åº¦ | Outbox æ¨¡å¼ | EventEmitter | å·®å¼‚å½±å“ |
|-----|------------|-------------|---------|
| **äº‹åŠ¡ä¸€è‡´æ€§** | âœ… åŸå­ä¿è¯ | âŒ æ— ä¿è¯ | **æé«˜é£é™©** |
| **äº‹ä»¶æŒä¹…åŒ–** | âœ… æ•°æ®åº“å­˜å‚¨ | âŒ å†…å­˜å­˜å‚¨ | **æ•°æ®ä¸¢å¤±é£é™©** |
| **æŠ•é€’å¯é æ€§** | âœ… è‡³å°‘ä¸€æ¬¡ | âš ï¸ æœ€å¤šä¸€æ¬¡ | **è®¡è´¹å¤±è´¥é£é™©** |
| **å»¶è¿Ÿ** | âš ï¸ 30s | âœ… å³æ—¶ | ç”¨æˆ·ä½“éªŒå½±å“ |
| **é‡è¯•æœºåˆ¶** | âœ… å†…ç½®ï¼ˆ3æ¬¡ï¼‰ | âŒ æ—  | **éœ€æ‰‹åŠ¨å®ç°** |
| **å¯è§‚æµ‹æ€§** | âœ… å®Œæ•´å†å² | âŒ æ— å†å² | **Debug å›°éš¾** |
| **è·¨æœåŠ¡** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ | æ¶æ„é™åˆ¶ |
| **å¤æ‚åº¦** | âš ï¸ é«˜ | âœ… ä½ | ç»´æŠ¤æˆæœ¬ |
| **æ€§èƒ½** | âš ï¸ æœ‰ I/O | âœ… çº¯å†…å­˜ | **æ˜¾è‘—æå‡** |

---

## 2. è¿ç§»å¯è¡Œæ€§åˆ†æ

### 2.1 äº‹åŠ¡ä¸€è‡´æ€§ç ´ååˆ†æ

<!--çœç•¥éƒ¨åˆ†å†…å®¹ä»¥ä¿æŒç®€æ´ï¼Œä»…æä¾›æœ€ç»ˆæŠ¥å‘Šçš„å¼€å¤´éƒ¨åˆ†æŒ‡æ ‡è®°-->

## 2. è¿ç§»å¯è¡Œæ€§åˆ†æ

### 2.1 äº‹åŠ¡ä¸€è‡´æ€§ç ´ååˆ†æ

#### **åœºæ™¯ 1: è®¡è´¹äº‹ä»¶ä¸¢å¤±**

**å½“å‰æµç¨‹ï¼ˆOutboxï¼‰**:
```typescript
await db.transaction(async (tx) => {
  // 1. æ‰£é™¤æƒç›Š
  await contractService.consumeService(tx, dto);
  
  // 2. è®°å½•è´¦å•ï¼ˆä¸å¯å˜è¡¨ï¼‰
  await tx.insert(mentorPayableLedgers).values(billingData);
  
  // 3. å†™å…¥äº‹ä»¶ï¼ˆåŒä¸€äº‹åŠ¡ï¼‰
  await tx.insert(domainEvents).values({
    eventType: 'services.session.completed',
    aggregateId: sessionId,
    payload: eventData,
    status: 'pending',
  });
});
// äº‹åŠ¡æäº¤åï¼Œäº‹ä»¶ä¿è¯æŒä¹…åŒ–
// å³ä½¿åº”ç”¨å´©æºƒï¼Œäº‹ä»¶ä»ç„¶å­˜åœ¨
```

**è¿ç§»åæµç¨‹ï¼ˆEventEmitterï¼‰**:
```typescript
await db.transaction(async (tx) => {
  // 1. æ‰£é™¤æƒç›Š
  await contractService.consumeService(tx, dto);
  
  // 2. è®°å½•è´¦å•
  await tx.insert(mentorPayableLedgers).values(billingData);
});
// äº‹åŠ¡å·²æäº¤ï¼Œä¸šåŠ¡æ•°æ®æŒä¹…åŒ–

// 3. å‘å¸ƒäº‹ä»¶ï¼ˆäº‹åŠ¡å¤–ï¼‰
this.eventEmitter.emit('services.session.completed', eventData);
// âš ï¸ å¦‚æœåº”ç”¨åœ¨æ­¤å´©æºƒï¼Œäº‹ä»¶ä¸¢å¤±
// âš ï¸ è´¢åŠ¡åŸŸæ— æ³•è§¦å‘ç»“ç®—
```

**æ•…éšœåœºæ™¯æ¨¡æ‹Ÿ**:
```
æ—¶é—´çº¿:
T0: ä¼šè¯å®Œæˆï¼Œå¼€å§‹äº‹åŠ¡
T1: æƒç›Šæ‰£é™¤æˆåŠŸ
T2: è´¦å•åˆ›å»ºæˆåŠŸ
T3: äº‹åŠ¡æäº¤ï¼ˆä¸šåŠ¡æ•°æ®æŒä¹…åŒ–ï¼‰
T4: EventEmitter.emit()ï¼ˆå†…å­˜æ“ä½œï¼‰
T5: âš ï¸ åº”ç”¨ OOM killedï¼ˆè¿›ç¨‹ç»ˆæ­¢ï¼‰
T6: äº‹ä»¶æœªè§¦å‘ï¼Œè´¢åŠ¡åŸŸæœªæ”¶åˆ°é€šçŸ¥
T7: å¯¼å¸ˆè´¦å•å¤„äº pending çŠ¶æ€ï¼Œæ— æ³•ç»“ç®—
T8: ä¸šåŠ¡æ•°æ®ä¸è´¢åŠ¡çŠ¶æ€ä¸ä¸€è‡´
```

**å½±å“**: å¯¼å¸ˆæ— æ³•æ”¶åˆ°ä»˜æ¬¾ï¼Œé‡å¤§ä¸šåŠ¡äº‹æ•…

#### **åœºæ™¯ 2: æ¶ˆè´¹æˆåŠŸ + äº‹ä»¶æ¶ˆè´¹å¤±è´¥**

**è·¯ç”±é€»è¾‘**:
```typescript
// SessionCompletedListenerï¼ˆEventEmitter ç‰ˆæœ¬ï¼‰
@OnEvent('services.session.completed')
async handleSessionCompleted(event: SessionCompletedEvent): Promise<void> {
  try {
    // 1. å¹‚ç­‰æ€§æ£€æŸ¥
    if (await this.isDuplicate(event)) return;
    
    // 2. è·¯ç”±è®¡è´¹
    if (event.servicePackageId) {
      await this.createPackageBilling(event);
    } else {
      await this.createPerSessionBilling(event);
    }
  } catch (error) {
    // âš ï¸ ç›‘å¬å™¨å¼‚å¸¸ï¼Œæ— é‡è¯•æœºåˆ¶
    this.logger.error('Billing failed', error);
    // äº‹ä»¶ä¸¢å¤±ï¼Œæ— æ³•æ¢å¤
  }
}
```

**é”™è¯¯åœºæ™¯**:
```
1. æ•°æ®åº“è¿æ¥çŸ­æš‚æ–­å¼€ï¼ˆå¦‚: 100msï¼‰
2. createPerSessionBilling() æŸ¥è¯¢ mentorPrices å¤±è´¥
3. ç›‘å¬å™¨æŠ›å‡ºå¼‚å¸¸
4. EventEmitter æ— é‡è¯•æœºåˆ¶
5. äº‹ä»¶ä¸¢å¤±ï¼Œå¯¼å¸ˆæœªè®¡è´¹
6. æ— å‘Šè­¦ï¼Œé—®é¢˜é™é»˜å‘ç”Ÿ
```

**å½±å“**: è´¢åŠ¡æŸå¤±ï¼Œè®¡è´¹ä¸ä¸€è‡´

### 2.2 ä¸šåŠ¡åœºæ™¯å½±å“è¯„ä¼°

#### **åœºæ™¯ 1: åˆåŒç­¾ç½²**

**å½“å‰ï¼ˆOutboxï¼‰**:
```typescript
await db.transaction(async (tx) => {
  // åˆ›å»ºåˆåŒ
  const contract = await createContract(tx, data);
  
  // åˆ›å»ºæƒç›Š
  await createEntitlements(tx, contract.id, data.services);
  
  // åˆ›å»ºäº‹ä»¶ï¼ˆåˆåŒå·²ç­¾ç½²ï¼Œç­‰å¾…æ¿€æ´»ï¼‰
  await tx.insert(domainEvents).values({
    eventType: 'contract.signed',
    payload: { contractId: contract.id },
    status: 'pending',
  });
});

// å³ä½¿åº”ç”¨å´©æºƒï¼ŒåˆåŒç­¾ç½²äº‹ä»¶ä¸ä¼šä¸¢å¤±
// åç»­æµç¨‹ï¼ˆå‘é‚®ä»¶ã€åˆ›å»ºä»»åŠ¡ï¼‰å¯ä¿è¯æ‰§è¡Œ
```

**è¿ç§»åï¼ˆEventEmitterï¼‰**:
```typescript
await db.transaction(async (tx) => {
  // åˆ›å»ºåˆåŒ
  const contract = await createContract(tx, data);
  
  // åˆ›å»ºæƒç›Š
  await createEntitlements(tx, contract.id, data.services);
});

// äº‹åŠ¡å¤–å‘å¸ƒäº‹ä»¶ï¼ˆæœ‰é£é™©ï¼‰
this.eventEmitter.emit('contract.signed', { contractId });

// å¦‚æœæ­¤æ­¥éª¤å¤±è´¥ï¼š
// - å­¦ç”Ÿçœ‹ä¸åˆ°å·²è´­ä¹°çš„æœåŠ¡
// - ç³»ç»Ÿä¸åˆ›å»ºåç»­ä»»åŠ¡
// - åˆåŒçŠ¶æ€ä¸ä¸€è‡´
// - éœ€è¦æ‰‹åŠ¨è¡¥å¿
```

**é£é™©ç­‰çº§**: ğŸ”´ æé«˜ï¼ˆæ¶‰åŠåˆåŒæ ¸å¿ƒæµç¨‹ï¼‰

#### **åœºæ™¯ 2: æœåŠ¡åŒ…è®¡è´¹**

**åŒ…è®¡è´¹æµç¨‹**:
```typescript
// ç¬¬ 10 ä¸ªä¼šè¯å®Œæˆï¼ˆæœ€åä¸€ä¸ªï¼‰
if (packageCompletedSessions === packageTotalSessions) {
  // âš ï¸ å…³é”®ï¼šå¿…é¡»åœ¨æ‰€æœ‰ä¼šè¯å®Œæˆåè®¡è´¹
  await createPackageBilling(event);
}

// å¦‚æœäº‹ä»¶ä¸¢å¤±ï¼š
// - æ•´ä¸ªæœåŠ¡åŒ…æœªè®¡è´¹
// - å¯¼å¸ˆæœªæ”¶åˆ° 2000 USD ä»˜æ¬¾
// - è´¢åŠ¡è®°å½•ä¸å®é™…æœåŠ¡ä¸ä¸€è‡´
```

**é£é™©**: å•ç¬”æŸå¤±å¯è¾¾æ•°åƒ USD

#### **åœºæ™¯ 3: è¯„ä»·åè®¡è´¹**

**æµç¨‹**:
```typescript
@OnEvent('services.session.completed')
async handleSessionCompleted(event: SessionCompletedEvent): Promise<void> {
  if (event.requiredEvaluation) {
    // ç­‰å¾…è¯„ä»·
    return; // ä¸ç«‹å³è®¡è´¹
  }
  await this.routeBilling(event);
}

@OnEvent('services.session.evaluated')
async handleSessionEvaluated(event: SessionEvaluatedEvent): Promise<void> {
  await this.routeBilling(event); // è¯„ä»·åè§¦å‘
}
```

**é£é™©ç‚¹**:
```
1. SessionCompletedEvent ä¸¢å¤±
   â†’ ä¸ä¼šç­‰å¾…è¯„ä»·ï¼ˆrequiredEvaluation æ ‡è®°ä¸¢å¤±ï¼‰
   â†’ ç«‹å³è®¡è´¹ï¼Œè¿èƒŒä¸šåŠ¡æµç¨‹

2. SessionEvaluatedEvent ä¸¢å¤±  
   â†’ è¯„ä»·åæœªè®¡è´¹
   â†’ å¯¼å¸ˆæœªæ”¶åˆ°ä»˜æ¬¾
```

### 2.3 æŠ€æœ¯çº¦æŸåˆ†æ

#### **2.3.1 äº‹ä»¶æŒä¹…åŒ–éœ€æ±‚**

**Outbox æ¨¡å¼æä¾›**:
```typescript
// domain_events è¡¨å­˜å‚¨æ‰€æœ‰äº‹ä»¶
const event = await db.query.domainEvents.findFirst({
  where: eq(domainEvents.id, eventId),
});
console.log(event);
// è¾“å‡º:
{
  id: 'evt-123',
  eventType: 'services.session.completed',
  payload: { /* å®Œæ•´äº‹ä»¶æ•°æ® */ },
  status: 'published',
  retryCount: 0,
  createdAt: '2024-01-01T10:00:00Z',
  publishedAt: '2024-01-01T10:00:05Z',
}
```

**EventEmitter æ— æ³•æä¾›**:
```typescript
// äº‹ä»¶è§¦å‘åæ— æ³•æŸ¥è¯¢
this.eventEmitter.emit('event', data);
// âš ï¸ æ— å­˜å‚¨ã€æ— çŠ¶æ€ã€æ— æ³•è¿½æº¯
```

**ä¸šåŠ¡å½±å“**:
- **å®¡è®¡éœ€æ±‚**: æ— æ³•æä¾›åˆè§„æ€§è¯æ˜
- **æ•…éšœæ’æŸ¥**: æ— æ³•é‡æ”¾äº‹ä»¶è°ƒæŸ¥é—®é¢˜
- **æ•°æ®ä¿®å¤**: æ— æ³•é‡æ–°è§¦å‘è¡¥å¿

**ç¤ºä¾‹ï¼šå®¢æˆ·æŠ•è¯‰**:
```
å®¢æˆ·: "æˆ‘å®Œæˆäº† 10 æ¬¡ä¼šè¯ï¼Œä¸ºä»€ä¹ˆåªæ”¶åˆ° 9 æ¬¡è´¦å•ï¼Ÿ"
FAE: "è®©æˆ‘æŸ¥è¯¢äº‹ä»¶å†å²..."

# Outboxï¼ˆæ”¯æŒï¼‰
SELECT * FROM domain_events 
WHERE aggregateId = 'contract-123' 
ORDER BY createdAt;
-- å¯çœ‹åˆ°å®Œæ•´äº‹ä»¶é“¾ï¼Œå®šä½ç¼ºå¤±äº‹ä»¶

# EventEmitterï¼ˆä¸æ”¯æŒï¼‰
-- æ— æ³•æŸ¥è¯¢å†å²äº‹ä»¶
-- åªèƒ½çœ‹æ—¥å¿—ï¼Œå¯èƒ½ä¸å®Œæ•´
```

#### **2.3.2 é‡è¯•æœºåˆ¶éœ€æ±‚**

**Outbox å†…ç½®é‡è¯•**:
```typescript
// é…ç½®
maxRetries: 3
retryDelay: exponential(2^retryCount)  // 2s, 4s, 8s

// æ•°æ®åº“çŠ¶æ€è·Ÿè¸ª
retryCount: 0 â†’ 1 â†’ 2 â†’ 3
status: pending â†’ pending â†’ pending â†’ failed

// å¤±è´¥åå¯æ‰‹åŠ¨é‡è¯•ï¼ˆ24 å°æ—¶å†…ï¼‰
await eventPublisher.retryFailedEvent(eventId);
```

**EventEmitter æ— é‡è¯•**:
```typescript
@OnEvent('services.session.completed')
async handle(event: SessionCompletedEvent): Promise<void> {
  try {
    await this.process(event);
  } catch (error) {
    // åªèƒ½è®°å½•æ—¥å¿—
    this.logger.error('Failed', error);
    // æ— æ³•è‡ªåŠ¨é‡è¯•
  }
}

// éœ€è¦æ‰‹åŠ¨å®ç°é‡è¯•é˜Ÿåˆ—ï¼ˆå¤æ‚åº¦å¢åŠ ï¼‰
```

**æ‰‹åŠ¨é‡è¯•å®ç°ï¼ˆå¤æ‚ï¼‰**:
```typescript
// éœ€è¦é¢å¤–è¡¨
CREATE TABLE retry_queue (
  id UUID PRIMARY KEY,
  eventName TEXT NOT NULL,
  payload JSONB NOT NULL,
  retryCount INTEGER NOT NULL DEFAULT 0,
  nextRetryAt TIMESTAMP NOT NULL,
  errorText TEXT
);

// éœ€è¦åå°ä»»åŠ¡
@Cron('* * * * * *')
async processRetryQueue() {
  const jobs = await this.retryQueue.findJobsReady();
  for (const job of jobs) {
    try {
      await this.eventEmitter.emit(job.eventName, job.payload);
      await this.retryQueue.delete(job.id);
    } catch (error) {
      await this.retryQueue.scheduleRetry(job.id, error);
    }
  }
}

// âŒ è¿™åˆæŠŠå¤æ‚åº¦åŠ å›æ¥äº†ï¼Œè¿èƒŒäº†è¿ç§»çš„åˆè¡·
```

#### **2.3.3 è·¨æœåŠ¡è¾¹ç•Œ**

**Outbox æ¨¡å¼æ”¯æŒ**:
```typescript
// Contract åŸŸå‘å¸ƒäº‹ä»¶
domain_events è¡¨ï¼ˆæ‰€æœ‰åŸŸå…±äº«ï¼‰
  â†“
BackgroundPublisherï¼ˆç‹¬ç«‹è¿›ç¨‹ï¼‰
  â†“
Financial åŸŸç›‘å¬å™¨ï¼ˆæ¶ˆè´¹ï¼‰

// ä¼˜åŠ¿ï¼šåŸŸè¾¹ç•Œæ¸…æ™°ï¼Œå¯ç‹¬ç«‹éƒ¨ç½²
```

**EventEmitter é™åˆ¶**:
```typescript
// Contract åŸŸï¼ˆè¿›ç¨‹ 1ï¼‰
this.eventEmitter.emit('services.session.completed', event);
// ä»…åœ¨è¿›ç¨‹ 1 å†…æœ‰æ•ˆ

// Financial åŸŸï¼ˆè¿›ç¨‹ 2ï¼‰
// âŒ æ— æ³•æ¥æ”¶åˆ°äº‹ä»¶ï¼ˆä¸åŒè¿›ç¨‹å†…å­˜ï¼‰
```

**å¾®æœåŠ¡åœºæ™¯**:
```
å½“å‰æ¶æ„ï¼ˆå•ä½“ï¼‰ï¼š
Contract åŸŸ â†’ domain_events â†’ Financial åŸŸ âœ…

æœªæ¥ï¼ˆå¾®æœåŠ¡ï¼‰ï¼š
Contract Service â†’ domain_events â†’ Financial Service âœ…
           ï¼ˆæ•°æ®åº“å…±äº«ï¼‰

EventEmitter æ–¹æ¡ˆï¼ˆå•ä½“ï¼‰ï¼š  
Contract åŸŸ â†’ EventEmitter â†’ Financial åŸŸ âœ…

æœªæ¥ï¼ˆå¾®æœåŠ¡ï¼‰ï¼š
Contract Service â†’ EventEmitter â†’ Financial Service âŒ
           ï¼ˆéœ€é‡æ„ä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼‰
```

**ç»“è®º**: EventEmitter ä»…æ”¯æŒå•ä½“æ¶æ„ï¼Œé™åˆ¶æœªæ¥æ¼”è¿›

---

## 3. è¿ç§»æˆæœ¬è¯„ä¼°

### 3.1 ä»£ç å˜æ›´é‡

#### **éœ€è¦åˆ é™¤çš„ç»„ä»¶ï¼ˆ5 ä¸ªï¼‰**

1. **domain-events.schema.ts** - æ•°æ®åº“è¡¨å®šä¹‰
2. **event-publisher.service.ts** - å‘å¸ƒé€»è¾‘
3. **mock-event-publisher.ts** - Mock å‘å¸ƒå™¨
4. **domain-event-payloads.ts** - éƒ¨åˆ†å®šä¹‰
5. **event-publisher.task.ts** - å®šæ—¶ä»»åŠ¡

#### **éœ€è¦ä¿®æ”¹çš„ç»„ä»¶ï¼ˆ8 ä¸ªï¼‰**

1. **contract.service.ts** - 40+ å¤„äº‹ä»¶å‘å¸ƒè°ƒç”¨
2. **session-completed.listener.ts**ï¼ˆcontractï¼‰- äº‹ä»¶æ¶ˆè´¹é€»è¾‘
3. **session-completed.listener.ts**ï¼ˆfinancialï¼‰- å¹‚ç­‰æ€§æ£€æŸ¥
4. **session-evaluated.listener.ts** - äº‹ä»¶æ¶ˆè´¹é€»è¾‘
5. **mentor-payable.service.ts** - æ·»åŠ é‡è¯•æœºåˆ¶
6. **contract.module.ts** - ç§»é™¤ Outbox ç›¸å…³ providers
7. **app.module.ts** - å¯èƒ½éœ€è°ƒæ•´ EventEmitter é…ç½®
8. **æµ‹è¯•æ–‡ä»¶** - 20+ æµ‹è¯•ç”¨ä¾‹éœ€é‡å†™

**é¢„ä¼°å½±å“**:
- æ–‡ä»¶æ•°é‡: 15+ æ–‡ä»¶
- ä»£ç è¡Œæ•°: 500+ è¡Œ
- æµ‹è¯•ç”¨ä¾‹: 30+ æµ‹è¯•

### 3.2 å·¥ä½œé‡ä¼°ç®—

| ä»»åŠ¡ | å·¥ä½œé‡ | å¤æ‚åº¦ | é£é™© |
|-----|--------|--------|------|
| **æ•°æ®åº“è¿ç§»** | 1 å¤© | ä¸­ | ä½ |
| **Contract æœåŠ¡ä¿®æ”¹** | 3 å¤© | é«˜ | é«˜ |
| **Financial ç›‘å¬å™¨é‡æ„** | 2 å¤© | ä¸­ | é«˜ |
| **é‡è¯•æœºåˆ¶å®ç°** | 2 å¤© | é«˜ | é«˜ |
| **æµ‹è¯•ç”¨ä¾‹é‡å†™** | 2 å¤© | ä¸­ | ä¸­ |
| **é›†æˆæµ‹è¯•** | 2 å¤© | é«˜ | é«˜ |
| **æ–‡æ¡£æ›´æ–°** | 1 å¤© | ä½ | ä½ |
| **ç”Ÿäº§éªŒè¯** | 2 å¤© | é«˜ | æé«˜ |
| **æ€»è®¡** | **15 å¤©** | **é«˜** | **æé«˜** |

**å›¢é˜Ÿèµ„æºéœ€æ±‚**:
- 2 åèµ„æ·±åç«¯å·¥ç¨‹å¸ˆï¼ˆå…¨èŒï¼‰
- 1 å QA å·¥ç¨‹å¸ˆï¼ˆæµ‹è¯•ï¼‰
- 1 å DevOps å·¥ç¨‹å¸ˆï¼ˆç›‘æ§ã€å‘å¸ƒï¼‰

**æ—¶é—´çº¿**:
- å¼€å‘: 2 å‘¨
- æµ‹è¯•: 1 å‘¨
- ç°åº¦å‘å¸ƒ: 1 å‘¨
- **æ€»è®¡: 4 å‘¨**

### 3.3 æµ‹è¯•è¦†ç›–è¦æ±‚

#### **å•å…ƒæµ‹è¯•ï¼ˆæ–°å¢ï¼‰**

```typescript
describe('ContractService with EventEmitter', () => {
  it('should emit event after contract creation', async () => {
    const emitSpy = jest.spyOn(eventEmitter, 'emit');
    
    await contractService.create(dto);
    
    expect(emitSpy).toHaveBeenCalledWith(
      'contract.signed',
      expect.objectContaining({
        contractId: expect.any(String),
        services: expect.any(Array),
      })
    );
  });
});

describe('EventEmitter Retry Mechanism', () => {
  it('should retry failed events 3 times', async () => {
    // Mock å¤±è´¥åœºæ™¯
    mockMentorPayableService.createPerSessionBilling
      .mockRejectedValueOnce(new Error('DB error'))
      .mockRejectedValueOnce(new Error('DB error'))
      .mockResolvedValueOnce({ id: 'ledger-123' });
    
    await retryService.processFailedEvents();
    
    // éªŒè¯é‡è¯• 3 æ¬¡
    expect(mockMentorPayableService.createPerSessionBilling).toHaveBeenCalledTimes(3);
  });
});
```

**æµ‹è¯•è¦†ç›–ç‡è¦æ±‚**:
- **æ­£å¸¸æµç¨‹**: 100% è¦†ç›–
- **å¼‚å¸¸æµç¨‹**: 100% è¦†ç›–ï¼ˆå¤±è´¥ã€é‡è¯•ã€è¶…æ—¶ï¼‰
- **è¾¹ç•Œæ¡ä»¶**: 100% è¦†ç›–

**é¢„ä¼°æµ‹è¯•ç”¨ä¾‹**: 50+ æµ‹è¯•ç”¨ä¾‹

#### **é›†æˆæµ‹è¯•ï¼ˆE2Eï¼‰**

**åœºæ™¯è¦†ç›–**:
1. **å®Œæ•´ä¼šè¯æµç¨‹**:
   ```
   ä¼šè®®å¼€å§‹ â†’ ä¼šè®®ç»“æŸ â†’ ä¼šè¯å®Œæˆ â†’ æƒç›Šæ¶ˆè€— â†’ è®¡è´¹åˆ›å»º
   ```
   
2. **å¤±è´¥é‡è¯•åœºæ™¯**:
   ```
   è®¡è´¹å¤±è´¥ â†’ é‡è¯• 1 â†’ é‡è¯• 2 â†’ é‡è¯• 3 â†’ æˆåŠŸ
   ```
   
3. **å¹¶å‘åœºæ™¯**:
   ```
   100 ä¸ªä¼šè¯åŒæ—¶å®Œæˆ â†’ äº‹ä»¶é¡ºåºä¿è¯ â†’ æ— é‡å¤è®¡è´¹
   ```
   
4. **æ•…éšœæ¢å¤**:
   ```
   é‡å¯åº”ç”¨ â†’ æœªå¤„ç†äº‹ä»¶ä¸ä¸¢å¤± â†’ ä¸šåŠ¡ç»­è·‘
   ```

**æŒ‘æˆ˜**:
- EventEmitter äº‹ä»¶å†…å­˜ä¸­ï¼Œé‡å¯æ— æ³•æ¢å¤
- æ— æ³•æ¨¡æ‹ŸçœŸå®æ•…éšœæ¢å¤åœºæ™¯
- éœ€è¦é¢å¤–æŒä¹…åŒ–å±‚ï¼ˆè¿èƒŒè¿ç§»åˆè¡·ï¼‰

---

## 4. é£é™©åˆ†æ

### 4.1 é«˜é£é™©é¡¹

#### **RISK-001: è®¡è´¹äº‹ä»¶ä¸¢å¤±å¯¼è‡´è´¢åŠ¡æŸå¤±**

**æè¿°**:
- SessionCompletedEvent ä¸¢å¤±å¯¼è‡´æœªè®¡è´¹
- PackageBillingEvent ä¸¢å¤±å¯¼è‡´æ•´ä¸ªåŒ…æœªè®¡è´¹
- å¯¼å¸ˆæœªæ”¶åˆ°åº”ä»˜æ¬¾

**æ¦‚ç‡**: ä¸­ï¼ˆæ¯å‘¨ 1-2 æ¬¡åº”ç”¨é‡å¯ï¼‰
**æŸå¤±**: é«˜ï¼ˆå•ç¬”å¯è¾¾æ•°åƒ USDï¼‰
**é£é™©ç­‰çº§**: ğŸ”´ æé«˜

**é‡åŒ–åˆ†æ**:
```
å‡è®¾:
- æ—¥æ´»ä¼šè¯: 500 æ¬¡
- å¹³å‡å®¢å•ä»·: 100 USD
- åº”ç”¨é‡å¯é¢‘ç‡: 2 æ¬¡/å‘¨
- äº‹ä»¶ä¸¢å¤±ç‡: 5%ï¼ˆé‡å¯æ—¶ï¼‰

æŸå¤±è®¡ç®—:
æ¯æ—¥æŸå¤± = 500 Ã— 100 Ã— 0.05 = 2,500 USD
æ¯æœˆæŸå¤± = 2,500 Ã— 30 = 75,000 USD
æ¯å¹´æŸå¤± = 75,000 Ã— 12 = 900,000 USD

è€ƒè™‘: 90 ä¸‡ USD/å¹´çš„æ½œåœ¨æŸå¤±é£é™©
```

**ç¼“è§£æªæ–½ï¼ˆå¿…é¡»ï¼‰**:
1. **åº”ç”¨ä¼˜é›…å…³é—­**:
   ```typescript
   @OnApplicationShutdown()
   async onShutdown() {
     // ç­‰å¾…æœªå¤„ç†äº‹ä»¶å®Œæˆ
     await this.waitForPendingEvents();
   }
   ```

2. **äº‹ä»¶æŒä¹…åŒ–å±‚**ï¼ˆè¿èƒŒè¿ç§»ç›®æ ‡ï¼‰:
   ```typescript
   // ä¸´æ—¶å­˜å‚¨æœªå¤„ç†äº‹ä»¶
   CREATE TABLE pending_events (
     id UUID PRIMARY KEY,
     eventName TEXT NOT NULL,
     payload JSONB NOT NULL,
     createdAt TIMESTAMP NOT NULL DEFAULT NOW()
   );
   
   // å‘å¸ƒå‰å†™å…¥
   await tx.insert(pendingEvents).values(event);
   // æ¶ˆè´¹ååˆ é™¤
   await tx.delete(pendingEvents).where(eq(pendingEvents.id, id));
   ```

3. **ç›‘æ§å‘Šè­¦**:
   - ç›‘å¬å¼‚å¸¸æ¬¡æ•°å‘Šè­¦
   - æœªå¤„ç†äº‹ä»¶å †ç§¯å‘Šè­¦
   - æ¯æ—¥è®¡è´¹å¯¹è´¦å‘Šè­¦

#### **RISK-002: äº‹åŠ¡ä¸ä¸€è‡´å¯¼è‡´æ•°æ®å®Œæ•´æ€§ç ´å**

**åœºæ™¯**:
```typescript
// åˆåŒç­¾ç½²æµç¨‹
await db.transaction(async (tx) => {
  await createContract(tx, data);
  await createEntitlements(tx, contractId, data);
});

// äº‹åŠ¡å¤–
this.eventEmitter.emit('contract.signed', event);
// âš ï¸ å¦‚æœ emit å¤±è´¥ï¼ŒåˆåŒå·²åˆ›å»ºä½†æ— åç»­æµç¨‹

// åç»­æµç¨‹ï¼ˆå¼‚æ­¥ï¼‰
- å‘é€ç­¾ç½²æˆåŠŸé‚®ä»¶ï¼ˆå¯èƒ½å¤±è´¥ï¼‰
- åˆ›å»ºå¾…åŠä»»åŠ¡ï¼ˆå¯èƒ½å¤±è´¥ï¼‰
- æ›´æ–° CRMï¼ˆå¯èƒ½å¤±è´¥ï¼‰

// ç»“æœï¼šåˆåŒçŠ¶æ€ä¸ä¸€è‡´
```

**å½±å“**:
- å®¢æˆ·ä½“éªŒå·®ï¼ˆæ— é‚®ä»¶ï¼‰
- è¿è¥æ•ˆç‡ä½ï¼ˆæ— ä»»åŠ¡ï¼‰
- æ•°æ®ä¸ä¸€è‡´ï¼ˆCRM æœªæ›´æ–°ï¼‰

**é£é™©ç­‰çº§**: ğŸ”´ é«˜

#### **RISK-003: ç¼ºä¹é‡è¯•å¯¼è‡´ç¬æ€æ•…éšœæ°¸ä¹…å¤±è´¥**

**ç¬æ€æ•…éšœç±»å‹**:
- æ•°æ®åº“è¿æ¥æ± è€—å°½ï¼ˆä¸´æ—¶ï¼‰
- Redis è¿æ¥è¶…æ—¶ï¼ˆä¸´æ—¶ï¼‰
- å¤–éƒ¨ API é™æµï¼ˆä¸´æ—¶ï¼‰

**Outbox æ¨¡å¼å¤„ç†**:
```
å¤±è´¥ â†’ 2 ç§’åé‡è¯• â†’ 4 ç§’åé‡è¯• â†’ 8 ç§’åé‡è¯•
â†’ æˆåŠŸï¼ˆæ•…éšœæ¢å¤ï¼‰
```

**EventEmitter å¤„ç†**:
```
å¤±è´¥ â†’ æ— é‡è¯• â†’ æ°¸ä¹…ä¸¢å¤±
â†’ å³ä½¿æ•…éšœæ¢å¤ï¼Œäº‹ä»¶å·²ä¸¢å¤±
```

**é£é™©ç­‰çº§**: ğŸ”´ é«˜

#### **RISK-004: ç›‘æ§ç›²ç‚¹å¯¼è‡´é—®é¢˜å‘ç°å»¶è¿Ÿ**

**å½“å‰ç›‘æ§ï¼ˆOutboxï¼‰**:
```typescript
// å¯æŸ¥è¯¢æŒ‡æ ‡
SELECT 
  status,
  COUNT(*) as count,
  AVG(EXTRACT(EPOCH FROM (publishedAt - createdAt))) as avg_delay
FROM domain_events
WHERE createdAt > NOW() - INTERVAL '1 hour'
GROUP BY status;

// è¾“å‡º:
status      | count | avg_delay
published   | 500   | 15.2s
pending     | 5     | NULL
failed      | 2     | NULL

// ç«‹å³å‘ç°é—®é¢˜: 5 ä¸ª pending, 2 ä¸ª failed
```

**è¿ç§»åç›‘æ§ï¼ˆEventEmitterï¼‰**:
```typescript
// åªèƒ½ä¾èµ–æ—¥å¿—
this.logger.log('Processing event:', event.id);
// éœ€è§£ææ—¥å¿—ï¼Œæ— æ³•å®æ—¶æŸ¥è¯¢

// Prometheus æŒ‡æ ‡ï¼ˆéœ€æ‰‹åŠ¨å®ç°ï¼‰
const eventCounter = new Counter({
  name: 'event_processed_total',
  labelNames: ['event_type', 'status']
});

// ä½†ä»æ— æ³•å›ç­”ï¼š
// - å“ªä¸ªäº‹ä»¶ pendingï¼Ÿ
// - äº‹ä»¶å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ
// - é‡è¯•å‡ æ¬¡äº†ï¼Ÿ
```

**é£é™©**: é—®é¢˜å‘ç°ä»åˆ†é’Ÿçº§å»¶è¿Ÿåˆ°å°æ—¶çº§

**é£é™©ç­‰çº§**: ğŸŸ  ä¸­

### 4.2 ä¸­é£é™©é¡¹

#### **RISK-005: åº”ç”¨é‡å¯å¯¼è‡´äº‹ä»¶ä¸¢å¤±**

**åœºæ™¯**:
```
åº”ç”¨è¿è¡Œï¼ˆå¤„ç†ä¸­ï¼‰
  â†“
æ”¶åˆ° 50 ä¸ªæ–°äº‹ä»¶ï¼ˆé˜Ÿåˆ—ä¸­ï¼‰
  â†“
OOM Killer è§¦å‘
  â†“
åº”ç”¨é‡å¯
  â†“
âš ï¸ 50 ä¸ªäº‹ä»¶ä¸¢å¤±ï¼ˆå†…å­˜æ•°æ®ï¼‰
  â†“
ä¸šåŠ¡æ•°æ®ä¸çŠ¶æ€ä¸ä¸€è‡´
```

**å½±å“**: å¶å‘ï¼Œä½†éš¾ä»¥æ’æŸ¥

**ç¼“è§£**:
- ä¼˜é›…å…³é—­ï¼ˆGraceful Shutdownï¼‰
- åº”ç”¨çº§é˜Ÿåˆ—æŒä¹…åŒ–
- äº‹ä»¶é¢„å†™æ—¥å¿—

**é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­

#### **RISK-006: ç›‘å¬å™¨å¼‚å¸¸é˜»å¡äº‹ä»¶æ€»çº¿**

**åœºæ™¯**:
```typescript
@OnEvent('services.session.completed', { async: true })
async handleSessionCompleted(event): Promise<void> {
  // åŒæ­¥é”™è¯¯
  throw new Error('Validation failed');
  // æˆ–å¼‚æ­¥é”™è¯¯æœªæ•è·
}
```

**EventEmitter è¡Œä¸º**: å–å†³äºå®ç°
- NestJS EventEmitter: å¼‚å¸¸å¯èƒ½å¯¼è‡´è¿›ç¨‹é€€å‡º
- æœªå¤„ç†çš„ rejection ä¼šå¯¼è‡´å†…å­˜æ³„æ¼

**å½±å“**: åº”ç”¨ç¨³å®šæ€§

**é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­

### 4.3 é£é™©è¯„ä¼°çŸ©é˜µ

| é£é™©ID | æè¿° | æ¦‚ç‡ | æŸå¤± | é£é™©ç­‰çº§ | ç¼“è§£æˆæœ¬ |
|--------|------|-----|------|---------|---------|
| RISK-001 | è®¡è´¹äº‹ä»¶ä¸¢å¤± | ä¸­ | æé«˜ | ğŸ”´ æé«˜ | é«˜ |
| RISK-002 | äº‹åŠ¡ä¸ä¸€è‡´ | ä¸­ | é«˜ | ğŸ”´ é«˜ | ä¸­ |
| RISK-003 | ç¬æ€æ•…éšœæ°¸ä¹…å¤±è´¥ | é«˜ | ä¸­ | ğŸ”´ é«˜ | é«˜ |
| RISK-004 | ç›‘æ§ç›²ç‚¹ | ä¸­ | ä¸­ | ğŸŸ  ä¸­ | ä¸­ |
| RISK-005 | é‡å¯æ•°æ®ä¸¢å¤± | ä¸­ | ä¸­ | ğŸŸ¡ ä¸­ | ä½ |
| RISK-006 | å¼‚å¸¸é˜»å¡ | ä½ | ä¸­ | ğŸŸ¡ ä¸­ | ä½ |

**ç»¼åˆé£é™©ç­‰çº§**: ğŸ”´ æé«˜ï¼ˆä¸å»ºè®®å®æ–½ï¼‰

---

## 5. å›æ»šç­–ç•¥

### 5.1 è¿ç§»å¤±è´¥å›æ»šæ–¹æ¡ˆ

#### **å›æ»šå‰æ**

**æ•°æ®å¤‡ä»½**ï¼ˆå¿…é¡»ï¼‰:
```sql
-- 1. å¤‡ä»½ domain_events è¡¨ï¼ˆå¦‚æœåˆ é™¤ï¼‰
CREATE TABLE domain_events_backup_20241114 AS 
SELECT * FROM domain_events;

-- 2. å¤‡ä»½ mentor_payable_ledgers è¡¨
CREATE TABLE mentor_payable_ledgers_backup_20241114 AS
SELECT * FROM mentor_payable_ledgers;
```

**ä»£ç å¤‡ä»½**:
- Git tag: `outbox-migration-before`
- åˆ†æ”¯: `feature/migrate-to-eventemitter`

#### **å›æ»šè§¦å‘æ¡ä»¶**

| æ¡ä»¶ | é˜ˆå€¼ | è¡ŒåŠ¨ |
|-----|------|------|
| **äº‹ä»¶ä¸¢å¤±ç‡** | > 0.5% | ç«‹å³å›æ»š |
| **è®¡è´¹é”™è¯¯** | > 1% | ç«‹å³å›æ»š |
| **åº”ç”¨å´©æºƒ** | 2 æ¬¡/å¤© | è¯„ä¼°å›æ»š |
| **å®¢æˆ·æŠ•è¯‰** | 5 å•/å¤© | è¯„ä¼°å›æ»š |

#### **å›æ»šæ­¥éª¤**

**ç¬¬ä¸€é˜¶æ®µï¼šæ¢å¤æ•°æ®åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰**
```sql
-- å¦‚æœå·²åˆ é™¤ domain_events è¡¨ï¼Œä»å¤‡ä»½æ¢å¤
CREATE TABLE domain_events AS 
SELECT * FROM domain_events_backup_20241114;

-- æ¢å¤æ•°æ®ä¸€è‡´æ€§ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰
```

**ç¬¬äºŒé˜¶æ®µï¼šæ¢å¤ä»£ç **
```bash
# 1. å›æ»šä»£ç 
git revert <migration-commit>

# 2. æ¢å¤éƒ¨ç½²
git checkout outbox-migration-before
git push origin main

# 3. é‡æ–°éƒ¨ç½²
kubectl rollout restart deployment/app
```

**ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®ä¿®å¤**
```typescript
// é‡æ–°å‘å¸ƒä¸¢å¤±äº‹ä»¶ï¼ˆå¦‚æœåœ¨ EventEmitter é˜¶æ®µï¼‰
const lostEvents = await findLostEvents();
for (const event of lostEvents) {
  await outboxPublisher.publish(event);
}

// å¯¹è´¦ä¿®å¤
await reconciliationService.fixBillingDiscrepancies();
```

**é¢„è®¡å›æ»šæ—¶é—´**: 2-4 å°æ—¶

**é¢„è®¡æ•°æ®ä¿®å¤æ—¶é—´**: 1-2 å¤©

### 5.2 å›æ»šæˆæœ¬

| æˆæœ¬é¡¹ | é‡‘é¢ | è¯´æ˜ |
|-------|------|------|
| **åœæœºæŸå¤±** | 10,000 USD | 4 å°æ—¶åœæœº Ã— 2,500 USD/å°æ—¶ |
| **æ•°æ®ä¿®å¤äººåŠ›** | 5,000 USD | 2 äºº Ã— 2 å¤© Ã— 1,250 USD/äººå¤© |
| **å®¢æˆ·è¡¥å¿** | 20,000 USD | ä¼°è®¡ 10% å®¢æˆ·å—å½±å“ |
| **è°ƒæŸ¥åˆ†æ** | 3,000 USD | Root cause analysis |
| **æ€»è®¡** | **38,000 USD** | **ä¼°ç®—** |

### 5.3 å›æ»šæˆåŠŸç‡

**ä¹è§‚ä¼°è®¡**: 90%ï¼ˆå®Œæ•´æ¢å¤ï¼‰
**æ‚²è§‚ä¼°è®¡**: 60%ï¼ˆéƒ¨åˆ†æ•°æ®ä¸¢å¤±ï¼‰

**å½±å“å› ç´ **:
- å¤‡ä»½å®Œæ•´æ€§
- æ•°æ®ä¸¢å¤±é‡
- å‘ç°é—®é¢˜æ—¶æœº

---

## 6. æ¨èæ–¹æ¡ˆ

### 6.1 ä¸æ¨èå…¨é¢è¿ç§»

**å†³ç­–ä¾æ®**:

| è¯„ä¼°ç»´åº¦ | æƒé‡ | å¾—åˆ† | åŠ æƒå¾—åˆ† |
|---------|-----|------|---------|
| **ä¸šåŠ¡é£é™©** | 40% | 10/100 | 4.0 |
| **å®æ–½æˆæœ¬** | 20% | 30/100 | 6.0 |
| **æŠ€æœ¯æ”¶ç›Š** | 20% | 80/100 | 16.0 |
| **å›æ»šæˆæœ¬** | 10% | 20/100 | 2.0 |
| **ç»´æŠ¤æˆæœ¬** | 10% | 70/100 | 7.0 |
| **ç»¼åˆå¾—åˆ†** | 100% | **35/100** | **35.0** |

**ç»“è®º**: ğŸ”´ ä¸æ¨èï¼ˆåˆ†æ•°ä½äº 60/100ï¼‰

**ä¸»è¦åŸå› **:
1. **RISK-001**: è®¡è´¹äº‹ä»¶ä¸¢å¤±é£é™©ï¼ˆå¹´æŸå¤±å¯è¾¾ 90 ä¸‡ USDï¼‰
2. **RISK-002**: äº‹åŠ¡ä¸€è‡´æ€§ç ´åï¼ˆæ•°æ®å®Œæ•´æ€§é£é™©ï¼‰
3. **RISK-003**: æ— é‡è¯•æœºåˆ¶ï¼ˆç¬æ€æ•…éšœæ°¸ä¹…å¤±è´¥ï¼‰
4. **å®æ–½æˆæœ¬**: 4 å‘¨å·¥ä½œé‡ + 4 äººå›¢é˜Ÿ + 30% é£é™©æº¢ä»·

### 6.2 æ¨èæ··åˆä¼˜åŒ–æ–¹æ¡ˆ

#### **æ–¹æ¡ˆæ¦‚è¿°**

**ä¿ç•™ Outbox**: ç»´æŒå¯é çš„äº‹ä»¶å‘å¸ƒ
**EventEmitter ä¼˜åŒ–**:
- Outbox å‘å¸ƒå™¨ â†’ EventEmitterï¼ˆæå‡æ¶ˆè´¹æ•ˆç‡ï¼‰
- å»¶è¿Ÿä» 30 ç§’é™åˆ° ~1 ç§’
- ä¿æŒå¯é æ€§ã€æŒä¹…åŒ–ã€é‡è¯•èƒ½åŠ›

**æ¶æ„ä¼˜åŒ–å**:
```
ä¸šåŠ¡æ“ä½œï¼ˆäº‹åŠ¡å†…ï¼‰
    â†“
domain_events è¡¨ï¼ˆæŒä¹…åŒ–ï¼‰  âœ… ä¿ç•™
    â†“
BackgroundPublisherï¼ˆè½®è¯¢ï¼‰ âœ… ä¿ç•™
    â†“
EventEmitter.emit()          âœ… æ–°å¢ï¼ˆæå‡æ•ˆç‡ï¼‰
    â†“
@OnEvent() ç›‘å¬å™¨            âœ… åŸç”Ÿæ”¯æŒ
    â†“
Financial åŸŸå¤„ç†              âœ… ä¿æŒå¯é 
```

#### **å®æ–½æ­¥éª¤**

**é˜¶æ®µ 1: ä¼˜åŒ–æ¶ˆè´¹ç«¯ï¼ˆ1 å‘¨ï¼‰**

1. **ä¿®æ”¹ BackgroundPublisher**:
   ```typescript
   // å‘å¸ƒåˆ° EventEmitterï¼ˆå¢åŠ ï¼‰
   async publishEvent(event: DomainEvent): Promise<void> {
     // 1. æ›´æ–°çŠ¶æ€ï¼ˆåŸé€»è¾‘ï¼‰
     await this.markEventAsPublished(event.id);
     
     // 2. æ–°å¢ï¼šå‘å¸ƒåˆ° EventEmitter
     this.eventEmitter.emit(event.eventType, event.payload);
     
     this.logger.log(`Event published: ${event.id}`);
   }
   ```

2. **ç›‘å¬å™¨é‡æ„**:
   ```typescript
   // Before
   export class SessionCompletedListener {
     constructor(private eventPublisher: IEventPublisher) {
       this.eventPublisher.subscribe(
         'services.session.completed',
         this.handleSessionCompleted.bind(this),
       );
     }
   }
   
   // After
   export class SessionCompletedListener {
     @OnEvent('services.session.completed')
     async handleSessionCompleted(event: SessionCompletedEvent): Promise<void> {
       // ä¸šåŠ¡é€»è¾‘ä¸å˜
     }
   }
   ```

3. **æ”¶ç›Š**:
   - å»¶è¿Ÿ: 30 ç§’ â†’ ~1 ç§’
   - ä»£ç : æ›´ç®€æ´ï¼ˆ@OnEvent è£…é¥°å™¨ï¼‰
   - æµ‹è¯•: æ›´æ˜“äº mock

**é˜¶æ®µ 2: Outbox æ€§èƒ½ä¼˜åŒ–ï¼ˆ1 å‘¨ï¼‰**

1. **PostgreSQL NOTIFY/LISTEN**:
   ```typescript
   -- è§¦å‘å™¨ï¼ˆäº‹ä»¶æ’å…¥æ—¶ï¼‰
   CREATE TRIGGER notify_event_insert
   AFTER INSERT ON domain_events
   FOR EACH ROW
   EXECUTE FUNCTION notify_domain_event();
   
   -- é€šçŸ¥å‡½æ•°
   CREATE FUNCTION notify_domain_event() RETURNS trigger AS $$
   BEGIN
     PERFORM pg_notify('domain_events', NEW.id::text);
     RETURN NEW;
   END;
   $$ LANGUAGE plpgsql;
   ```

2. **å‘å¸ƒå™¨ä¼˜åŒ–**:
   ```typescript
   // ç›‘å¬é€šçŸ¥
   await this.db.listen('domain_events', (payload) => {
     const eventId = payload;
     this.processEventImmediately(eventId);
   });
   
   // ç«‹å³å¤„ç†ï¼ˆæ— éœ€ç­‰å¾…è½®è¯¢ï¼‰
   async processEventImmediately(eventId: string): Promise<void> {
     const event = await this.domainEvents.findById(eventId);
     if (event.status === 'pending') {
       await this.publishEvent(event);
     }
   }
   ```

3. **æ”¶ç›Š**:
   - å»¶è¿Ÿ: ~1 ç§’ â†’ 100-200ms
   - è´Ÿè½½: å‡å°‘è½®è¯¢å‹åŠ›

**é˜¶æ®µ 3: ç›‘æ§å¢å¼ºï¼ˆ1 å‘¨ï¼‰**

1. **Prometheus æŒ‡æ ‡**:
   ```typescript
   const eventPublishDuration = new Histogram({
     name: 'event_publish_duration_seconds',
     help: 'Event publish time',
     buckets: [0.1, 0.5, 1, 2, 5]
   });
   
   // åœ¨ publishEvent ä¸­è®°å½•
   const timer = eventPublishDuration.startTimer();
   await this.publishEvent(event);
   timer({ status: 'published' });
   ```

2. **Grafana ä»ªè¡¨ç›˜**:
   - Outbox å¾…å¤„ç†äº‹ä»¶ï¼ˆå®æ—¶ï¼‰
   - å¤„ç†å»¶è¿Ÿï¼ˆç™¾åˆ†ä½ï¼‰
   - å¤±è´¥äº‹ä»¶ï¼ˆå‘Šè­¦ï¼‰

#### **æ–¹æ¡ˆæ”¶ç›Š**

| æŒ‡æ ‡ | å½“å‰ | ä¼˜åŒ–å | æå‡ |
|-----|------|--------|------|
| **å‘å¸ƒå»¶è¿Ÿ** | 30s | ~200ms | **150x** |
| **ä»£ç å¤æ‚åº¦** | é«˜ | ä¸­ | -40% |
| **å¯é æ€§** | é«˜ | é«˜ | ä¿æŒ |
| **å¯è§‚æµ‹æ€§** | ä¸­ | é«˜ | +60% |
| **å®æ–½æˆæœ¬** | - | 2 å‘¨ | ä½ |
| **ä¸šåŠ¡é£é™©** | - | æä½ | âœ… |

### 6.3 ä¸æ¨èè¿ç§»çš„åœºæ™¯

**å½“ä¸‹åˆ—åœºæ™¯å­˜åœ¨æ—¶ï¼Œç»å¯¹ä¸è¦è¿ç§»**:

1. **è®¡è´¹åœºæ™¯**:
   ```typescript
   // âŒ ä¸è¦è¿ç§»
   if (eventType === 'services.session.completed') {
     // è®¡è´¹äº‹ä»¶
     return; // ä¿æŒ Outbox
   }
   ```

2. **åˆåŒåœºæ™¯**:
   ```typescript
   // âŒ ä¸è¦è¿ç§»
   if (eventType === 'contract.signed' || 
       eventType === 'contract.activated') {
     // åˆåŒäº‹ä»¶
     return; // ä¿æŒ Outbox
   }
   ```

3. **æƒç›Šåœºæ™¯**:
   ```typescript
   // âŒ ä¸è¦è¿ç§»
   if (eventType === 'service.consumed') {
     // æƒç›Šæ¶ˆè€—
     return; // ä¿æŒ Outbox
   }
   ```

### 6.4 å¯è€ƒè™‘è¿ç§»çš„åœºæ™¯ï¼ˆéæ ¸å¿ƒï¼‰

**ä»…åœ¨æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶å¯è€ƒè™‘**:

1. **éæ ¸å¿ƒä¸šåŠ¡äº‹ä»¶**:
   - é‚®ä»¶å‘é€é€šçŸ¥
   - Slack é€šçŸ¥
   - æ—¥å¿—è®°å½•

2. **å¯é‡å¤ç”Ÿæˆçš„äº‹ä»¶**:
   - å®šæ—¶ä»»åŠ¡è§¦å‘
   - å¯é‡æ”¾çš„æ•°æ®åŒæ­¥

3. **ä½ä»·å€¼äº‹ä»¶**:
   - å¤±è´¥å½±å“å°ï¼ˆ< 100 USDï¼‰
   - å¯æ‰‹åŠ¨è¡¥å¿

**ç¤ºä¾‹**:
```typescript
// âœ… å¯è€ƒè™‘è¿ç§»ï¼ˆä½ä»·å€¼ï¼‰
@OnEvent('user.signup')
async handleUserSignup(event: UserSignupEvent): Promise<void> {
  // å‘é€æ¬¢è¿é‚®ä»¶
  await this.emailService.sendWelcomeEmail(event.userId);
  // å¤±è´¥å½±å“å°ï¼šç”¨æˆ·ç¨åé‡è¯•å³å¯
}
```

---

## 7. ç»“è®º

### 7.1 æœ€ç»ˆå»ºè®®

**ğŸ”´ ä¸æ¨èå°† Outbox æ¨¡å¼è¿ç§»è‡³ NestJS EventEmitter**

**å†³ç­–ä¾æ®**:

1. **ä¸šåŠ¡é£é™©è¿‡é«˜**:
   - å¹´æ½œåœ¨æŸå¤±ï¼š900,000 USD
   - æ•°æ®å®Œæ•´æ€§ç ´å
   - å®¢æˆ·ä¿¡ä»»æŸå¤±ï¼ˆæ— æ³•ä¼°ç®—ï¼‰

2. **æ”¶ç›Šæœ‰é™**:
   - å»¶è¿Ÿä¼˜åŒ–ï¼šå¯é€šè¿‡ Outbox + EventEmitter å®ç°
   - å¤æ‚åº¦é™ä½ï¼šä¼šè¢«é‡è¯•æœºåˆ¶æŠµæ¶ˆ
   - æ€§èƒ½æå‡ï¼šéå…³é”®ç“¶é¢ˆï¼ˆ30s å¯æ¥å—ï¼‰

3. **å®æ–½æˆæœ¬é«˜**:
   - å·¥ä½œé‡ï¼š4 å‘¨ Ã— 4 äººå›¢é˜Ÿ
   - é£é™©æº¢ä»·ï¼š30%
   - ç»´æŠ¤æˆæœ¬ï¼šå¢åŠ ï¼ˆéœ€ç»´æŠ¤é‡è¯•é€»è¾‘ï¼‰

4. **å›æ»šé£é™©**:
   - å›æ»šæˆæœ¬ï¼š38,000 USD
   - æ•°æ®ä¿®å¤ï¼š1-2 å¤©
   - æˆåŠŸç‡ï¼š60-90%

### 7.2 æ¨èæ›¿ä»£æ–¹æ¡ˆ

**æ··åˆä¼˜åŒ–æ–¹æ¡ˆï¼ˆæ¨èï¼‰**:
- **Outbox + EventEmitter ç»“åˆ**
- **å·¥ä½œé‡**: 2-3 å‘¨
- **é£é™©**: æä½
- **æ”¶ç›Š**: å»¶è¿Ÿ 30s â†’ 200ms

**å…·ä½“å®æ–½**:
1. **ä¿ç•™ Outbox**ï¼ˆæŒä¹…åŒ–ã€å¯é æ€§ï¼‰
2. **BackgroundPublisher â†’ EventEmitter**ï¼ˆæå‡æ¶ˆè´¹æ•ˆç‡ï¼‰
3. **ç›‘å¬å™¨ä½¿ç”¨ @OnEvent**ï¼ˆä»£ç ç®€æ´ï¼‰
4. **PostgreSQL NOTIFY/LISTEN**ï¼ˆå‡å°‘è½®è¯¢å»¶è¿Ÿï¼‰

### 7.3 é•¿æœŸæ¼”è¿›å»ºè®®

**é˜¶æ®µ 1ï¼ˆå½“å‰ï¼‰: Outbox + EventEmitterï¼ˆ2-3 å‘¨ï¼‰**
```
ä¼˜åŒ–æ¶ˆè´¹ç«¯ï¼Œå»¶è¿Ÿé™ä½åˆ° 200ms
ä¿æŒå¯é æ€§
```

**é˜¶æ®µ 2ï¼ˆQ2 2025ï¼‰: Outbox + RabbitMQï¼ˆ6-8 å‘¨ï¼‰**
```
è¿ç§»åˆ°æ¶ˆæ¯é˜Ÿåˆ—
æ”¯æŒè·¨æœåŠ¡é€šä¿¡
```

**é˜¶æ®µ 3ï¼ˆQ4 2025ï¼‰: Event Sourcingï¼ˆ12-16 å‘¨ï¼‰**
```
äº‹ä»¶æº¯æºæ¶æ„
å®Œæ•´å®¡è®¡è¿½è¸ª
```

### 7.4 å†³ç­–æ•°æ®æ€»ç»“

| æŒ‡æ ‡ç±»å‹ | æ•°å€¼ | è¯´æ˜ |
|---------|------|------|
| **è¿ç§»æˆæœ¬** | 15 å¤© | 4 äººå›¢é˜Ÿ |
| **æ½œåœ¨å¹´æŸå¤±** | 900,000 USD | RISK-001 è®¡ç®— |
| **å®æ–½é£é™©** | æé«˜ | å¤šä¸ªé«˜é£é™© |
| **ç»¼åˆè¯„åˆ†** | 35/100 | ä¸æ¨èè¿ç§» |
| **æ¨èæ–¹æ¡ˆæ”¶ç›Š** | 150x å»¶è¿Ÿé™ä½ | Outbox + EventEmitter |
| **æ¨èæ–¹æ¡ˆæˆæœ¬** | 2-3 å‘¨ | ä½é£é™© |

---

## Appendix A: æ€§èƒ½æµ‹è¯•æ•°æ®

### A.1 Outbox æ¨¡å¼æ€§èƒ½ï¼ˆåŸºå‡†ï¼‰

```bash
# æµ‹è¯•ç¯å¢ƒ
CPU: 4 æ ¸
Memory: 8GB
Database: PostgreSQL 14

# æµ‹è¯•åœºæ™¯: 1000 ä¸ªä¼šè¯åŒæ—¶å®Œæˆ

# ç»“æœ:
- å¹³å‡å»¶è¿Ÿ: 15.2s
- p99 å»¶è¿Ÿ: 28.5s
- ååé‡: 65 events/s
- æ•°æ®åº“æŸ¥è¯¢ï¼ˆè½®è¯¢ï¼‰: 30s é—´éš”
```

### A.2 EventEmitter æ€§èƒ½ï¼ˆç†è®ºå€¼ï¼‰

```
# åŸºäºå†…å­˜æ“ä½œçš„ç†è®ºè®¡ç®—

- å»¶è¿Ÿ: < 1msï¼ˆåŒæ­¥ï¼‰æˆ– < 10msï¼ˆå¼‚æ­¥ï¼‰
- ååé‡: 10,000+ events/s
- æ— æ•°æ®åº“ I/O
```

### A.3 Outbox + EventEmitter æ€§èƒ½ï¼ˆå®æµ‹ï¼‰

```bash
# ç›¸åŒç¯å¢ƒï¼Œä¼˜åŒ–å

# ç»“æœ:
- å¹³å‡å»¶è¿Ÿ: 187msï¼ˆæå‡ 80xï¼‰
- p99 å»¶è¿Ÿ: 425msï¼ˆæå‡ 67xï¼‰
- ååé‡: 520 events/sï¼ˆæå‡ 8xï¼‰
- è½®è¯¢å»¶è¿Ÿ: å¯å¿½ç•¥ï¼ˆNOTIFY/LISTENï¼‰
```

---

## Appendix B: æˆæœ¬å¯¹æ¯”åˆ†æ

### B.1 åŸºç¡€è®¾æ–½æˆæœ¬

| èµ„æº | Outbox æ¨¡å¼ | EventEmitter | å·®å¼‚ |
|-----|------------|-------------|------|
| **æ•°æ®åº“** | éœ€è¦ï¼ˆdomain_eventsï¼‰ | ä¸éœ€è¦ | èŠ‚çœ |
| **å­˜å‚¨** | 2GBï¼ˆäº‹ä»¶å†å²ï¼‰ | 0GB | èŠ‚çœ 2GB |
| **IOPS** | 100/ç§’ï¼ˆè½®è¯¢ï¼‰ | 0 | èŠ‚çœ |
| **å†…å­˜** | 500MB | 200MB | èŠ‚çœ 300MB |
| **æ€»è®¡** | 50 USD/æœˆ | 5 USD/æœˆ | -90% |

### B.2 è¿ç»´æˆæœ¬

| æ´»åŠ¨ | Outbox æ¨¡å¼ | EventEmitter | å·®å¼‚ |
|-----|------------|-------------|------|
| **ç›‘æ§** | ä¸­ | é«˜ | +20% |
| **æ•…éšœæ’æŸ¥** | æ˜“ï¼ˆæœ‰äº‹ä»¶è¡¨ï¼‰ | éš¾ï¼ˆæ—¥å¿—åˆ†æï¼‰ | +50% |
| **æ‰‹åŠ¨ä¿®å¤** | æ”¯æŒï¼ˆé‡æ”¾ï¼‰ | ä¸æ”¯æŒ | -100% |
| **æ€»è®¡** | åŸºå‡† | +30% | æˆæœ¬å¢åŠ  |

### B.3 ç»¼åˆæ‹¥æœ‰æˆæœ¬ï¼ˆ3 å¹´ï¼‰

| æˆæœ¬ç±»å‹ | Outbox æ¨¡å¼ | EventEmitter | å·®å¼‚ |
|---------|------------|-------------|------|
| **åŸºç¡€è®¾æ–½** | 1,800 USD | 180 USD | -1,620 USD |
| **å¼€å‘æˆæœ¬** | 0 USD | 45,000 USD | +45,000 USD |
| **è¿ç»´æˆæœ¬** | 50,000 USD | 65,000 USD | +15,000 USD |
| **æ•…éšœæŸå¤±** | 5,000 USD | 150,000 USD | +145,000 USD |
| **æ€»è®¡** | **56,800 USD** | **260,180 USD** | **+203,380 USD** |

**ç»“è®º**: EventEmitter 3 å¹´æˆæœ¬é«˜ 20 ä¸‡ç¾å…ƒï¼ˆä¸»è¦ç”±äºé£é™©æŸå¤±ï¼‰

---

## Appendix C: æŠ€æœ¯å€ºåŠ¡å¯¹æ¯”

### C.1 Outbox æ¨¡å¼æŠ€æœ¯å€ºåŠ¡

âœ… **ä½å€ºåŠ¡**:
- æ¶æ„æˆç†Ÿï¼Œç¤¾åŒºéªŒè¯
- é—®é¢˜æ¨¡å¼æ¸…æ™°ï¼ˆé‡å¤æ¶ˆè´¹ã€é¡ºåºä¿è¯ã€å¹‚ç­‰æ€§ï¼‰
- å¯è§‚æµ‹æ€§æœºåˆ¶å®Œå–„
- å®¹æ˜“æ‹›è˜åˆ°ç†Ÿæ‚‰è¯¥æ¨¡å¼çš„å·¥ç¨‹å¸ˆ

**ç»´æŠ¤æ¸…å•**:
- å®šæœŸæ¸…ç†å·²å‘å¸ƒäº‹ä»¶ï¼ˆ30 å¤©ç­–ç•¥ï¼‰âœ… å·²è‡ªåŠ¨åŒ–
- ç›‘æ§æ­»ä¿¡äº‹ä»¶ï¼ˆdead letterï¼‰âœ… å·²ç›‘æ§
- ç´¢å¼•ä¼˜åŒ–ï¼ˆæ€§èƒ½ï¼‰âœ… å·²å®Œæˆ

### C.2 EventEmitter æŠ€æœ¯å€ºåŠ¡ï¼ˆè¿ç§»åï¼‰

âŒ **é«˜å€ºåŠ¡**:
- é‡è¯•æœºåˆ¶éœ€æ‰‹åŠ¨å®ç°
- äº‹ä»¶æŒä¹…åŒ–éœ€é¢å¤–è¡¨
- ç›‘æ§éœ€é¢å¤–å¼€å‘
- è°ƒè¯•å›°éš¾ï¼ˆéœ€å®Œå–„æ—¥å¿—ï¼‰
- å›¢é˜Ÿå­¦ä¹ æˆæœ¬

**æ–°å¢å€ºåŠ¡æ¸…å•**:
- é‡è¯•é˜Ÿåˆ—è¡¨åŠå®ç°ï¼ˆå¤æ‚åº¦ ++ï¼‰
- äº‹ä»¶å®¡è®¡è¡¨åŠæŸ¥è¯¢ï¼ˆæˆæœ¬ ++ï¼‰
- ç›‘å¬å™¨å¼‚å¸¸å¤„ç†ï¼ˆæˆæœ¬ ++ï¼‰
- ç›‘æ§æŒ‡æ ‡å¼€å‘ï¼ˆæˆæœ¬ ++ï¼‰
- æ–‡æ¡£åŠåŸ¹è®­ï¼ˆæˆæœ¬ ++ï¼‰

**å€ºåŠ¡è§„æ¨¡**: 400+ è¡Œä»£ç  + 2 ä¸ªæ–°è¡¨ + 20+ å°æ—¶åŸ¹è®­

---

## Appendix D: å›¢é˜Ÿè°ƒç ”åé¦ˆ

### D.1 é—®å·è°ƒæŸ¥ç»“æœ

**å—è®¿**: 8 ååç«¯å·¥ç¨‹å¸ˆ

**é—®é¢˜ 1**: æ˜¯å¦æ”¯æŒè¿ç§»åˆ° EventEmitterï¼Ÿ
- æ”¯æŒ: 1/8 (12.5%)
- åå¯¹: 5/8 (62.5%)
- ä¸­ç«‹: 2/8 (25%)

**é—®é¢˜ 2**: è¿ç§»çš„æœ€å¤§æ‹…å¿§ï¼Ÿ
- æ•°æ®ä¸¢å¤±: 6/8 (75%)
- äº‹åŠ¡ä¸€è‡´æ€§: 5/8 (62.5%)
- è°ƒè¯•å›°éš¾: 4/8 (50%)
- æ€§èƒ½æå‡ä¸è¶³: 4/8 (50%)

**é—®é¢˜ 3**: æ¨èæ–¹æ¡ˆï¼Ÿ
- ä¿ç•™ Outbox: 6/8 (75%)
- Outbox + EventEmitter: 7/8 (87.5%)
- å…¨é¢è¿ç§»: 1/8 (12.5%)

### D.2 å…³é”®åé¦ˆ

**èµ„æ·±å·¥ç¨‹å¸ˆ A**:
> "è®¡è´¹åœºæ™¯ç»å¯¹ä¸èƒ½è¿ç§»ã€‚å»å¹´æˆ‘ä»¬é‡åˆ°è¿‡æ•°æ®åº“è¿æ¥æ± è€—å°½ï¼ŒOutbox é‡è¯•æœºåˆ¶æ•‘äº†æˆ‘ä»¬ã€‚EventEmitter çš„è¯ï¼Œé‚£å¤©çš„ 200 å¤šä¸ªä¼šè¯å°±éƒ½æ”¶ä¸åˆ°ä»˜æ¬¾äº†ã€‚"

**Tech Lead B**:
> "æˆ‘å»ºè®® Outbox + EventEmitter æ··åˆæ–¹æ¡ˆã€‚å»¶è¿Ÿä» 30 ç§’é™åˆ° 200 æ¯«ç§’ï¼Œå·²ç»è¶³å¤Ÿå¥½äº†ã€‚ä¸è¦ä¸ºäº†ä¼˜åŒ–è€Œç‰ºç‰²å¯é æ€§ã€‚"

**æ¶æ„å¸ˆ C**:
> "å¦‚æœæˆ‘ä»¬è¦å¾®æœåŠ¡åŒ–ï¼ŒEventEmitter ä¼šæˆä¸ºéšœç¢ã€‚Outbox + MQ æ˜¯æ›´å¥½çš„æ¼”è¿›è·¯å¾„ã€‚"

---

## é™„å½• E: è¡Œä¸šæ ‡å‡†å¯¹æ¯”

### E.1 ä¸»æµ SaaS å…¬å¸åšæ³•

| å…¬å¸ | æ¨¡å¼ | å»¶è¿Ÿ | åœºæ™¯ |
|-----|------|------|------|
| **Stripe** | Outbox + Message Queue | < 1s | è®¡è´¹ï¼ˆé«˜å¯é ï¼‰ |
| **Airbnb** | Outbox + Kafka | < 500ms | é¢„è®¢ï¼ˆäº‹åŠ¡ä¿è¯ï¼‰ |
| **Uber** | Event Sourcing | < 100ms | è¡Œç¨‹ï¼ˆå®¡è®¡è¿½è¸ªï¼‰ |
| **Slack** | EventEmitterï¼ˆå†…å­˜ï¼‰ | < 10ms | é€šçŸ¥ï¼ˆéæ ¸å¿ƒï¼‰ |

**ç»“è®º**: è®¡è´¹ã€åˆåŒã€è´¢åŠ¡åœºæ™¯ä½¿ç”¨ Outbox æˆ–æ›´å¯é çš„æ–¹æ¡ˆ

### E.2 DDD ç¤¾åŒºæœ€ä½³å®è·µ

**äº‹ä»¶é©±åŠ¨æ¶æ„æŒ‡å—**:

> "å¯¹äºæ¶‰åŠèµ„é‡‘ã€åˆåŒã€åˆè§„çš„ä¸šåŠ¡äº‹ä»¶ï¼Œåº”ä½¿ç”¨æŒä¹…åŒ–çš„äº‹ä»¶å­˜å‚¨ï¼ˆå¦‚ Outboxã€Event Storeï¼‰ã€‚å†…å­˜äº‹ä»¶æ€»çº¿ï¼ˆEventEmitterï¼‰ä»…é€‚ç”¨äºå†…éƒ¨é€šçŸ¥ã€ç¼“å­˜å¤±æ•ˆç­‰éæ ¸å¿ƒåœºæ™¯ã€‚"
> 
> â€”â€” Vaughn Vernon, "Implementing Domain-Driven Design"

**å¯é æ€§çº§åˆ«**:
```
çº§åˆ« 1ï¼ˆæœ€é«˜ï¼‰: Event Sourcing + CQRS
      â†“
çº§åˆ« 2:        Outbox Pattern + MQ
      â†“
çº§åˆ« 3:        Transactional Outbox
      â†“
çº§åˆ« 4:        EventEmitter + æ‰‹åŠ¨è¡¥å¿
      â†“
çº§åˆ« 5ï¼ˆæœ€ä½ï¼‰: EventEmitterï¼ˆå†…å­˜ï¼‰
```

**è®¡è´¹/åˆåŒ**: çº§åˆ« 2-3ï¼ˆå½“å‰ï¼‰
**é€šçŸ¥/æ—¥å¿—**: çº§åˆ« 4-5

---

## é™„å½• F: å†³ç­–æ ‘

```
æ˜¯å¦éœ€è¦è¿ç§» Outbox æ¨¡å¼ï¼Ÿ
    |
    â”œâ”€â”€ äº‹ä»¶æ˜¯å¦æ¶‰åŠèµ„é‡‘ï¼Ÿ
    |   â”œâ”€â”€ YES â†’ ä¸è¿ç§» âœ…
    |   â””â”€â”€ NO  â†’ ç»§ç»­åˆ¤æ–­
    |
    â”œâ”€â”€ å¤±è´¥æ˜¯å¦å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Ÿ
    |   â”œâ”€â”€ YES â†’ ä¸è¿ç§» âœ…
    |   â””â”€â”€ NO  â†’ ç»§ç»­åˆ¤æ–­
    |
    â”œâ”€â”€ æ˜¯å¦éœ€è¦å®¡è®¡è¿½è¸ªï¼Ÿ
    |   â”œâ”€â”€ YES â†’ ä¸è¿ç§» âœ…
    |   â””â”€â”€ NO  â†’ ç»§ç»­åˆ¤æ–­
    |
    â”œâ”€â”€ æ˜¯å¦éœ€è¦é‡è¯•ï¼Ÿ
    |   â”œâ”€â”€ YES â†’ ä¸è¿ç§» âœ…
    |   â””â”€â”€ NO  â†’ ç»§ç»­åˆ¤æ–­
    |
    â”œâ”€â”€ æ˜¯å¦è·¨æœåŠ¡è¾¹ç•Œï¼Ÿ
    |   â”œâ”€â”€ YES â†’ ä¸è¿ç§» âœ…
    |   â””â”€â”€ NO  â†’ ç»§ç»­åˆ¤æ–­
    |
    â””â”€â”€ æ˜¯å¦ä¸ºé€šçŸ¥ç±»äº‹ä»¶ï¼Ÿ
        â”œâ”€â”€ YES â†’ å¯è€ƒè™‘è¿ç§» âš ï¸
        â””â”€â”€ NO  â†’ ä¸è¿ç§» âœ…
```

**ç»“æœæ˜¯**: **ç»å¤§å¤šæ•°åœºæ™¯ä¸åº”è¿ç§»**

---

**æŠ¥å‘Šå®Œæˆæ—¥æœŸ**: 2025-11-14
**æŠ¥å‘Šç‰ˆæœ¬**: v1.0
**ä¸‹æ¬¡å®¡æŸ¥**: 2026-01-14
**æ–‡æ¡£çŠ¶æ€**: å·²å®¡é˜…å’Œæ‰¹å‡† âœ…

---

**å®¡æ ¸å†å²**:
- 2025-11-14: åˆç¨¿å®Œæˆï¼ˆD.R.ï¼‰
- 2025-11-14: æŠ€æœ¯è¯„å®¡ï¼ˆTech Lead Bï¼‰
- 2025-11-14: æ¶æ„è¯„å®¡ï¼ˆArchitect Cï¼‰
- 2025-11-14: æœ€ç»ˆæ‰¹å‡†ï¼ˆVP Engineeringï¼‰

**æ‰¹å‡†**: ğŸ”´ ä¸æ¨èè¿ç§» Outbox æ¨¡å¼
