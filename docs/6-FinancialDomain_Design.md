# Financial Domain (è´¢åŠ¡åŸŸ) è¯¦ç»†è®¾è®¡æ–‡æ¡£

> ç‰ˆæœ¬ï¼šv2.21
> æœ€åæ›´æ–°ï¼š2025-11-12
> çŠ¶æ€ï¼šè®¾è®¡å®Œæˆ
> è´Ÿè´£åŸŸï¼š**Financial Domain** (AR + APï¼šStudent Account, Payment, Mentor Billing, Settlement)

---

## ğŸ“‹ æ–‡æ¡£ç›®å½•

1. [åŸŸèŒè´£ä¸æ¶æ„](#1-åŸŸèŒè´£ä¸æ¶æ„)
2. [æ ¸å¿ƒæ•°æ®æ¨¡å‹](#2-æ ¸å¿ƒæ•°æ®æ¨¡å‹)
3. [æœåŠ¡æ¥å£æ¸…å•](#3-æœåŠ¡æ¥å£æ¸…å•)
4. [äº‹ä»¶é©±åŠ¨è®¾è®¡](#4-äº‹ä»¶é©±åŠ¨è®¾è®¡)
5. [ä¸šåŠ¡æµç¨‹](#5-ä¸šåŠ¡æµç¨‹)
6. [é™„å½•](#6-é™„å½•)

---

## 1. åŸŸèŒè´£ä¸æ¶æ„

### 1.1 åŸŸèŒè´£åˆ’åˆ†

Financial Domain æ˜¯ç»Ÿä¸€è´¢åŠ¡ç®¡ç†åŸŸï¼Œè´Ÿè´£å¹³å°æ‰€æœ‰è´¢åŠ¡å¾€æ¥ï¼ˆå­¦ç”Ÿä»˜æ¬¾ + å¯¼å¸ˆç»“ç®—ï¼‰ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Financial Domain èŒè´£                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Students (AR)   â”‚  â”‚  Mentors (AP)    â”‚  â”‚   Management     â”‚
â”‚  å­¦ç”Ÿåº”æ”¶ç®¡ç†     â”‚  â”‚  å¯¼å¸ˆåº”ä»˜ç®¡ç†     â”‚  â”‚    ç®¡ç†æ¨¡å—       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚
â”‚ ğŸŸ¢ Payment       â”‚  â”‚ ğŸ”´ Billing       â”‚  â”‚ ğŸ“Š Stats         â”‚
â”‚   å­¦ç”Ÿæ”¯ä»˜æœåŠ¡    â”‚  â”‚   å¯¼å¸ˆè®¡è´¹æœåŠ¡    â”‚  â”‚   è®¡è´¹ç»Ÿè®¡        â”‚
â”‚   Â· Payment      â”‚  â”‚   Â· Ledger       â”‚  â”‚                  â”‚
â”‚     Service      â”‚  â”‚   Â· Pricing      â”‚  â”‚                  â”‚
â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚
â”‚ ğŸ”µ Student       â”‚  â”‚ ğŸ”´ Settlement    â”‚  â”‚                  â”‚
â”‚   Payment        â”‚  â”‚   å¯¼å¸ˆç»“ç®—æœåŠ¡    â”‚  â”‚                  â”‚
â”‚   Ledger         â”‚  â”‚   Â· Settlement   â”‚  â”‚                  â”‚
â”‚   å­¦ç”Ÿæ”¯ä»˜æµæ°´    â”‚  â”‚   Â· Parameters   â”‚  â”‚                  â”‚
â”‚   Â· balanceAfter â”‚  â”‚   Â· Appeals      â”‚  â”‚                  â”‚
â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒæ•°æ®å½’å±

| æ•°æ®å®ä½“ | ä»£ç è·¯å¾„ | èŒè´£è¯´æ˜ |
|---------|---------|---------|
| **student_payment_ledgers** | `@domains/financial/payment` | å­¦ç”Ÿæ”¯ä»˜æµæ°´ï¼ˆè´¢åŠ¡ç¡®è®¤æ¨¡å¼ï¼Œå«balanceAfterä½™é¢å¿«ç…§ï¼‰â—ç”¨æˆ·æ”¯ä»˜ä¸å¯¼å¸ˆæ¿€åŠ±æ˜¯ç‹¬ç«‹çš„è´¢åŠ¡æµ |
| **mentor_payable_ledgers** | `@domains/financial/mentor-billing` | å¯¼å¸ˆåº”ä»˜è´¦æ¬¾æµæ°´ï¼ˆAppend-onlyï¼Œæ”¯æŒè´Ÿæ•°è°ƒæ•´ï¼Œä½œä¸ºå¹³å°çš„æˆæœ¬ï¼‰ |
| **mentor_prices** | `@domains/financial/mentor-billing` | å¯¼å¸ˆå®šä»·é…ç½®ï¼ˆæ”¯æŒä¸€å¯¹ä¸€ã€ç­è¯¾ã€é˜¶æ®µæ€§ä¸‰ç§å®šä»·æ¨¡å¼ï¼‰ |
| **settlement_ledgers** | `@domains/financial/settlement` | å¯¼å¸ˆç»“ç®—è®°å½•ï¼ˆå«ç»“ç®—æ–¹å¼å’Œæ‰‹ç»­è´¹ï¼Œä¿å­˜å®Œæ•´å‚æ•°å¿«ç…§ï¼‰ |
| **settlement_parameters** | `@domains/financial/settlement` | ç»“ç®—å‚æ•°ï¼ˆæ±‡ç‡ã€æ‰£é™¤ã€æ‰‹ç»­è´¹ç‡ï¼Œæ”¯æŒæ¯æœˆå¤šç‰ˆæœ¬ï¼‰ |
| **settlement_appeals** | `@domains/financial/settlement` | ç»“ç®—ç”³è¯‰ï¼ˆå¼‚è®®å¤„ç†ï¼‰ |

**ğŸ’¡ è´¢åŠ¡æµç‹¬ç«‹æ€§è¯´æ˜ï¼ˆ2025-11-12 å†³ç­–ï¼‰ï¼š**
- **å­¦ç”Ÿ â†’ å¹³å°**ï¼šæŒ‰åˆåŒé‡‘é¢æ”¯ä»˜ï¼ˆæ”¶å…¥ï¼‰ï¼Œå­˜å‚¨åœ¨ `student_payment_ledgers`
- **å¹³å° â†’ å¯¼å¸ˆ**ï¼šæŒ‰ `mentor_prices` æ”¯ä»˜æ¿€åŠ±ï¼ˆæˆæœ¬ï¼‰ï¼Œå­˜å‚¨åœ¨ `mentor_payable_ledgers`
- è¿™æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„è´¢åŠ¡æµï¼Œå¹³å°é€šè¿‡å®šä»·å·®å¼‚è·å–åˆ©æ¶¦ï¼Œæ— éœ€è®°å½•å·®é¢

### 1.3 è·¨åŸŸåä½œæ¨¡å¼


#### 1.3.1 äº‹ä»¶é©±åŠ¨åä½œ

**Contract â†’ Financial** (æ”¯ä»˜è§¦å‘åˆåŒæ¿€æ´»)
```
Contract Domain
    â”‚
    â”‚ å‘å¸ƒäº‹ä»¶: payment.succeeded
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
    â”‚                                      Financial Domain
    â”‚                                      ç›‘å¬å™¨å¤„ç†
    â”‚                                      åˆ›å»ºæ”¶å…¥è®°å½•
```

**Financial (Settlement) â†’ Financial (Billing)** (ç»“ç®—å®Œæˆæ›´æ–°çŠ¶æ€)
```
Settlement Service
    â”‚
    â”‚ å‘å¸ƒäº‹ä»¶: settlement.completed
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
    â”‚                                      Billing Service
    â”‚                                      ç›‘å¬å™¨å¤„ç†
    â”‚                                      æ›´æ–° mentor_payable_ledgers.settlement_status
```

---

## 2. æ ¸å¿ƒæ•°æ®æ¨¡å‹

### 2.1 mentor_payable_ledgers (å¯¼å¸ˆåº”ä»˜è´¦æ¬¾æµæ°´è¡¨)

**æ–‡ä»¶è·¯å¾„ï¼š** `src/infrastructure/database/schema/mentor-payable-ledgers.schema.ts`

**åŸŸå½’å±ï¼š** Financial Domain

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- **Append-only æ¨¡å¼**ï¼šåªèƒ½ INSERTï¼Œç¦æ­¢ UPDATE/DELETE
- æ”¯æŒè´Ÿæ•°è°ƒæ•´ï¼šå¤„ç† appeal ç”³è¯‰æ—¶ï¼Œå¯åˆ›å»ºé‡‘é¢ä¸ºè´Ÿæ•°çš„è®°å½•è°ƒæ•´åº”ä»˜é‡‘é¢
- ä»…è®°å½•å¯¼å¸ˆæœåŠ¡å’Œè®¡è´¹ï¼ˆé¡¾é—®ä¸å‚ä¸æ”¶ç›Šåˆ†é…ï¼‰
- **æ”¯æŒä¸¤ç§æœåŠ¡ç±»å‹**ï¼š1å¯¹1æœåŠ¡ï¼ˆå…³è” sessionï¼‰å’Œç­è¯¾æœåŠ¡ï¼ˆå…³è” classï¼‰

**ğŸ’¡ å¤šæœåŠ¡æ¨¡å¼æ”¯æŒï¼ˆ2025-11-12 æ–°å¢ï¼‰ï¼š**
- **1å¯¹1æœåŠ¡**ï¼šä½¿ç”¨ `sessionId` å­—æ®µï¼Œå…³è” Services Domain çš„ sessions è¡¨
- **ç­è¯¾æœåŠ¡**ï¼šä½¿ç”¨ `classId` å­—æ®µï¼Œå…³è” Services Domain çš„ classes è¡¨
- **äº’æ–¥çº¦æŸ**ï¼š`sessionId` å’Œ `classId` åªèƒ½æœ‰ä¸€ä¸ªæœ‰å€¼ï¼ˆåº”ç”¨å±‚ä¿è¯ï¼‰
- **æŸ¥è¯¢æ–¹å¼ä¸åŒ**ï¼š1å¯¹1æŒ‰ `studentId` æŸ¥è¯¢ï¼Œç­è¯¾æŒ‰ `classId` æŸ¥è¯¢

```typescript
export const mentorPayableLedgers = pgTable('mentor_payable_ledgers', {
  id: uuid('id').defaultRandom().primaryKey(),

  // æ–°å¢ï¼šç­è¯¾å…³è”ï¼ˆè·¨åŸŸå¼•ç”¨ Services Domainï¼Œæ³¨é‡Šå¤–é”®ï¼Œ2025-11-12ï¼‰
  // ä¸ sessionId äº’æ–¥ï¼šç­è¯¾æœåŠ¡ä½¿ç”¨ classIdï¼Œ1å¯¹1æœåŠ¡ä½¿ç”¨ sessionId
  classId: uuid('class_id'), // æ³¨é‡Šå¤–é”®ï¼šå…³è” Services Domain çš„ classes è¡¨

  // åŸæœ‰ï¼š1å¯¹1æœåŠ¡å…³è”
  sessionId: uuid('session_id'), // æ³¨é‡Šå¤–é”®ï¼šå…³è” Services Domain çš„ sessions è¡¨

  mentorId: uuid('mentor_id').notNull().references(() => users.id),
  studentId: uuid('student_id').notNull().references(() => users.id),

  // æœåŠ¡ä¿¡æ¯
  serviceType: serviceTypeEnum('service_type').notNull(),
  serviceName: varchar('service_name', { length: 500 }),

  // è®¡è´¹ä¿¡æ¯
  quantity: integer('quantity').notNull().default(1), // æœåŠ¡æ•°é‡ï¼ˆæ”¯æŒè´Ÿæ•°è°ƒæ•´ï¼‰
  adjustmentReason: varchar('adjustment_reason', { length: 500 }), // quantityä¸ºè´Ÿæ•°æ—¶å¿…å¡«

  // é‡‘é¢å­—æ®µï¼ˆéµå¾ªç²¾åº¦è§„èŒƒï¼‰
  unitPrice: numeric('unit_price', { precision: 12, scale: 1 }).notNull(), // å•ä»·ä¿ç•™1ä½å°æ•°
  totalAmount: numeric('total_amount', { precision: 12, scale: 2 }).notNull(), // æ€»é¢ä¿ç•™2ä½å°æ•°
  currency: varchar('currency', { length: 3 }).notNull().default('USD'),

  // é˜¶æ®µæ€§è®¡è´¹ï¼ˆå¦‚å†…æ¨ï¼‰
  stageName: varchar('stage_name', { length: 200 }), // é˜¶æ®µåç§°

  // æœåŠ¡çŠ¶æ€
  status: serviceStatusEnum('status').notNull().default('pending'),

  // ç»“ç®—çŠ¶æ€ï¼ˆv2.18æ›´æ–°ï¼‰
  settlementStatus: settlementStatusEnum('settlement_status').notNull().default('pending'),
  settledAt: timestamp('settled_at', { withTimezone: true }),
  settlementId: uuid('settlement_id').references(() => settlement_ledgers.id),

  // æ—¶é—´
  serviceCompletedAt: timestamp('service_completed_at', { withTimezone: true }).notNull(),

  // å¤‡æ³¨
  notes: text('notes'),
  metadata: json('metadata'),

  // å®¡è®¡å­—æ®µï¼ˆAppend-only: æ— éœ€ updatedAtï¼‰
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  createdBy: uuid('created_by').references(() => users.id),
});
```

**å­—æ®µè¯´æ˜ï¼š**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| `quantity` | integer | æœåŠ¡æ•°é‡ï¼ˆæ­£æ•°=æ­£å¸¸æœåŠ¡ï¼Œè´Ÿæ•°=ç”³è¯‰è°ƒæ•´ï¼‰ |
| `unitPrice` | numeric(12,1) | å•ä»·ï¼ˆç¾å…ƒï¼Œä¿ç•™1ä½å°æ•°ï¼‰ |
| `totalAmount` | numeric(12,2) | æ€»é¢ï¼ˆç¾å…ƒï¼Œç²¾ç¡®åˆ°åˆ†ï¼‰ |
| `settlementStatus` | enum | pending/processing/settled/on_hold/failed |
| `adjustmentReason` | varchar | è°ƒæ•´åŸå› ï¼ˆquantityä¸ºè´Ÿæ—¶å¿…å¡«ï¼‰ |

**ä½¿ç”¨åœºæ™¯ï¼š**

1. **æœåŠ¡å®Œæˆååˆ›å»ºè®¡è´¹è®°å½•**
```typescript
// Session å®Œæˆæ—¶è‡ªåŠ¨åˆ›å»º
{
  sessionId: 'session-uuid-1',
  mentorId: 'mentor-uuid-1',
  studentId: 'student-uuid-1',
  serviceType: 'gap_analysis',
  serviceName: 'GAPåˆ†æ',
  quantity: 1,  // æ­£æ•°
  unitPrice: 150.0,  // $150/å°æ—¶
  totalAmount: 150.00,
  status: 'pending',
  settlementStatus: 'pending',
  serviceCompletedAt: new Date('2025-11-10T14:00:00Z'),
}
```

2. **ç”³è¯‰é€šè¿‡ååˆ›å»ºè´Ÿæ•°è°ƒæ•´è®°å½•**
```typescript
// Appeal å®¡æ ¸é€šè¿‡ååˆ›å»º
{
  sessionId: 'session-uuid-1',
  mentorId: 'mentor-uuid-1',
  studentId: 'student-uuid-1',
  serviceType: 'gap_analysis',
  serviceName: 'GAPåˆ†æ',
  quantity: -1,  // è´Ÿæ•°ï¼Œè¡¨ç¤ºæ‰£å‡
  adjustmentReason: 'ç”³è¯‰é€šè¿‡ï¼šæœåŠ¡æœªå®Œæˆï¼Œå…¨é¢é€€æ¬¾',
  unitPrice: 150.0,
  totalAmount: -150.00,  // è´Ÿæ•°é‡‘é¢
  status: 'refunded',
  settlementStatus: 'pending',
  serviceCompletedAt: new Date('2025-11-10T14:00:00Z'),
}
```

### 2.2 student_payment_ledgers (å­¦ç”Ÿæ”¯ä»˜æµæ°´è¡¨)

**æ–‡ä»¶è·¯å¾„ï¼š** `src/infrastructure/database/schema/student-payment-ledgers.schema.ts`

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- **è´¢åŠ¡ç¡®è®¤æ¨¡å¼**ï¼šä¸å¯¹æ¥ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°
- å­¦ç”Ÿåœ¨ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼ˆé“¶è¡Œï¼‰å®Œæˆæ”¯ä»˜
- è´¢åŠ¡åœ¨ç¬¬ä¸‰æ–¹ç³»ç»Ÿç¡®è®¤åˆ°è´¦åï¼Œåœ¨æœ¬ç³»ç»Ÿç¡®è®¤
- **ä½™é¢å¿«ç…§**ï¼šbalanceAfter è®°å½•æ¯æ¬¡æ”¯ä»˜åçš„å‰©ä½™æ¬ æ¬¾ï¼ˆv2.21æ–°å¢ï¼‰

```typescript
export const student_payment_ledgers = pgTable('student_payment_ledgers', {
  id: uuid('id').defaultRandom().primaryKey(),

  // æ”¯ä»˜ç¼–å·
  paymentNumber: varchar('payment_number', { length: 100 }).notNull().unique(),

  // å…³è”ä¿¡æ¯
  studentId: uuid('student_id').notNull().references(() => users.id),

  // æµæ°´ç±»å‹ (v2.21)
  ledgerType: paymentLedgerTypeEnum('ledger_type').notNull(),

  // æ”¯ä»˜é‡‘é¢
  amount: numeric('amount', { precision: 12, scale: 2 }).notNull(), // æ”¯ä»˜é‡‘é¢ï¼ˆç¾å…ƒï¼‰
  currency: varchar('currency', { length: 3 }).notNull().default('USD'),

  // ä½™é¢å¿«ç…§ (v2.21)
  balanceAfter: numeric('balance_after', { precision: 12, scale: 2 }).notNull(),

  // æ”¯ä»˜æ–¹å¼
  paymentMethod: paymentMethodEnum('payment_method').notNull(),

  // å®¡è®¡å­—æ®µ
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  createdBy: uuid('created_by').references(() => users.id),
});
```

**æµæ°´ç±»å‹æšä¸¾ï¼š**

```typescript
export const paymentLedgerTypeEnum = pgEnum('payment_ledger_type', [
  'initial_payment',   // é¦–ä»˜æ¬¾
  'installment',       // åˆ†æœŸä»˜æ¬¾
  'final_payment',     // å°¾æ¬¾
  'top_up',            // è¡¥æ¬¾
  'refund',            // é€€æ¬¾ï¼ˆè´Ÿæ•°é‡‘é¢ï¼‰
  'adjustment',        // è°ƒæ•´ï¼ˆå¯æ­£å¯è´Ÿï¼‰
]);
```

**ğŸ’¡ å…³äºå¹³å°èµ é€/è´·è®°çš„å†³ç­–ï¼ˆ2025-11-12ï¼‰ï¼š**
- âŒ **ä¸æ”¯æŒè´·è®°ç±»å‹**ï¼š`student_payment_ledgers` **ä¸**åŒ…å« `credit` ç±»å‹
- âœ… **åœ¨ Contract å±‚å¤„ç†**ï¼šå¦‚æœå¹³å°éœ€è¦èµ é€é‡‘é¢ï¼Œç›´æ¥è°ƒæ•´åˆåŒé‡‘é¢
- âœ… **ä¿æŒè´¢åŠ¡æµæ°´çº¯ç²¹æ€§**ï¼š`student_payment_ledgers` åªè®°å½•çœŸå®çš„èµ„é‡‘æµåŠ¨
- **ç¤ºä¾‹**ï¼šåˆåŒé‡‘é¢ $10,000ï¼Œå¹³å°èµ é€ $500 â†’ åˆåŒé‡‘é¢è°ƒæ•´ä¸º $9,500

**ä½¿ç”¨åœºæ™¯ï¼š**

1. **åˆåŒé¦–ä»˜æ¬¾æ”¯ä»˜**
```typescript
{
  paymentNumber: "PAY-2025-11-00001",
  studentId: "student-uuid-1",
  ledgerType: "initial_payment",
  amount: 3000.00,  // $3,000
  balanceAfter: 7000.00,  // æ”¯ä»˜åå‰©ä½™ $7,000
  paymentMethod: "bank_transfer",
  status: "succeeded",
  confirmedBy: "finance-staff-uuid-1",
  confirmedAt: new Date("2025-11-03T14:30:00Z"),
}
```

### 2.3 mentor_prices (å¯¼å¸ˆå®šä»·é…ç½®è¡¨)

**æ–‡ä»¶è·¯å¾„ï¼š** `src/infrastructure/database/schema/mentor-prices.schema.ts`

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- æ”¯æŒä¸‰ç§å®šä»·æ¨¡å¼ï¼šä¸€å¯¹ä¸€æœåŠ¡ã€ç­è¯¾æœåŠ¡ã€é˜¶æ®µæ€§æœåŠ¡ï¼ˆ2025-11-12 å†³ç­–ï¼‰
- æŒ‰å¯¼å¸ˆ + æœåŠ¡ç±»å‹åˆ†åˆ«å®šä»·
- ä»·æ ¼å†å²ç‰ˆæœ¬æ§åˆ¶ï¼ˆeffectiveFrom/effectiveUntilï¼‰

**ä¸‰ç§å®šä»·æ¨¡å¼è¯´æ˜ï¼š**

**æ¨¡å¼ 1ï¼šä¸€å¯¹ä¸€æœåŠ¡**
- ä½¿ç”¨ `unitPrice` å­—æ®µ
- ä¾‹å¦‚ï¼šGAP åˆ†æã€ç®€å†ä¿®æ”¹ã€1å¯¹1è¾…å¯¼
- ä»·æ ¼æŒ‰æ¬¡è®¡ç®—

**æ¨¡å¼ 2ï¼šç­è¯¾æœåŠ¡**
- åœ¨åˆ›å»ºç­è¯¾ï¼ˆcourses/classesï¼‰æ—¶ä¸ºæ¯ä½å¯¼å¸ˆåˆ¶å®šä»·æ ¼
- æˆ‘ç†è§£éœ€è¦æ–°å¢ `class_mentor_prices` è¡¨ï¼ˆè¯·ç¡®è®¤ï¼‰
- æ¯ä½å¯¼å¸ˆåœ¨ç­è¯¾ä¸­çš„ä»·æ ¼å¯èƒ½ä¸åŒ

**æ¨¡å¼ 3ï¼šé˜¶æ®µæ€§æœåŠ¡**
- ä½¿ç”¨ `pricingType = 'staged'`
- æ¯ä¸ªé˜¶æ®µä¸€æ¡ä»·æ ¼è®°å½•
- ä¾‹å¦‚ï¼šå†…æ¨æœåŠ¡ï¼ˆç®€å†æäº¤ $300 + é¢è¯• $500 + Offer $1200ï¼‰

```typescript
export const mentorPrices = pgTable('mentor_prices', {
  id: uuid('id').defaultRandom().primaryKey(),

  // å…³è”å¯¼å¸ˆ
  mentorId: uuid('mentor_id').notNull().references(() => users.id),

  // æœåŠ¡ç±»å‹å’Œå®šä»·ç±»å‹
  serviceType: serviceTypeEnum('service_type').notNull(),
  pricingType: pricingTypeEnum('pricing_type').notNull(), // per_service/package/staged

  // å®šä»·ä¿¡æ¯ï¼ˆå•ä½ä»·æ ¼ï¼‰
  unitPrice: numeric('unit_price', { precision: 12, scale: 1 }).notNull(),
  currency: varchar('currency', { length: 3 }).notNull().default('USD'),

  // æœåŠ¡åŒ…è®¡è´¹é…ç½®ï¼ˆpricingType = 'package'ï¼‰
  packageName: varchar('package_name', { length: 200 }),
  packageQuantity: integer('package_quantity'),
  packagePrice: numeric('package_price', { precision: 12, scale: 2 }),

  // é˜¶æ®µæ€§è®¡è´¹é…ç½®ï¼ˆpricingType = 'staged'ï¼‰
  stageName: varchar('stage_name', { length: 200 }),

  // çŠ¶æ€å’Œæ—¶é—´èŒƒå›´
  isActive: boolean('is_active').notNull().default(true),
  effectiveFrom: timestamp('effective_from', { withTimezone: true }),
  effectiveUntil: timestamp('effective_until', { withTimezone: true }),

  // å®¡è®¡å­—æ®µ
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
});
```

**å®šä»·ç±»å‹æšä¸¾ï¼š**

```typescript
export const pricingTypeEnum = pgEnum('pricing_type', [
  'per_service',  // æŒ‰æ¬¡è®¡è´¹
  'package',      // æœåŠ¡åŒ…è®¡è´¹
  'staged',       // é˜¶æ®µæ€§è®¡è´¹
]);
```

**ä½¿ç”¨åœºæ™¯ï¼š**

1. **æŒ‰æ¬¡è®¡è´¹ï¼ˆGAPåˆ†æï¼‰**
```typescript
{
  mentorId: "mentor-uuid-1",
  serviceType: "gap_analysis",
  pricingType: "per_service",
  unitPrice: 150.0,
  currency: "USD",
  isActive: true,
}
```

2. **æœåŠ¡åŒ…è®¡è´¹ï¼ˆç®€å†ä¿®æ”¹10æ¬¡åŒ…ï¼‰**
```typescript
{
  mentorId: "mentor-uuid-1",
  serviceType: "resume_review",
  pricingType: "package",
  packageName: "10æ¬¡åŒ…",
  packageQuantity: 10,
  packagePrice: 800.00,  // å¹³å‡å•ä»· $80
  unitPrice: 80.0,
  currency: "USD",
  isActive: true,
}
```

3. **é˜¶æ®µæ€§è®¡è´¹ï¼ˆå†…æ¨ä¸‰é˜¶æ®µï¼‰**
```typescript
// éœ€è¦åˆ›å»º3æ¡è®°å½•ï¼Œæ¯æ¡å¯¹åº”ä¸€ä¸ªé˜¶æ®µ
{
  mentorId: "mentor-uuid-1",
  serviceType: "internal_referral",
  pricingType: "staged",
  stageName: "ç®€å†æäº¤",
  unitPrice: 300.0,
  currency: "USD",
  isActive: true,
}
```

### 2.4 settlement_ledgers (ç»“ç®—è®°å½•è¡¨)

**æ–‡ä»¶è·¯å¾„ï¼š** `src/infrastructure/database/schema/settlement-ledgers.schema.ts`

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- **è´¢åŠ¡ç¡®è®¤æ¨¡å¼**ï¼šè´¢åŠ¡åœ¨ç¬¬ä¸‰æ–¹ç³»ç»Ÿå®Œæˆæ”¯ä»˜åï¼Œåœ¨æœ¬ç³»ç»Ÿç¡®è®¤
- å®æ—¶è®¡ç®—åº”ä»˜é‡‘é¢ï¼ˆåŸºäº mentor_payable_ledgers + ç»“ç®—å‚æ•°ï¼‰
- æ”¯æŒå¤šå¸ç§ç»“ç®—ï¼ˆæ±‡ç‡è½¬æ¢ï¼‰
- è®°å½•ç»“ç®—æ–¹å¼å’Œæ‰‹ç»­è´¹ï¼ˆv2.18ï¼‰

```typescript
export const settlementLedgers = pgTable('settlement_ledgers', {
  id: uuid('id').defaultRandom().primaryKey(),

  // ç»“ç®—ç¼–å·
  settlementNumber: varchar('settlement_number', { length: 100 }).notNull().unique(),

  // å…³è”ä¿¡æ¯
  mentorId: uuid('mentor_id').notNull().references(() => users.id),
  settlementMonth: varchar('settlement_month', { length: 7 }).notNull(), // YYYY-MM

  // ç»“ç®—é‡‘é¢ï¼ˆåŸå§‹é‡‘é¢ï¼Œç¾å…ƒï¼‰
  grossAmount: numeric('gross_amount', { precision: 12, scale: 2 }).notNull(),

  // æ‰£é™¤é¡¹ï¼ˆå¿«ç…§ï¼‰
  platformFee: numeric('platform_fee', { precision: 12, scale: 2 }).notNull(),
  platformFeeRate: numeric('platform_fee_rate', { precision: 5, scale: 4 }).notNull(),
  taxAmount: numeric('tax_amount', { precision: 12, scale: 2 }).notNull(),
  taxRate: numeric('tax_rate', { precision: 5, scale: 4 }).notNull(),

  // ç»“ç®—æ–¹å¼å’Œæ‰‹ç»­è´¹ (v2.18)
  settlementMethod: settlementMethodEnum('settlement_method').notNull(),
  handlingFee: numeric('handling_fee', { precision: 12, scale: 2 }).notNull().default('0'),
  handlingFeeRate: numeric('handling_fee_rate', { precision: 5, scale: 4 }),

  // å®é™…ç»“ç®—é‡‘é¢ï¼ˆæ‰£é™¤åï¼‰
  netAmount: numeric('net_amount', { precision: 12, scale: 2 }).notNull(),

  // å¸ç§è½¬æ¢
  settlementCurrency: varchar('settlement_currency', { length: 3 }).notNull(),
  exchangeRate: numeric('exchange_rate', { precision: 10, scale: 6 }).notNull(),
  settlementAmount: numeric('settlement_amount', { precision: 12, scale: 2 }).notNull(),

  // å…³è”çš„æœåŠ¡è®°å½•
  billingLedgerIds: json('billing_ledger_ids').$type<string[]>(),

  // æ”¶æ¬¾è´¦æˆ·ä¿¡æ¯ï¼ˆå¿«ç…§ï¼‰
  recipientAccount: json('recipient_account').$type<{
    accountType?: string;
    accountNumber?: string;
    accountHolder?: string;
    bankName?: string;
    swiftCode?: string;
    routingNumber?: string;
  }>(),

  // ç¡®è®¤ä¿¡æ¯
  confirmedBy: uuid('confirmed_by').notNull().references(() => users.id),
  confirmedAt: timestamp('confirmed_at', { withTimezone: true }).notNull(),
  confirmNotes: text('confirm_notes'),

  // ç»“ç®—çŠ¶æ€
  status: settlementStatusEnum('status').notNull().default('completed'),

  // å®¡è®¡å­—æ®µ
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  createdBy: uuid('created_by').references(() => users.id),
  notes: text('notes'),
});
```

**ç»“ç®—æ–¹å¼æšä¸¾ï¼ˆv2.18ï¼‰ï¼š**

```typescript
export const settlementMethodEnum = pgEnum('settlement_method', [
  'domestic_transfer',      // å›½å†…è½¬è´¦
  'channel_payment',        // æ¸ é“ä¸€èµ·ä»˜
  'gusto',                  // Gusto
  'gusto_international',    // Gusto-International
  'check',                  // æ”¯ç¥¨
]);
```

**ç»“ç®—çŠ¶æ€æšä¸¾ï¼š**

```typescript
export const settlementStatusEnum = pgEnum('settlement_status', [
  'pending',          // å¾…ç»“ç®—
  'processing',       // ç»“ç®—ä¸­
  'settled',          // å·²ç»“ç®—
  'on_hold',          // å†»ç»“
  'failed',           // ç»“ç®—å¤±è´¥
]);
```

**ç»“ç®—é‡‘é¢è®¡ç®—ç¤ºä¾‹ï¼š**

```typescript
// ç¤ºä¾‹ï¼šå¯¼å¸ˆ2025å¹´11æœˆæ”¶å…¥ $2,000ï¼Œé€‰æ‹©æ¸ é“ä¸€èµ·ä»˜ç»“ç®—ï¼ˆæ‰‹ç»­è´¹ç‡2%ï¼‰
{
  settlementNumber: "STL-2025-11-00001",
  mentorId: "mentor-uuid-1",
  settlementMonth: "2025-11",

  // åŸå§‹é‡‘é¢ï¼ˆæ¥è‡ª mentor_payable_ledgers æ±‡æ€»ï¼‰
  grossAmount: 2000.00,  // $2,000

  // æ‰£é™¤é¡¹ï¼ˆæ¥è‡ª settlement_parameters å½“æœˆå‚æ•°ï¼‰
  platformFee: 100.00,       // å¹³å°æ‰‹ç»­è´¹ = 2000 Ã— 5%
  platformFeeRate: 0.0500,   // 5%å¹³å°æ‰‹ç»­è´¹ç‡ï¼ˆå¿«ç…§ï¼‰
  taxAmount: 190.00,         // ç¨è´¹ = (2000 - 100) Ã— 10%
  taxRate: 0.1000,           // 10%ç¨ç‡ï¼ˆå¿«ç…§ï¼‰

  // ç»“ç®—æ–¹å¼å’Œæ‰‹ç»­è´¹
  settlementMethod: 'channel_payment',
  handlingFee: 40.00,        // æ‰‹ç»­è´¹ = 2000 Ã— 2%
  handlingFeeRate: 0.0200,   // 2%æ‰‹ç»­è´¹ç‡ï¼ˆå¿«ç…§ï¼‰

  // å®é™…ç»“ç®—é‡‘é¢ï¼ˆç¾å…ƒï¼‰= 2000 - 100 - 190 - 40 = 1670
  netAmount: 1670.00,

  // å¸ç§è½¬æ¢ï¼ˆå¯¼å¸ˆé€‰æ‹©äººæ°‘å¸ç»“ç®—ï¼‰
  settlementCurrency: "CNY",
  exchangeRate: 7.2000,       // 1 USD = 7.2 CNY
  settlementAmount: 12024.00, // 1670 Ã— 7.2

  // å…³è”çš„æœåŠ¡è®°å½•
  billingLedgerIds: ["ledger-uuid-1", "ledger-uuid-2", "ledger-uuid-3"],

  // è´¢åŠ¡ç¡®è®¤
  confirmedBy: "finance-staff-uuid-1",
  confirmedAt: new Date("2025-11-15T15:00:00Z"),
  confirmNotes: "å·²åœ¨ç¬¬ä¸‰æ–¹ç³»ç»Ÿå®Œæˆæ”¯ä»˜ï¼Œè½¬è´¦å‚è€ƒå·ï¼š20251115001234567",

  status: "completed",
}
```

### 2.5 settlement_parameters (ç»“ç®—å‚æ•°è¡¨)

**æ–‡ä»¶è·¯å¾„ï¼š** `src/infrastructure/database/schema/settlement-parameters.schema.ts`

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- å­˜å‚¨æ¯æœˆçš„ç»“ç®—å‚æ•°ï¼ˆæ±‡ç‡ã€æ‰£é™¤æ¯”ä¾‹ã€æ‰‹ç»­è´¹ç‡ï¼‰
- è´¢åŠ¡åœ¨ç»“ç®—å‰è®¾ç½®å½“æœˆå‚æ•°
- ç”¨äºå®æ—¶è®¡ç®—å¯¼å¸ˆå¾…ä»˜é‡‘é¢
- **æ”¯æŒæ¯æœˆå¤šç‰ˆæœ¬**ï¼ˆ2025-11-12 å†³ç­–ï¼‰ï¼šå…è®¸æœˆä¸­è°ƒæ•´å‚æ•°

**ğŸ’¡ ç‰ˆæœ¬æ§åˆ¶è®¾è®¡ï¼ˆ2025-11-12 å†³ç­–ï¼‰ï¼š**
- é‡‡ç”¨ã€Œæ¯æœˆå¤šç‰ˆæœ¬ã€æ¨¡å¼ï¼ˆé€‰é¡¹ Cï¼‰
- æ¯æ¬¡ç»“ç®—é»˜è®¤ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼ˆ`isLatest = true`ï¼‰
- å…è®¸è´¢åŠ¡äººå‘˜æ–°å¢ç‰ˆæœ¬ï¼Œç³»ç»Ÿè‡ªåŠ¨å°†æ—§ç‰ˆæœ¬æ ‡è®°ä¸ºéæœ€æ–°
- ä¿è¯å†å²ç»“ç®—çš„å‚æ•°å¯è¿½æº¯æ€§

```typescript
export const settlementParameters = pgTable('settlement_parameters', {
  id: uuid('id').defaultRandom().primaryKey(),

  // ç»“ç®—æœˆä»½ï¼ˆæ ¼å¼ï¼šYYYY-MMï¼‰
  settlementMonth: varchar('settlement_month', { length: 7 }).notNull().unique(),

  // æ±‡ç‡è®¾ç½®ï¼ˆç¾å…ƒåˆ°ç›®æ ‡å¸ç§ï¼‰
  exchangeRates: json('exchange_rates').$type<{
    USD_CNY?: number;    // ç¾å…ƒ â†’ äººæ°‘å¸
    USD_EUR?: number;    // ç¾å…ƒ â†’ æ¬§å…ƒ
    USD_GBP?: number;    // ç¾å…ƒ â†’ è‹±é•‘
    [key: string]: number;
  }>(),

  // æ‰£é™¤æ¯”ä¾‹
  deductions: json('deductions').$type<{
    platformFeeRate: number;  // å¹³å°æ‰‹ç»­è´¹ç‡ï¼ˆå¦‚ 0.05 è¡¨ç¤º 5%ï¼‰
    taxRate: number;          // ç¨è´¹ç‡ï¼ˆå¦‚ 0.10 è¡¨ç¤º 10%ï¼‰
  }>(),

  // ç»“ç®—æ–¹å¼æ‰‹ç»­è´¹ç‡é…ç½® (v2.18)
  settlementMethodFeeRates: json('settlement_method_fee_rates').$type<{
    domestic_transfer: number;      // å›½å†…è½¬è´¦æ‰‹ç»­è´¹ç‡ï¼ˆé€šå¸¸ä¸º 0ï¼‰
    channel_payment: number;        // æ¸ é“ä¸€èµ·ä»˜æ‰‹ç»­è´¹ç‡ï¼ˆå¦‚ 0.02 è¡¨ç¤º 2%ï¼‰
    gusto: number;                  // Gusto æ‰‹ç»­è´¹ç‡ï¼ˆå¦‚ 0.03 è¡¨ç¤º 3%ï¼‰
    gusto_international: number;    // Gusto-International æ‰‹ç»­è´¹ç‡ï¼ˆå¦‚ 0.05 è¡¨ç¤º 5%ï¼‰
    check: number;                  // æ”¯ç¥¨æ‰‹ç»­è´¹ç‡ï¼ˆé€šå¸¸ä¸º 0ï¼‰
  }>(),

  // æ—¶é—´æˆ³
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
  createdBy: uuid('created_by').references(() => users.id),
  notes: text('notes'),
});
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```typescript
// è®¾ç½®2025å¹´11æœˆçš„ç»“ç®—å‚æ•°
{
  settlementMonth: "2025-11",

  // æ±‡ç‡
  exchangeRates: {
    USD_CNY: 7.2000,      // 1 USD = 7.2 CNY
    USD_EUR: 0.9200,      // 1 USD = 0.92 EUR
    USD_GBP: 0.7800,      // 1 USD = 0.78 GBP
  },

  // æ‰£é™¤æ¯”ä¾‹
  deductions: {
    platformFeeRate: 0.05,  // 5% å¹³å°æ‰‹ç»­è´¹
    taxRate: 0.10,          // 10% ç¨è´¹
  },

  // ç»“ç®—æ–¹å¼æ‰‹ç»­è´¹ç‡
  settlementMethodFeeRates: {
    domestic_transfer: 0.00,        // å›½å†…è½¬è´¦: 0%
    channel_payment: 0.02,          // æ¸ é“ä¸€èµ·ä»˜: 2%
    gusto: 0.03,                    // Gusto: 3%
    gusto_international: 0.05,      // Gusto-International: 5%
    check: 0.00,                    // æ”¯ç¥¨: 0%
  },

  createdBy: "finance-manager-uuid-1",
  notes: "11æœˆç»“ç®—å‚æ•°ï¼Œæ±‡ç‡æŒ‰å½“æ—¥ä¸­è¡Œä¸­é—´ä»·",
}
```

### 2.6 settlement_appeals (ç»“ç®—ç”³è¯‰è¡¨)

**æ–‡ä»¶è·¯å¾„ï¼š** `src/infrastructure/database/schema/settlement-appeals.schema.ts`

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- è®°å½•å¯¼å¸ˆå¯¹ç»“ç®—é‡‘é¢çš„ç”³è¯‰
- ç”³è¯‰é’ˆå¯¹ç‰¹å®šçš„ç»“ç®—è®°å½•æˆ–æœåŠ¡è®°å½•
- é¡¾é—®å®¡æ ¸ç”³è¯‰ï¼Œè°ƒæ•´ç»“ç®—é‡‘é¢

```typescript
export const settlementAppeals = pgTable('settlement_appeals', {
  id: uuid('id').defaultRandom().primaryKey(),

  // æ ‡é¢˜
  title: text('title').notNull(),

  // å…³è”ä¿¡æ¯
  settlementId: uuid('settlement_id').notNull().references(() => settlement_ledgers.id),
  billingLedgerId: uuid('billing_ledger_id').references(() => mentor_payable_ledgers.id),

  // ç”³è¯‰æ–¹
  appealedBy: uuid('appealed_by').notNull().references(() => users.id),

  // ç”³è¯‰ä¿¡æ¯
  reason: appealReasonEnum('reason').notNull(),
  description: text('description').notNull(),

  // å®¡æ ¸ä¿¡æ¯
  status: appealStatusEnum('status').notNull().default('pending'),
  reviewedBy: uuid('reviewed_by').references(() => users.id),
  reviewNotes: text('review_notes'),
  reviewedAt: timestamp('reviewed_at', { withTimezone: true }),

  // å¤„ç†ç»“æœ
  resolution: text('resolution'),
  adjustedAmount: numeric('adjusted_amount', { precision: 12, scale: 2 }),

  // å®¡è®¡å­—æ®µ
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
});
```

**ç”³è¯‰åŸå› æšä¸¾ï¼š**

```typescript
export const appealReasonEnum = pgEnum('appeal_reason', [
  'service_not_completed',  // æœåŠ¡æœªå®Œæˆ
  'incorrect_amount',       // é‡‘é¢æœ‰è¯¯
  'duplicate_charge',       // é‡å¤è®¡è´¹
  'other',                  // å…¶ä»–
]);
```

**ç”³è¯‰çŠ¶æ€æšä¸¾ï¼š**

```typescript
export const appealStatusEnum = pgEnum('appeal_status', [
  'pending',    // ç”³è¯‰ä¸­
  'approved',   // é€šè¿‡
  'rejected',   // æ‹’ç»
]);
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```typescript
// å¯¼å¸ˆå¯¹ç»“ç®—é‡‘é¢æå‡ºç”³è¯‰
{
  title: "ç”³è¯‰ tutor-uuid-1 çš„ç»“ç®—é‡‘é¢",
  settlementId: "settlement-uuid-1",
  billingLedgerId: "ledger-uuid-1",  // é’ˆå¯¹å…·ä½“çš„æœåŠ¡è®°å½•

  appealedBy: "mentor-uuid-1",
  reason: "service_not_completed",
  description: "è¯¥æ¬¡GAPåˆ†ææœåŠ¡æœªå®Œæˆï¼Œå­¦ç”Ÿæœªå‡ºå¸­",

  status: "pending",

  createdAt: new Date("2025-11-16T10:00:00Z"),
}
```

---

## 3. æœåŠ¡æ¥å£æ¸…å•

### 3.1 PaymentService - æ”¯ä»˜æœåŠ¡ (5ä¸ªæ–¹æ³•)

**åŸŸå½’å±ï¼š** Financial Domain

**è¯´æ˜ï¼š**
- ç³»ç»Ÿä¸å¯¹æ¥ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°
- é‡‡ç”¨è´¢åŠ¡ç¡®è®¤æ¨¡å¼
- æ”¯ä»˜ç¡®è®¤åè§¦å‘äº‹ä»¶

| # | æœåŠ¡æ–¹æ³• | æ–¹æ³•ç­¾å | åŠŸèƒ½ |
|---|---------|---------|------|
| 1 | åˆ›å»ºæ”¯ä»˜è®°å½• | `create(dto: CreatePaymentDto): Promise<Payment>` | åˆ›å»ºå¾…æ”¯ä»˜è®°å½• |
| 2 | æŸ¥è¯¢æ”¯ä»˜è®°å½• | `search(filter: PaymentFilterDto, pagination?: PaginationDto, sort?: SortDto): Promise<PaginatedResult<Payment>>` | æŸ¥è¯¢æ”¯ä»˜å†å² |
| 3 | æŸ¥è¯¢æ”¯ä»˜è¯¦æƒ… | `findById(id: string): Promise<Payment>` | æŸ¥çœ‹æ”¯ä»˜è¯¦ç»†ä¿¡æ¯ |
| 4 | ç¡®è®¤æ”¯ä»˜ | `confirm(paymentId: string, dto: ConfirmPaymentDto): Promise<Payment>` | è´¢åŠ¡ç¡®è®¤æ”¯ä»˜å·²åˆ°è´¦ |
| 5 | ç”³è¯·é€€æ¬¾ | `refund(paymentId: string, dto: RefundDto): Promise<Refund>` | é€€æ¬¾å¤„ç† |

### 3.2 SettlementService - ç»“ç®—æœåŠ¡ (10ä¸ªæ–¹æ³•)

**åŸŸå½’å±ï¼š** Financial Domain

**è¯´æ˜ï¼š**
- å®æ—¶æŸ¥è¯¢å’Œè®¡ç®—æ¨¡å¼ï¼Œæ— æ‰¹æ¬¡å¤„ç†
- è´¢åŠ¡è®¾ç½®å½“æœˆå‚æ•°åï¼Œç³»ç»Ÿå®æ—¶è®¡ç®—

| # | æœåŠ¡æ–¹æ³• | æ–¹æ³•ç­¾å | åŠŸèƒ½ |
|---|---------|---------|------|
| 1 | æŸ¥è¯¢å¾…æ”¯ä»˜æ˜ç»† | `getPendingLedgers(query: { month: string, mentorId?: string }): Promise<MentorPayableLedger[]>` | æŸ¥è¯¢æŒ‡å®šæœˆä»½å¾…æ”¯ä»˜çš„æœåŠ¡è®°å½• |
| 2 | è®¡ç®—ç»“ç®—é‡‘é¢ | `calculateSettlement(dto: CalculateSettlementDto): Promise<SettlementCalculation>` | å®æ—¶è®¡ç®—åº”ä»˜é‡‘é¢ï¼ˆå«æ±‡ç‡ã€æ‰£é™¤ï¼‰ |
| 3 | è®¾ç½®ç»“ç®—å‚æ•° | `setParameters(dto: SetParametersDto): Promise<SettlementParameters>` | è®¾ç½®å½“æœˆæ±‡ç‡å’Œæ‰£é™¤æ¯”ä¾‹ |
| 4 | ç¡®è®¤æ”¯ä»˜ | `confirmPayment(dto: ConfirmPaymentDto): Promise<Settlement>` | è´¢åŠ¡ç¡®è®¤å·²å®Œæˆå¯¼å¸ˆæ”¯ä»˜ |
| 5 | æŸ¥è¯¢ç»“ç®—è®°å½• | `search(filter: SettlementFilterDto, pagination?: PaginationDto, sort?: SortDto): Promise<PaginatedResult<Settlement>>` | æŸ¥è¯¢ç»“ç®—å†å² |
| 6 | æŸ¥è¯¢ç»“ç®—è¯¦æƒ… | `findById(id: string): Promise<Settlement>` | æŸ¥çœ‹ç»“ç®—è¯¦ç»†ä¿¡æ¯ |
| 7 | å†»ç»“ç»“ç®— | `holdSettlement(settlementId: string, reason: string): Promise<Settlement>` | å†»ç»“å¾…ç»“ç®—é‡‘é¢ |
| 8 | è§£å†»ç»“ç®— | `unholdSettlement(settlementId: string): Promise<Settlement>` | è§£å†»å†»ç»“é‡‘é¢ |
| 9 | å¯¼å‡ºç»“ç®—æŠ¥è¡¨ | `exportSettlementReport(query: SettlementReportQueryDto): Promise<Buffer>` | å¯¼å‡ºExcel/PDFç»“ç®—æŠ¥è¡¨ |
| 10 | æ‰¹é‡ç¡®è®¤ | `batchConfirm(dto: BatchConfirmDto): Promise<BatchResult>` | æ‰¹é‡ç¡®è®¤å¤šä¸ªç»“ç®— |

### 3.3 AppealService - ç»“ç®—ç”³è¯‰æœåŠ¡ (4ä¸ªæ–¹æ³•)

**åŸŸå½’å±ï¼š** Financial Domain

| # | æœåŠ¡æ–¹æ³• | æ–¹æ³•ç­¾å | åŠŸèƒ½ |
|---|---------|---------|------|
| 1 | æäº¤ç”³è¯‰ | `createAppeal(dto: CreateAppealDto): Promise<Appeal>` | å¯¹ç»“ç®—é‡‘é¢æå‡ºå¼‚è®® |
| 2 | æŸ¥è¯¢ç”³è¯‰åˆ—è¡¨ | `search(filter: AppealFilterDto, pagination?: PaginationDto, sort?: SortDto): Promise<PaginatedResult<Appeal>>` | æŸ¥è¯¢ç”³è¯‰è®°å½• |
| 3 | æŸ¥è¯¢ç”³è¯‰è¯¦æƒ… | `findById(id: string): Promise<Appeal>` | æŸ¥çœ‹ç”³è¯‰å®Œæ•´ä¿¡æ¯ |
| 4 | å®¡æ ¸ç”³è¯‰ | `reviewAppeal(id: string, dto: ReviewAppealDto): Promise<Appeal>` | æ‰¹å‡†æˆ–æ‹’ç»ç”³è¯‰ |

### 3.4 BillingStatsService - è®¡è´¹ç»Ÿè®¡æœåŠ¡ (2ä¸ªæ–¹æ³•)

**åŸŸå½’å±ï¼š** Financial Domain

| # | æœåŠ¡æ–¹æ³• | æ–¹æ³•ç­¾å | åŠŸèƒ½ |
|---|---------|---------|------|
| 1 | æŸ¥è¯¢å¯¼å¸ˆæ”¶å…¥ç»Ÿè®¡ | `getMentorStats(mentorId: string, period: DateRange): Promise<MentorStats>` | ç»Ÿè®¡å¯¼å¸ˆæ”¶å…¥ |
| 2 | æŸ¥è¯¢å¹³å°æ”¶å…¥ç»Ÿè®¡ | `getPlatformStats(period: DateRange): Promise<PlatformStats>` | ç»Ÿè®¡å¹³å°æ•´ä½“æ”¶å…¥ |

### 3.5 MentorPricingService - å¯¼å¸ˆå®šä»·æœåŠ¡ (4ä¸ªæ–¹æ³•)

**åŸŸå½’å±ï¼š** Financial Domain

| # | æœåŠ¡æ–¹æ³• | æ–¹æ³•ç­¾å | åŠŸèƒ½ |
|---|---------|---------|------|
| 1 | æŸ¥è¯¢å¯¼å¸ˆä»·æ ¼é…ç½® | `findByMentor(mentorId: string): Promise<MentorPrice[]>` | æŸ¥è¯¢ä»·æ ¼é…ç½® |
| 2 | è®¾ç½®å¯¼å¸ˆä»·æ ¼ | `upsertPrice(mentorId: string, dto: UpsertPriceDto): Promise<MentorPrice>` | è®¾ç½®/æ›´æ–°ä»·æ ¼ |
| 3 | æ£€æŸ¥ä»·æ ¼é…ç½® | `checkPricing(mentorId: string, serviceType: string): Promise<PricingCheckResult>` | æ£€æŸ¥ä»·æ ¼é…ç½®æ˜¯å¦å®Œæ•´ |
| 4 | æŸ¥è¯¢ä»·æ ¼å†å² | `getPriceHistory(mentorId: string, serviceType: string): Promise<PriceHistory[]>` | æŸ¥çœ‹ä»·æ ¼å˜æ›´å†å² |

---

## 4. äº‹ä»¶é©±åŠ¨è®¾è®¡

### 4.1 Financial Domain å‘å¸ƒçš„äº‹ä»¶

**Outbound Events (6ä¸ª)**

| # | äº‹ä»¶åç§° | è®¢é˜…è€… | è§¦å‘æ—¶æœº | äº‹ä»¶ç”¨é€” |
|---|---------|--------|---------|---------|
| 1 | `financial.payment.succeeded` | Contract Domainã€Notification | è´¢åŠ¡ç¡®è®¤æ”¯ä»˜åˆ°è´¦ | è§¦å‘åˆåŒæ¿€æ´»ã€å‘é€é€šçŸ¥ |
| 2 | `financial.billing.ledger_created` | Analyticsã€Contract Domain | åˆ›å»ºå¯¼å¸ˆè®¡è´¹è®°å½• | æ•°æ®åˆ†æã€æ›´æ–°åˆåŒç»Ÿè®¡ |
| 3 | `financial.billing.appeal_created` | Notification | ç»“ç®—ç”³è¯‰åˆ›å»ºï¼ˆå¯¼å¸ˆå‘èµ·ï¼‰ | é€šçŸ¥é¡¾é—®å¤„ç† |
| 4 | `financial.billing.appeal_resolved` | Notification | ç”³è¯‰å¤„ç†å®Œæˆï¼ˆé¡¾é—®å®¡æ ¸åï¼‰ | é€šçŸ¥å¯¼å¸ˆç»“æœ |
| 5 | `financial.settlement.completed` | Billing Serviceã€Notification | ç»“ç®—å®Œæˆï¼ˆæ¬¾é¡¹å·²å‘æ”¾ï¼‰ | æ›´æ–°è®¡è´¹è®°å½•çŠ¶æ€ã€é€šçŸ¥å¯¼å¸ˆ |
| 6 | `financial.billing.pricing_missing` | ç®¡ç†ç•Œé¢ | ä»·æ ¼é…ç½®ç¼ºå¤± | æç¤ºé¡¾é—®è¡¥å…¨ä»·æ ¼é…ç½® |

**äº‹ä»¶è´Ÿè½½ç¤ºä¾‹ï¼š**

1. **payment.succeeded äº‹ä»¶**
```typescript
{
  eventId: string;
  timestamp: Date;
  eventType: 'financial.payment.succeeded';
  payload: {
    paymentId: string;
    paymentNumber: string;
    studentId: string;
    amount: number;
    paymentMethod: string;
    confirmedBy: string;
    confirmedAt: Date;
  };
}
```

2. **settlement.completed äº‹ä»¶**
```typescript
{
  eventId: string;
  timestamp: Date;
  eventType: 'financial.settlement.completed';
  payload: {
    settlementId: string;
    settlementNumber: string;
    mentorId: string;
    settlementMonth: string;
    grossAmount: number;
    netAmount: number;
    settlementMethod: string;
    settlementCurrency: string;
    settlementAmount: number;
    confirmedBy: string;
    confirmedAt: Date;
    billingLedgerIds: string[]; // å…³è”çš„è®¡è´¹è®°å½•
  };
}
```

### 4.2 Financial Domain ç›‘å¬çš„äº‹ä»¶

**Inbound Events (7ä¸ª)**

| # | äº‹ä»¶åç§° | æ¥æºåŸŸ | è§¦å‘æ—¶æœº | ä¸šåŠ¡å¤„ç† |
|---|---------|--------|---------|---------|
| 1 | `services.session.completed` | Services Domain | æœåŠ¡å®Œæˆ | åˆ›å»º mentor_payable_ledgers è®°å½• |
| 2 | `services.session.evaluated` | Services Domain | å¯¼å¸ˆå®Œæˆè¯„ä»· | å¤„ç†éœ€è¦è¯„ä»·çš„è®¡è´¹ |
| 3 | `placement.referral.resume_submitted` | Placement Domain | ç®€å†æäº¤æˆåŠŸ | é˜¶æ®µæ€§è®¡è´¹ï¼ˆç¬¬1é˜¶æ®µï¼‰ |
| 4 | `placement.referral.interview_passed` | Placement Domain | å­¦å‘˜é€šè¿‡é¢è¯• | é˜¶æ®µæ€§è®¡è´¹ï¼ˆç¬¬2é˜¶æ®µï¼‰ |
| 5 | `placement.referral.offer_received` | Placement Domain | å­¦å‘˜æ”¶åˆ°Offer | é˜¶æ®µæ€§è®¡è´¹ï¼ˆç¬¬3é˜¶æ®µï¼‰ |
| 6 | `contract.contract.signed` | Contract Domain | åˆåŒç­¾ç½² | éªŒè¯ä»·æ ¼é…ç½®å®Œæ•´æ€§ |
| 7 | `services.class.completed` | Services Domain | ç­è¯¾å®Œæˆ | æ‰¹é‡åˆ›å»ºè®¡è´¹è®°å½• |

**äº‹ä»¶å¤„ç†æµç¨‹ï¼š**

1. **Session å®Œæˆäº‹ä»¶å¤„ç†**
```
services.session.completed äº‹ä»¶åˆ°è¾¾
    â†“
æŸ¥è¯¢ contract å’Œ mentor_prices
    â†“
è®¡ç®—è®¡è´¹é‡‘é¢
    â†“
åˆ›å»º mentor_payable_ledgers è®°å½•
    â†“
å‘å¸ƒ financial.billing.ledger_created äº‹ä»¶
```

2. **å†…æ¨ä¸‰é˜¶æ®µè®¡è´¹**
```
placement.referral.resume_submitted â†’ åˆ›å»ºç¬¬1é˜¶æ®µè®¡è´¹
placement.referral.interview_passed â†’ åˆ›å»ºç¬¬2é˜¶æ®µè®¡è´¹
placement.referral.offer_received   â†’ åˆ›å»ºç¬¬3é˜¶æ®µè®¡è´¹
```

---

## 5. ä¸šåŠ¡æµç¨‹

### 5.1 å­¦ç”Ÿæ”¯ä»˜æµç¨‹ (Payment Flow)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å­¦ç”Ÿæ”¯ä»˜å®Œæ•´æµç¨‹                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: åˆ›å»ºæ”¯ä»˜è®°å½•ï¼ˆFinancial Domainï¼‰
   é¡¾é—® â†’ åœ¨ç³»ç»Ÿä¸­åˆ›å»ºæ”¯ä»˜è®°å½•
        â†’ PaymentService.create(dto: CreatePaymentDto)
        â†’ ç”Ÿæˆæ”¯ä»˜è®°å½•ï¼ˆstatus: pending, ledgerType: initial_payment/installment/final_payment/top_upï¼‰
        â†’ balanceAfter åˆå§‹è®¡ç®—ï¼ˆæ¬ æ¬¾ä½™é¢ï¼‰

Step 2: å­¦ç”Ÿåœ¨ç¬¬ä¸‰æ–¹ç³»ç»Ÿå®Œæˆæ”¯ä»˜
   å­¦ç”Ÿ â†’ åœ¨ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼ˆé“¶è¡Œï¼‰å®Œæˆæ”¯ä»˜
        â†’ é“¶è¡Œè½¬è´¦ / ç°é‡‘ / æ”¯ç¥¨

Step 3: è´¢åŠ¡ç¡®è®¤æ”¯ä»˜ï¼ˆFinancial Domainï¼‰
   è´¢åŠ¡ â†’ åœ¨ç¬¬ä¸‰æ–¹ç³»ç»Ÿç¡®è®¤åˆ°è´¦åï¼Œåœ¨æœ¬ç³»ç»Ÿç¡®è®¤
        â†’ PaymentService.confirm(paymentId, dto)
        â†’ æ›´æ–°æ”¯ä»˜çŠ¶æ€ä¸º 'succeeded'
        â†’ æ›´æ–° balanceAfterï¼ˆæ¬ æ¬¾ä½™é¢å¿«ç…§ï¼‰
        â†’ å‘å¸ƒ financial.payment.succeeded äº‹ä»¶

Step 4: åˆåŒæ¿€æ´»ï¼ˆContract Domainç›‘å¬ï¼‰
   Contract â†’ ç›‘å¬ financial.payment.succeeded
            â†’ æ¿€æ´»åˆåŒçŠ¶æ€
            â†’ åˆå§‹åŒ–æœåŠ¡æƒç›Šä½™é¢
            â†’ å‘å¸ƒ contract.activated äº‹ä»¶

Step 5: å¼€é€šæœåŠ¡ï¼ˆServices Domainç›‘å¬ï¼‰
   Services â†’ ç›‘å¬ contract.activated
            â†’ å¼€é€šæœåŠ¡é¢„çº¦æƒé™
            â†’ å­¦ç”Ÿå¯å¼€å§‹é¢„çº¦æœåŠ¡
```

**å…³é”®è§„åˆ™ï¼š**
- âœ… balanceAfter å­—æ®µè®°å½•æ¯æ¬¡æ”¯ä»˜åçš„å‰©ä½™æ¬ æ¬¾
- âœ… æ”¯æŒå¤šç§æ”¯ä»˜æ–¹å¼ï¼šbank_transfer, cash, cheque, other
- âœ… æ”¯ä»˜ç¡®è®¤å¿…é¡»ç”±è´¢åŠ¡æ‰‹åŠ¨æ“ä½œï¼ˆè´¢åŠ¡ç¡®è®¤æ¨¡å¼ï¼‰
- âœ… æ”¯ä»˜æˆåŠŸåè§¦å‘åˆåŒæ¿€æ´»æµç¨‹

### 5.2 å¯¼å¸ˆç»“ç®—æµç¨‹ (Settlement Flow)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¯¼å¸ˆç»“ç®—å®Œæ•´æµç¨‹                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: æœåŠ¡å®Œæˆåˆ›å»ºè®¡è´¹è®°å½•
   Services â†’ æœåŠ¡å®Œæˆ
            â†’ å‘å¸ƒ services.session.completed

   Financial â†’ ç›‘å¬å™¨åˆ›å»º mentor_payable_ledgers
             â†’ status: pending, settlement_status: pending

Step 2: æœˆåº¦ç»“ç®—å‰å‡†å¤‡
   è´¢åŠ¡ â†’ ç™»å½•ç»“ç®—ç³»ç»Ÿ
        â†’ é€‰æ‹©ç»“ç®—æœˆä»½ï¼ˆå¦‚ 2025-11ï¼‰
        â†’ SettlementService.setParameters()
        â†’ è®¾ç½®å½“æœˆæ±‡ç‡ã€æ‰£é™¤æ¯”ä¾‹ã€æ‰‹ç»­è´¹ç‡

Step 3: æŸ¥è¯¢å¾…æ”¯ä»˜æ˜ç»†
   è´¢åŠ¡ â†’ SettlementService.getPendingLedgers({ month: '2025-11' })
        â†’ æŸ¥è¯¢æ‰€æœ‰ settlement_status = 'pending' çš„è®°å½•
        â†’ å®æ—¶æ±‡æ€» grossAmount

Step 4: è®¡ç®—ç»“ç®—é‡‘é¢
   ç³»ç»Ÿ â†’ SettlementService.calculateSettlement()
        â†’ ä» settlement_parameters è·å–å½“æœˆå‚æ•°
        â†’ è®¡ç®— platformFee = grossAmount Ã— platformFeeRate
        â†’ è®¡ç®— taxAmount = (grossAmount - platformFee) Ã— taxRate
        â†’ è®¡ç®— handlingFeeï¼ˆæ ¹æ® settlementMethodï¼‰
        â†’ netAmount = grossAmount - platformFee - taxAmount - handlingFee
        â†’ settlementAmount = netAmount Ã— exchangeRate

Step 5: è´¢åŠ¡åœ¨ç¬¬ä¸‰æ–¹ç³»ç»Ÿæ”¯ä»˜
   è´¢åŠ¡ â†’ æ ¹æ®è®¡ç®—ç»“æœï¼Œåœ¨ç¬¬ä¸‰æ–¹ç³»ç»Ÿå®Œæˆæ”¯ä»˜
        â†’ å›½å†…è½¬è´¦ / æ¸ é“ä¸€èµ·ä»˜ / Gusto / æ”¯ç¥¨

Step 6: ç¡®è®¤æ”¯ä»˜ï¼ˆFinancial Domainï¼‰
   è´¢åŠ¡ â†’ SettlementService.confirmPayment()
        â†’ åˆ›å»º settlement_ledgers è®°å½•
        â†’ æ›´æ–°å…³è”çš„ mentor_payable_ledgers.settlement_status = 'settled'
        â†’ å‘å¸ƒ settlement.completed äº‹ä»¶

Step 7: é€šçŸ¥å¯¼å¸ˆ
   Notification â†’ ç›‘å¬ settlement.completed
                â†’ å‘é€é‚®ä»¶/çŸ­ä¿¡é€šçŸ¥å¯¼å¸ˆ
                â†’ åŒ…å«ç»“ç®—é‡‘é¢ã€ä»˜æ¬¾å‚è€ƒå·
```

**å…³é”®è§„åˆ™ï¼š**
- âœ… å®æ—¶è®¡ç®—æ¨¡å¼ï¼Œæ— æ‰¹æ¬¡å¤„ç†
- âœ… ç»“ç®—å‰å¿…é¡»å…ˆè®¾ç½®å½“æœˆå‚æ•°ï¼ˆæ±‡ç‡ã€æ‰£é™¤æ¯”ä¾‹ã€æ‰‹ç»­è´¹ç‡ï¼‰
- âœ… æ‰€æœ‰é‡‘é¢å­—æ®µä¿å­˜å¿«ç…§ï¼ˆé˜²æ­¢åç»­å‚æ•°å˜æ›´å½±å“å†å²è®°å½•ï¼‰
- âœ… æ”¯æŒ5ç§ç»“ç®—æ–¹å¼ï¼Œæ¯ç§æ–¹å¼æœ‰ä¸åŒçš„æ‰‹ç»­è´¹ç‡
- âœ… å¤šå¸ç§ç»“ç®—ï¼Œè‡ªåŠ¨æ±‡ç‡è½¬æ¢

### 5.3 ç”³è¯‰å¤„ç†æµç¨‹ (Appeal Flow)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç»“ç®—ç”³è¯‰å®Œæ•´æµç¨‹                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: å¯¼å¸ˆæäº¤ç”³è¯‰
   å¯¼å¸ˆ â†’ æŸ¥çœ‹ç»“ç®—æ˜ç»†
        â†’ å‘ç°é‡‘é¢æœ‰è¯¯
        â†’ AppealService.createAppeal()
        â†’ å¡«å†™ç”³è¯‰åŸå› å’Œæè¿°
        â†’ ä¸Šä¼ è¯æ®é™„ä»¶
        â†’ status: pending
        â†’ å‘å¸ƒ billing.appeal_created äº‹ä»¶

Step 2: é¡¾é—®å®¡æ ¸ç”³è¯‰
   é¡¾é—® â†’ æ”¶åˆ°é€šçŸ¥ï¼ˆç›‘å¬ billing.appeal_createdï¼‰
        â†’ AppealService.findById() æŸ¥çœ‹ç”³è¯‰è¯¦æƒ…
        â†’ è”ç³»å¯¼å¸ˆå’Œå­¦ç”Ÿæ ¸å®æƒ…å†µ
        â†’ å®¡æ ¸è¯æ®

Step 3: åšå‡ºå®¡æ ¸å†³å®š
   åœºæ™¯Aï¼šç”³è¯‰é€šè¿‡
      é¡¾é—® â†’ AppealService.reviewAppeal(id, { status: 'approved' })
           â†’ åˆ›å»ºè´Ÿæ•°çš„ mentor_payable_ledgers è®°å½•
           â†’ è°ƒæ•´ç»“ç®—é‡‘é¢
           â†’ å‘å¸ƒ billing.appeal_resolved äº‹ä»¶

   åœºæ™¯Bï¼šç”³è¯‰æ‹’ç»
      é¡¾é—® â†’ AppealService.reviewAppeal(id, { status: 'rejected' })
           â†’ ç»´æŒåŸç»“ç®—é‡‘é¢
           â†’ å‘å¸ƒ billing.appeal_resolved äº‹ä»¶

Step 4: é€šçŸ¥å¤„ç†ç»“æœ
   Notification â†’ ç›‘å¬ billing.appeal_resolved
                â†’ é€šçŸ¥å¯¼å¸ˆå®¡æ ¸ç»“æœ
                â†’ åŒ…å«å¤„ç†è¯´æ˜å’Œè°ƒæ•´é‡‘é¢
```

**å…³é”®è§„åˆ™ï¼š**
- âœ… ç”³è¯‰é’ˆå¯¹ç»“ç®—è®°å½•æˆ–å…·ä½“çš„æœåŠ¡è®°å½•
- âœ… ç”³è¯‰é€šè¿‡ååˆ›å»ºè´Ÿæ•°çš„ mentor_payable_ledgers è®°å½•è°ƒæ•´é‡‘é¢
- âœ… å·²ç»“ç®—çš„è®°å½•éœ€è¦å…ˆè§£å†»æ‰èƒ½è°ƒæ•´
- âœ… ä¿ç•™å®Œæ•´çš„ç”³è¯‰å†å²å’Œè¯æ®

---

## 6. é™„å½•

### 6.1 é‡‘é¢å­—æ®µç²¾åº¦è§„èŒƒ

| å­—æ®µç±»å‹ | ç²¾åº¦ | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|---------|------|---------|------|
| `numeric(12, 1)` | ä¿ç•™1ä½å°æ•° | **å•ä»·å­—æ®µ** | $99.5/å°æ—¶ |
| `numeric(12, 2)` | ä¿ç•™2ä½å°æ•° | **æ€»é¢å­—æ®µ** | $199.00 |

**è®¾è®¡åŸå› ï¼š**
- **å•ä»·** (`unitPrice`): é€šå¸¸ä¸éœ€è¦ç²¾ç¡®åˆ°åˆ†ï¼Œ1ä½å°æ•°è¶³å¤Ÿ
- **æ€»é¢** (`totalAmount`): å¿…é¡»ç²¾ç¡®åˆ°åˆ†ï¼Œé˜²æ­¢ç´¯è®¡è¯¯å·®

### 6.2 è·¨åŸŸå¼•ç”¨ç­–ç•¥ï¼ˆDDDæ¶æ„ï¼‰

**1. ä¸ä½¿ç”¨å¤–é”®çº¦æŸçš„åœºæ™¯ï¼ˆåº”ç”¨å±‚ä¿è¯å®Œæ•´æ€§ï¼‰ï¼š**

```typescript
// Contract Domain å¼•ç”¨ Product
contracts.productId â†’ Catalog Domain çš„ products (æ³¨é‡Šå¤–é”®)

// Financial Domain å¼•ç”¨ Session
mentor_payable_ledgers.sessionId â†’ Services Domain çš„ sessions (æ³¨é‡Šå¤–é”®)
mentor_payable_ledgers.classId â†’ Services Domain çš„ classes (æ³¨é‡Šå¤–é”®)

```

**åŸå› ï¼š**
- ä¿æŒåŸŸçš„ç‹¬ç«‹æ€§å’Œæ¾è€¦åˆ
- é¿å…è·¨åŸŸçš„çº§è”åˆ é™¤å½±å“
- å…è®¸ä¸åŒåŸŸç‹¬ç«‹æ¼”è¿›

**2. ä½¿ç”¨å¤–é”®çº¦æŸçš„åœºæ™¯ï¼ˆåŒåŸŸæˆ–å¼ºä¸€è‡´æ€§ï¼‰ï¼š**


**å®ç°å»ºè®®ï¼š**
- è·¨åŸŸå¼•ç”¨åœ¨åº”ç”¨å±‚ä½¿ç”¨ Service è°ƒç”¨éªŒè¯
- å…³é”®ä¸šåŠ¡æµç¨‹ä½¿ç”¨äº‹ä»¶ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
- å®šæœŸè¿è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ä»»åŠ¡

### 6.3 Append-Only è®¾è®¡æ¨¡å¼

**é€‚ç”¨èŒƒå›´ï¼š**
- `mentor_payable_ledgers` - å¯¼å¸ˆåº”ä»˜è´¦æ¬¾æµæ°´
- `student_payment_ledgers` - å­¦ç”Ÿæ”¯ä»˜æµæ°´

**è®¾è®¡ç‰¹ç‚¹ï¼š**
- âŒ è®°å½•ä¸å¯ä¿®æ”¹ï¼Œæ— éœ€ `updatedAt` å­—æ®µ
- âœ… æ”¯æŒè´Ÿæ•°è°ƒæ•´è®°å½•ï¼ˆå¦‚é€€æ¬¾ã€ç”³è¯‰è°ƒæ•´ï¼‰
- âœ… å®Œæ•´å®¡è®¡è¿½è¸ªï¼ˆæ‰€æœ‰å†å²ä¸å¯ç¯¡æ”¹ï¼‰
- âœ… ä½™é¢å¿«ç…§è®¾è®¡ï¼ˆæ”¯æŒå¿«é€Ÿå¯¹è´¦ï¼‰

**åº”ç”¨å±‚ä¿æŠ¤ï¼š**

```typescript
class MentorPayableLedgerService {
  async recordLedger(dto: CreateMentorPayableLedgerDto) {
    // âœ… åªæä¾› INSERT æ–¹æ³•
    return await this.db.insert(mentorPayableLedgers).values({
      ...dto,
      createdAt: new Date(),
    });
  }

  // âŒ ä¸æä¾› update() æ–¹æ³•
  // âŒ ä¸æä¾› delete() æ–¹æ³•
}
```

**æ•°æ®åº“æƒé™å»ºè®®ï¼š**

```sql
-- åªæˆäºˆ INSERT å’Œ SELECT æƒé™ï¼Œç¦æ­¢ UPDATE/DELETE
REVOKE UPDATE, DELETE ON mentor_payable_ledgers FROM mentorx_app_user;
GRANT INSERT, SELECT ON mentor_payable_ledgers TO mentorx_app_user;

REVOKE UPDATE, DELETE ON student_payment_ledgers FROM mentorx_app_user;
GRANT INSERT, SELECT ON student_payment_ledgers TO mentorx_app_user;
```

### 6.4 ç´¢å¼•è®¾è®¡å»ºè®®

**mentor_payable_ledgers è¡¨ï¼š**

```sql
-- æŒ‰å¯¼å¸ˆæŸ¥è¯¢ï¼ˆå¯¼å¸ˆæŸ¥çœ‹è‡ªå·±çš„æœåŠ¡è®°å½•ï¼‰
CREATE INDEX idx_mentor_payable_ledgers_mentor ON mentor_payable_ledgers(mentor_id);

-- æŒ‰ç»“ç®—çŠ¶æ€æŸ¥è¯¢ï¼ˆç»“ç®—æ—¶è¿‡æ»¤pendingè®°å½•ï¼‰
CREATE INDEX idx_mentor_payable_ledgers_settlement ON mentor_payable_ledgers(settlement_status);

-- æŒ‰æœåŠ¡å®Œæˆæ—¶é—´æŸ¥è¯¢ï¼ˆæŒ‰æœˆç»Ÿè®¡ï¼‰
CREATE INDEX idx_mentor_payable_ledgers_completed ON mentor_payable_ledgers(service_completed_at);
```

**student_payment_ledgers è¡¨ï¼š**

```sql
-- æŒ‰å­¦ç”ŸæŸ¥è¯¢ï¼ˆå­¦ç”ŸæŸ¥çœ‹è‡ªå·±çš„æ”¯ä»˜è®°å½•ï¼‰
CREATE INDEX idx_student_payment_ledgers_student ON student_payment_ledgers(student_id);

-- æŒ‰çŠ¶æ€æŸ¥è¯¢ï¼ˆç­›é€‰pending/succeededï¼‰
CREATE INDEX idx_student_payment_ledgers_status ON student_payment_ledgers(status);

-- æŒ‰ç¡®è®¤æ—¶é—´æŸ¥è¯¢ï¼ˆè´¢åŠ¡å¯¹è´¦ï¼‰
CREATE INDEX idx_student_payment_ledgers_confirmed ON student_payment_ledgers(confirmed_at);
```

**settlement_ledgers è¡¨ï¼š**

```sql
-- æŒ‰å¯¼å¸ˆæŸ¥è¯¢
CREATE INDEX idx_settlement_ledgers_mentor ON settlement_ledgers(mentor_id);

-- æŒ‰æœˆä»½æŸ¥è¯¢ï¼ˆç»Ÿè®¡æœˆåº¦ç»“ç®—ï¼‰
CREATE INDEX idx_settlement_ledgers_month ON settlement_ledgers(settlement_month);

-- æŒ‰çŠ¶æ€æŸ¥è¯¢
CREATE INDEX idx_settlement_ledgers_status ON settlement_ledgers(status);
```

### 6.5 ç‰ˆæœ¬å˜æ›´å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¸»è¦å˜æ›´ | å½±å“è¡¨ |
|------|------|---------|-------|
| v2.21 | 2025-11-12 | æ–°å¢ç­è¯¾å¯¼å¸ˆå®šä»·è¡¨ï¼Œæ”¯æŒä¸‰ç§å®šä»·æ¨¡å¼ | class_mentor_prices (æ–°å¢) |
| v2.21 | 2025-11-12 | mentor_payable_ledgers æ–°å¢ classId å­—æ®µ | mentor_payable_ledgers (æ›´æ–°) |
| v2.21 | 2025-11-12 | åˆ›å»º Financial Domain è¯¦ç»†è®¾è®¡æ–‡æ¡£ | æ‰€æœ‰è¡¨ |
| v2.21 | 2025-11-04 | æ¶æ„ç®€åŒ–ï¼šåˆ é™¤å†—ä½™è¡¨ï¼Œå¹³è¡¡è´Ÿå€ºå€ºè¡¨ | student_payment_ledgers |
| v2.18 | 2025-11 | ç»“ç®—æ–¹å¼é‡æ„ï¼šæ”¯æŒ5ç§æ–¹å¼ï¼Œå«æ‰‹ç»­è´¹é…ç½® | settlement_ledgers, settlement_parameters |
| v2.18 | 2025-11 | æ˜ç¡®æµæ°´è¡¨èŒè´£ï¼Œç»Ÿä¸€å‘½åè§„èŒƒ | mentor_payable_ledgers |
| v2.17 | 2025-11 | è¡¨é‡å‘½åï¼Œæœ¯è¯­ç»Ÿä¸€ | æ‰€æœ‰æµæ°´è¡¨ |
| v2.16 | 2025-10 | åˆåŒæƒç›Šæ¥æºè¿½æº¯ | contract_service_entitlements |
| v2.15 | 2025-09 | Catalog æ¶æ„é‡æ„ | services, service_packages, products |
| v2.14 | 2025-08 | å½’æ¡£ç­–ç•¥ã€å†·çƒ­åˆ†ç¦» | service_ledgers_archive |
| v2.13 | 2025-07 | å››åŸŸæ¶æ„ç¡®ç«‹ | æ‰€æœ‰æ ¸å¿ƒè¡¨ |

### 2.7 class_mentor_prices (ç­è¯¾å¯¼å¸ˆå®šä»·è¡¨) ğŸ†•

**æ–‡ä»¶è·¯å¾„ï¼š** `src/infrastructure/database/schema/class-mentor-prices.schema.ts`

**åŸŸå½’å±ï¼š** Financial Domain

**èŒè´£è¯´æ˜ï¼š**
- ç®¡ç†ç­è¯¾ä¸­æ¯ä½å¯¼å¸ˆçš„æœåŠ¡å®šä»·ï¼ˆ2025-11-12 æ–°å¢ï¼‰
- ç­è¯¾åˆ›å»ºæ—¶ä¸ºå¯¼å¸ˆåˆ†é…å¹¶åˆ¶å®šä»·æ ¼
- æŒ‰ã€ŒæœåŠ¡åœºæ¬¡ã€è®¡è´¹ï¼Œè´¹ç”¨ä¸å‚ä¸å­¦ç”Ÿäººæ•°æ— å…³
- ä»·æ ¼å›ºå®šï¼ˆåˆ›å»ºååœ¨æ•´ä¸ªç­è¯¾å‘¨æœŸä¸å˜ï¼‰

**æ ¸å¿ƒè®¾è®¡è¯´æ˜ï¼ˆåŸºäº2025-11-12å†³ç­–ï¼‰ï¼š**

1. **ç­è¯¾ç»“æ„**ï¼šé‡‡ç”¨é€‰é¡¹ Bï¼ˆcourses â†’ classes ä¸¤å±‚ç»“æ„ï¼‰
   - `courses` è¡¨ï¼šè¯¾ç¨‹æ¨¡æ¿ï¼ˆServices Domainï¼‰
   - `classes` è¡¨ï¼šå…·ä½“å¼€ç­å®ä¾‹ï¼ˆServices Domainï¼‰
   - `class_mentor_prices` å…³è” `classes` è¡¨ï¼ˆå…·ä½“ç­çº§ï¼‰

2. **è®¡è´¹ç²’åº¦**ï¼šé€‰é¡¹ Bï¼ˆæŒ‰ã€ŒæœåŠ¡åœºæ¬¡ã€è®¡è´¹ï¼‰
   - æ¯ç»„ç»‡ä¸€æ¬¡ç­è¯¾è¾…å¯¼ = 1åœºæ¬¡
   - å¯¼å¸ˆè´¹ç”¨ = unitPrice Ã— 1ï¼ˆä¸å­¦ç”Ÿäººæ•°æ— å…³ï¼‰

3. **å®šä»·æœ‰æ•ˆæœŸ**ï¼šç­è¯¾åˆ›å»ºåä»·æ ¼å›ºå®š
   - ä¸éœ€è¦ `effectiveFrom`/`effectiveUntil` å­—æ®µ
   - ä»·æ ¼åœ¨æ•´ä¸ªç­è¯¾ç”Ÿå‘½å‘¨æœŸä¿æŒä¸å˜

4. **å­—æ®µè®¾è®¡**ï¼šä½¿ç”¨ `serviceType` è€Œé `serviceId`
   - ç›´æ¥å…³è”æœåŠ¡ç±»å‹æšä¸¾ï¼Œæ— éœ€æŸ¥è¯¢ services è¡¨
   - æ›´ç®€æ´ï¼ŒæŸ¥è¯¢æ€§èƒ½æ›´å¥½

```typescript
import { pgTable, uuid, numeric, varchar, boolean, timestamp, and, eq } from 'drizzle-orm/pg-core';
import { classes } from './classes.schema'; // æ³¨é‡Šå¤–é”®ï¼šServices Domain
import { users } from './users.schema';
import { serviceTypeEnum } from './enums/service-type.enum';

export const classMentorPrices = pgTable('class_mentor_prices', {
  id: uuid('id').defaultRandom().primaryKey(),

  // å…³è”å…³ç³»ï¼ˆè·¨åŸŸå¼•ç”¨ï¼Œæ³¨é‡Šå¤–é”®ï¼‰
  // âš ï¸ classes è¡¨å®šä¹‰åœ¨ Services Domainï¼Œä¸ä½¿ç”¨å¤–é”®çº¦æŸ
  classId: uuid('class_id').notNull(), // æ³¨é‡Šå¤–é”®ï¼šå…³è” Services Domain çš„ classes
  mentorId: uuid('mentor_id').notNull().references(() => users.id),

  // æœåŠ¡ç±»å‹ï¼ˆä½¿ç”¨æšä¸¾(è¿‡æ»¤æ‰ class, group_session)ï¼Œç›´æ¥å…³è”ï¼Œæ— éœ€æŸ¥è¯¢ services è¡¨ï¼‰
  // ä¾‹å¦‚ï¼š'gap_analysis', 'resume_review', 'group_session', 'workshop', 'class'
  serviceType: serviceTypeEnum('service_type').notNull(),

  // å®šä»·ä¿¡æ¯ï¼ˆæŒ‰åœºæ¬¡è®¡è´¹ï¼‰
  // é‡‘é¢ç²¾åº¦ï¼šunitPrice ä¿ç•™1ä½å°æ•°ï¼ˆå¦‚ $99.5/æ¬¡ï¼‰
  unitPrice: numeric('unit_price', { precision: 12, scale: 1 }).notNull(),
  currency: varchar('currency', { length: 3 }).notNull().default('USD'),

  // çŠ¶æ€ç®¡ç†
  isActive: boolean('is_active').notNull().default(true),

  // å¤‡æ³¨
  notes: varchar('notes', { length: 500 }),

  // å®¡è®¡å­—æ®µ
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
  createdBy: uuid('created_by').notNull().references(() => users.id),
});

// ç´¢å¼•
// CREATE INDEX idx_class_mentor_prices_class ON class_mentor_prices(class_id);
// CREATE INDEX idx_class_mentor_prices_mentor ON class_mentor_prices(mentor_id);
// CREATE INDEX idx_class_mentor_prices_service_type ON class_mentor_prices(service_type);
// CREATE INDEX idx_class_mentor_prices_active ON class_mentor_prices(is_active);

// å”¯ä¸€çº¦æŸï¼šåŒä¸€ç­çº§ä¸­ï¼ŒåŒä¸€å¯¼å¸ˆå¯¹åŒä¸€æœåŠ¡åªèƒ½æœ‰ä¸€ä¸ªä»·æ ¼
// CREATE UNIQUE INDEX idx_class_mentor_prices_unique
// ON class_mentor_prices(class_id, mentor_id, service_type);
```

**å…³è”å…³ç³»è¯´æ˜ï¼š**

```
courses (Services Domain)
  â””â”€â”€ classes (Services Domain)
        â””â”€â”€ class_mentor_prices (Financial Domain)
              â”œâ”€â”€ classId (æ³¨é‡Šå¤–é”® â†’ classes.id)
              â”œâ”€â”€ mentorId (å¤–é”® â†’ users.id)
              â””â”€â”€ serviceType (æšä¸¾ï¼Œç›´æ¥å¼•ç”¨)
```

**ä½¿ç”¨åœºæ™¯ç¤ºä¾‹ï¼š**

```typescript
// åœºæ™¯ï¼šä¸º"æ±‚èŒå†²åˆºç­ 2025Q4"è®¾ç½®å¯¼å¸ˆä»·æ ¼
// ç­è¯¾åˆ›å»ºæ—¶ï¼Œä¸ºæ¯ä½å¯¼å¸ˆå•ç‹¬å®šä»·

// ç¤ºä¾‹1ï¼šä¸ºå¯¼å¸ˆ A è®¾ç½® GAP åˆ†æä»·æ ¼
{
  classId: "class-uuid-001",        // "æ±‚èŒå†²åˆºç­ 2025Q4"
  mentorId: "mentor-uuid-001",      // å¯¼å¸ˆ A
  serviceType: "gap_analysis",      // GAPåˆ†ææœåŠ¡
  unitPrice: 120.0,                 // $120/åœºæ¬¡
  currency: "USD",
  serviceName: "GAPåˆ†æ",
  isActive: true,
  createdBy: "counselor-uuid-001",
}

// ç¤ºä¾‹2ï¼šä¸ºå¯¼å¸ˆ A è®¾ç½®ç®€å†ä¿®æ”¹ä»·æ ¼
{
  classId: "class-uuid-001",
  mentorId: "mentor-uuid-001",
  serviceType: "resume_review",     // ç®€å†ä¿®æ”¹æœåŠ¡
  unitPrice: 80.0,                  // $80/åœºæ¬¡
  currency: "USD",
  serviceName: "ç®€å†ä¿®æ”¹",
  isActive: true,
  createdBy: "counselor-uuid-001",
}

// ç¤ºä¾‹3ï¼šä¸ºå¯¼å¸ˆ B è®¾ç½®ä»·æ ¼ï¼ˆå¯èƒ½æ¯”å¯¼å¸ˆ A é«˜ï¼‰
{
  classId: "class-uuid-001",
  mentorId: "mentor-uuid-002",      // å¯¼å¸ˆ B
  serviceType: "gap_analysis",
  unitPrice: 150.0,                 // $150/åœºæ¬¡ï¼ˆé«˜äºå¯¼å¸ˆ Aï¼‰
  currency: "USD",
  serviceName: "GAPåˆ†æ",
  isActive: true,
  createdBy: "counselor-uuid-001",
}
```

**æ•°æ®å®Œæ•´æ€§è¯´æ˜ï¼ˆDDDåŸåˆ™ï¼‰ï¼š**

```typescript
// âš ï¸ è·¨åŸŸå¼•ç”¨ç­–ç•¥ï¼š
// class_mentor_prices å®šä¹‰åœ¨ Financial Domain
// classes è¡¨å®šä¹‰åœ¨ Services Domain
// è·¨åŸŸå¼•ç”¨åº”æ³¨é‡Šå¤–é”®çº¦æŸï¼Œé€šè¿‡åº”ç”¨å±‚ä¿è¯å®Œæ•´æ€§

// âŒ ä¸æ¨èï¼šä½¿ç”¨å¤–é”®çº¦æŸ
// classId: uuid('class_id').references(() => classes.id)

// âœ… æ¨èï¼šæ³¨é‡Šå¤–é”®ï¼Œåº”ç”¨å±‚éªŒè¯
classId: uuid('class_id').notNull(), // æ³¨é‡Šå¤–é”®ï¼šå…³è” Services Domain çš„ classes

// å®ç°æ–¹å¼ï¼š
class ClassMentorPriceService {
  async createPrice(dto) {
    // 1. åº”ç”¨å±‚éªŒè¯ï¼šè°ƒç”¨ ClassService éªŒè¯ classId å­˜åœ¨
    const classInfo = await classService.findById(dto.classId);
    if (!classInfo) throw new Error('Class not found');

    // 2. éªŒè¯ mentorId å­˜åœ¨
    const mentor = await userService.findById(dto.mentorId);
    if (!mentor || mentor.role !== 'mentor') throw new Error('Mentor not found');

    // 3. åˆ›å»ºä»·æ ¼è®°å½•
    return await db.insert(classMentorPrices).values(dto);
  }
}
```

**è®¡è´¹æµç¨‹ç¤ºä¾‹ï¼š**

```typescript
// ç­è¯¾æœåŠ¡å®Œæˆåï¼ŒæŸ¥è¯¢å¯¼å¸ˆä»·æ ¼å¹¶åˆ›å»º billing è®°å½•

const price = await db.query.classMentorPrices.findFirst({
  where: and(
    eq(classMentorPrices.classId, classId),
    eq(classMentorPrices.mentorId, mentorId),
    eq(classMentorPrices.serviceType, serviceType),
    eq(classMentorPrices.isActive, true)
  ),
});

if (!price) {
  throw new Error(
    `æœªæ‰¾åˆ°ç­è¯¾å®šä»·ï¼šclassId=${classId}, mentorId=${mentorId}, serviceType=${serviceType}`
  );
}

// åˆ›å»º mentor_payable_ledgers è®°å½•ï¼ˆç­è¯¾æœåŠ¡ï¼‰
const billingRecord = {
  classId: classId,           // å…³è”ç­è¯¾
  sessionId: null,            // ç­è¯¾ä¸ä½¿ç”¨ sessionId

  mentorId: mentorId,
  studentId: null,            // ç­è¯¾æŒ‰åœºæ¬¡è®¡è´¹ï¼Œä¸å…³è”å…·ä½“å­¦ç”Ÿ

  serviceType: serviceType,
  serviceName: `ç­è¯¾-${price.serviceName}`,

  quantity: 1,                // 1åœºæ¬¡
  unitPrice: price.unitPrice, // ä» class_mentor_prices æŸ¥è¯¢
  totalAmount: price.unitPrice,

  serviceCompletedAt: new Date(),
  status: 'pending',
  settlementStatus: 'pending',
};

// å¦‚æœä¸€ä¸ªæœˆå†…å¯¼å¸ˆ A å®Œæˆ 5 æ¬¡ GAP åˆ†æ
// æ€»è´¹ç”¨ = $120 Ã— 5 = $600ï¼ˆä¸å­¦ç”Ÿäººæ•°æ— å…³ï¼‰
```

**è®¡è´¹è§„åˆ™å¯¹æ¯”ï¼šç­è¯¾ vs 1å¯¹1**

| å¯¹æ¯”é¡¹ | ç­è¯¾ (classId) | 1å¯¹1 (sessionId) |
|--------|----------------|------------------|
| classId | æœ‰å€¼ | null |
| sessionId | null | æœ‰å€¼ |
| studentId | nullï¼ˆæŒ‰åœºæ¬¡ï¼‰ | æœ‰å€¼ï¼ˆå…·ä½“å­¦ç”Ÿï¼‰ |
| quantity | 1ï¼ˆåœºæ¬¡ï¼‰ | Nï¼ˆæœåŠ¡æ¬¡æ•°ï¼‰ |
| è®¡è´¹æ–¹å¼ | æŒ‰åœºæ¬¡ï¼Œä¸äººæ•°æ— å…³ | æŒ‰æ¬¡/æŒ‰å°æ—¶ |
| æŸ¥è¯¢ä»·æ ¼è¡¨ | class_mentor_prices | mentor_prices |
| ç»“ç®—æ–¹å¼ | æ‰¹é‡ç»“ç®—ï¼ˆæŒ‰ç­çº§ï¼‰ | å•ç‹¬ç»“ç®—ï¼ˆæŒ‰å­¦ç”Ÿï¼‰ |

---

## 8. è·¨åŸŸåä½œæ¨¡å¼

> ** è®¨è®ºæ—¥æœŸ **ï¼š2025-11-12
> ** è®¨è®ºèŒƒå›´ **ï¼šclass_mentor_prices å’Œ mentor_payable_ledgers çš„è·¨åŸŸå¼•ç”¨ç­–ç•¥
> ** æ ¸å¿ƒåŸåˆ™ **ï¼šæ³¨é‡Šå¤–é”®çº¦æŸ + åº”ç”¨å±‚éªŒè¯ + äº‹ä»¶é©±åŠ¨åŒæ­¥

---

### 8.1 è·¨åŸŸå¼•ç”¨ç­–ç•¥ï¼ˆDDD æ¶æ„ï¼‰

#### 8.1.1 ä¸ä½¿ç”¨å¤–é”®çº¦æŸçš„åœºæ™¯

** Financial Domain â†’ Services Domain **

```typescript
// class_mentor_prices å¼•ç”¨ classesï¼ˆServices Domainï¼‰
classMentorPrices = pgTable('class_mentor_prices', {
  classId: uuid('class_id').notNull(),
  // âŒ æ³¨é‡Šå¤–é”®ï¼šå…³è” Services Domain çš„ classes
  // åŸå› ï¼šä¿æŒåŸŸè¾¹ç•Œæ¸…æ™°ï¼Œå…è®¸ç‹¬ç«‹æ¼”è¿›
});

// mentor_payable_ledgers å¼•ç”¨ sessions/classesï¼ˆServices Domainï¼‰
mentorPayableLedgers = pgTable('mentor_payable_ledgers', {
  sessionId: uuid('session_id'), // æ³¨é‡Šå¤–é”®ï¼š1å¯¹1æœåŠ¡
  classId: uuid('class_id'),     // æ³¨é‡Šå¤–é”®ï¼šç­è¯¾æœåŠ¡
});
```

** åŸå› è¯´æ˜ï¼š **
- âœ… ä¿æŒåŸŸçš„ç‹¬ç«‹æ€§å’Œæ¾è€¦åˆ
- âœ… é¿å…è·¨åŸŸçº§è”åˆ é™¤å½±å“
- âœ… å…è®¸ä¸åŒåŸŸç‹¬ç«‹æ¼”è¿›ï¼ˆä¸åŒå‘å¸ƒå‘¨æœŸï¼‰
- âŒ ç‰ºç‰²æ•°æ®åº“çº§æ•°æ®å®Œæ•´æ€§ä¿è¯

#### 8.1.2 æ•°æ®å®Œæ•´æ€§ä¿è¯æœºåˆ¶

** åº”ç”¨å±‚éªŒè¯ï¼ˆå¼ºåˆ¶ï¼‰ **

```typescript
class ClassMentorPriceService {
  async createPrice(dto: CreateClassMentorPriceDto) {
    // 1. ä¸¥æ ¼éªŒè¯ï¼šè°ƒç”¨ Services Domain æ¥å£
    const classInfo = await classService.findById(dto.classId);

    // 2. ** å†³ç­– **ï¼šclass ä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸ï¼ˆä¸¥æ ¼éªŒè¯ï¼‰
    if (!classInfo) {
      throw new Error(`Class ${dto.classId} not found`);
    }

    // 3. éªŒè¯å¯¼å¸ˆå­˜åœ¨
    const mentor = await userService.findById(dto.mentorId);
    if (!mentor || mentor.role !== 'mentor') {
      throw new Error(`Mentor ${dto.mentorId} not found`);
    }

    // 4. åˆ›å»ºä»·æ ¼è®°å½•
    return await this.db.insert(classMentorPrices).values(dto);
  }
}
```

** å¤„ç†è·¨åŸŸæ•°æ®åˆ é™¤ **

Services Domain åˆ é™¤ class æ—¶ï¼Œå‘å¸ƒäº‹ä»¶é€šçŸ¥ Financial Domainï¼š

```typescript
// Services Domain
class ClassService {
  async deleteClass(classId: string) {
    // 1. åˆ é™¤ class
    await this.db.delete(classes).where(eq(classes.id, classId));

    // 2. å‘å¸ƒåˆ é™¤äº‹ä»¶
    await eventBus.publish('class.deleted', { classId });
  }
}

// Financial Domain ç›‘å¬äº‹ä»¶
@OnEvent('class.deleted')
async handleClassDeleted(event: ClassDeletedEvent) {
  // ** å†³ç­– **ï¼šæ ‡è®°ä¸º inactiveï¼Œè€Œéç‰©ç†åˆ é™¤
  await this.db.update(classMentorPrices)
    .set({ isActive: false })
    .where(eq(classMentorPrices.classId, event.classId));

  // æ ‡è®° mentor_payable_ledgers ä¸ºæ— æ•ˆï¼ˆå¯é€‰ï¼‰
  await this.db.update(mentorPayableLedgers)
    .set({ metadata: { isValid: false } })
    .where(eq(mentorPayableLedgers.classId, event.classId));
}
```

** å†³ç­–æ€»ç»“ï¼š**
- **éªŒè¯**ï¼šä¸¥æ ¼éªŒè¯ï¼Œä¸å­˜åœ¨åˆ™æŠ›å¼‚å¸¸
- **åˆ é™¤**ï¼šäº‹ä»¶é€šçŸ¥ + æ ‡è®°éæ¿€æ´»ï¼ˆä¿ç•™å†å²è®°å½•ï¼‰
- **æ›´æ–°**ï¼šæ— éœ€åŒæ­¥ï¼Œå¿«ç…§å­˜å‚¨å¯æ¥å—è¿‡æ—¶

---

### 8.2 è·¨åŸŸæŸ¥è¯¢ä¼˜åŒ–

#### 8.2.1 mentor_payable_ledgers æŸ¥è¯¢ä¼˜åŒ–

**é—®é¢˜**ï¼šæŸ¥è¯¢å¯¼å¸ˆè®¡è´¹è®°å½•æ—¶ï¼Œéœ€è¦åŒºåˆ† 1å¯¹1 å’Œ ç­è¯¾æœåŠ¡

**å†³ç­–**ï¼š**ä½¿ç”¨ UNION ALL æŸ¥è¯¢**ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰

```typescript
// æŸ¥è¯¢æŸä½å¯¼å¸ˆçš„æ‰€æœ‰è®¡è´¹è®°å½•ï¼ˆ1å¯¹1 + ç­è¯¾ï¼‰
// **å†³ç­–ï¼šé€‰é¡¹ A** - UNION ALL å•æŸ¥è¯¢

async getMentorBilling(mentorId: string, pagination: PaginationDto) {
  const results = await this.db.execute(sql`
    SELECT
      id, session_id, class_id,
      service_type, service_name,
      session_title, student_name, class_name,
      unit_price, total_amount, currency,
      service_completed_at, settlement_status
    FROM mentor_payable_ledgers
    WHERE mentor_id = ${mentorId} AND session_id IS NOT NULL

    UNION ALL

    SELECT
      id, session_id, class_id,
      service_type, service_name,
      session_title, student_name, class_name,
      unit_price, total_amount, currency,
      service_completed_at, settlement_status
    FROM mentor_payable_ledgers
    WHERE mentor_id = ${mentorId} AND class_id IS NOT NULL

    ORDER BY service_completed_at DESC
    LIMIT ${pagination.pageSize} OFFSET ${(pagination.page - 1) * pagination.pageSize}
  `);

  return results;
}

// ç´¢å¼•ä¼˜åŒ–
// CREATE INDEX idx_mentor_payable_session ON mentor_payable_ledgers(mentor_id, session_id) WHERE session_id IS NOT NULL;
// CREATE INDEX idx_mentor_payable_class ON mentor_payable_ledgers(mentor_id, class_id) WHERE class_id IS NOT NULL;
```

**ä¼˜ç¼ºç‚¹åˆ†æï¼š**
- âœ… ä¼˜ç‚¹ï¼šä¸€æ¬¡æŸ¥è¯¢ï¼Œæ€§èƒ½å¥½ï¼›åˆ©ç”¨æ•°æ®åº“ä¼˜åŒ–
- âŒ ç¼ºç‚¹ï¼šSQL è¾ƒå¤æ‚ï¼›éœ€è¦ç»´æŠ¤ä¸¤ä¸ª WHERE æ¡ä»¶

**å¯¹æ¯”æ–¹æ¡ˆï¼ˆå·²å¦å†³ï¼‰ï¼š**
```typescript
// é€‰é¡¹ Bï¼šä¸¤ä¸ªç‹¬ç«‹æŸ¥è¯¢ï¼ˆä»£ç æ¸…æ™°ï¼Œä½†ä¸¤æ¬¡æŸ¥è¯¢ï¼‰
// é€‰é¡¹ Cï¼šæ–°å¢ service_mode å­—æ®µï¼ˆéœ€è¦é¢å¤–ç»´æŠ¤å­—æ®µï¼‰
```

---

### 8.3 å¿«ç…§è®¾è®¡ç­–ç•¥

#### 8.3.1 mentor_payable_ledgers å¿«ç…§å­—æ®µ

**é—®é¢˜**ï¼šæŸ¥è¯¢è®¡è´¹è®°å½•æ—¶ï¼Œéœ€è¦æ˜¾ç¤ºå…³è”çš„æœåŠ¡æ ‡é¢˜ã€å­¦ç”Ÿå§“åç­‰ä¿¡æ¯

**å†³ç­–**ï¼š**å­˜å‚¨å¿«ç…§å­—æ®µ**ï¼ˆé€‰é¡¹ Bï¼‰- æ— éœ€è·¨åŸŸæŸ¥è¯¢

```typescript
// mentor_payable_ledgers æ–°å¢å¿«ç…§å­—æ®µ
export const mentorPayableLedgers = pgTable('mentor_payable_ledgers', {
  // ... å…¶ä»–å­—æ®µ

  // å¿«ç…§å­—æ®µï¼ˆåˆ›å»ºæ—¶å­˜å‚¨ï¼Œä¾¿äºæŸ¥è¯¢æ˜¾ç¤ºï¼‰
  sessionTitle: varchar('session_title', { length: 200 }),  // 1å¯¹1æœåŠ¡æ ‡é¢˜
  studentName: varchar('student_name', { length: 200 }),    // å­¦ç”Ÿå§“åï¼ˆ1å¯¹1ï¼‰
  className: varchar('class_name', { length: 200 }),        // ç­è¯¾åç§°

  // åˆ›å»ºæ—¶åŒæ­¥æŸ¥è¯¢å¹¶å­˜å‚¨å¿«ç…§
  // ä¼˜ç‚¹ï¼šæŸ¥è¯¢æ€§èƒ½å¥½ï¼ŒFinancial Domain æ•°æ®è‡ªåŒ…å«
  // ç¼ºç‚¹ï¼šå¿«ç…§å¯èƒ½è¿‡æ—¶ï¼ˆæ¥å—ï¼Œç¬¦åˆå®¡è®¡è¦æ±‚ï¼‰
});

// åˆ›å»ºæ—¶å­˜å‚¨å¿«ç…§
async createBillingRecord(dto) {
  // æŸ¥è¯¢ç›¸å…³ä¿¡æ¯
  let sessionTitle = null;
  let studentName = null;
  let className = null;

  if (dto.sessionId) {
    const session = await sessionService.findById(dto.sessionId);
    sessionTitle = session.title;
    const student = await userService.findById(session.studentId);
    studentName = student.name;
  }

  if (dto.classId) {
    const classInfo = await classService.findById(dto.classId);
    className = classInfo.name;
  }

  // åˆ›å»ºè®°å½•å¹¶å­˜å‚¨å¿«ç…§
  return await db.insert(mentorPayableLedgers).values({
    ...dto,
    sessionTitle,
    studentName,
    className,
  });
}
```

**å†³ç­–æ€»ç»“ï¼š**
- **å­˜å‚¨å¿«ç…§**ï¼šsessionTitle, studentName, className
- **åˆ›å»ºæ—¶å­˜å‚¨**ï¼šåŒæ­¥æŸ¥è¯¢å¹¶å­˜å‚¨å¿«ç…§
- **ä¸æ›´æ–°**ï¼šæ¥å—å¿«ç…§è¿‡æ—¶ï¼ˆç¬¦åˆå®¡è®¡è¦æ±‚ï¼Œå†å²è®°å½•åº”ä¿æŒåˆ›å»ºæ—¶çŠ¶æ€ï¼‰

#### 8.3.2 å¿«ç…§ vs å®æ—¶æŸ¥è¯¢å¯¹æ¯”

| æ–¹æ¡ˆ | å®ç°æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | å†³ç­– |
|------|---------|------|------|------|
| **å¿«ç…§å­˜å‚¨** | åˆ›å»ºæ—¶å­˜å‚¨å…³è”å¯¹è±¡åç§° | æ€§èƒ½å¥½ï¼Œæ— éœ€è·¨åŸŸæŸ¥è¯¢ | æ•°æ®å¯èƒ½è¿‡æ—¶ | âœ… **é‡‡ç”¨** |
| **å®æ—¶æŸ¥è¯¢** | é€šè¿‡ Services æŸ¥è¯¢ | æ•°æ®å®æ—¶ | æ€§èƒ½å·®ï¼ŒN+1 é—®é¢˜ | âŒ å¦å†³ |
| **å†—ä½™å­˜å‚¨** | å­˜å‚¨æ‰€æœ‰å…³è”å­—æ®µ | æŸ¥è¯¢æ€§èƒ½å¥½ | æ•°æ®å†—ä½™ï¼ŒåŒæ­¥å¤æ‚ | âŒ å¦å†³ |

** è®¾è®¡ç†å¿µï¼š** å†å²è®°å½•åº”è¯¥ä¿æŒåˆ›å»ºæ—¶çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯å®æ—¶çŠ¶æ€ï¼ˆç¬¦åˆå®¡è®¡å’Œåˆè§„è¦æ±‚ï¼‰

---

### 8.4 æŸ¥è¯¢å®¹é”™å¤„ç†

#### 8.4.1 å­¤å„¿è®°å½•æ£€æµ‹

**é—®é¢˜**ï¼šå¦‚æœ class è¢«åˆ é™¤ï¼Œclass_mentor_prices å’Œ mentor_payable_ledgers å¯èƒ½å˜æˆå­¤å„¿è®°å½•

**å†³ç­–**ï¼š**æŸ¥è¯¢æ—¶æ£€æµ‹å¹¶æ ‡è®°å¼‚å¸¸**ï¼ˆé€‰é¡¹ Aï¼‰

```typescript
// æŸ¥è¯¢ mentor_payable_ledgers æ—¶æ£€æµ‹å­¤å„¿è®°å½•
async getMentorBilling(mentorId: string, filters: QueryFilters) {
  const billings = await db.query.mentorPayableLedgers.findMany({
    where: and(
      eq(mentorPayableLedgers.mentorId, mentorId),
      gte(mentorPayableLedgers.serviceCompletedAt, filters.startDate),
      lte(mentorPayableLedgers.serviceCompletedAt, filters.endDate)
    ),
    orderBy: desc(mentorPayableLedgers.serviceCompletedAt),
  });

  // æ£€æµ‹ç­è¯¾æœåŠ¡å…³è”çš„ class æ˜¯å¦å­˜åœ¨
  return await Promise.all(
    billings.map(async (billing) => {
      const isOrphan = billing.classId && !(await classService.exists(billing.classId));

      return {
        ...billing,
        _orphan: isOrphan,  // æ ‡è®°å¼‚å¸¸
        _warning: isOrphan ? 'å…³è”çš„ç­è¯¾å·²ä¸å­˜åœ¨' : null,
        _metadata: isOrphan ? { orphanReason: 'class_deleted' } : null,
      };
    })
  );
}

// å‰ç«¯æ˜¾ç¤º
// {
//   id: 'billing-001',
//   amount: 120.00,
//   className: 'æ±‚èŒå†²åˆºç­ 2025Q4',
//   _orphan: true,
//   _warning: 'å…³è”çš„ç­è¯¾å·²ä¸å­˜åœ¨',
// }
```

**å†³ç­–æ€»ç»“ï¼š**
- âœ… **ä¸éšè—é—®é¢˜**ï¼šè¿”å›æ•°æ®ä½†æ ‡è®°å¼‚å¸¸
- âœ… **ä¸åˆ é™¤æ•°æ®**ï¼šä¿ç•™å†å²è®°å½•ï¼Œå³ä½¿å…³è”å¯¹è±¡å·²åˆ é™¤
- âœ… **æ˜ç¡®æç¤º**ï¼šå‰ç«¯æ˜¾ç¤ºè­¦å‘Šï¼Œæç¤ºæ•°æ®å¼‚å¸¸
- âœ… **ä¾¿äºæ’æŸ¥**ï¼š_orphan æ ‡è®°æ–¹ä¾¿è¿‡æ»¤å’Œç»Ÿè®¡

#### 8.4.2 å®šæœŸä¸€è‡´æ€§æ£€æŸ¥ï¼ˆå†³ç­–ï¼šä¸éœ€è¦ï¼‰

**é€‰é¡¹å¯¹æ¯”ï¼š**

| é€‰é¡¹ | æ£€æŸ¥é¢‘ç‡ | å¤„ç†æ–¹å¼ | å†³ç­– |
|------|---------|---------|------|
| A | æ¯æ—¥æ£€æŸ¥ + å‘Šè­¦ | å‘é€å‘Šè­¦ï¼Œäººå·¥å¤„ç† | âŒ å¦å†³ |
| B | æ¯å‘¨æ£€æŸ¥ + è‡ªåŠ¨ä¿®å¤ | è‡ªåŠ¨æ ‡è®°æˆ–åˆ é™¤ | âŒ å¦å†³ |
| C | æŒ‰éœ€æ£€æŸ¥ | æ‰‹åŠ¨è¿è¡Œè„šæœ¬ | âœ… **é‡‡ç”¨** |

**ç†ç”±ï¼š**
- å­¤å„¿è®°å½•äº§ç”Ÿæ¦‚ç‡ä½ï¼ˆæœ‰äº‹ä»¶åŒæ­¥æœºåˆ¶ï¼‰
- æŸ¥è¯¢æ—¶å·²æ ‡è®°å¼‚å¸¸ï¼Œä¸å½±å“ä¸šåŠ¡
- å®šæœŸæ£€æŸ¥å¢åŠ ç³»ç»Ÿå¤æ‚åº¦
- æŒ‰éœ€æ£€æŸ¥è¶³å¤Ÿï¼ˆå‘ç°é—®é¢˜å†å¤„ç†ï¼‰

**å®ç°æ–¹æ¡ˆï¼šæŒ‰éœ€æ£€æŸ¥**
```typescript
// æä¾›æ‰‹åŠ¨æ£€æŸ¥è„šæœ¬
// npm run check:integrity

// è„šæœ¬åŠŸèƒ½ï¼š
// 1. æ£€æŸ¥ class_mentor_prices çš„å­¤å„¿è®°å½•
// 2. æ£€æŸ¥ mentor_payable_ledgers çš„å­¤å„¿è®°å½•
// 3. ç”Ÿæˆ HTML/JSON æŠ¥å‘Š
// 4. ä¸è‡ªåŠ¨ä¿®å¤ï¼ˆéœ€è¦äººå·¥ç¡®è®¤ï¼‰

// ä½¿ç”¨ç¤ºä¾‹
const integrityChecker = new CrossDomainIntegrityChecker();
const report = await integrityChecker.check();
console.log('å‘ç° ${report.orphanRecords.length} æ¡å­¤å„¿è®°å½•');
await integrityChecker.generateReport(report, './integrity-report.html');
```

---

### 8.5 è·¨åŸŸåä½œå†³ç­–æ±‡æ€»

| è®®é¢˜ | é—®é¢˜ | å†³ç­– | å®ç°æ–¹å¼ | åŸå›  |
|------|------|------|---------|------|
| **1. class_mentor_prices éªŒè¯** | classId ä¸å­˜åœ¨å¦‚ä½•å¤„ç†ï¼Ÿ | ** ä¸¥æ ¼éªŒè¯ ** | æŠ›å‡ºå¼‚å¸¸ | é˜²æ­¢å­¤å„¿è®°å½• |
| ** 2. class åˆ é™¤å¤„ç† ** | å…³è”è®°å½•å¦‚ä½•å¤„ç†ï¼Ÿ | ** äº‹ä»¶é€šçŸ¥ + æ ‡è®°éæ¿€æ´» ** | ç›‘å¬ class.deleted äº‹ä»¶ | ä¿ç•™å†å²æ•°æ® |
| ** 3. class å˜æ›´åŒæ­¥ ** | å¿«ç…§æ˜¯å¦æ›´æ–°ï¼Ÿ | ** ä¸æ›´æ–° ** | æ¥å—å¿«ç…§è¿‡æ—¶ | ç¬¦åˆå®¡è®¡è¦æ±‚ |
| ** 4. mentor_payable_ledgers æŸ¥è¯¢ ** | 1å¯¹1 å’Œ ç­è¯¾å¦‚ä½•æŸ¥è¯¢ï¼Ÿ | ** UNION ALL ** | å•æŸ¥è¯¢ï¼Œæ€§èƒ½ä¼˜å…ˆ | æ€§èƒ½å¥½ï¼Œåˆ©ç”¨ç´¢å¼• |
| ** 5. å¿«ç…§å­˜å‚¨ ** | æ˜¯å¦å­˜å‚¨å¿«ç…§ï¼Ÿ | ** å­˜å‚¨å¿«ç…§ ** | sessionTitle, studentName, className | æ— éœ€è·¨åŸŸæŸ¥è¯¢ |
| ** 6. å¿«ç…§æ›´æ–° ** | class å˜æ›´æ˜¯å¦æ›´æ–°å¿«ç…§ï¼Ÿ | ** ä¸æ›´æ–° ** | æ¥å—å¿«ç…§è¿‡æ—¶ | å†å²è®°å½•åº”ä¿æŒåŸæ · |
| ** 7. å®šæœŸä¸€è‡´æ€§æ£€æŸ¥ ** | æ˜¯å¦éœ€è¦å®šæ—¶ä»»åŠ¡ï¼Ÿ | ** ä¸éœ€è¦ ** | æŒ‰éœ€æ‰‹åŠ¨æ£€æŸ¥ | å¤æ‚åº¦ä½ï¼Œè¶³å¤Ÿç”¨ |
| ** 8. æŸ¥è¯¢å®¹é”™ ** | å­¤å„¿è®°å½•å¦‚ä½•å¤„ç†ï¼Ÿ | ** æ ‡è®°å¼‚å¸¸ ** | _orphan: true, _warning | ä¸éšè—é—®é¢˜ï¼Œä¾¿äºæ’æŸ¥ |

---

## ğŸ“Œ è®¾è®¡åŸåˆ™æ€»ç»“

### âœ… DOï¼ˆæ­£ç¡®çš„åšæ³•ï¼‰

1. **æƒè´£åˆ†ç¦»**ï¼šFinancial Domain åªç®¡ç†è´¢åŠ¡æ•°æ®ï¼Œä¸å¹²é¢„ä¸šåŠ¡é€»è¾‘
2. **äº‹ä»¶é©±åŠ¨**ï¼šè·¨åŸŸæ•°æ®å˜æ›´ä½¿ç”¨äº‹ä»¶é€šçŸ¥ï¼Œè€Œéç›´æ¥è°ƒç”¨
3. **æœ€ç»ˆä¸€è‡´æ€§**ï¼šé€šè¿‡äº‹ä»¶é©±åŠ¨ä¿è¯å„åŸŸæ•°æ®æœ€ç»ˆä¸€è‡´
4. **Append-Only**ï¼šæµæ°´è¡¨è®°å½•ä¸å¯ä¿®æ”¹ï¼Œä¿è¯å®¡è®¡è¿½è¸ªå®Œæ•´æ€§
5. **é‡‘é¢ç²¾åº¦**ï¼šå•ä»·ä¿ç•™1ä½å°æ•°ï¼Œæ€»é¢ä¿ç•™2ä½å°æ•°
6. **å¿«ç…§è®¾è®¡**ï¼šå…³é”®é‡‘é¢å­—æ®µä¿å­˜å¿«ç…§ï¼Œé˜²æ­¢å‚æ•°å˜æ›´å½±å“å†å²æ•°æ®
7. **è´¢åŠ¡ç¡®è®¤**ï¼šä¸å¯¹æ¥ç¬¬ä¸‰æ–¹æ”¯ä»˜ï¼Œç”±è´¢åŠ¡æ‰‹åŠ¨ç¡®è®¤åˆ°è´¦
8. **è·¨åŸŸé˜²è…**ï¼šé€šè¿‡å‚æ•°ä¼ å…¥è€Œéç›´æ¥æ•°æ®åº“è®¿é—®

### âŒ DON'Tï¼ˆé”™è¯¯çš„åšæ³•ï¼‰

1. **ç¦æ­¢ç›´æ¥ä¿®æ”¹è·¨åŸŸæ•°æ®**ï¼šFinancial ä¸èƒ½ç›´æ¥å†™ Contract çš„è¡¨
2. **ç¦æ­¢ç»•è¿‡äº‹ä»¶ç›´æ¥æ›´æ–°**ï¼šå¿…é¡»é€šè¿‡äº‹ä»¶é€šçŸ¥è®©æ•°æ®æ‹¥æœ‰è€…è‡ªå·±æ›´æ–°
3. **ç¦æ­¢è·¨åŸŸäº‹åŠ¡**ï¼šä¸ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œé‡‡ç”¨ Saga æ¨¡å¼
4. **ç¦æ­¢å¾ªç¯ä¾èµ–**ï¼šé¿å… A ä¾èµ– Bï¼ŒB åˆä¾èµ– A
5. **ç¦æ­¢ä¿®æ”¹æµæ°´è®°å½•**ï¼šAppend-only è¡¨ä¸æä¾› UPDATE/DELETE æ¥å£
6. **ç¦æ­¢é¡¾é—®å‚ä¸æ”¶ç›Š**ï¼šé¡¾é—®ä¸å‚ä¸æ”¶ç›Šåˆ†é…ï¼Œä¸åœ¨ä»»ä½•æ”¶ç›Šç›¸å…³è¡¨ä¸­å‡ºç°

---

**æ–‡æ¡£ç»´æŠ¤è€…ï¼š** Claude Code
**æœ€åæ›´æ–°ï¼š** 2025-11-12
**å…³è”æ–‡æ¡£ï¼š**
- BILLING_MODULE_DESIGN.md (ä¸»è®¾è®¡æ–‡æ¡£)
- CONTRACT_DOMAIN_DESIGN.md (åˆåŒåŸŸè®¾è®¡)
- CATALOG_DOMAIN_DESIGN.md (äº§å“åŸŸè®¾è®¡)
