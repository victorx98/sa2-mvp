# domainEvents è¡¨ä½¿ç”¨åˆ†ææŠ¥å‘Š

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**ç”Ÿæˆæ—¥æœŸ**: 2025-11-14
**æ–‡æ¡£ç±»å‹**: æŠ€æœ¯æŠ¥å‘Š

---

## æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æäº† SA2-MVP é¡¹ç›®ä¸­ `domainEvents` è¡¨çš„ä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬æ•°æ®å†™å…¥ã€æŸ¥è¯¢ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œçš„å®Œæ•´åœºæ™¯å’ŒæŠ€æœ¯å®ç°ã€‚

## ğŸ”§ è¡¨ç»“æ„å®šä¹‰

### Schema æ–‡ä»¶
**è·¯å¾„**: `src/infrastructure/database/schema/domain-events.schema.ts`

### è¿ç§»æ–‡ä»¶
**è·¯å¾„**: `src/infrastructure/database/migrations/0003_serious_reaper.sql`

### è®¾è®¡æ¨¡å¼
è¯¥è¡¨å®ç°äº†**äº‹åŠ¡æ€§å‡ºç®±æ¨¡å¼ï¼ˆTransactional Outbox Patternï¼‰**ï¼Œç”¨äºå¯é çš„äº‹ä»¶å‘å¸ƒå’Œå®¡è®¡è·Ÿè¸ªï¼Œç¡®ä¿ä¸šåŠ¡æ•°æ®ä¸äº‹ä»¶åœ¨åŒä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡ä¸­æäº¤ï¼Œé¿å…åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ã€‚

---

## â• æ•°æ®å†™å…¥/æ’å…¥æ“ä½œ

### æ€»ä½“ç»Ÿè®¡
**æ“ä½œæ¬¡æ•°**: 11 å¤„
**æ‰€å±æœåŠ¡**: Contract Service
**æ–‡ä»¶è·¯å¾„**: `src/domains/contract/services/contract.service.ts`

### è¯¦ç»†æ¸…å•

| åºå· | äº‹ä»¶ç±»å‹ | è§¦å‘åœºæ™¯ | ä»£ç è¡Œå· | ä¸šåŠ¡è¯´æ˜ |
|------|----------|----------|----------|----------|
| 1 | `contract.signed` | åˆ›å»ºæ–°åˆçº¦æ—¶ | 92 | å­¦ç”Ÿç­¾çº¦æ–°åˆçº¦ |
| 2 | `contract.activated` | åˆçº¦çŠ¶æ€ä» signed å˜ä¸º active | 292 | åˆçº¦æ¿€æ´»å¼€å§‹ç”Ÿæ•ˆ |
| 3 | `service.consumed` | å­¦ç”Ÿæ¶ˆè´¹æœåŠ¡ | 411 | å­¦ç”Ÿä½¿ç”¨åˆçº¦ä¸­çš„æœåŠ¡ |
| 4 | `contract.terminated` | åˆçº¦è¢«ç»ˆæ­¢ | 466 | åˆçº¦æå‰ç»ˆæ­¢ |
| 5 | `contract.suspended` | åˆçº¦è¢«æš‚åœ | 525 | åˆçº¦çŠ¶æ€æš‚åœ |
| 6 | `contract.resumed` | åˆçº¦ä»æš‚åœæ¢å¤ | 575 | åˆçº¦æ¢å¤æ‰§è¡Œ |
| 7 | `contract.completed` | åˆçº¦å®Œæˆ | 624 | åˆçº¦æ­£å¸¸å®Œæˆ |
| 8 | `contract.signed` | è‰ç¨¿åˆçº¦è¢«ç­¾ç½² | 672 | è‰ç¨¿çŠ¶æ€è½¬ä¸ºå·²ç­¾ç½² |
| 9 | `contract.updated` | åˆçº¦ä¿¡æ¯æ›´æ–° | 768 | åˆçº¦æ¡æ¬¾æˆ–ä¿¡æ¯ä¿®æ”¹ |
| 10 | `entitlement.added` | ä¸ºå­¦ç”Ÿæ·»åŠ æƒç›Š | 968 | æ·»åŠ é¢å¤–æœåŠ¡æƒç›Š |

### ä»£ç å®ç°ç¤ºä¾‹

**ä½ç½®**: `src/domains/contract/services/contract.service.ts:105`

```typescript
await trx.insert(domainEvents).values({
  id: randomUUID(),
  aggregateType: 'contract',
  aggregateId: contract.id,
  eventType: 'contract.signed',
  payload: signedContract,
  createdAt: new Date(),
});
```

**å…³é”®å­—æ®µè¯´æ˜**:
- `aggregateType`: èšåˆæ ¹ç±»å‹ï¼ˆå›ºå®šä¸º 'contract'ï¼‰
- `aggregateId`: å…³è”çš„åˆçº¦ ID
- `eventType`: äº‹ä»¶ç±»å‹æ ‡è¯†
- `payload`: äº‹ä»¶è´Ÿè½½æ•°æ®
- `status`: é»˜è®¤ä¸º 'pending'ï¼Œç­‰å¾…å‘å¸ƒ

---

## ğŸ” æ•°æ®æŸ¥è¯¢/è¯»å–æ“ä½œ

### æŸ¥è¯¢ç»Ÿè®¡
**æ“ä½œæ¬¡æ•°**: 3 å¤„
**ä¸»è¦åœºæ™¯**: äº‹ä»¶å‘å¸ƒã€å¹‚ç­‰æ€§æ£€æŸ¥ã€ç›‘æ§ç»Ÿè®¡

### 1. æŸ¥è¯¢å¾…å¤„ç†äº‹ä»¶

**æ–‡ä»¶**: `src/domains/contract/services/event-publisher.service.ts:98`
**ç”¨é€”**: Event Publisher æœåŠ¡è½®è¯¢å¾…å‘å¸ƒäº‹ä»¶
**æŸ¥è¯¢æ¡ä»¶**:
- çŠ¶æ€ä¸º 'pending'
- é‡è¯•æ¬¡æ•°å°äºæœ€å¤§é‡è¯•é™åˆ¶
- æŒ‰åˆ›å»ºæ—¶é—´å‡åºæ’åº

```typescript
const events = await this.db.query.domainEvents.findMany({
  where: and(
    eq(domainEvents.status, 'pending'),
    lt(domainEvents.retryCount, maxRetries),
  ),
  orderBy: [asc(domainEvents.createdAt)],
  limit: batchSize,
});
```

### 2. äº‹ä»¶ç»Ÿè®¡æŸ¥è¯¢

**æ–‡ä»¶**: `src/domains/contract/services/event-publisher.service.ts:248`
**ç”¨é€”**: å¥åº·æ£€æŸ¥å’Œç›‘æ§ä»ªè¡¨æ¿
**æŸ¥è¯¢ç±»å‹**: æŒ‰çŠ¶æ€åˆ†ç»„ç»Ÿè®¡äº‹ä»¶æ•°é‡

### 3. å¹‚ç­‰æ€§æ£€æŸ¥

**æ–‡ä»¶**: `src/domains/financial/services/mentor-payable.service.ts:347`
**ç”¨é€”**: é˜²æ­¢é‡‘èäº¤æ˜“é‡å¤å¤„ç†
**å®ç°æ–¹å¼**:

```typescript
const existingEvent = await this.db.query.domainEvents.findFirst({
  where: eq(domainEvents.id, eventId),
});

// æ£€æŸ¥äº‹ä»¶æ˜¯å¦å·²å‘å¸ƒ
if (existingEvent && existingEvent.status === 'published') {
  return; // è·³è¿‡é‡å¤å¤„ç†
}
```

---

## âœï¸ æ•°æ®æ›´æ–°æ“ä½œ

### æ›´æ–°ç»Ÿè®¡
**æ“ä½œæ¬¡æ•°**: 3 å¤„
**æ‰€å±æœåŠ¡**: Event Publisher Service

### 1. æ›´æ–°ä¸ºå·²å‘å¸ƒçŠ¶æ€

**æ–‡ä»¶**: `src/domains/contract/services/event-publisher.service.ts:122`
**è§¦å‘æ—¶æœº**: äº‹ä»¶æˆåŠŸå‘å¸ƒå
**æ›´æ–°å†…å®¹**:
- `status` â†’ 'published'
- `publishedAt` â†’ å½“å‰æ—¶é—´æˆ³

### 2. æ›´æ–°é‡è¯•ä¿¡æ¯å’Œå¤±è´¥çŠ¶æ€

**æ–‡ä»¶**: `src/domains/contract/services/event-publisher.service.ts:141`
**è§¦å‘æ—¶æœº**: äº‹ä»¶å‘å¸ƒå¤±è´¥
**æ›´æ–°å†…å®¹**:
- `retryCount` â†’ é€’å¢ 1
- `status` â†’ 'failed' æˆ–ä¿æŒ 'pending'
- `errorMessage` â†’ é”™è¯¯è¯¦æƒ…
- `lastErrorAt` â†’ é”™è¯¯å‘ç”Ÿæ—¶é—´

### 3. é‡è¯•å¤±è´¥äº‹ä»¶

**æ–‡ä»¶**: `src/domains/contract/services/event-publisher.service.ts:182`
**è§¦å‘æ—¶æœº**: å®šæ—¶é‡è¯•ä»»åŠ¡
**æ›´æ–°å†…å®¹**:
- `status` â†’ 'pending'
- `retryCount` â†’ 0
- `errorMessage` â†’ null
- `lastErrorAt` â†’ null

---

## ğŸ—‘ï¸ æ•°æ®åˆ é™¤æ“ä½œ

### åˆ é™¤ç»Ÿè®¡
**æ“ä½œæ¬¡æ•°**: 3 å¤„
**åˆ é™¤ç±»å‹**: ç‰©ç†åˆ é™¤ï¼ˆ**æ— é€»è¾‘åˆ é™¤**ï¼‰

### 1. æ¸…ç†å·²å‘å¸ƒäº‹ä»¶

**æ–‡ä»¶**: `src/domains/contract/services/event-publisher.service.ts:219`
**åˆ é™¤ç±»å‹**: ç‰©ç†åˆ é™¤
**è§¦å‘æ–¹å¼**: å®šæ—¶æ¸…ç†ä»»åŠ¡ï¼ˆæ¯æ—¥æ‰§è¡Œï¼‰
**åˆ é™¤æ¡ä»¶**:
- çŠ¶æ€ä¸º 'published'
- å‘å¸ƒæ—¶é—´è¶…è¿‡ä¿ç•™æœŸï¼ˆé»˜è®¤ 90 å¤©ï¼‰

```typescript
await this.db.delete(domainEvents).where(
  and(
    eq(domainEvents.status, 'published'),
    lt(domainEvents.publishedAt, retentionDate),
  ),
);
```

**è®¾è®¡è€ƒè™‘**:
- ä»…åˆ é™¤å·²ç¡®è®¤å‘å¸ƒçš„äº‹ä»¶
- ä¿ç•™è¿‘æœŸäº‹ä»¶ç”¨äºå®¡è®¡å’Œé—®é¢˜æ’æŸ¥
- æ§åˆ¶è¡¨ä½“ç§¯ï¼Œé¿å…æ— é™å¢é•¿

### 2. æµ‹è¯•æ•°æ®æ¸…ç†

**æ–‡ä»¶**: `test/utils/test-fixtures.ts`
**ä½ç½®**: ç¬¬ 432 è¡Œã€ç¬¬ 441 è¡Œ
**æ“ä½œ**: `DELETE FROM "domain_events"`
**ç”¨é€”**: å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ç¯å¢ƒçš„æ•°æ®æ¸…ç†
**æ‰§è¡Œæ—¶æœº**: æµ‹è¯•å¥—ä»¶è¿è¡Œå‰å

---

## ğŸ“Š çŠ¶æ€æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pending  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                          â”‚
     â”‚                                              â”‚
     â”‚ å‘å¸ƒæˆåŠŸ                                       â”‚ é‡è¯•
     â–¼                                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚published â”‚â”€â”€â”€â”€â–ºâ”‚ 90å¤©ä¿ç•™æœŸå â”‚â”€â”€â”€â”€â–ºâ”‚ ç‰©ç†åˆ é™¤ â”‚   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
     â”‚                                              â”‚
     â”‚ å‘å¸ƒå¤±è´¥                                       â”‚
     â–¼                                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     é‡è¯•æ¬¡æ•°<5                          â”‚
â”‚  failed  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     é‡è¯•æ¬¡æ•°>=5
     â”‚
     â–¼
æ°¸ä¹…ä¿ç•™ï¼ˆéœ€äººå·¥å¹²é¢„ï¼‰
```

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç‰¹ç‚¹

### 1. äº‹åŠ¡æ€§å‡ºç®±æ¨¡å¼
- âœ… äº‹ä»¶ä¸ä¸šåŠ¡æ•°æ®åœ¨åŒä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡ä¸­æäº¤
- âœ… é¿å…ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡
- âœ… ä¿è¯åŸå­æ€§å’Œä¸€è‡´æ€§

### 2. å¯é æ¶ˆæ¯æŠ•é€’
- âœ… è‡³å°‘ä¸€æ¬¡æŠ•é€’è¯­ä¹‰ï¼ˆAt-least-once semanticsï¼‰
- âœ… é‡è¯•æœºåˆ¶ï¼ˆé»˜è®¤æœ€å¤§ 5 æ¬¡ï¼‰
- âœ… å¤±è´¥äº‹ä»¶å¯æ‰‹åŠ¨æˆ–è‡ªåŠ¨é‡è¯•

### 3. å¹‚ç­‰æ€§ä¿éšœ
- âœ… é‡‘èäº¤æ˜“é€šè¿‡äº‹ä»¶ ID æ£€æŸ¥é˜²æ­¢é‡å¤å¤„ç†
- âœ… å‘å¸ƒæœåŠ¡ç¡®ä¿äº‹ä»¶ä¸é‡å¤æŠ•é€’
- âœ… æ¶ˆè´¹è€…éœ€å®ç°å¹‚ç­‰æ¥æ”¶é€»è¾‘

### 4. å¯è§‚æµ‹æ€§
- âœ… è¯¦ç»†çš„çŠ¶æ€æµè½¬è·Ÿè¸ª
- âœ… é‡è¯•æ¬¡æ•°å’Œé”™è¯¯ä¿¡æ¯è®°å½•
- âœ… äº‹ä»¶ç»Ÿè®¡å’Œç›‘æ§æ”¯æŒ

### 5. æ•°æ®ä¿ç•™ç­–ç•¥
- âœ… å·²å‘å¸ƒäº‹ä»¶ä¿ç•™ 90 å¤©ç”¨äºå®¡è®¡
- âœ… è‡ªåŠ¨æ¸…ç†è¿‡æœŸäº‹ä»¶
- âœ… å¤±è´¥äº‹ä»¶æ°¸ä¹…ä¿ç•™å¾…äººå·¥å¤„ç†

---

## ğŸ” æ•°æ®å®Œæ•´æ€§çº¦æŸ

### å¤–é”®çº¦æŸ
è¯¥è¡¨**ä¸ä¾èµ–å¤–é”®çº¦æŸ**ï¼Œéµå¾ªé˜²è…å±‚ï¼ˆAnti-Corruption Layerï¼‰è®¾è®¡åŸåˆ™ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨å­—ç¬¦ä¸²å¼•ç”¨
aggregateId: string;  // å¼•ç”¨åˆçº¦æˆ–å…¶ä»–èšåˆæ ¹çš„ UUID

// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨å¤–é”®
aggregateId: number;  // æˆ– aggregateId: ForeignKey;
```

### ç´¢å¼•è®¾è®¡
- ä¸»é”®ç´¢å¼•ï¼š`id`
- èšåˆæŸ¥è¯¢ç´¢å¼•ï¼š`aggregateType`, `aggregateId`
- çŠ¶æ€æŸ¥è¯¢ç´¢å¼•ï¼š`status`
- æ—¶é—´æ’åºç´¢å¼•ï¼š`createdAt`

---

## ğŸš€ æ€§èƒ½è€ƒè™‘

### 1. æ‰¹é‡å¤„ç†
```typescript
limit: batchSize;  // é»˜è®¤ 100 æ¡
```

### 2. ç´¢å¼•ä¼˜åŒ–
- ä¸ºé«˜é¢‘æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
- æŒ‰çŠ¶æ€åˆ†åŒºæŸ¥è¯¢é¿å…å…¨è¡¨æ‰«æ

### 3. å®šæœŸæ¸…ç†
- æ¯æ—¥æ¸…ç†å·²å‘å¸ƒäº‹ä»¶
- æ§åˆ¶è¡¨ä½“ç§¯ï¼Œä¿æŒæŸ¥è¯¢æ€§èƒ½

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

å»ºè®®ç›‘æ§ä»¥ä¸‹å…³é”®æŒ‡æ ‡ï¼š

| æŒ‡æ ‡ | è¯´æ˜ | å‘Šè­¦é˜ˆå€¼ |
|------|------|----------|
| pending äº‹ä»¶æ•°é‡ | å¾…å¤„ç†äº‹ä»¶ç§¯å‹ | > 1000 |
| failed äº‹ä»¶æ•°é‡ | å‘å¸ƒå¤±è´¥äº‹ä»¶ | > 100 |
| å¹³å‡å‘å¸ƒå»¶è¿Ÿ | äº‹ä»¶åˆ›å»ºåˆ°å‘å¸ƒçš„æ—¶é—´ | > 5 åˆ†é’Ÿ |
| é‡è¯•ç‡ | éœ€è¦é‡è¯•çš„äº‹ä»¶æ¯”ä¾‹ | > 5% |
| æ¸…ç†äº‹ä»¶æ•° | æ¯æ—¥æ¸…ç†çš„è¿‡æœŸäº‹ä»¶ | å¼‚å¸¸æ³¢åŠ¨ |

---

## ğŸ”§ ç»´æŠ¤å»ºè®®

### æ—¥å¸¸è¿ç»´
1. **ç›‘æ§ failed äº‹ä»¶**ï¼šå®šæœŸæ£€æŸ¥å¤±è´¥åŸå› ï¼Œä¿®å¤åé‡è¯•
2. **æŸ¥çœ‹å‘å¸ƒå»¶è¿Ÿ**ï¼šç¡®ä¿äº‹ä»¶åŠæ—¶å‘å¸ƒï¼Œé¿å…ä¸šåŠ¡å»¶è¿Ÿ
3. **æ£€æŸ¥å­˜å‚¨ç©ºé—´**ï¼šç›‘æ§è¡¨å¤§å°ï¼Œç¡®è®¤æ¸…ç†ä»»åŠ¡æ­£å¸¸å·¥ä½œ

### æ•…éšœæ’æŸ¥
1. **äº‹ä»¶æœªå‘å¸ƒ**ï¼šæ£€æŸ¥ Event Publisher æœåŠ¡æ˜¯å¦è¿è¡Œ
2. **é‡å¤å¤„ç†**ï¼šæ£€æŸ¥æ¶ˆè´¹è€…å¹‚ç­‰æ€§å®ç°
3. **æ€§èƒ½é—®é¢˜**ï¼šæŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µï¼Œè°ƒæ•´ batchSize

### æ•°æ®ä¿®å¤
1. **é‡è¯•å¤±è´¥äº‹ä»¶**ï¼šä½¿ç”¨é‡è¯•æ¥å£æˆ–æ‰‹åŠ¨æ›´æ–°çŠ¶æ€
2. **æ¸…ç†è„æ•°æ®**ï¼šå¯¹äºæ— æ³•ä¿®å¤çš„äº‹ä»¶ï¼Œå¯æ‰‹åŠ¨åˆ é™¤
3. **æ¢å¤è¯¯åˆ æ•°æ®**ï¼šå¦‚æœ‰å¤‡ä»½å¯æ¢å¤ï¼Œæˆ–é‡æ–°ç”Ÿæˆäº‹ä»¶

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [äº‹åŠ¡æ€§å‡ºç®±æ¨¡å¼ - Martin Fowler](https://microservices.io/patterns/data/transactional-outbox.html)
- [DDD é˜²è…å±‚è®¾è®¡](../README.md)
- [CQRS å®ç°æŒ‡å—](../README.md)

---

## ğŸ“ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|----------|
| v1.0 | 2025-11-14 | Claude Code | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´åˆ†æ domainEvents è¡¨ä½¿ç”¨æƒ…å†µ |

---

**æ–‡æ¡£ç»´æŠ¤**: å½“ domainEvents è¡¨çš„ä½¿ç”¨æ–¹å¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè¯·åŠæ—¶æ›´æ–°æœ¬æ–‡æ¡£ã€‚
