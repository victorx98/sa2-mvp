# å¯¼å¸ˆè®¡è´¹ç³»ç»Ÿæ·±åº¦åˆ†ææŠ¥å‘Š

> åˆ†ææ—¥æœŸ: 2025-12-16
> åˆ†æèŒƒå›´: å¯¼å¸ˆè®¡è´¹ã€æœˆåº¦ç»“ç®—ã€ç”³è¯‰å¤„ç†ã€æ”¯ä»˜æµç¨‹

---

## ä¸€ã€æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šå¯¹ MentorX MVP ç³»ç»Ÿçš„å¯¼å¸ˆè®¡è´¹ç³»ç»Ÿè¿›è¡Œäº†å…¨é¢å®¡æŸ¥ï¼ŒåŒ…æ‹¬ï¼š
- è®¡è´¹è®°å½•åˆ›å»ºæµç¨‹
- æœˆåº¦ç»“ç®—è®¡ç®—é€»è¾‘
- å¯¼å¸ˆç”³è¯‰ä¸è§£å†³æµç¨‹
- æ”¯ä»˜ä¿¡æ¯ç®¡ç†

### å‘ç°é—®é¢˜ç­‰çº§

| ç­‰çº§ | æ•°é‡ | è¯´æ˜ |
|------|------|------|
| ğŸ”´ P0 ä¸¥é‡ | 1 | ç”³è¯‰æ‰¹å‡†åæ— è‡ªåŠ¨è°ƒæ•´ |
| ğŸŸ¡ P1 ä¸­ç­‰ | 3 | ç»“ç®—åè°ƒæ•´å¤„ç†ã€å¹¶å‘é—®é¢˜ã€å•ä½ä¸ä¸€è‡´ |
| ğŸŸ¢ P2 è½»å¾® | 3 | å­—æ®µæ‹¼å†™ã€ç´¢å¼•ä¼˜åŒ–ã€é”™è¯¯å¤„ç† |

---

## äºŒã€ç³»ç»Ÿæ¶æ„æ€»è§ˆ

### 2.1 æ ¸å¿ƒæ•°æ®è¡¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Financial Domain Schema                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  mentor_payable_ledgers â”‚      â”‚   settlement_ledgers    â”‚
â”‚  (å¯¼å¸ˆåº”ä»˜è´¦æ¬¾æµæ°´)       â”‚      â”‚   (ç»“ç®—è®°å½•)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  id                     â”‚      â”‚  id                     â”‚
â”‚  reference_id           â”‚      â”‚  mentor_id              â”‚
â”‚  mentor_id              â”‚â—„â”€â”€â”€â”€â”€â”‚  settlement_month       â”‚
â”‚  student_id             â”‚      â”‚  original_amount        â”‚
â”‚  session_type_code      â”‚      â”‚  target_amount          â”‚
â”‚  price                  â”‚      â”‚  exchange_rate          â”‚
â”‚  amount                 â”‚      â”‚  deduction_rate         â”‚
â”‚  currency               â”‚      â”‚  settlement_method      â”‚
â”‚  original_id (è°ƒæ•´é“¾)    â”‚      â”‚  mentor_payment_info_id â”‚
â”‚  adjustment_reason      â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  settlement_id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  settled_at             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    settlement_details   â”‚      â”‚    mentor_appeals       â”‚
â”‚    (ç»“ç®—æ˜ç»†)            â”‚      â”‚    (å¯¼å¸ˆç”³è¯‰)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  settlement_id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”   â”‚  id                     â”‚
â”‚  mentor_payable_id â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â†’ â”‚  mentor_id              â”‚
â”‚  original_amount        â”‚  â”‚   â”‚  counselor_id           â”‚
â”‚  target_amount          â”‚  â”‚   â”‚  mentor_payable_id â”€â”€â”€â”€â”€â”¼â”€â”€â†’ (å¯é€‰å…³è”)
â”‚  exchange_rate          â”‚  â”‚   â”‚  settlement_id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â†’ (å¯é€‰å…³è”)
â”‚  deduction_rate         â”‚  â””â”€â”€â”€â”‚  appeal_type            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  appeal_amount          â”‚
                                 â”‚  status                 â”‚
                                 â”‚  approved_by/at         â”‚
                                 â”‚  rejected_by/at         â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è®¾è®¡åŸåˆ™ï¼ˆå·²å®ç°ï¼‰

| åŸåˆ™ | è¯´æ˜ | å®ç°çŠ¶æ€ |
|------|------|----------|
| **Append-Only** | è´¦æœ¬è¡¨åª INSERTï¼Œä¸ UPDATE/DELETE | âœ… |
| **é˜²è…å±‚** | ä½¿ç”¨ UUID å­—ç¬¦ä¸²å¼•ç”¨è€Œéå¤–é”® | âœ… |
| **é“¾å¼è°ƒæ•´** | é€šè¿‡ originalId é“¾å¼è®°å½•è°ƒæ•´ | âœ… |
| **å¹‚ç­‰æ€§** | referenceId + originalId=null å”¯ä¸€ç´¢å¼• | âœ… |
| **è®¡ç®—é€æ˜** | å­˜å‚¨æ±‡ç‡ã€æ‰£é™¤ç‡ç­‰è®¡ç®—å‚æ•° | âœ… |

---

## ä¸‰ã€è®¡è´¹æµç¨‹åˆ†æ

### 3.1 æŒ‰ä¼šè¯è®¡è´¹æµç¨‹ (Per-Session Billing)

**è§¦å‘äº‹ä»¶**: `SERVICE_SESSION_COMPLETED_EVENT`

**ç›‘å¬å™¨**: `ServiceSessionCompletedListener` (`src/domains/financial/events/listeners/service-session-completed-listener.ts`)

**æµç¨‹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Per-Session Billing Flow                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[SESSION_COMPLETED_EVENT]
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ServiceSessionCompletedListener.handleServiceSessionCompletedEvent()            â”‚
â”‚                                                                                  â”‚
â”‚  1. å¹‚ç­‰æ€§æ£€æŸ¥: isDuplicate(refrenceId)                                          â”‚
â”‚     - æŸ¥è¯¢ reference_id ç›¸åŒä¸” original_id = null çš„è®°å½•                          â”‚
â”‚     - å¦‚å·²å­˜åœ¨åˆ™è·³è¿‡                                                              â”‚
â”‚                                                                                  â”‚
â”‚  2. éªŒè¯ payload:                                                                â”‚
â”‚     - sessionId, studentId, mentorId, sessionTypeCode å¿…å¡«                       â”‚
â”‚     - allowBilling = true                                                        â”‚
â”‚                                                                                  â”‚
â”‚  3. è·å–å¯¼å¸ˆä»·æ ¼:                                                                 â”‚
â”‚     - getMentorPrice(mentorId, sessionTypeCode)                                  â”‚
â”‚     - ä» mentor_prices è¡¨æŸ¥è¯¢                                                    â”‚
â”‚                                                                                  â”‚
â”‚  4. è®¡ç®—é‡‘é¢:                                                                    â”‚
â”‚     totalAmount = unitPrice Ã— actualDurationHours                               â”‚
â”‚                                                                                  â”‚
â”‚  5. åˆ›å»ºè´¦æ¬¾è®°å½•:                                                                â”‚
â”‚     INSERT INTO mentor_payable_ledgers (                                        â”‚
â”‚       reference_id, mentor_id, student_id, session_type_code,                   â”‚
â”‚       price, amount, currency                                                    â”‚
â”‚     )                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜åˆ†æ**:

1. **âš ï¸ actualDurationHours å•ä½é—®é¢˜**
   - äº‹ä»¶å‘å¸ƒæ—¶: `actualDurationHours = payload.actualDuration / 3600`
   - ä½† `payload.actualDuration` æ¥è‡ª `MeetingLifecycleService`ï¼Œå•ä½æ˜¯**åˆ†é’Ÿ**
   - å¯¼è‡´: `actualDurationHours = minutes / 3600`ï¼Œé‡‘é¢åå° 60 å€ï¼

### 3.2 å®‰ç½®ç”³è¯·è®¡è´¹æµç¨‹ (Placement Billing)

**è§¦å‘äº‹ä»¶**: `JOB_APPLICATION_STATUS_CHANGED_EVENT`

**ç›‘å¬å™¨**: `PlacementApplicationStatusChangedListener`

**å¯è®¡è´¹çŠ¶æ€**: `recommended`, `interviewed`, `hired`

**æµç¨‹ä¸ Per-Session ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äº**:
- ä½¿ç”¨ `applicationId` ä½œä¸º `referenceId`
- é‡‘é¢ = å•ä»·ï¼ˆæ— æ—¶é•¿ä¹˜æ•°ï¼‰

---

## å››ã€æœˆåº¦ç»“ç®—åˆ†æ

### 4.1 ç»“ç®—è®¡ç®—é€»è¾‘

**æœåŠ¡**: `SettlementService.generateSettlement()`

**æ–‡ä»¶**: `src/domains/financial/services/settlement.service.ts`

**æµç¨‹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Settlement Generation Flow                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[API: POST /api/financial/settlements]
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    generateSettlement() - äº‹åŠ¡å†…                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  Step 1: å‚æ•°éªŒè¯                                                                â”‚
â”‚    - settlementMonth æ ¼å¼: YYYY-MM                                               â”‚
â”‚    - exchangeRate > 0                                                            â”‚
â”‚    - 0 <= deductionRate <= 1                                                     â”‚
â”‚                                                                                  â”‚
â”‚  Step 2: è·å–å¯¼å¸ˆæ”¯ä»˜ä¿¡æ¯                                                         â”‚
â”‚    - æŸ¥è¯¢ mentor_payment_infos (status = ACTIVE)                                 â”‚
â”‚    - ä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸                                                            â”‚
â”‚                                                                                  â”‚
â”‚  Step 3: æ£€æŸ¥é‡å¤ç»“ç®—                                                            â”‚
â”‚    - æŸ¥è¯¢ settlement_ledgers (mentor_id, settlement_month)                       â”‚
â”‚    - å·²å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸                                                            â”‚
â”‚                                                                                  â”‚
â”‚  Step 4: é”å®šå¹¶è·å–æœªç»“ç®—è´¦æ¬¾                                                     â”‚
â”‚    SELECT * FROM mentor_payable_ledgers                                         â”‚
â”‚    WHERE mentor_id = ?                                                           â”‚
â”‚      AND settlement_id IS NULL                                                   â”‚
â”‚      AND created_at BETWEEN startOfMonth AND endOfMonth                         â”‚
â”‚    FOR UPDATE SKIP LOCKED                                                        â”‚
â”‚                                                                                  â”‚
â”‚  Step 5: è®¡ç®—é‡‘é¢ï¼ˆå››èˆäº”å…¥ä¸€è‡´æ€§ï¼‰                                               â”‚
â”‚    FOR EACH ledger:                                                              â”‚
â”‚      targetAmount = originalAmount Ã— (1 - deductionRate) Ã— exchangeRate          â”‚
â”‚      targetAmount = ROUND(targetAmount, 2)                                       â”‚
â”‚                                                                                  â”‚
â”‚    headerTotal = SUM(detail.targetAmount)  // ä»æ˜ç»†æ±‚å’Œï¼Œç¡®ä¿ä¸€è‡´                â”‚
â”‚                                                                                  â”‚
â”‚  Step 6: åˆ›å»ºç»“ç®—è®°å½•                                                            â”‚
â”‚    INSERT INTO settlement_ledgers (...)                                          â”‚
â”‚                                                                                  â”‚
â”‚  Step 7: åˆ›å»ºç»“ç®—æ˜ç»†                                                            â”‚
â”‚    INSERT INTO settlement_details (...)                                          â”‚
â”‚                                                                                  â”‚
â”‚  Step 8: æ›´æ–°è´¦æ¬¾è®°å½•                                                            â”‚
â”‚    UPDATE mentor_payable_ledgers                                                â”‚
â”‚    SET settlement_id = ?, settled_at = NOW()                                    â”‚
â”‚    WHERE id IN (...)                                                             â”‚
â”‚                                                                                  â”‚
â”‚  Step 9: å‘å¸ƒäº‹ä»¶                                                                â”‚
â”‚    emit(SETTLEMENT_CONFIRMED_EVENT)                                              â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 é‡‘é¢è®¡ç®—å…¬å¼

```
å•ä¸ªè´¦æ¬¾ç›®æ ‡é‡‘é¢ = åŸå§‹é‡‘é¢ Ã— (1 - æ‰£é™¤ç‡) Ã— æ±‡ç‡

ç¤ºä¾‹:
  åŸå§‹é‡‘é¢ = $100.00 USD
  æ‰£é™¤ç‡ = 0.10 (10% å¹³å°è´¹)
  æ±‡ç‡ = 7.2 (USD â†’ CNY)

  ç›®æ ‡é‡‘é¢ = 100 Ã— (1 - 0.10) Ã— 7.2 = 100 Ã— 0.9 Ã— 7.2 = Â¥648.00 CNY
```

### 4.3 ç»“ç®—è®¾è®¡ä¼˜ç‚¹

1. **é˜²æ­¢é‡å¤ç»“ç®—**: å”¯ä¸€ç´¢å¼• `(mentor_id, settlement_month)`
2. **é˜²æ­¢å¹¶å‘é—®é¢˜**: `FOR UPDATE SKIP LOCKED` é”å®šè´¦æ¬¾
3. **å››èˆäº”å…¥ä¸€è‡´æ€§**: å…ˆç®—æ˜ç»†å†æ±‚å’Œï¼Œheader ä¸ details é‡‘é¢ä¸€è‡´
4. **Append-Only**: ç»“ç®—è®°å½•ä¸å¯ä¿®æ”¹ï¼ŒçŠ¶æ€å§‹ç»ˆä¸º `CONFIRMED`

### 4.4 ğŸŸ¡ é—®é¢˜ï¼šç»“ç®—åçš„è°ƒæ•´å¦‚ä½•å¤„ç†ï¼Ÿ

**åœºæ™¯**: ç»“ç®—å·²å®Œæˆï¼Œä½†å‘ç°æŸä¸ªä¼šè¯è®°å½•æœ‰è¯¯éœ€è¦è°ƒæ•´

**å½“å‰é—®é¢˜**:
- è°ƒæ•´è®°å½• (`originalId IS NOT NULL`) çš„ `settlement_id` ä¸º `NULL`
- ä¸‹æ¬¡ç»“ç®—æ—¶ï¼Œè°ƒæ•´è®°å½•ä¼šè¢«çº³å…¥æ–°æœˆä»½çš„ç»“ç®—
- **ç»“æœ**: è°ƒæ•´é‡‘é¢ä¼šå‡ºç°åœ¨ä¸åŸè®°å½•ä¸åŒçš„ç»“ç®—æœˆä»½ï¼

**ç¤ºä¾‹**:
```
1. 1æœˆä¼šè¯è®¡è´¹ $100ï¼Œçº³å…¥1æœˆç»“ç®—
2. 2æœˆå‘ç°é”™è¯¯ï¼Œåˆ›å»ºè°ƒæ•´ -$50
3. è°ƒæ•´è®°å½•çš„ settlement_id = NULL
4. 2æœˆç»“ç®—æ—¶ï¼Œ-$50 è¢«çº³å…¥2æœˆç»“ç®—
5. é—®é¢˜ï¼š1æœˆæŠ¥è¡¨æ˜¾ç¤º $100ï¼Œ2æœˆæŠ¥è¡¨æ˜¾ç¤º -$50
```

**å»ºè®®ä¿®å¤**:
- è°ƒæ•´è®°å½•åº”ä¸åŸè®°å½•å…³è”åˆ°åŒä¸€ä¸ªç»“ç®—ï¼ˆå¦‚æœåŸè®°å½•å·²ç»“ç®—ï¼‰
- æˆ–è€…ï¼šå·²ç»“ç®—çš„è´¦æ¬¾ä¸åº”å…è®¸è°ƒæ•´ï¼Œéœ€èµ°å•ç‹¬çš„é€€æ¬¾/è¡¥å¿æµç¨‹

---

## äº”ã€å¯¼å¸ˆç”³è¯‰æµç¨‹åˆ†æ

### 5.1 ç”³è¯‰ç”Ÿå‘½å‘¨æœŸ

**æœåŠ¡**: `MentorAppealService`

**æ–‡ä»¶**: `src/domains/financial/services/mentor-appeal.service.ts`

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚    PENDING      â”‚
                        â”‚   (å¾…å¤„ç†)       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚                 â”‚                 â”‚
               â–¼                 â”‚                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    APPROVED     â”‚         â”‚      â”‚    REJECTED     â”‚
    â”‚    (å·²æ‰¹å‡†)      â”‚         â”‚      â”‚    (å·²é©³å›)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                 â”‚
               â–¼                 â”‚
    âŒ æ— è‡ªåŠ¨è°ƒæ•´ï¼              â”‚
                                â”‚
```

### 5.2 ç”³è¯‰åˆ›å»ºæµç¨‹

```typescript
createAppeal(dto, createdByUserId)
  1. éªŒè¯ mentorId === createdByUserId
  2. INSERT INTO mentor_appeals (status = 'PENDING')
  3. emit(MENTOR_APPEAL_CREATED_EVENT)
```

### 5.3 ç”³è¯‰æ‰¹å‡†æµç¨‹

```typescript
approveAppeal(id, approvedByUserId, appealAmount?, currency?, comments?)
  1. æŸ¥è¯¢ç”³è¯‰è®°å½•
  2. éªŒè¯ status === 'PENDING'
  3. éªŒè¯ approvedByUserId === counselorId (æƒé™æ£€æŸ¥)
  4. å¦‚æœ appealAmount æ— æ•ˆï¼Œè¦æ±‚æä¾›æ–°çš„é‡‘é¢
  5. UPDATE mentor_appeals SET status = 'APPROVED'
  6. emit(MENTOR_APPEAL_APPROVED_EVENT)
```

### 5.4 ğŸ”´ ä¸¥é‡é—®é¢˜ï¼šç”³è¯‰æ‰¹å‡†åæ— è‡ªåŠ¨è°ƒæ•´

**é—®é¢˜æè¿°**:

å½“ç”³è¯‰è¢«æ‰¹å‡†åï¼Œç³»ç»Ÿ**ä»…æ›´æ–°ç”³è¯‰çŠ¶æ€**ï¼Œä½†**ä¸ä¼šè‡ªåŠ¨åˆ›å»ºè°ƒæ•´è®°å½•**æ¥è¡¥å¿å¯¼å¸ˆï¼

**ä»£ç è¯æ®**:

```typescript
// mentor-appeal.service.ts:324-355
const [updatedAppeal] = await this.db
  .update(schema.mentorAppeals)
  .set({
    status: "APPROVED",
    approvedBy: approvedByUserId,
    approvedAt: now,
    // ... å…¶ä»–å­—æ®µ
  })
  .where(eq(schema.mentorAppeals.id, id))
  .returning();

// å‘å¸ƒäº‹ä»¶
this.eventEmitter.emit(MENTOR_APPEAL_APPROVED_EVENT, { ... });
// âŒ æ²¡æœ‰ç›‘å¬å™¨å¤„ç†è¿™ä¸ªäº‹ä»¶ï¼
```

**æœç´¢ç¡®è®¤**: `@OnEvent(MENTOR_APPEAL_APPROVED_EVENT)` åœ¨ä»£ç åº“ä¸­**ä¸å­˜åœ¨**

**å½±å“**:
1. å¯¼å¸ˆç”³è¯‰è¢«æ‰¹å‡†ï¼Œä½†å®é™…é‡‘é¢æ²¡æœ‰å˜åŒ–
2. éœ€è¦äººå·¥æ‰‹åŠ¨è°ƒç”¨ `/api/financial/payable-ledgers/:id/adjust` åˆ›å»ºè°ƒæ•´
3. å®¹æ˜“é—å¿˜ï¼Œå¯¼è‡´å¯¼å¸ˆå°‘æ”¶é’±

**å»ºè®®ä¿®å¤**:

åˆ›å»ºäº‹ä»¶ç›‘å¬å™¨è‡ªåŠ¨å¤„ç†ï¼š

```typescript
// æ–°å¢æ–‡ä»¶: src/domains/financial/events/listeners/appeal-approved.listener.ts

@Injectable()
export class AppealApprovedListener {
  @OnEvent(MENTOR_APPEAL_APPROVED_EVENT)
  async handleAppealApproved(event: MentorAppealApprovedEvent) {
    const { appealId, mentorPayableId, appealAmount, currency } = event;

    if (mentorPayableId) {
      // è‡ªåŠ¨åˆ›å»ºè°ƒæ•´è®°å½•
      await this.mentorPayableService.adjustPayableLedger({
        originalLedgerId: mentorPayableId,
        adjustmentAmount: Number(appealAmount),
        reason: `Appeal approved: ${appealId}`,
        createdBy: event.approvedBy,
      });
    }
  }
}
```

---

## å…­ã€æ”¯ä»˜æµç¨‹åˆ†æ

### 6.1 æ”¯ä»˜ä¿¡æ¯ç®¡ç†

**æœåŠ¡**: `MentorPaymentInfoService`

**æ”¯ä»˜æ–¹å¼**:
| æ–¹å¼ | è¯´æ˜ | è¯¦æƒ…å­—æ®µ |
|------|------|----------|
| `DOMESTIC_TRANSFER` | å›½å†…é“¶è¡Œè½¬è´¦ | bankName, accountNumber, accountHolder |
| `CHANNEL_BATCH_PAY` | æ¸ é“æ‰¹é‡æ”¯ä»˜ | channelDetails |
| `GUSTO` | Gusto ç¾å›½å·¥èµ„ | employeeId, companyId |
| `GUSTO_INTERNATIONAL` | Gusto å›½é™… | employeeId, companyId |
| `CHECK` | æ”¯ç¥¨ | payee, address |

### 6.2 å®é™…æ”¯ä»˜æ‰§è¡Œ

**å½“å‰çŠ¶æ€**: ç³»ç»Ÿ**ä¸æ‰§è¡Œå®é™…æ”¯ä»˜**

ç»“ç®—è®°å½•åˆ›å»ºåï¼Œéœ€è¦å¤–éƒ¨ç³»ç»Ÿ/äººå·¥æ“ä½œå®Œæˆå®é™…æ”¯ä»˜ï¼š
1. è´¢åŠ¡å›¢é˜Ÿå¯¼å‡ºç»“ç®—æ•°æ®
2. é€šè¿‡ Gusto/é“¶è¡Œç³»ç»Ÿå‘èµ·è½¬è´¦
3. **é—®é¢˜**: æ²¡æœ‰æ”¯ä»˜çŠ¶æ€å›å†™æœºåˆ¶

### 6.3 ğŸŸ¡ é—®é¢˜ï¼šç¼ºå°‘æ”¯ä»˜çŠ¶æ€è¿½è¸ª

**å½“å‰**:
- `settlement_ledgers` æ²¡æœ‰æ”¯ä»˜çŠ¶æ€å­—æ®µ
- æ— æ³•åŒºåˆ†"å·²ç»“ç®—"å’Œ"å·²æ”¯ä»˜"
- å¯¼å¸ˆæ— æ³•çŸ¥é“é’±æ˜¯å¦å·²åˆ°è´¦

**å»ºè®®**:
- å¢åŠ  `payment_status` å­—æ®µ: `PENDING_PAYMENT` â†’ `PAID` â†’ `PAYMENT_FAILED`
- å¢åŠ  `paid_at` æ—¶é—´æˆ³
- å¢åŠ æ”¯ä»˜å›è°ƒ/çŠ¶æ€æ›´æ–°æ¥å£

---

## ä¸ƒã€é—®é¢˜æ±‡æ€»

### 7.1 ğŸ”´ P0 ä¸¥é‡é—®é¢˜

| # | é—®é¢˜ | å½±å“ | æ–‡ä»¶ä½ç½® |
|---|------|------|----------|
| 1 | **ç”³è¯‰æ‰¹å‡†åæ— è‡ªåŠ¨è°ƒæ•´** | å¯¼å¸ˆå°‘æ”¶é’± | `mentor-appeal.service.ts` |

### 7.2 ğŸŸ¡ P1 ä¸­ç­‰é—®é¢˜

| # | é—®é¢˜ | å½±å“ | æ–‡ä»¶ä½ç½® |
|---|------|------|----------|
| 2 | **ç»“ç®—åè°ƒæ•´è®°å½•å½’å…¥ä¸‹æœˆ** | æŠ¥è¡¨ä¸å‡†ç¡® | `settlement.service.ts` |
| 3 | **actualDurationHours å•ä½é”™è¯¯** | è®¡è´¹é‡‘é¢é”™è¯¯ 60 å€ | `regular-mentoring.service.ts:176` |
| 4 | **ç¼ºå°‘æ”¯ä»˜çŠ¶æ€è¿½è¸ª** | æ— æ³•ç¡®è®¤æ”¯ä»˜æ˜¯å¦å®Œæˆ | `settlement-ledgers.schema.ts` |

### 7.3 ğŸŸ¢ P2 è½»å¾®é—®é¢˜

| # | é—®é¢˜ | å½±å“ | æ–‡ä»¶ä½ç½® |
|---|------|------|----------|
| 5 | `refrenceId` æ‹¼å†™é”™è¯¯ | ä»£ç å¯è¯»æ€§ | å¤šå¤„ |
| 6 | ç”³è¯‰æœç´¢ count æŸ¥è¯¢æ•ˆç‡ä½ | æ€§èƒ½ | `mentor-appeal.service.ts:218-222` |
| 7 | ç»“ç®—äº‹ä»¶åœ¨äº‹åŠ¡å†…å‘å¸ƒ | äº‹åŠ¡å›æ»šåäº‹ä»¶å·²å‘å‡º | `settlement.service.ts:257` |

---

## å…«ã€å®Œæ•´æµç¨‹å›¾

### 8.1 è®¡è´¹åˆ°æ”¯ä»˜å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Complete Billing to Payment Flow                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ä¼šè¯å®Œæˆ]
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVICE_SESSION_COMPLETED_EVENTâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ServiceSessionCompletedListener â”‚     â”‚ SessionCompletedListener      â”‚
â”‚ (Financial Domain)             â”‚      â”‚ (Contract Domain)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. å¹‚ç­‰æ€§æ£€æŸ¥                  â”‚      â”‚ 1. é‡Šæ”¾ Service Hold          â”‚
â”‚ 2. è·å–å¯¼å¸ˆä»·æ ¼                â”‚      â”‚ 2. è®°å½•æ¶ˆè´¹æµæ°´               â”‚
â”‚ 3. è®¡ç®—é‡‘é¢                   â”‚      â”‚    (service_ledgers)          â”‚
â”‚ 4. åˆ›å»º payable ledger        â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ [åˆ›å»º mentor_payable_ledgers è®°å½•]
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç­‰å¾…æœˆåº¦ç»“ç®—                                       â”‚
â”‚                                                                                â”‚
â”‚  è´¦æ¬¾çŠ¶æ€: settlement_id = NULL, settled_at = NULL                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ [æ¯æœˆç»“ç®—è§¦å‘: POST /api/financial/settlements]
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       generateSettlement() äº‹åŠ¡å†…                              â”‚
â”‚                                                                                â”‚
â”‚  1. é”å®šæœªç»“ç®—è´¦æ¬¾ (FOR UPDATE SKIP LOCKED)                                    â”‚
â”‚  2. è®¡ç®—åŸå§‹é‡‘é¢å’Œç›®æ ‡é‡‘é¢                                                     â”‚
â”‚  3. åˆ›å»º settlement_ledgers è®°å½•                                               â”‚
â”‚  4. åˆ›å»º settlement_details æ˜ç»†                                               â”‚
â”‚  5. æ›´æ–° payable_ledgers.settlement_id                                         â”‚
â”‚  6. å‘å¸ƒ SETTLEMENT_CONFIRMED_EVENT                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ [è´¦æ¬¾çŠ¶æ€: settlement_id = xxx, settled_at = NOW()]
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç­‰å¾…å®é™…æ”¯ä»˜ (ç³»ç»Ÿå¤–)                                 â”‚
â”‚                                                                                â”‚
â”‚  è´¢åŠ¡å›¢é˜Ÿ:                                                                     â”‚
â”‚  1. å¯¼å‡ºç»“ç®—æ•°æ®                                                               â”‚
â”‚  2. é€šè¿‡ Gusto/é“¶è¡Œ å‘èµ·è½¬è´¦                                                   â”‚
â”‚  3. âŒ æ— å›å†™æœºåˆ¶                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
    ? (æ”¯ä»˜çŠ¶æ€æœªè¿½è¸ª)
```

### 8.2 ç”³è¯‰å¤„ç†æµç¨‹ï¼ˆå½“å‰ vs åº”æœ‰ï¼‰

**å½“å‰æµç¨‹ï¼ˆæœ‰ç¼ºé™·ï¼‰**:
```
å¯¼å¸ˆå‘èµ·ç”³è¯‰ â†’ PENDING â†’ é¡¾é—®æ‰¹å‡† â†’ APPROVED â†’ âŒ ç»“æŸï¼ˆæ— è°ƒæ•´ï¼‰
```

**åº”æœ‰æµç¨‹**:
```
å¯¼å¸ˆå‘èµ·ç”³è¯‰ â†’ PENDING â†’ é¡¾é—®æ‰¹å‡† â†’ APPROVED
                                      â”‚
                                      â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ AppealApprovedListener â”‚
                            â”‚ (æ–°å¢)               â”‚
                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                            â”‚ è‡ªåŠ¨åˆ›å»ºè°ƒæ•´è®°å½•     â”‚
                            â”‚ adjustPayableLedger() â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                            [è°ƒæ•´è®°å½•çº³å…¥ä¸‹æ¬¡ç»“ç®—]
```

---

## ä¹ã€ä¿®å¤å»ºè®®ä¼˜å…ˆçº§

### 9.1 ç«‹å³ä¿®å¤ (P0)

**1. åˆ›å»ºç”³è¯‰æ‰¹å‡†äº‹ä»¶ç›‘å¬å™¨**

```typescript
// src/domains/financial/events/listeners/appeal-approved.listener.ts
@Injectable()
export class AppealApprovedListener {
  private readonly logger = new Logger(AppealApprovedListener.name);

  constructor(
    private readonly mentorPayableService: MentorPayableService,
    @Inject(DATABASE_CONNECTION)
    private readonly db: DrizzleDatabase,
  ) {}

  @OnEvent(MENTOR_APPEAL_APPROVED_EVENT)
  async handleAppealApproved(event: {
    appealId: string;
    mentorId: string;
    appealAmount: string;
    currency: string;
    approvedBy: string;
  }): Promise<void> {
    this.logger.log(`Processing approved appeal: ${event.appealId}`);

    // 1. æŸ¥è¯¢ç”³è¯‰è¯¦æƒ…è·å– mentorPayableId
    const appeal = await this.db.query.mentorAppeals.findFirst({
      where: eq(schema.mentorAppeals.id, event.appealId),
    });

    if (!appeal?.mentorPayableId) {
      this.logger.warn(`No mentorPayableId for appeal ${event.appealId}`);
      return;
    }

    // 2. åˆ›å»ºè°ƒæ•´è®°å½•
    await this.mentorPayableService.adjustPayableLedger({
      originalLedgerId: appeal.mentorPayableId,
      adjustmentAmount: Number(event.appealAmount),
      reason: `Appeal approved: ${event.appealId}`,
      createdBy: event.approvedBy,
    });

    this.logger.log(`Created adjustment for appeal ${event.appealId}`);
  }
}
```

### 9.2 å»ºè®®ä¿®å¤ (P1)

**2. ä¿®å¤ actualDurationHours å•ä½**

```typescript
// src/domains/services/sessions/regular-mentoring/services/regular-mentoring.service.ts
// ä¿®æ”¹å‰
actualDurationHours: payload.actualDuration / 3600,  // é”™è¯¯: actualDuration å•ä½æ˜¯åˆ†é’Ÿ

// ä¿®æ”¹å
actualDurationHours: payload.actualDuration / 60,    // æ­£ç¡®: åˆ†é’Ÿ â†’ å°æ—¶
```

**3. ç»“ç®—åè°ƒæ•´è®°å½•å¤„ç†ç­–ç•¥**

é€‰é¡¹ A: ç¦æ­¢å¯¹å·²ç»“ç®—è´¦æ¬¾è°ƒæ•´
```typescript
// mentor-payable.service.ts:adjustPayableLedger()
if (originalLedger.settlementId) {
  throw new BadRequestException(
    'Cannot adjust a settled ledger. Please create a new compensation record.'
  );
}
```

é€‰é¡¹ B: è°ƒæ•´è®°å½•å…³è”åŸç»“ç®—
```typescript
await this.db.insert(schema.mentorPayableLedgers).values({
  // ...
  settlementId: originalLedger.settlementId, // å…³è”åŒä¸€ç»“ç®—
});
```

**4. æ·»åŠ æ”¯ä»˜çŠ¶æ€è¿½è¸ª**

```sql
ALTER TABLE settlement_ledgers ADD COLUMN payment_status VARCHAR(20) DEFAULT 'PENDING_PAYMENT';
ALTER TABLE settlement_ledgers ADD COLUMN paid_at TIMESTAMP WITH TIME ZONE;
ALTER TABLE settlement_ledgers ADD COLUMN payment_reference VARCHAR(100);
```

### 9.3 ä½ä¼˜å…ˆçº§ä¿®å¤ (P2)

1. ä¿®å¤ `refrenceId` â†’ `referenceId` æ‹¼å†™
2. ä¼˜åŒ–ç”³è¯‰æœç´¢ count æŸ¥è¯¢
3. å°†äº‹ä»¶å‘å¸ƒç§»åˆ°äº‹åŠ¡å¤–

---

## åã€æµ‹è¯•è¦†ç›–å»ºè®®

### 10.1 éœ€è¦å¢åŠ çš„æµ‹è¯•ç”¨ä¾‹

| æµ‹è¯•åœºæ™¯ | å½“å‰çŠ¶æ€ | å»ºè®® |
|----------|----------|------|
| ç”³è¯‰æ‰¹å‡†è‡ªåŠ¨è°ƒæ•´ | âŒ ç¼ºå¤± | æ·»åŠ é›†æˆæµ‹è¯• |
| ç»“ç®—åè°ƒæ•´å½’å±æœˆä»½ | âŒ ç¼ºå¤± | æ·»åŠ è¾¹ç•Œæµ‹è¯• |
| å¹¶å‘ç»“ç®—é˜²æŠ¤ | âš ï¸ æœ‰å•å…ƒæµ‹è¯• | æ·»åŠ å¹¶å‘æµ‹è¯• |
| actualDuration å•ä½ | âŒ ç¼ºå¤± | æ·»åŠ è®¡ç®—éªŒè¯ |

---

## åä¸€ã€ç»“è®º

å¯¼å¸ˆè®¡è´¹ç³»ç»Ÿæ•´ä½“æ¶æ„è®¾è®¡åˆç†ï¼Œéµå¾ªäº† Append-Onlyã€é˜²è…å±‚ç­‰æœ€ä½³å®è·µã€‚ä½†å­˜åœ¨ä»¥ä¸‹å…³é”®é—®é¢˜éœ€è¦ä¿®å¤ï¼š

1. **ğŸ”´ æœ€ä¸¥é‡**: ç”³è¯‰æ‰¹å‡†åæ— è‡ªåŠ¨è°ƒæ•´ï¼Œå¯èƒ½å¯¼è‡´å¯¼å¸ˆå°‘æ”¶é’±
2. **ğŸŸ¡ éœ€å…³æ³¨**: actualDurationHours å•ä½é—®é¢˜å¯èƒ½å¯¼è‡´è®¡è´¹é‡‘é¢åå° 60 å€
3. **ğŸŸ¡ éœ€è®¾è®¡**: ç»“ç®—åè°ƒæ•´çš„ä¸šåŠ¡è§„åˆ™éœ€è¦æ˜ç¡®

å»ºè®®ä¼˜å…ˆä¿®å¤ P0 é—®é¢˜ï¼Œå¹¶åœ¨ä¿®å¤åè¿›è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•éªŒè¯ã€‚

---

*æŠ¥å‘Šç”Ÿæˆè€…: Claude Code*
*å®¡æŸ¥ç‰ˆæœ¬: main branch*
