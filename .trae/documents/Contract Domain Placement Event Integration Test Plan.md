# Contract Domain Placement Event Integration Test Plan

## 1. 测试目标与范围

### 1.1 测试目标
- 验证contract domain对placement domain事件的正确接收和处理
- 验证权益消耗和退款逻辑的正确性
- 验证数据库触发器自动更新机制的有效性
- 验证事件处理的幂等性和异常处理
- 验证跨合同权益累积机制

### 1.2 测试范围
- **事件类型**：`placement.application.status_changed` 和 `placement.application.status_rolled_back`
- **处理逻辑**：权益消耗记录和权益退款调整
- **数据库表**：`service_ledgers`、`contract_service_entitlements`
- **服务**：`PlacementEventListener`、`ServiceLedgerService`

## 2. 测试环境配置

### 2.1 基础设施要求
- 测试数据库实例（与开发/生产环境隔离）
- NestJS测试环境配置
- 事件驱动架构环境（EventEmitter2）

### 2.2 数据准备
- 创建测试学生用户
- 创建测试服务类型（`job_application`）
- 为测试学生分配初始权益
- 创建测试投递申请

### 2.3 环境配置
- 启用详细日志记录（设置日志级别为DEBUG）
- 配置数据库连接字符串
- 初始化测试数据库架构

## 3. 测试用例设计

### 3.1 正常流程测试

#### 3.1.1 投递状态变为submitted时的权益消耗
- **测试场景**：当投递申请状态从`mentor_assigned`变为`submitted`时
- **预期结果**：
  - 成功创建一条类型为`consumption`的服务账本记录
  - `contract_service_entitlements`表中`consumed_quantity`增加1
  - `available_quantity`减少1
  - 日志记录完整的事件处理流程

#### 3.1.2 投递状态从submitted回撤时的权益退款
- **测试场景**：当投递申请状态从`submitted`回撤到`mentor_assigned`时
- **预期结果**：
  - 成功创建一条类型为`adjustment`的服务账本记录
  - `contract_service_entitlements`表中`available_quantity`增加1
  - 日志记录完整的事件处理流程和回撤原因

#### 3.1.3 跨合同权益累积
- **测试场景**：多个合同的同类型服务权益自动累加
- **预期结果**：
  - 多个合同的权益自动累积到同一学生记录
  - 权益消耗从累积权益中扣除

### 3.2 边界条件测试

#### 3.2.1 权益不足时的处理
- **测试场景**：当学生权益不足时尝试消耗权益
- **预期结果**：
  - 事件处理失败，抛出`INSUFFICIENT_BALANCE`异常
  - 数据库记录无变化
  - 日志记录详细的错误信息

#### 3.2.2 重复事件处理
- **测试场景**：多次发送相同的事件
- **预期结果**：
  - 事件处理具有幂等性
  - 数据库只记录一次权益变化
  - 日志记录重复事件处理情况

#### 3.2.3 无效事件数据
- **测试场景**：发送缺少必要字段的事件
- **预期结果**：
  - 事件处理失败，返回适当的错误信息
  - 数据库记录无变化
  - 日志记录详细的错误信息

### 3.3 异常场景测试

#### 3.3.1 数据库连接失败
- **测试场景**：模拟数据库连接失败
- **预期结果**：
  - 事件处理失败，抛出适当的异常
  - 日志记录详细的错误信息
  - 系统能够恢复正常运行

#### 3.3.2 服务依赖失败
- **测试场景**：模拟`ServiceLedgerService`失败
- **预期结果**：
  - 事件处理失败，抛出适当的异常
  - 日志记录详细的错误信息
  - 系统能够恢复正常运行

## 4. 测试执行步骤

### 4.1 测试前准备
1. 初始化测试数据库
2. 创建测试数据（学生、服务类型、初始权益、投递申请）
3. 启用详细日志记录
4. 启动测试环境

### 4.2 测试执行

#### 4.2.1 测试用例1：投递状态变为submitted时的权益消耗
1. 记录初始数据库状态（查询`contract_service_entitlements`和`service_ledgers`）
2. 发送`placement.application.status_changed`事件，状态从`mentor_assigned`变为`submitted`
3. 等待事件处理完成
4. 记录最终数据库状态
5. 比较数据库状态变化
6. 检查日志记录

#### 4.2.2 测试用例2：投递状态从submitted回撤时的权益退款
1. 记录初始数据库状态
2. 发送`placement.application.status_rolled_back`事件，状态从`submitted`回撤到`mentor_assigned`
3. 等待事件处理完成
4. 记录最终数据库状态
5. 比较数据库状态变化
6. 检查日志记录

#### 4.2.3 测试用例3：权益不足时的处理
1. 记录初始数据库状态
2. 消耗完所有可用权益
3. 再次尝试消耗权益
4. 检查异常处理和日志记录
5. 验证数据库状态无变化

### 4.3 测试后清理
1. 清理测试数据
2. 关闭测试环境
3. 生成测试报告

## 5. 测试验证方法

### 5.1 日志验证
- 记录事件接收时间和处理开始时间
- 记录事件处理的每个步骤
- 记录数据库操作结果
- 记录事件处理完成时间和结果

### 5.2 数据库验证
- **`service_ledgers`表**：
  - 检查记录新增情况
  - 验证`quantity`、`type`、`source`等字段的正确性
  - 验证`balanceAfter`字段的准确性
- **`contract_service_entitlements`表**：
  - 检查`consumed_quantity`和`available_quantity`的变化
  - 验证触发器自动更新的正确性
  - 验证跨合同权益累积

### 5.3 业务逻辑验证
- 权益消耗数量是否正确（1个`job_application`权益）
- 权益退款逻辑是否正确（通过调整增加权益）
- 状态变化是否符合预期

## 6. 测试报告生成

### 6.1 报告内容
- 测试执行摘要
- 测试用例执行结果
- 日志分析结果
- 数据库验证结论
- 问题和缺陷报告
- 建议和改进措施

### 6.2 报告格式
- Markdown格式
- 包含关键日志片段
- 包含数据库状态变化对比
- 包含测试结果统计

## 7. 测试风险和缓解措施

### 7.1 测试风险
- 数据库触发器配置错误
- 事件处理顺序问题
- 并发事件处理冲突
- 测试数据准备不充分

### 7.2 缓解措施
- 仔细检查数据库触发器配置
- 使用事件顺序控制机制
- 实现事件处理的幂等性
- 充分准备测试数据和测试环境

## 8. 测试工具和框架

- **测试框架**：Jest + NestJS TestingModule
- **事件模拟**：EventEmitter2
- **数据库操作**：Drizzle ORM
- **日志分析**：Winston日志系统
- **报告生成**：自定义测试报告生成器

## 9. 测试执行计划

### 9.1 测试执行时间
- 计划执行时间：[具体日期]
- 预计执行时长：2-4小时

### 9.2 测试执行人员
- 测试负责人：[姓名]
- 开发人员：[姓名]
- 数据库管理员：[姓名]

## 10. 测试通过标准

- 所有测试用例通过
- 日志记录完整准确
- 数据库状态变化符合预期
- 无严重缺陷
- 性能指标符合要求

---

**测试计划版本**：1.0
**测试计划日期**：2025-12-01
**测试计划作者**：Trae AI